<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="pdoc 15.0.4"/>
    <title>batchata API documentation</title>

    <style>/*! * Bootstrap Reboot v5.0.0 (https://getbootstrap.com/) * Copyright 2011-2021 The Bootstrap Authors * Copyright 2011-2021 Twitter, Inc. * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE) * Forked from Normalize.css, licensed MIT (https://github.com/necolas/normalize.css/blob/master/LICENSE.md) */*,::after,::before{box-sizing:border-box}@media (prefers-reduced-motion:no-preference){:root{scroll-behavior:smooth}}body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-size:1rem;font-weight:400;line-height:1.5;color:#212529;background-color:#fff;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}hr{margin:1rem 0;color:inherit;background-color:currentColor;border:0;opacity:.25}hr:not([size]){height:1px}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2}h1{font-size:calc(1.375rem + 1.5vw)}@media (min-width:1200px){h1{font-size:2.5rem}}h2{font-size:calc(1.325rem + .9vw)}@media (min-width:1200px){h2{font-size:2rem}}h3{font-size:calc(1.3rem + .6vw)}@media (min-width:1200px){h3{font-size:1.75rem}}h4{font-size:calc(1.275rem + .3vw)}@media (min-width:1200px){h4{font-size:1.5rem}}h5{font-size:1.25rem}h6{font-size:1rem}p{margin-top:0;margin-bottom:1rem}abbr[data-bs-original-title],abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted;cursor:help;-webkit-text-decoration-skip-ink:none;text-decoration-skip-ink:none}address{margin-bottom:1rem;font-style:normal;line-height:inherit}ol,ul{padding-left:2rem}dl,ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}dt{font-weight:700}dd{margin-bottom:.5rem;margin-left:0}blockquote{margin:0 0 1rem}b,strong{font-weight:bolder}small{font-size:.875em}mark{padding:.2em;background-color:#fcf8e3}sub,sup{position:relative;font-size:.75em;line-height:0;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}a{color:#0d6efd;text-decoration:underline}a:hover{color:#0a58ca}a:not([href]):not([class]),a:not([href]):not([class]):hover{color:inherit;text-decoration:none}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em;direction:ltr;unicode-bidi:bidi-override}pre{display:block;margin-top:0;margin-bottom:1rem;overflow:auto;font-size:.875em}pre code{font-size:inherit;color:inherit;word-break:normal}code{font-size:.875em;color:#d63384;word-wrap:break-word}a>code{color:inherit}kbd{padding:.2rem .4rem;font-size:.875em;color:#fff;background-color:#212529;border-radius:.2rem}kbd kbd{padding:0;font-size:1em;font-weight:700}figure{margin:0 0 1rem}img,svg{vertical-align:middle}table{caption-side:bottom;border-collapse:collapse}caption{padding-top:.5rem;padding-bottom:.5rem;color:#6c757d;text-align:left}th{text-align:inherit;text-align:-webkit-match-parent}tbody,td,tfoot,th,thead,tr{border-color:inherit;border-style:solid;border-width:0}label{display:inline-block}button{border-radius:0}button:focus:not(:focus-visible){outline:0}button,input,optgroup,select,textarea{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}button,select{text-transform:none}[role=button]{cursor:pointer}select{word-wrap:normal}select:disabled{opacity:1}[list]::-webkit-calendar-picker-indicator{display:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled),button:not(:disabled){cursor:pointer}::-moz-focus-inner{padding:0;border-style:none}textarea{resize:vertical}fieldset{min-width:0;padding:0;margin:0;border:0}legend{float:left;width:100%;padding:0;margin-bottom:.5rem;font-size:calc(1.275rem + .3vw);line-height:inherit}@media (min-width:1200px){legend{font-size:1.5rem}}legend+*{clear:left}::-webkit-datetime-edit-day-field,::-webkit-datetime-edit-fields-wrapper,::-webkit-datetime-edit-hour-field,::-webkit-datetime-edit-minute,::-webkit-datetime-edit-month-field,::-webkit-datetime-edit-text,::-webkit-datetime-edit-year-field{padding:0}::-webkit-inner-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:textfield}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-color-swatch-wrapper{padding:0}::file-selector-button{font:inherit}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}output{display:inline-block}iframe{border:0}summary{display:list-item;cursor:pointer}progress{vertical-align:baseline}[hidden]{display:none!important}</style>
    <style>/*! syntax-highlighting.css */pre{line-height:125%;}span.linenos{color:inherit; background-color:transparent; padding-left:5px; padding-right:20px;}.pdoc-code .hll{background-color:#ffffcc}.pdoc-code{background:#f8f8f8;}.pdoc-code .c{color:#3D7B7B; font-style:italic}.pdoc-code .err{border:1px solid #FF0000}.pdoc-code .k{color:#008000; font-weight:bold}.pdoc-code .o{color:#666666}.pdoc-code .ch{color:#3D7B7B; font-style:italic}.pdoc-code .cm{color:#3D7B7B; font-style:italic}.pdoc-code .cp{color:#9C6500}.pdoc-code .cpf{color:#3D7B7B; font-style:italic}.pdoc-code .c1{color:#3D7B7B; font-style:italic}.pdoc-code .cs{color:#3D7B7B; font-style:italic}.pdoc-code .gd{color:#A00000}.pdoc-code .ge{font-style:italic}.pdoc-code .gr{color:#E40000}.pdoc-code .gh{color:#000080; font-weight:bold}.pdoc-code .gi{color:#008400}.pdoc-code .go{color:#717171}.pdoc-code .gp{color:#000080; font-weight:bold}.pdoc-code .gs{font-weight:bold}.pdoc-code .gu{color:#800080; font-weight:bold}.pdoc-code .gt{color:#0044DD}.pdoc-code .kc{color:#008000; font-weight:bold}.pdoc-code .kd{color:#008000; font-weight:bold}.pdoc-code .kn{color:#008000; font-weight:bold}.pdoc-code .kp{color:#008000}.pdoc-code .kr{color:#008000; font-weight:bold}.pdoc-code .kt{color:#B00040}.pdoc-code .m{color:#666666}.pdoc-code .s{color:#BA2121}.pdoc-code .na{color:#687822}.pdoc-code .nb{color:#008000}.pdoc-code .nc{color:#0000FF; font-weight:bold}.pdoc-code .no{color:#880000}.pdoc-code .nd{color:#AA22FF}.pdoc-code .ni{color:#717171; font-weight:bold}.pdoc-code .ne{color:#CB3F38; font-weight:bold}.pdoc-code .nf{color:#0000FF}.pdoc-code .nl{color:#767600}.pdoc-code .nn{color:#0000FF; font-weight:bold}.pdoc-code .nt{color:#008000; font-weight:bold}.pdoc-code .nv{color:#19177C}.pdoc-code .ow{color:#AA22FF; font-weight:bold}.pdoc-code .w{color:#bbbbbb}.pdoc-code .mb{color:#666666}.pdoc-code .mf{color:#666666}.pdoc-code .mh{color:#666666}.pdoc-code .mi{color:#666666}.pdoc-code .mo{color:#666666}.pdoc-code .sa{color:#BA2121}.pdoc-code .sb{color:#BA2121}.pdoc-code .sc{color:#BA2121}.pdoc-code .dl{color:#BA2121}.pdoc-code .sd{color:#BA2121; font-style:italic}.pdoc-code .s2{color:#BA2121}.pdoc-code .se{color:#AA5D1F; font-weight:bold}.pdoc-code .sh{color:#BA2121}.pdoc-code .si{color:#A45A77; font-weight:bold}.pdoc-code .sx{color:#008000}.pdoc-code .sr{color:#A45A77}.pdoc-code .s1{color:#BA2121}.pdoc-code .ss{color:#19177C}.pdoc-code .bp{color:#008000}.pdoc-code .fm{color:#0000FF}.pdoc-code .vc{color:#19177C}.pdoc-code .vg{color:#19177C}.pdoc-code .vi{color:#19177C}.pdoc-code .vm{color:#19177C}.pdoc-code .il{color:#666666}</style>
    <style>/*! theme.css */:root{--pdoc-background:#fff;}.pdoc{--text:#212529;--muted:#6c757d;--link:#3660a5;--link-hover:#1659c5;--code:#f8f8f8;--active:#fff598;--accent:#eee;--accent2:#c1c1c1;--nav-hover:rgba(255, 255, 255, 0.5);--name:#0066BB;--def:#008800;--annotation:#007020;}</style>
    <style>/*! layout.css */html, body{width:100%;height:100%;}html, main{scroll-behavior:smooth;}body{background-color:var(--pdoc-background);}@media (max-width:769px){#navtoggle{cursor:pointer;position:absolute;width:50px;height:40px;top:1rem;right:1rem;border-color:var(--text);color:var(--text);display:flex;opacity:0.8;z-index:999;}#navtoggle:hover{opacity:1;}#togglestate + div{display:none;}#togglestate:checked + div{display:inherit;}main, header{padding:2rem 3vw;}header + main{margin-top:-3rem;}.git-button{display:none !important;}nav input[type="search"]{max-width:77%;}nav input[type="search"]:first-child{margin-top:-6px;}nav input[type="search"]:valid ~ *{display:none !important;}}@media (min-width:770px){:root{--sidebar-width:clamp(12.5rem, 28vw, 22rem);}nav{position:fixed;overflow:auto;height:100vh;width:var(--sidebar-width);}main, header{padding:3rem 2rem 3rem calc(var(--sidebar-width) + 3rem);width:calc(54rem + var(--sidebar-width));max-width:100%;}header + main{margin-top:-4rem;}#navtoggle{display:none;}}#togglestate{position:absolute;height:0;opacity:0;}nav.pdoc{--pad:clamp(0.5rem, 2vw, 1.75rem);--indent:1.5rem;background-color:var(--accent);border-right:1px solid var(--accent2);box-shadow:0 0 20px rgba(50, 50, 50, .2) inset;padding:0 0 0 var(--pad);overflow-wrap:anywhere;scrollbar-width:thin; scrollbar-color:var(--accent2) transparent; z-index:1}nav.pdoc::-webkit-scrollbar{width:.4rem; }nav.pdoc::-webkit-scrollbar-thumb{background-color:var(--accent2); }nav.pdoc > div{padding:var(--pad) 0;}nav.pdoc .module-list-button{display:inline-flex;align-items:center;color:var(--text);border-color:var(--muted);margin-bottom:1rem;}nav.pdoc .module-list-button:hover{border-color:var(--text);}nav.pdoc input[type=search]{display:block;outline-offset:0;width:calc(100% - var(--pad));}nav.pdoc .logo{max-width:calc(100% - var(--pad));max-height:35vh;display:block;margin:0 auto 1rem;transform:translate(calc(-.5 * var(--pad)), 0);}nav.pdoc ul{list-style:none;padding-left:0;}nav.pdoc > div > ul{margin-left:calc(0px - var(--pad));}nav.pdoc li a{padding:.2rem 0 .2rem calc(var(--pad) + var(--indent));}nav.pdoc > div > ul > li > a{padding-left:var(--pad);}nav.pdoc li{transition:all 100ms;}nav.pdoc li:hover{background-color:var(--nav-hover);}nav.pdoc a, nav.pdoc a:hover{color:var(--text);}nav.pdoc a{display:block;}nav.pdoc > h2:first-of-type{margin-top:1.5rem;}nav.pdoc .class:before{content:"class ";color:var(--muted);}nav.pdoc .function:after{content:"()";color:var(--muted);}nav.pdoc footer:before{content:"";display:block;width:calc(100% - var(--pad));border-top:solid var(--accent2) 1px;margin-top:1.5rem;padding-top:.5rem;}nav.pdoc footer{font-size:small;}</style>
    <style>/*! content.css */.pdoc{color:var(--text);box-sizing:border-box;line-height:1.5;background:none;}.pdoc .pdoc-button{cursor:pointer;display:inline-block;border:solid black 1px;border-radius:2px;font-size:.75rem;padding:calc(0.5em - 1px) 1em;transition:100ms all;}.pdoc .alert{padding:1rem 1rem 1rem calc(1.5rem + 24px);border:1px solid transparent;border-radius:.25rem;background-repeat:no-repeat;background-position:.75rem center;margin-bottom:1rem;}.pdoc .alert > em{display:none;}.pdoc .alert > *:last-child{margin-bottom:0;}.pdoc .alert.note{color:#084298;background-color:#cfe2ff;border-color:#b6d4fe;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23084298%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8%2016A8%208%200%201%200%208%200a8%208%200%200%200%200%2016zm.93-9.412-1%204.705c-.07.34.029.533.304.533.194%200%20.487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703%200-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381%202.29-.287zM8%205.5a1%201%200%201%201%200-2%201%201%200%200%201%200%202z%22/%3E%3C/svg%3E");}.pdoc .alert.tip{color:#0a3622;background-color:#d1e7dd;border-color:#a3cfbb;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%230a3622%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M2%206a6%206%200%201%201%2010.174%204.31c-.203.196-.359.4-.453.619l-.762%201.769A.5.5%200%200%201%2010.5%2013a.5.5%200%200%201%200%201%20.5.5%200%200%201%200%201l-.224.447a1%201%200%200%201-.894.553H6.618a1%201%200%200%201-.894-.553L5.5%2015a.5.5%200%200%201%200-1%20.5.5%200%200%201%200-1%20.5.5%200%200%201-.46-.302l-.761-1.77a2%202%200%200%200-.453-.618A5.98%205.98%200%200%201%202%206m6-5a5%205%200%200%200-3.479%208.592c.263.254.514.564.676.941L5.83%2012h4.342l.632-1.467c.162-.377.413-.687.676-.941A5%205%200%200%200%208%201%22/%3E%3C/svg%3E");}.pdoc .alert.important{color:#055160;background-color:#cff4fc;border-color:#9eeaf9;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23055160%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M2%200a2%202%200%200%200-2%202v12a2%202%200%200%200%202%202h12a2%202%200%200%200%202-2V2a2%202%200%200%200-2-2zm6%204c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%204.995A.905.905%200%200%201%208%204m.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2%22/%3E%3C/svg%3E");}.pdoc .alert.warning{color:#664d03;background-color:#fff3cd;border-color:#ffecb5;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23664d03%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8.982%201.566a1.13%201.13%200%200%200-1.96%200L.165%2013.233c-.457.778.091%201.767.98%201.767h13.713c.889%200%201.438-.99.98-1.767L8.982%201.566zM8%205c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%205.995A.905.905%200%200%201%208%205zm.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2z%22/%3E%3C/svg%3E");}.pdoc .alert.caution{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M11.46.146A.5.5%200%200%200%2011.107%200H4.893a.5.5%200%200%200-.353.146L.146%204.54A.5.5%200%200%200%200%204.893v6.214a.5.5%200%200%200%20.146.353l4.394%204.394a.5.5%200%200%200%20.353.146h6.214a.5.5%200%200%200%20.353-.146l4.394-4.394a.5.5%200%200%200%20.146-.353V4.893a.5.5%200%200%200-.146-.353zM8%204c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%204.995A.905.905%200%200%201%208%204m.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2%22/%3E%3C/svg%3E");}.pdoc .alert.danger{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M5.52.359A.5.5%200%200%201%206%200h4a.5.5%200%200%201%20.474.658L8.694%206H12.5a.5.5%200%200%201%20.395.807l-7%209a.5.5%200%200%201-.873-.454L6.823%209.5H3.5a.5.5%200%200%201-.48-.641l2.5-8.5z%22/%3E%3C/svg%3E");}.pdoc .visually-hidden{position:absolute !important;width:1px !important;height:1px !important;padding:0 !important;margin:-1px !important;overflow:hidden !important;clip:rect(0, 0, 0, 0) !important;white-space:nowrap !important;border:0 !important;}.pdoc h1, .pdoc h2, .pdoc h3{font-weight:300;margin:.3em 0;padding:.2em 0;}.pdoc > section:not(.module-info) h1{font-size:1.5rem;font-weight:500;}.pdoc > section:not(.module-info) h2{font-size:1.4rem;font-weight:500;}.pdoc > section:not(.module-info) h3{font-size:1.3rem;font-weight:500;}.pdoc > section:not(.module-info) h4{font-size:1.2rem;}.pdoc > section:not(.module-info) h5{font-size:1.1rem;}.pdoc a{text-decoration:none;color:var(--link);}.pdoc a:hover{color:var(--link-hover);}.pdoc blockquote{margin-left:2rem;}.pdoc pre{border-top:1px solid var(--accent2);border-bottom:1px solid var(--accent2);margin-top:0;margin-bottom:1em;padding:.5rem 0 .5rem .5rem;overflow-x:auto;background-color:var(--code);}.pdoc code{color:var(--text);padding:.2em .4em;margin:0;font-size:85%;background-color:var(--accent);border-radius:6px;}.pdoc a > code{color:inherit;}.pdoc pre > code{display:inline-block;font-size:inherit;background:none;border:none;padding:0;}.pdoc > section:not(.module-info){margin-bottom:1.5rem;}.pdoc .modulename{margin-top:0;font-weight:bold;}.pdoc .modulename a{color:var(--link);transition:100ms all;}.pdoc .git-button{float:right;border:solid var(--link) 1px;}.pdoc .git-button:hover{background-color:var(--link);color:var(--pdoc-background);}.view-source-toggle-state,.view-source-toggle-state ~ .pdoc-code{display:none;}.view-source-toggle-state:checked ~ .pdoc-code{display:block;}.view-source-button{display:inline-block;float:right;font-size:.75rem;line-height:1.5rem;color:var(--muted);padding:0 .4rem 0 1.3rem;cursor:pointer;text-indent:-2px;}.view-source-button > span{visibility:hidden;}.module-info .view-source-button{float:none;display:flex;justify-content:flex-end;margin:-1.2rem .4rem -.2rem 0;}.view-source-button::before{position:absolute;content:"View Source";display:list-item;list-style-type:disclosure-closed;}.view-source-toggle-state:checked ~ .attr .view-source-button::before,.view-source-toggle-state:checked ~ .view-source-button::before{list-style-type:disclosure-open;}.pdoc .docstring{margin-bottom:1.5rem;}.pdoc section:not(.module-info) .docstring{margin-left:clamp(0rem, 5vw - 2rem, 1rem);}.pdoc .docstring .pdoc-code{margin-left:1em;margin-right:1em;}.pdoc h1:target,.pdoc h2:target,.pdoc h3:target,.pdoc h4:target,.pdoc h5:target,.pdoc h6:target,.pdoc .pdoc-code > pre > span:target{background-color:var(--active);box-shadow:-1rem 0 0 0 var(--active);}.pdoc .pdoc-code > pre > span:target{display:block;}.pdoc div:target > .attr,.pdoc section:target > .attr,.pdoc dd:target > a{background-color:var(--active);}.pdoc *{scroll-margin:2rem;}.pdoc .pdoc-code .linenos{user-select:none;}.pdoc .attr:hover{filter:contrast(0.95);}.pdoc section, .pdoc .classattr{position:relative;}.pdoc .headerlink{--width:clamp(1rem, 3vw, 2rem);position:absolute;top:0;left:calc(0rem - var(--width));transition:all 100ms ease-in-out;opacity:0;}.pdoc .headerlink::before{content:"#";display:block;text-align:center;width:var(--width);height:2.3rem;line-height:2.3rem;font-size:1.5rem;}.pdoc .attr:hover ~ .headerlink,.pdoc *:target > .headerlink,.pdoc .headerlink:hover{opacity:1;}.pdoc .attr{display:block;margin:.5rem 0 .5rem;padding:.4rem .4rem .4rem 1rem;background-color:var(--accent);overflow-x:auto;}.pdoc .classattr{margin-left:2rem;}.pdoc .decorator-deprecated{color:#842029;}.pdoc .decorator-deprecated ~ span{filter:grayscale(1) opacity(0.8);}.pdoc .name{color:var(--name);font-weight:bold;}.pdoc .def{color:var(--def);font-weight:bold;}.pdoc .signature{background-color:transparent;}.pdoc .param, .pdoc .return-annotation{white-space:pre;}.pdoc .signature.multiline .param{display:block;}.pdoc .signature.condensed .param{display:inline-block;}.pdoc .annotation{color:var(--annotation);}.pdoc .view-value-toggle-state,.pdoc .view-value-toggle-state ~ .default_value{display:none;}.pdoc .view-value-toggle-state:checked ~ .default_value{display:inherit;}.pdoc .view-value-button{font-size:.5rem;vertical-align:middle;border-style:dashed;margin-top:-0.1rem;}.pdoc .view-value-button:hover{background:white;}.pdoc .view-value-button::before{content:"show";text-align:center;width:2.2em;display:inline-block;}.pdoc .view-value-toggle-state:checked ~ .view-value-button::before{content:"hide";}.pdoc .inherited{margin-left:2rem;}.pdoc .inherited dt{font-weight:700;}.pdoc .inherited dt, .pdoc .inherited dd{display:inline;margin-left:0;margin-bottom:.5rem;}.pdoc .inherited dd:not(:last-child):after{content:", ";}.pdoc .inherited .class:before{content:"class ";}.pdoc .inherited .function a:after{content:"()";}.pdoc .search-result .docstring{overflow:auto;max-height:25vh;}.pdoc .search-result.focused > .attr{background-color:var(--active);}.pdoc .attribution{margin-top:2rem;display:block;opacity:0.5;transition:all 200ms;filter:grayscale(100%);}.pdoc .attribution:hover{opacity:1;filter:grayscale(0%);}.pdoc .attribution img{margin-left:5px;height:35px;vertical-align:middle;width:70px;transition:all 200ms;}.pdoc table{display:block;width:max-content;max-width:100%;overflow:auto;margin-bottom:1rem;}.pdoc table th{font-weight:600;}.pdoc table th, .pdoc table td{padding:6px 13px;border:1px solid var(--accent2);}</style>
    <style>/*! custom.css */</style></head>
<body>
    <nav class="pdoc">
        <label id="navtoggle" for="togglestate" class="pdoc-button"><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'><path stroke-linecap='round' stroke="currentColor" stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/></svg></label>
        <input id="togglestate" type="checkbox" aria-hidden="true" tabindex="-1">
        <div>


            <h2>Contents</h2>
            <ul>
  <li><a href="#quick-start">Quick Start</a></li>
  <li><a href="#key-features">Key Features</a></li>
  <li><a href="#supported-providers">Supported Providers</a></li>
  <li><a href="#configuration">Configuration</a></li>
</ul>



            <h2>API Documentation</h2>
                <ul class="memberlist">
            <li>
                    <a class="class" href="#Batch">Batch</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#Batch.__init__">Batch</a>
                        </li>
                        <li>
                                <a class="variable" href="#Batch.config">config</a>
                        </li>
                        <li>
                                <a class="variable" href="#Batch.jobs">jobs</a>
                        </li>
                        <li>
                                <a class="function" href="#Batch.set_default_params">set_default_params</a>
                        </li>
                        <li>
                                <a class="function" href="#Batch.set_state">set_state</a>
                        </li>
                        <li>
                                <a class="function" href="#Batch.add_cost_limit">add_cost_limit</a>
                        </li>
                        <li>
                                <a class="function" href="#Batch.raw_files">raw_files</a>
                        </li>
                        <li>
                                <a class="function" href="#Batch.set_verbosity">set_verbosity</a>
                        </li>
                        <li>
                                <a class="function" href="#Batch.add_time_limit">add_time_limit</a>
                        </li>
                        <li>
                                <a class="function" href="#Batch.add_job">add_job</a>
                        </li>
                        <li>
                                <a class="function" href="#Batch.run">run</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#BatchRun">BatchRun</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#BatchRun.__init__">BatchRun</a>
                        </li>
                        <li>
                                <a class="variable" href="#BatchRun.config">config</a>
                        </li>
                        <li>
                                <a class="variable" href="#BatchRun.jobs">jobs</a>
                        </li>
                        <li>
                                <a class="variable" href="#BatchRun.cost_tracker">cost_tracker</a>
                        </li>
                        <li>
                                <a class="variable" href="#BatchRun.state_manager">state_manager</a>
                        </li>
                        <li>
                                <a class="variable" href="#BatchRun.pending_jobs">pending_jobs</a>
                        </li>
                        <li>
                                <a class="variable" href="#BatchRun.completed_results">completed_results</a>
                        </li>
                        <li>
                                <a class="variable" href="#BatchRun.failed_jobs">failed_jobs</a>
                        </li>
                        <li>
                                <a class="variable" href="#BatchRun.cancelled_jobs">cancelled_jobs</a>
                        </li>
                        <li>
                                <a class="variable" href="#BatchRun.total_batches">total_batches</a>
                        </li>
                        <li>
                                <a class="variable" href="#BatchRun.completed_batches">completed_batches</a>
                        </li>
                        <li>
                                <a class="variable" href="#BatchRun.current_batch_index">current_batch_index</a>
                        </li>
                        <li>
                                <a class="variable" href="#BatchRun.current_batch_size">current_batch_size</a>
                        </li>
                        <li>
                                <a class="variable" href="#BatchRun.batch_tracking">batch_tracking</a>
                        </li>
                        <li>
                                <a class="variable" href="#BatchRun.results_dir">results_dir</a>
                        </li>
                        <li>
                                <a class="variable" href="#BatchRun.raw_files_dir">raw_files_dir</a>
                        </li>
                        <li>
                                <a class="function" href="#BatchRun.to_json">to_json</a>
                        </li>
                        <li>
                                <a class="function" href="#BatchRun.execute">execute</a>
                        </li>
                        <li>
                                <a class="function" href="#BatchRun.set_on_progress">set_on_progress</a>
                        </li>
                        <li>
                                <a class="variable" href="#BatchRun.is_complete">is_complete</a>
                        </li>
                        <li>
                                <a class="function" href="#BatchRun.status">status</a>
                        </li>
                        <li>
                                <a class="function" href="#BatchRun.results">results</a>
                        </li>
                        <li>
                                <a class="function" href="#BatchRun.get_failed_jobs">get_failed_jobs</a>
                        </li>
                        <li>
                                <a class="function" href="#BatchRun.shutdown">shutdown</a>
                        </li>
                        <li>
                                <a class="function" href="#BatchRun.dry_run">dry_run</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#Job">Job</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#Job.__init__">Job</a>
                        </li>
                        <li>
                                <a class="variable" href="#Job.id">id</a>
                        </li>
                        <li>
                                <a class="variable" href="#Job.model">model</a>
                        </li>
                        <li>
                                <a class="variable" href="#Job.messages">messages</a>
                        </li>
                        <li>
                                <a class="variable" href="#Job.file">file</a>
                        </li>
                        <li>
                                <a class="variable" href="#Job.prompt">prompt</a>
                        </li>
                        <li>
                                <a class="variable" href="#Job.temperature">temperature</a>
                        </li>
                        <li>
                                <a class="variable" href="#Job.max_tokens">max_tokens</a>
                        </li>
                        <li>
                                <a class="variable" href="#Job.response_model">response_model</a>
                        </li>
                        <li>
                                <a class="variable" href="#Job.enable_citations">enable_citations</a>
                        </li>
                        <li>
                                <a class="function" href="#Job.to_dict">to_dict</a>
                        </li>
                        <li>
                                <a class="function" href="#Job.from_dict">from_dict</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#JobResult">JobResult</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#JobResult.__init__">JobResult</a>
                        </li>
                        <li>
                                <a class="variable" href="#JobResult.job_id">job_id</a>
                        </li>
                        <li>
                                <a class="variable" href="#JobResult.raw_response">raw_response</a>
                        </li>
                        <li>
                                <a class="variable" href="#JobResult.parsed_response">parsed_response</a>
                        </li>
                        <li>
                                <a class="variable" href="#JobResult.citations">citations</a>
                        </li>
                        <li>
                                <a class="variable" href="#JobResult.citation_mappings">citation_mappings</a>
                        </li>
                        <li>
                                <a class="variable" href="#JobResult.input_tokens">input_tokens</a>
                        </li>
                        <li>
                                <a class="variable" href="#JobResult.output_tokens">output_tokens</a>
                        </li>
                        <li>
                                <a class="variable" href="#JobResult.cost_usd">cost_usd</a>
                        </li>
                        <li>
                                <a class="variable" href="#JobResult.error">error</a>
                        </li>
                        <li>
                                <a class="variable" href="#JobResult.batch_id">batch_id</a>
                        </li>
                        <li>
                                <a class="variable" href="#JobResult.is_success">is_success</a>
                        </li>
                        <li>
                                <a class="variable" href="#JobResult.total_tokens">total_tokens</a>
                        </li>
                        <li>
                                <a class="function" href="#JobResult.to_dict">to_dict</a>
                        </li>
                        <li>
                                <a class="function" href="#JobResult.from_dict">from_dict</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#Citation">Citation</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#Citation.__init__">Citation</a>
                        </li>
                        <li>
                                <a class="variable" href="#Citation.text">text</a>
                        </li>
                        <li>
                                <a class="variable" href="#Citation.source">source</a>
                        </li>
                        <li>
                                <a class="variable" href="#Citation.page">page</a>
                        </li>
                        <li>
                                <a class="variable" href="#Citation.metadata">metadata</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#BatchataError">BatchataError</a>
                            <ul class="memberlist">
                </ul>

            </li>
            <li>
                    <a class="class" href="#CostLimitExceededError">CostLimitExceededError</a>
                            <ul class="memberlist">
                </ul>

            </li>
            <li>
                    <a class="class" href="#ProviderError">ProviderError</a>
                            <ul class="memberlist">
                </ul>

            </li>
            <li>
                    <a class="class" href="#ProviderNotFoundError">ProviderNotFoundError</a>
                            <ul class="memberlist">
                </ul>

            </li>
            <li>
                    <a class="class" href="#ValidationError">ValidationError</a>
                            <ul class="memberlist">
                </ul>

            </li>
    </ul>



        <a class="attribution" title="pdoc: Python API documentation generator" href="https://pdoc.dev" target="_blank">
            built with <span class="visually-hidden">pdoc</span><img
                alt="pdoc logo"
                src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20role%3D%22img%22%20aria-label%3D%22pdoc%20logo%22%20width%3D%22300%22%20height%3D%22150%22%20viewBox%3D%22-1%200%2060%2030%22%3E%3Ctitle%3Epdoc%3C/title%3E%3Cpath%20d%3D%22M29.621%2021.293c-.011-.273-.214-.475-.511-.481a.5.5%200%200%200-.489.503l-.044%201.393c-.097.551-.695%201.215-1.566%201.704-.577.428-1.306.486-2.193.182-1.426-.617-2.467-1.654-3.304-2.487l-.173-.172a3.43%203.43%200%200%200-.365-.306.49.49%200%200%200-.286-.196c-1.718-1.06-4.931-1.47-7.353.191l-.219.15c-1.707%201.187-3.413%202.131-4.328%201.03-.02-.027-.49-.685-.141-1.763.233-.721.546-2.408.772-4.076.042-.09.067-.187.046-.288.166-1.347.277-2.625.241-3.351%201.378-1.008%202.271-2.586%202.271-4.362%200-.976-.272-1.935-.788-2.774-.057-.094-.122-.18-.184-.268.033-.167.052-.339.052-.516%200-1.477-1.202-2.679-2.679-2.679-.791%200-1.496.352-1.987.9a6.3%206.3%200%200%200-1.001.029c-.492-.564-1.207-.929-2.012-.929-1.477%200-2.679%201.202-2.679%202.679A2.65%202.65%200%200%200%20.97%206.554c-.383.747-.595%201.572-.595%202.41%200%202.311%201.507%204.29%203.635%205.107-.037.699-.147%202.27-.423%203.294l-.137.461c-.622%202.042-2.515%208.257%201.727%2010.643%201.614.908%203.06%201.248%204.317%201.248%202.665%200%204.492-1.524%205.322-2.401%201.476-1.559%202.886-1.854%206.491.82%201.877%201.393%203.514%201.753%204.861%201.068%202.223-1.713%202.811-3.867%203.399-6.374.077-.846.056-1.469.054-1.537zm-4.835%204.313c-.054.305-.156.586-.242.629-.034-.007-.131-.022-.307-.157-.145-.111-.314-.478-.456-.908.221.121.432.25.675.355.115.039.219.051.33.081zm-2.251-1.238c-.05.33-.158.648-.252.694-.022.001-.125-.018-.307-.157-.217-.166-.488-.906-.639-1.573.358.344.754.693%201.198%201.036zm-3.887-2.337c-.006-.116-.018-.231-.041-.342.635.145%201.189.368%201.599.625.097.231.166.481.174.642-.03.049-.055.101-.067.158-.046.013-.128.026-.298.004-.278-.037-.901-.57-1.367-1.087zm-1.127-.497c.116.306.176.625.12.71-.019.014-.117.045-.345.016-.206-.027-.604-.332-.986-.695.41-.051.816-.056%201.211-.031zm-4.535%201.535c.209.22.379.47.358.598-.006.041-.088.138-.351.234-.144.055-.539-.063-.979-.259a11.66%2011.66%200%200%200%20.972-.573zm.983-.664c.359-.237.738-.418%201.126-.554.25.237.479.548.457.694-.006.042-.087.138-.351.235-.174.064-.694-.105-1.232-.375zm-3.381%201.794c-.022.145-.061.29-.149.401-.133.166-.358.248-.69.251h-.002c-.133%200-.306-.26-.45-.621.417.091.854.07%201.291-.031zm-2.066-8.077a4.78%204.78%200%200%201-.775-.584c.172-.115.505-.254.88-.378l-.105.962zm-.331%202.302a10.32%2010.32%200%200%201-.828-.502c.202-.143.576-.328.984-.49l-.156.992zm-.45%202.157l-.701-.403c.214-.115.536-.249.891-.376a11.57%2011.57%200%200%201-.19.779zm-.181%201.716c.064.398.194.702.298.893-.194-.051-.435-.162-.736-.398.061-.119.224-.3.438-.495zM8.87%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zm-.735-.389a1.15%201.15%200%200%200-.314.783%201.16%201.16%200%200%200%201.162%201.162c.457%200%20.842-.27%201.032-.653.026.117.042.238.042.362a1.68%201.68%200%200%201-1.679%201.679%201.68%201.68%200%200%201-1.679-1.679c0-.843.626-1.535%201.436-1.654zM5.059%205.406A1.68%201.68%200%200%201%203.38%207.085a1.68%201.68%200%200%201-1.679-1.679c0-.037.009-.072.011-.109.21.3.541.508.935.508a1.16%201.16%200%200%200%201.162-1.162%201.14%201.14%200%200%200-.474-.912c.015%200%20.03-.005.045-.005.926.001%201.679.754%201.679%201.68zM3.198%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zM1.375%208.964c0-.52.103-1.035.288-1.52.466.394%201.06.64%201.717.64%201.144%200%202.116-.725%202.499-1.738.383%201.012%201.355%201.738%202.499%201.738.867%200%201.631-.421%202.121-1.062.307.605.478%201.267.478%201.942%200%202.486-2.153%204.51-4.801%204.51s-4.801-2.023-4.801-4.51zm24.342%2019.349c-.985.498-2.267.168-3.813-.979-3.073-2.281-5.453-3.199-7.813-.705-1.315%201.391-4.163%203.365-8.423.97-3.174-1.786-2.239-6.266-1.261-9.479l.146-.492c.276-1.02.395-2.457.444-3.268a6.11%206.11%200%200%200%201.18.115%206.01%206.01%200%200%200%202.536-.562l-.006.175c-.802.215-1.848.612-2.021%201.25-.079.295.021.601.274.837.219.203.415.364.598.501-.667.304-1.243.698-1.311%201.179-.02.144-.022.507.393.787.213.144.395.26.564.365-1.285.521-1.361.96-1.381%201.126-.018.142-.011.496.427.746l.854.489c-.473.389-.971.914-.999%201.429-.018.278.095.532.316.713.675.556%201.231.721%201.653.721.059%200%20.104-.014.158-.02.207.707.641%201.64%201.513%201.64h.013c.8-.008%201.236-.345%201.462-.626.173-.216.268-.457.325-.692.424.195.93.374%201.372.374.151%200%20.294-.021.423-.068.732-.27.944-.704.993-1.021.009-.061.003-.119.002-.179.266.086.538.147.789.147.15%200%20.294-.021.423-.069.542-.2.797-.489.914-.754.237.147.478.258.704.288.106.014.205.021.296.021.356%200%20.595-.101.767-.229.438.435%201.094.992%201.656%201.067.106.014.205.021.296.021a1.56%201.56%200%200%200%20.323-.035c.17.575.453%201.289.866%201.605.358.273.665.362.914.362a.99.99%200%200%200%20.421-.093%201.03%201.03%200%200%200%20.245-.164c.168.428.39.846.68%201.068.358.273.665.362.913.362a.99.99%200%200%200%20.421-.093c.317-.148.512-.448.639-.762.251.157.495.257.726.257.127%200%20.25-.024.37-.071.427-.17.706-.617.841-1.314.022-.015.047-.022.068-.038.067-.051.133-.104.196-.159-.443%201.486-1.107%202.761-2.086%203.257zM8.66%209.925a.5.5%200%201%200-1%200c0%20.653-.818%201.205-1.787%201.205s-1.787-.552-1.787-1.205a.5.5%200%201%200-1%200c0%201.216%201.25%202.205%202.787%202.205s2.787-.989%202.787-2.205zm4.4%2015.965l-.208.097c-2.661%201.258-4.708%201.436-6.086.527-1.542-1.017-1.88-3.19-1.844-4.198a.4.4%200%200%200-.385-.414c-.242-.029-.406.164-.414.385-.046%201.249.367%203.686%202.202%204.896.708.467%201.547.7%202.51.7%201.248%200%202.706-.392%204.362-1.174l.185-.086a.4.4%200%200%200%20.205-.527c-.089-.204-.326-.291-.527-.206zM9.547%202.292c.093.077.205.114.317.114a.5.5%200%200%200%20.318-.886L8.817.397a.5.5%200%200%200-.703.068.5.5%200%200%200%20.069.703l1.364%201.124zm-7.661-.065c.086%200%20.173-.022.253-.068l1.523-.893a.5.5%200%200%200-.506-.863l-1.523.892a.5.5%200%200%200-.179.685c.094.158.261.247.432.247z%22%20transform%3D%22matrix%28-1%200%200%201%2058%200%29%22%20fill%3D%22%233bb300%22/%3E%3Cpath%20d%3D%22M.3%2021.86V10.18q0-.46.02-.68.04-.22.18-.5.28-.54%201.34-.54%201.06%200%201.42.28.38.26.44.78.76-1.04%202.38-1.04%201.64%200%203.1%201.54%201.46%201.54%201.46%203.58%200%202.04-1.46%203.58-1.44%201.54-3.08%201.54-1.64%200-2.38-.92v4.04q0%20.46-.04.68-.02.22-.18.5-.14.3-.5.42-.36.12-.98.12-.62%200-1-.12-.36-.12-.52-.4-.14-.28-.18-.5-.02-.22-.02-.68zm3.96-9.42q-.46.54-.46%201.18%200%20.64.46%201.18.48.52%201.2.52.74%200%201.24-.52.52-.52.52-1.18%200-.66-.48-1.18-.48-.54-1.26-.54-.76%200-1.22.54zm14.741-8.36q.16-.3.54-.42.38-.12%201-.12.64%200%201.02.12.38.12.52.42.16.3.18.54.04.22.04.68v11.94q0%20.46-.04.7-.02.22-.18.5-.3.54-1.7.54-1.38%200-1.54-.98-.84.96-2.34.96-1.8%200-3.28-1.56-1.48-1.58-1.48-3.66%200-2.1%201.48-3.68%201.5-1.58%203.28-1.58%201.48%200%202.3%201v-4.2q0-.46.02-.68.04-.24.18-.52zm-3.24%2010.86q.52.54%201.26.54.74%200%201.22-.54.5-.54.5-1.18%200-.66-.48-1.22-.46-.56-1.26-.56-.8%200-1.28.56-.48.54-.48%201.2%200%20.66.52%201.2zm7.833-1.2q0-2.4%201.68-3.96%201.68-1.56%203.84-1.56%202.16%200%203.82%201.56%201.66%201.54%201.66%203.94%200%201.66-.86%202.96-.86%201.28-2.1%201.9-1.22.6-2.54.6-1.32%200-2.56-.64-1.24-.66-2.1-1.92-.84-1.28-.84-2.88zm4.18%201.44q.64.48%201.3.48.66%200%201.32-.5.66-.5.66-1.48%200-.98-.62-1.46-.62-.48-1.34-.48-.72%200-1.34.5-.62.5-.62%201.48%200%20.96.64%201.46zm11.412-1.44q0%20.84.56%201.32.56.46%201.18.46.64%200%201.18-.36.56-.38.9-.38.6%200%201.46%201.06.46.58.46%201.04%200%20.76-1.1%201.42-1.14.8-2.8.8-1.86%200-3.58-1.34-.82-.64-1.34-1.7-.52-1.08-.52-2.36%200-1.3.52-2.34.52-1.06%201.34-1.7%201.66-1.32%203.54-1.32.76%200%201.48.22.72.2%201.06.4l.32.2q.36.24.56.38.52.4.52.92%200%20.5-.42%201.14-.72%201.1-1.38%201.1-.38%200-1.08-.44-.36-.34-1.04-.34-.66%200-1.24.48-.58.48-.58%201.34z%22%20fill%3D%22green%22/%3E%3C/svg%3E"/>
        </a>
</div>
    </nav>
    <main class="pdoc">
            <section class="module-info">
                    <h1 class="modulename">
batchata    </h1>

                        <div class="docstring"><p>Batchata - Unified Python API for AI Batch requests with cost tracking, Pydantic responses, and parallel execution.</p>

<p><strong>Why AI-batching?</strong></p>

<p>AI providers offer batch APIs that process requests asynchronously at 50% reduced cost compared to real-time APIs. 
This is ideal for workloads like document processing, data analysis, and content generation where immediate 
responses aren't required.</p>

<h2 id="quick-start">Quick Start</h2>

<h3 id="installation">Installation</h3>

<div class="pdoc-code codehilite">
<pre><span></span><code>pip<span class="w"> </span>install<span class="w"> </span>batchata
</code></pre>
</div>

<h3 id="basic-usage">Basic Usage</h3>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">batchata</span><span class="w"> </span><span class="kn">import</span> <span class="n">Batch</span>

<span class="c1"># Simple batch processing</span>
<span class="n">batch</span> <span class="o">=</span> <span class="n">Batch</span><span class="p">(</span><span class="n">results_dir</span><span class="o">=</span><span class="s2">&quot;./output&quot;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">set_default_params</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="s2">&quot;claude-sonnet-4-20250514&quot;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">add_cost_limit</span><span class="p">(</span><span class="n">usd</span><span class="o">=</span><span class="mf">5.0</span><span class="p">)</span>

<span class="c1"># Add jobs</span>
<span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
    <span class="n">batch</span><span class="o">.</span><span class="n">add_job</span><span class="p">(</span><span class="n">file</span><span class="o">=</span><span class="n">file</span><span class="p">,</span> <span class="n">prompt</span><span class="o">=</span><span class="s2">&quot;Summarize this document&quot;</span><span class="p">)</span>

<span class="c1"># Execute</span>
<span class="n">run</span> <span class="o">=</span> <span class="n">batch</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
<span class="n">results</span> <span class="o">=</span> <span class="n">run</span><span class="o">.</span><span class="n">results</span><span class="p">()</span>
</code></pre>
</div>

<h3 id="structured-output-with-pydantic">Structured Output with Pydantic</h3>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">batchata</span><span class="w"> </span><span class="kn">import</span> <span class="n">Batch</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span>

<span class="k">class</span><span class="w"> </span><span class="nc">DocumentAnalysis</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">title</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">summary</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">key_points</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>

<span class="n">batch</span> <span class="o">=</span> <span class="n">Batch</span><span class="p">(</span><span class="n">results_dir</span><span class="o">=</span><span class="s2">&quot;./results&quot;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">set_default_params</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="s2">&quot;claude-sonnet-4-20250514&quot;</span><span class="p">)</span>

<span class="n">batch</span><span class="o">.</span><span class="n">add_job</span><span class="p">(</span>
    <span class="n">file</span><span class="o">=</span><span class="s2">&quot;document.pdf&quot;</span><span class="p">,</span>
    <span class="n">prompt</span><span class="o">=</span><span class="s2">&quot;Analyze this document&quot;</span><span class="p">,</span>
    <span class="n">response_model</span><span class="o">=</span><span class="n">DocumentAnalysis</span><span class="p">,</span>
    <span class="n">enable_citations</span><span class="o">=</span><span class="kc">True</span>  <span class="c1"># Anthropic only</span>
<span class="p">)</span>

<span class="n">run</span> <span class="o">=</span> <span class="n">batch</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
<span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">run</span><span class="o">.</span><span class="n">results</span><span class="p">()[</span><span class="s2">&quot;completed&quot;</span><span class="p">]:</span>
    <span class="n">analysis</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">parsed_response</span>  <span class="c1"># DocumentAnalysis object</span>
    <span class="n">citations</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">citation_mappings</span>  <span class="c1"># Field -&gt; Citation mapping</span>
</code></pre>
</div>

<h2 id="key-features">Key Features</h2>

<ul>
<li><strong>50% Cost Savings</strong>: Native batch processing via provider APIs</li>
<li><strong>Cost Limits</strong>: Set <code>max_cost_usd</code> limits for batch requests  </li>
<li><strong>Time Limits</strong>: Control execution time with <code>.add_time_limit()</code></li>
<li><strong>State Persistence</strong>: Resume interrupted batches automatically</li>
<li><strong>Structured Output</strong>: Pydantic models with automatic validation</li>
<li><strong>Citations</strong>: Extract and map citations to response fields (Anthropic)</li>
<li><strong>Multiple Providers</strong>: Anthropic Claude and OpenAI GPT models</li>
</ul>

<h2 id="supported-providers">Supported Providers</h2>

<table>
<thead>
<tr>
  <th>Feature</th>
  <th>Anthropic</th>
  <th>OpenAI</th>
</tr>
</thead>
<tbody>
<tr>
  <td>Models</td>
  <td><a href="https://github.com/agamm/batchata/blob/main/batchata/providers/anthropic/models.py">All Claude models</a></td>
  <td><a href="https://github.com/agamm/batchata/blob/main/batchata/providers/openai/models.py">All GPT models</a></td>
</tr>
<tr>
  <td>Citations</td>
  <td>✅</td>
  <td>❌</td>
</tr>
<tr>
  <td>Structured Output</td>
  <td>✅</td>
  <td>✅</td>
</tr>
<tr>
  <td>File Types</td>
  <td>PDF, TXT, DOCX, Images</td>
  <td>PDF, Images</td>
</tr>
</tbody>
</table>

<h2 id="configuration">Configuration</h2>

<p>Set API keys as environment variables:</p>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="nb">export</span><span class="w"> </span><span class="nv">ANTHROPIC_API_KEY</span><span class="o">=</span><span class="s2">&quot;your-key&quot;</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">OPENAI_API_KEY</span><span class="o">=</span><span class="s2">&quot;your-key&quot;</span>
</code></pre>
</div>

<p>Or use a <code>.env</code> file with python-dotenv.</p>
</div>

                        <input id="mod-batchata-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">

                        <label class="view-source-button" for="mod-batchata-view-source"><span>View Source</span></label>

                        <div class="pdoc-code codehilite"><pre><span></span><span id="L-1"><a href="#L-1"><span class="linenos">  1</span></a><span class="sd">&quot;&quot;&quot;Batchata - Unified Python API for AI Batch requests with cost tracking, Pydantic responses, and parallel execution.</span>
</span><span id="L-2"><a href="#L-2"><span class="linenos">  2</span></a>
</span><span id="L-3"><a href="#L-3"><span class="linenos">  3</span></a><span class="sd">**Why AI-batching?**</span>
</span><span id="L-4"><a href="#L-4"><span class="linenos">  4</span></a>
</span><span id="L-5"><a href="#L-5"><span class="linenos">  5</span></a><span class="sd">AI providers offer batch APIs that process requests asynchronously at 50% reduced cost compared to real-time APIs. </span>
</span><span id="L-6"><a href="#L-6"><span class="linenos">  6</span></a><span class="sd">This is ideal for workloads like document processing, data analysis, and content generation where immediate </span>
</span><span id="L-7"><a href="#L-7"><span class="linenos">  7</span></a><span class="sd">responses aren&#39;t required.</span>
</span><span id="L-8"><a href="#L-8"><span class="linenos">  8</span></a>
</span><span id="L-9"><a href="#L-9"><span class="linenos">  9</span></a><span class="sd">## Quick Start</span>
</span><span id="L-10"><a href="#L-10"><span class="linenos"> 10</span></a>
</span><span id="L-11"><a href="#L-11"><span class="linenos"> 11</span></a><span class="sd">### Installation</span>
</span><span id="L-12"><a href="#L-12"><span class="linenos"> 12</span></a>
</span><span id="L-13"><a href="#L-13"><span class="linenos"> 13</span></a><span class="sd">```bash</span>
</span><span id="L-14"><a href="#L-14"><span class="linenos"> 14</span></a><span class="sd">pip install batchata</span>
</span><span id="L-15"><a href="#L-15"><span class="linenos"> 15</span></a><span class="sd">```</span>
</span><span id="L-16"><a href="#L-16"><span class="linenos"> 16</span></a>
</span><span id="L-17"><a href="#L-17"><span class="linenos"> 17</span></a><span class="sd">### Basic Usage</span>
</span><span id="L-18"><a href="#L-18"><span class="linenos"> 18</span></a>
</span><span id="L-19"><a href="#L-19"><span class="linenos"> 19</span></a><span class="sd">```python</span>
</span><span id="L-20"><a href="#L-20"><span class="linenos"> 20</span></a><span class="sd">from batchata import Batch</span>
</span><span id="L-21"><a href="#L-21"><span class="linenos"> 21</span></a>
</span><span id="L-22"><a href="#L-22"><span class="linenos"> 22</span></a><span class="sd"># Simple batch processing</span>
</span><span id="L-23"><a href="#L-23"><span class="linenos"> 23</span></a><span class="sd">batch = Batch(results_dir=&quot;./output&quot;)</span>
</span><span id="L-24"><a href="#L-24"><span class="linenos"> 24</span></a><span class="sd">    .set_default_params(model=&quot;claude-sonnet-4-20250514&quot;)</span>
</span><span id="L-25"><a href="#L-25"><span class="linenos"> 25</span></a><span class="sd">    .add_cost_limit(usd=5.0)</span>
</span><span id="L-26"><a href="#L-26"><span class="linenos"> 26</span></a>
</span><span id="L-27"><a href="#L-27"><span class="linenos"> 27</span></a><span class="sd"># Add jobs</span>
</span><span id="L-28"><a href="#L-28"><span class="linenos"> 28</span></a><span class="sd">for file in files:</span>
</span><span id="L-29"><a href="#L-29"><span class="linenos"> 29</span></a><span class="sd">    batch.add_job(file=file, prompt=&quot;Summarize this document&quot;)</span>
</span><span id="L-30"><a href="#L-30"><span class="linenos"> 30</span></a>
</span><span id="L-31"><a href="#L-31"><span class="linenos"> 31</span></a><span class="sd"># Execute</span>
</span><span id="L-32"><a href="#L-32"><span class="linenos"> 32</span></a><span class="sd">run = batch.run()</span>
</span><span id="L-33"><a href="#L-33"><span class="linenos"> 33</span></a><span class="sd">results = run.results()</span>
</span><span id="L-34"><a href="#L-34"><span class="linenos"> 34</span></a><span class="sd">```</span>
</span><span id="L-35"><a href="#L-35"><span class="linenos"> 35</span></a>
</span><span id="L-36"><a href="#L-36"><span class="linenos"> 36</span></a><span class="sd">### Structured Output with Pydantic</span>
</span><span id="L-37"><a href="#L-37"><span class="linenos"> 37</span></a>
</span><span id="L-38"><a href="#L-38"><span class="linenos"> 38</span></a><span class="sd">```python</span>
</span><span id="L-39"><a href="#L-39"><span class="linenos"> 39</span></a><span class="sd">from batchata import Batch</span>
</span><span id="L-40"><a href="#L-40"><span class="linenos"> 40</span></a><span class="sd">from pydantic import BaseModel</span>
</span><span id="L-41"><a href="#L-41"><span class="linenos"> 41</span></a>
</span><span id="L-42"><a href="#L-42"><span class="linenos"> 42</span></a><span class="sd">class DocumentAnalysis(BaseModel):</span>
</span><span id="L-43"><a href="#L-43"><span class="linenos"> 43</span></a><span class="sd">    title: str</span>
</span><span id="L-44"><a href="#L-44"><span class="linenos"> 44</span></a><span class="sd">    summary: str</span>
</span><span id="L-45"><a href="#L-45"><span class="linenos"> 45</span></a><span class="sd">    key_points: list[str]</span>
</span><span id="L-46"><a href="#L-46"><span class="linenos"> 46</span></a>
</span><span id="L-47"><a href="#L-47"><span class="linenos"> 47</span></a><span class="sd">batch = Batch(results_dir=&quot;./results&quot;)</span>
</span><span id="L-48"><a href="#L-48"><span class="linenos"> 48</span></a><span class="sd">    .set_default_params(model=&quot;claude-sonnet-4-20250514&quot;)</span>
</span><span id="L-49"><a href="#L-49"><span class="linenos"> 49</span></a>
</span><span id="L-50"><a href="#L-50"><span class="linenos"> 50</span></a><span class="sd">batch.add_job(</span>
</span><span id="L-51"><a href="#L-51"><span class="linenos"> 51</span></a><span class="sd">    file=&quot;document.pdf&quot;,</span>
</span><span id="L-52"><a href="#L-52"><span class="linenos"> 52</span></a><span class="sd">    prompt=&quot;Analyze this document&quot;,</span>
</span><span id="L-53"><a href="#L-53"><span class="linenos"> 53</span></a><span class="sd">    response_model=DocumentAnalysis,</span>
</span><span id="L-54"><a href="#L-54"><span class="linenos"> 54</span></a><span class="sd">    enable_citations=True  # Anthropic only</span>
</span><span id="L-55"><a href="#L-55"><span class="linenos"> 55</span></a><span class="sd">)</span>
</span><span id="L-56"><a href="#L-56"><span class="linenos"> 56</span></a>
</span><span id="L-57"><a href="#L-57"><span class="linenos"> 57</span></a><span class="sd">run = batch.run()</span>
</span><span id="L-58"><a href="#L-58"><span class="linenos"> 58</span></a><span class="sd">for result in run.results()[&quot;completed&quot;]:</span>
</span><span id="L-59"><a href="#L-59"><span class="linenos"> 59</span></a><span class="sd">    analysis = result.parsed_response  # DocumentAnalysis object</span>
</span><span id="L-60"><a href="#L-60"><span class="linenos"> 60</span></a><span class="sd">    citations = result.citation_mappings  # Field -&gt; Citation mapping</span>
</span><span id="L-61"><a href="#L-61"><span class="linenos"> 61</span></a><span class="sd">```</span>
</span><span id="L-62"><a href="#L-62"><span class="linenos"> 62</span></a>
</span><span id="L-63"><a href="#L-63"><span class="linenos"> 63</span></a><span class="sd">## Key Features</span>
</span><span id="L-64"><a href="#L-64"><span class="linenos"> 64</span></a>
</span><span id="L-65"><a href="#L-65"><span class="linenos"> 65</span></a><span class="sd">- **50% Cost Savings**: Native batch processing via provider APIs</span>
</span><span id="L-66"><a href="#L-66"><span class="linenos"> 66</span></a><span class="sd">- **Cost Limits**: Set `max_cost_usd` limits for batch requests  </span>
</span><span id="L-67"><a href="#L-67"><span class="linenos"> 67</span></a><span class="sd">- **Time Limits**: Control execution time with `.add_time_limit()`</span>
</span><span id="L-68"><a href="#L-68"><span class="linenos"> 68</span></a><span class="sd">- **State Persistence**: Resume interrupted batches automatically</span>
</span><span id="L-69"><a href="#L-69"><span class="linenos"> 69</span></a><span class="sd">- **Structured Output**: Pydantic models with automatic validation</span>
</span><span id="L-70"><a href="#L-70"><span class="linenos"> 70</span></a><span class="sd">- **Citations**: Extract and map citations to response fields (Anthropic)</span>
</span><span id="L-71"><a href="#L-71"><span class="linenos"> 71</span></a><span class="sd">- **Multiple Providers**: Anthropic Claude and OpenAI GPT models</span>
</span><span id="L-72"><a href="#L-72"><span class="linenos"> 72</span></a>
</span><span id="L-73"><a href="#L-73"><span class="linenos"> 73</span></a><span class="sd">## Supported Providers</span>
</span><span id="L-74"><a href="#L-74"><span class="linenos"> 74</span></a>
</span><span id="L-75"><a href="#L-75"><span class="linenos"> 75</span></a><span class="sd">| Feature | Anthropic | OpenAI |</span>
</span><span id="L-76"><a href="#L-76"><span class="linenos"> 76</span></a><span class="sd">|---------|-----------|--------|</span>
</span><span id="L-77"><a href="#L-77"><span class="linenos"> 77</span></a><span class="sd">| Models | [All Claude models](https://github.com/agamm/batchata/blob/main/batchata/providers/anthropic/models.py) | [All GPT models](https://github.com/agamm/batchata/blob/main/batchata/providers/openai/models.py) |</span>
</span><span id="L-78"><a href="#L-78"><span class="linenos"> 78</span></a><span class="sd">| Citations | ✅ | ❌ |</span>
</span><span id="L-79"><a href="#L-79"><span class="linenos"> 79</span></a><span class="sd">| Structured Output | ✅ | ✅ |</span>
</span><span id="L-80"><a href="#L-80"><span class="linenos"> 80</span></a><span class="sd">| File Types | PDF, TXT, DOCX, Images | PDF, Images |</span>
</span><span id="L-81"><a href="#L-81"><span class="linenos"> 81</span></a>
</span><span id="L-82"><a href="#L-82"><span class="linenos"> 82</span></a><span class="sd">## Configuration</span>
</span><span id="L-83"><a href="#L-83"><span class="linenos"> 83</span></a>
</span><span id="L-84"><a href="#L-84"><span class="linenos"> 84</span></a><span class="sd">Set API keys as environment variables:</span>
</span><span id="L-85"><a href="#L-85"><span class="linenos"> 85</span></a>
</span><span id="L-86"><a href="#L-86"><span class="linenos"> 86</span></a><span class="sd">```bash</span>
</span><span id="L-87"><a href="#L-87"><span class="linenos"> 87</span></a><span class="sd">export ANTHROPIC_API_KEY=&quot;your-key&quot;</span>
</span><span id="L-88"><a href="#L-88"><span class="linenos"> 88</span></a><span class="sd">export OPENAI_API_KEY=&quot;your-key&quot;</span>
</span><span id="L-89"><a href="#L-89"><span class="linenos"> 89</span></a><span class="sd">```</span>
</span><span id="L-90"><a href="#L-90"><span class="linenos"> 90</span></a>
</span><span id="L-91"><a href="#L-91"><span class="linenos"> 91</span></a><span class="sd">Or use a `.env` file with python-dotenv.</span>
</span><span id="L-92"><a href="#L-92"><span class="linenos"> 92</span></a><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-93"><a href="#L-93"><span class="linenos"> 93</span></a>
</span><span id="L-94"><a href="#L-94"><span class="linenos"> 94</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">.core</span><span class="w"> </span><span class="kn">import</span> <span class="n">Batch</span><span class="p">,</span> <span class="n">BatchRun</span><span class="p">,</span> <span class="n">Job</span><span class="p">,</span> <span class="n">JobResult</span>
</span><span id="L-95"><a href="#L-95"><span class="linenos"> 95</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">.exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
</span><span id="L-96"><a href="#L-96"><span class="linenos"> 96</span></a>    <span class="n">BatchataError</span><span class="p">,</span>
</span><span id="L-97"><a href="#L-97"><span class="linenos"> 97</span></a>    <span class="n">CostLimitExceededError</span><span class="p">,</span>
</span><span id="L-98"><a href="#L-98"><span class="linenos"> 98</span></a>    <span class="n">ProviderError</span><span class="p">,</span>
</span><span id="L-99"><a href="#L-99"><span class="linenos"> 99</span></a>    <span class="n">ProviderNotFoundError</span><span class="p">,</span>
</span><span id="L-100"><a href="#L-100"><span class="linenos">100</span></a>    <span class="n">ValidationError</span><span class="p">,</span>
</span><span id="L-101"><a href="#L-101"><span class="linenos">101</span></a><span class="p">)</span>
</span><span id="L-102"><a href="#L-102"><span class="linenos">102</span></a><span class="kn">from</span><span class="w"> </span><span class="nn">.types</span><span class="w"> </span><span class="kn">import</span> <span class="n">Citation</span>
</span><span id="L-103"><a href="#L-103"><span class="linenos">103</span></a>
</span><span id="L-104"><a href="#L-104"><span class="linenos">104</span></a><span class="n">__version__</span> <span class="o">=</span> <span class="s2">&quot;0.3.0&quot;</span>
</span><span id="L-105"><a href="#L-105"><span class="linenos">105</span></a>
</span><span id="L-106"><a href="#L-106"><span class="linenos">106</span></a><span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="L-107"><a href="#L-107"><span class="linenos">107</span></a>    <span class="s2">&quot;Batch&quot;</span><span class="p">,</span>
</span><span id="L-108"><a href="#L-108"><span class="linenos">108</span></a>    <span class="s2">&quot;BatchRun&quot;</span><span class="p">,</span> 
</span><span id="L-109"><a href="#L-109"><span class="linenos">109</span></a>    <span class="s2">&quot;Job&quot;</span><span class="p">,</span>
</span><span id="L-110"><a href="#L-110"><span class="linenos">110</span></a>    <span class="s2">&quot;JobResult&quot;</span><span class="p">,</span>
</span><span id="L-111"><a href="#L-111"><span class="linenos">111</span></a>    <span class="s2">&quot;Citation&quot;</span><span class="p">,</span>
</span><span id="L-112"><a href="#L-112"><span class="linenos">112</span></a>    <span class="s2">&quot;BatchataError&quot;</span><span class="p">,</span>
</span><span id="L-113"><a href="#L-113"><span class="linenos">113</span></a>    <span class="s2">&quot;CostLimitExceededError&quot;</span><span class="p">,</span>
</span><span id="L-114"><a href="#L-114"><span class="linenos">114</span></a>    <span class="s2">&quot;ProviderError&quot;</span><span class="p">,</span>
</span><span id="L-115"><a href="#L-115"><span class="linenos">115</span></a>    <span class="s2">&quot;ProviderNotFoundError&quot;</span><span class="p">,</span>
</span><span id="L-116"><a href="#L-116"><span class="linenos">116</span></a>    <span class="s2">&quot;ValidationError&quot;</span><span class="p">,</span>
</span><span id="L-117"><a href="#L-117"><span class="linenos">117</span></a><span class="p">]</span>
</span></pre></div>


            </section>
                <section id="Batch">
                            <input id="Batch-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">Batch</span>:

                <label class="view-source-button" for="Batch-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Batch"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Batch-19"><a href="#Batch-19"><span class="linenos"> 19</span></a><span class="k">class</span><span class="w"> </span><span class="nc">Batch</span><span class="p">:</span>
</span><span id="Batch-20"><a href="#Batch-20"><span class="linenos"> 20</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Builder for batch job configuration.</span>
</span><span id="Batch-21"><a href="#Batch-21"><span class="linenos"> 21</span></a><span class="sd">    </span>
</span><span id="Batch-22"><a href="#Batch-22"><span class="linenos"> 22</span></a><span class="sd">    Provides a fluent interface for configuring batch jobs with sensible defaults</span>
</span><span id="Batch-23"><a href="#Batch-23"><span class="linenos"> 23</span></a><span class="sd">    and validation. The batch can be configured with cost limits, default parameters,</span>
</span><span id="Batch-24"><a href="#Batch-24"><span class="linenos"> 24</span></a><span class="sd">    and progress callbacks.</span>
</span><span id="Batch-25"><a href="#Batch-25"><span class="linenos"> 25</span></a><span class="sd">    </span>
</span><span id="Batch-26"><a href="#Batch-26"><span class="linenos"> 26</span></a><span class="sd">    Example:</span>
</span><span id="Batch-27"><a href="#Batch-27"><span class="linenos"> 27</span></a><span class="sd">        ```python</span>
</span><span id="Batch-28"><a href="#Batch-28"><span class="linenos"> 28</span></a><span class="sd">        batch = Batch(&quot;./results&quot;, max_parallel_batches=10, items_per_batch=10)</span>
</span><span id="Batch-29"><a href="#Batch-29"><span class="linenos"> 29</span></a><span class="sd">            .set_state(file=&quot;./state.json&quot;, reuse_state=True)</span>
</span><span id="Batch-30"><a href="#Batch-30"><span class="linenos"> 30</span></a><span class="sd">            .set_default_params(model=&quot;claude-sonnet-4-20250514&quot;, temperature=0.7)</span>
</span><span id="Batch-31"><a href="#Batch-31"><span class="linenos"> 31</span></a><span class="sd">            .add_cost_limit(usd=15.0)</span>
</span><span id="Batch-32"><a href="#Batch-32"><span class="linenos"> 32</span></a><span class="sd">            .add_job(messages=[{&quot;role&quot;: &quot;user&quot;, &quot;content&quot;: &quot;Hello&quot;}])</span>
</span><span id="Batch-33"><a href="#Batch-33"><span class="linenos"> 33</span></a><span class="sd">            .add_job(file=&quot;./path/to/file.pdf&quot;, prompt=&quot;Generate summary of file&quot;)</span>
</span><span id="Batch-34"><a href="#Batch-34"><span class="linenos"> 34</span></a><span class="sd">        </span>
</span><span id="Batch-35"><a href="#Batch-35"><span class="linenos"> 35</span></a><span class="sd">        run = batch.run()</span>
</span><span id="Batch-36"><a href="#Batch-36"><span class="linenos"> 36</span></a><span class="sd">        ```</span>
</span><span id="Batch-37"><a href="#Batch-37"><span class="linenos"> 37</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="Batch-38"><a href="#Batch-38"><span class="linenos"> 38</span></a>    
</span><span id="Batch-39"><a href="#Batch-39"><span class="linenos"> 39</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">results_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">max_parallel_batches</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">items_per_batch</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">raw_files</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="Batch-40"><a href="#Batch-40"><span class="linenos"> 40</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize batch configuration.</span>
</span><span id="Batch-41"><a href="#Batch-41"><span class="linenos"> 41</span></a><span class="sd">        </span>
</span><span id="Batch-42"><a href="#Batch-42"><span class="linenos"> 42</span></a><span class="sd">        Args:</span>
</span><span id="Batch-43"><a href="#Batch-43"><span class="linenos"> 43</span></a><span class="sd">            results_dir: Directory to store results</span>
</span><span id="Batch-44"><a href="#Batch-44"><span class="linenos"> 44</span></a><span class="sd">            max_parallel_batches: Maximum parallel batch requests</span>
</span><span id="Batch-45"><a href="#Batch-45"><span class="linenos"> 45</span></a><span class="sd">            items_per_batch: Number of jobs per provider batch</span>
</span><span id="Batch-46"><a href="#Batch-46"><span class="linenos"> 46</span></a><span class="sd">            raw_files: Whether to save debug files (raw responses, JSONL files) from providers (default: True if results_dir is set, False otherwise)</span>
</span><span id="Batch-47"><a href="#Batch-47"><span class="linenos"> 47</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Batch-48"><a href="#Batch-48"><span class="linenos"> 48</span></a>        <span class="c1"># Auto-determine raw_files based on results_dir if not explicitly set</span>
</span><span id="Batch-49"><a href="#Batch-49"><span class="linenos"> 49</span></a>        <span class="k">if</span> <span class="n">raw_files</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Batch-50"><a href="#Batch-50"><span class="linenos"> 50</span></a>            <span class="n">raw_files</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">results_dir</span> <span class="ow">and</span> <span class="n">results_dir</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
</span><span id="Batch-51"><a href="#Batch-51"><span class="linenos"> 51</span></a>        
</span><span id="Batch-52"><a href="#Batch-52"><span class="linenos"> 52</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">BatchParams</span><span class="p">(</span>
</span><span id="Batch-53"><a href="#Batch-53"><span class="linenos"> 53</span></a>            <span class="n">state_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="Batch-54"><a href="#Batch-54"><span class="linenos"> 54</span></a>            <span class="n">results_dir</span><span class="o">=</span><span class="n">results_dir</span><span class="p">,</span>
</span><span id="Batch-55"><a href="#Batch-55"><span class="linenos"> 55</span></a>            <span class="n">max_parallel_batches</span><span class="o">=</span><span class="n">max_parallel_batches</span><span class="p">,</span>
</span><span id="Batch-56"><a href="#Batch-56"><span class="linenos"> 56</span></a>            <span class="n">items_per_batch</span><span class="o">=</span><span class="n">items_per_batch</span><span class="p">,</span>
</span><span id="Batch-57"><a href="#Batch-57"><span class="linenos"> 57</span></a>            <span class="n">reuse_state</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="Batch-58"><a href="#Batch-58"><span class="linenos"> 58</span></a>            <span class="n">raw_files</span><span class="o">=</span><span class="n">raw_files</span>
</span><span id="Batch-59"><a href="#Batch-59"><span class="linenos"> 59</span></a>        <span class="p">)</span>
</span><span id="Batch-60"><a href="#Batch-60"><span class="linenos"> 60</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">jobs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Job</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="Batch-61"><a href="#Batch-61"><span class="linenos"> 61</span></a>    
</span><span id="Batch-62"><a href="#Batch-62"><span class="linenos"> 62</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">set_default_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;Batch&#39;</span><span class="p">:</span>
</span><span id="Batch-63"><a href="#Batch-63"><span class="linenos"> 63</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Set default parameters for all jobs.</span>
</span><span id="Batch-64"><a href="#Batch-64"><span class="linenos"> 64</span></a><span class="sd">        </span>
</span><span id="Batch-65"><a href="#Batch-65"><span class="linenos"> 65</span></a><span class="sd">        These defaults will be applied to all jobs unless overridden</span>
</span><span id="Batch-66"><a href="#Batch-66"><span class="linenos"> 66</span></a><span class="sd">        by job-specific parameters.</span>
</span><span id="Batch-67"><a href="#Batch-67"><span class="linenos"> 67</span></a><span class="sd">        </span>
</span><span id="Batch-68"><a href="#Batch-68"><span class="linenos"> 68</span></a><span class="sd">        Args:</span>
</span><span id="Batch-69"><a href="#Batch-69"><span class="linenos"> 69</span></a><span class="sd">            **kwargs: Default parameters (model, temperature, max_tokens, etc.)</span>
</span><span id="Batch-70"><a href="#Batch-70"><span class="linenos"> 70</span></a><span class="sd">            </span>
</span><span id="Batch-71"><a href="#Batch-71"><span class="linenos"> 71</span></a><span class="sd">        Returns:</span>
</span><span id="Batch-72"><a href="#Batch-72"><span class="linenos"> 72</span></a><span class="sd">            Self for chaining</span>
</span><span id="Batch-73"><a href="#Batch-73"><span class="linenos"> 73</span></a><span class="sd">            </span>
</span><span id="Batch-74"><a href="#Batch-74"><span class="linenos"> 74</span></a><span class="sd">        Example:</span>
</span><span id="Batch-75"><a href="#Batch-75"><span class="linenos"> 75</span></a><span class="sd">            ```python</span>
</span><span id="Batch-76"><a href="#Batch-76"><span class="linenos"> 76</span></a><span class="sd">            batch.set_default_params(model=&quot;claude-3-sonnet&quot;, temperature=0.7)</span>
</span><span id="Batch-77"><a href="#Batch-77"><span class="linenos"> 77</span></a><span class="sd">            ```</span>
</span><span id="Batch-78"><a href="#Batch-78"><span class="linenos"> 78</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Batch-79"><a href="#Batch-79"><span class="linenos"> 79</span></a>        <span class="c1"># Validate if model is provided</span>
</span><span id="Batch-80"><a href="#Batch-80"><span class="linenos"> 80</span></a>        <span class="k">if</span> <span class="s2">&quot;model&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
</span><span id="Batch-81"><a href="#Batch-81"><span class="linenos"> 81</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">validate_default_params</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;model&quot;</span><span class="p">])</span>
</span><span id="Batch-82"><a href="#Batch-82"><span class="linenos"> 82</span></a>        
</span><span id="Batch-83"><a href="#Batch-83"><span class="linenos"> 83</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">default_params</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="Batch-84"><a href="#Batch-84"><span class="linenos"> 84</span></a>        <span class="k">return</span> <span class="bp">self</span>
</span><span id="Batch-85"><a href="#Batch-85"><span class="linenos"> 85</span></a>    
</span><span id="Batch-86"><a href="#Batch-86"><span class="linenos"> 86</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">set_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">reuse_state</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;Batch&#39;</span><span class="p">:</span>
</span><span id="Batch-87"><a href="#Batch-87"><span class="linenos"> 87</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Set state file configuration.</span>
</span><span id="Batch-88"><a href="#Batch-88"><span class="linenos"> 88</span></a><span class="sd">        </span>
</span><span id="Batch-89"><a href="#Batch-89"><span class="linenos"> 89</span></a><span class="sd">        Args:</span>
</span><span id="Batch-90"><a href="#Batch-90"><span class="linenos"> 90</span></a><span class="sd">            file: Path to state file for persistence (default: None)</span>
</span><span id="Batch-91"><a href="#Batch-91"><span class="linenos"> 91</span></a><span class="sd">            reuse_state: Whether to resume from existing state file (default: True)</span>
</span><span id="Batch-92"><a href="#Batch-92"><span class="linenos"> 92</span></a><span class="sd">            </span>
</span><span id="Batch-93"><a href="#Batch-93"><span class="linenos"> 93</span></a><span class="sd">        Returns:</span>
</span><span id="Batch-94"><a href="#Batch-94"><span class="linenos"> 94</span></a><span class="sd">            Self for chaining</span>
</span><span id="Batch-95"><a href="#Batch-95"><span class="linenos"> 95</span></a><span class="sd">            </span>
</span><span id="Batch-96"><a href="#Batch-96"><span class="linenos"> 96</span></a><span class="sd">        Example:</span>
</span><span id="Batch-97"><a href="#Batch-97"><span class="linenos"> 97</span></a><span class="sd">            ```python</span>
</span><span id="Batch-98"><a href="#Batch-98"><span class="linenos"> 98</span></a><span class="sd">            batch.set_state(file=&quot;./state.json&quot;, reuse_state=True)</span>
</span><span id="Batch-99"><a href="#Batch-99"><span class="linenos"> 99</span></a><span class="sd">            ```</span>
</span><span id="Batch-100"><a href="#Batch-100"><span class="linenos">100</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Batch-101"><a href="#Batch-101"><span class="linenos">101</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">state_file</span> <span class="o">=</span> <span class="n">file</span>
</span><span id="Batch-102"><a href="#Batch-102"><span class="linenos">102</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">reuse_state</span> <span class="o">=</span> <span class="n">reuse_state</span>
</span><span id="Batch-103"><a href="#Batch-103"><span class="linenos">103</span></a>        <span class="k">return</span> <span class="bp">self</span>
</span><span id="Batch-104"><a href="#Batch-104"><span class="linenos">104</span></a>    
</span><span id="Batch-105"><a href="#Batch-105"><span class="linenos">105</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">add_cost_limit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">usd</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;Batch&#39;</span><span class="p">:</span>
</span><span id="Batch-106"><a href="#Batch-106"><span class="linenos">106</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Add cost limit for the batch.</span>
</span><span id="Batch-107"><a href="#Batch-107"><span class="linenos">107</span></a><span class="sd">        </span>
</span><span id="Batch-108"><a href="#Batch-108"><span class="linenos">108</span></a><span class="sd">        The batch will stop accepting new jobs once the cost limit is reached.</span>
</span><span id="Batch-109"><a href="#Batch-109"><span class="linenos">109</span></a><span class="sd">        Active jobs will be allowed to complete.</span>
</span><span id="Batch-110"><a href="#Batch-110"><span class="linenos">110</span></a><span class="sd">        </span>
</span><span id="Batch-111"><a href="#Batch-111"><span class="linenos">111</span></a><span class="sd">        Args:</span>
</span><span id="Batch-112"><a href="#Batch-112"><span class="linenos">112</span></a><span class="sd">            usd: Cost limit in USD</span>
</span><span id="Batch-113"><a href="#Batch-113"><span class="linenos">113</span></a><span class="sd">            </span>
</span><span id="Batch-114"><a href="#Batch-114"><span class="linenos">114</span></a><span class="sd">        Returns:</span>
</span><span id="Batch-115"><a href="#Batch-115"><span class="linenos">115</span></a><span class="sd">            Self for chaining</span>
</span><span id="Batch-116"><a href="#Batch-116"><span class="linenos">116</span></a><span class="sd">            </span>
</span><span id="Batch-117"><a href="#Batch-117"><span class="linenos">117</span></a><span class="sd">        Example:</span>
</span><span id="Batch-118"><a href="#Batch-118"><span class="linenos">118</span></a><span class="sd">            ```python</span>
</span><span id="Batch-119"><a href="#Batch-119"><span class="linenos">119</span></a><span class="sd">            batch.add_cost_limit(usd=50.0)</span>
</span><span id="Batch-120"><a href="#Batch-120"><span class="linenos">120</span></a><span class="sd">            ```</span>
</span><span id="Batch-121"><a href="#Batch-121"><span class="linenos">121</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Batch-122"><a href="#Batch-122"><span class="linenos">122</span></a>        <span class="k">if</span> <span class="n">usd</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Batch-123"><a href="#Batch-123"><span class="linenos">123</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cost limit must be positive&quot;</span><span class="p">)</span>
</span><span id="Batch-124"><a href="#Batch-124"><span class="linenos">124</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">cost_limit_usd</span> <span class="o">=</span> <span class="n">usd</span>
</span><span id="Batch-125"><a href="#Batch-125"><span class="linenos">125</span></a>        <span class="k">return</span> <span class="bp">self</span>
</span><span id="Batch-126"><a href="#Batch-126"><span class="linenos">126</span></a>    
</span><span id="Batch-127"><a href="#Batch-127"><span class="linenos">127</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">raw_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">enabled</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;Batch&#39;</span><span class="p">:</span>
</span><span id="Batch-128"><a href="#Batch-128"><span class="linenos">128</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Enable or disable saving debug files from providers.</span>
</span><span id="Batch-129"><a href="#Batch-129"><span class="linenos">129</span></a><span class="sd">        </span>
</span><span id="Batch-130"><a href="#Batch-130"><span class="linenos">130</span></a><span class="sd">        When enabled, debug files (raw API responses, JSONL files) will be saved</span>
</span><span id="Batch-131"><a href="#Batch-131"><span class="linenos">131</span></a><span class="sd">        in a &#39;raw_files&#39; subdirectory within the results directory.</span>
</span><span id="Batch-132"><a href="#Batch-132"><span class="linenos">132</span></a><span class="sd">        This is useful for debugging, auditing, or accessing provider-specific metadata.</span>
</span><span id="Batch-133"><a href="#Batch-133"><span class="linenos">133</span></a><span class="sd">        </span>
</span><span id="Batch-134"><a href="#Batch-134"><span class="linenos">134</span></a><span class="sd">        Args:</span>
</span><span id="Batch-135"><a href="#Batch-135"><span class="linenos">135</span></a><span class="sd">            enabled: Whether to save debug files (default: True)</span>
</span><span id="Batch-136"><a href="#Batch-136"><span class="linenos">136</span></a><span class="sd">            </span>
</span><span id="Batch-137"><a href="#Batch-137"><span class="linenos">137</span></a><span class="sd">        Returns:</span>
</span><span id="Batch-138"><a href="#Batch-138"><span class="linenos">138</span></a><span class="sd">            Self for chaining</span>
</span><span id="Batch-139"><a href="#Batch-139"><span class="linenos">139</span></a><span class="sd">            </span>
</span><span id="Batch-140"><a href="#Batch-140"><span class="linenos">140</span></a><span class="sd">        Example:</span>
</span><span id="Batch-141"><a href="#Batch-141"><span class="linenos">141</span></a><span class="sd">            ```python</span>
</span><span id="Batch-142"><a href="#Batch-142"><span class="linenos">142</span></a><span class="sd">            batch.raw_files(True)</span>
</span><span id="Batch-143"><a href="#Batch-143"><span class="linenos">143</span></a><span class="sd">            ```</span>
</span><span id="Batch-144"><a href="#Batch-144"><span class="linenos">144</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Batch-145"><a href="#Batch-145"><span class="linenos">145</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">raw_files</span> <span class="o">=</span> <span class="n">enabled</span>
</span><span id="Batch-146"><a href="#Batch-146"><span class="linenos">146</span></a>        <span class="k">return</span> <span class="bp">self</span>
</span><span id="Batch-147"><a href="#Batch-147"><span class="linenos">147</span></a>    
</span><span id="Batch-148"><a href="#Batch-148"><span class="linenos">148</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">set_verbosity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">level</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;Batch&#39;</span><span class="p">:</span>
</span><span id="Batch-149"><a href="#Batch-149"><span class="linenos">149</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Set logging verbosity level.</span>
</span><span id="Batch-150"><a href="#Batch-150"><span class="linenos">150</span></a><span class="sd">        </span>
</span><span id="Batch-151"><a href="#Batch-151"><span class="linenos">151</span></a><span class="sd">        Args:</span>
</span><span id="Batch-152"><a href="#Batch-152"><span class="linenos">152</span></a><span class="sd">            level: Verbosity level (&quot;debug&quot;, &quot;info&quot;, &quot;warn&quot;, &quot;error&quot;)</span>
</span><span id="Batch-153"><a href="#Batch-153"><span class="linenos">153</span></a><span class="sd">            </span>
</span><span id="Batch-154"><a href="#Batch-154"><span class="linenos">154</span></a><span class="sd">        Returns:</span>
</span><span id="Batch-155"><a href="#Batch-155"><span class="linenos">155</span></a><span class="sd">            Self for chaining</span>
</span><span id="Batch-156"><a href="#Batch-156"><span class="linenos">156</span></a><span class="sd">            </span>
</span><span id="Batch-157"><a href="#Batch-157"><span class="linenos">157</span></a><span class="sd">        Example:</span>
</span><span id="Batch-158"><a href="#Batch-158"><span class="linenos">158</span></a><span class="sd">            ```python</span>
</span><span id="Batch-159"><a href="#Batch-159"><span class="linenos">159</span></a><span class="sd">            batch.set_verbosity(&quot;error&quot;)  # For production</span>
</span><span id="Batch-160"><a href="#Batch-160"><span class="linenos">160</span></a><span class="sd">            batch.set_verbosity(&quot;debug&quot;)  # For debugging</span>
</span><span id="Batch-161"><a href="#Batch-161"><span class="linenos">161</span></a><span class="sd">            ```</span>
</span><span id="Batch-162"><a href="#Batch-162"><span class="linenos">162</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Batch-163"><a href="#Batch-163"><span class="linenos">163</span></a>        <span class="n">valid_levels</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;debug&quot;</span><span class="p">,</span> <span class="s2">&quot;info&quot;</span><span class="p">,</span> <span class="s2">&quot;warn&quot;</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">}</span>
</span><span id="Batch-164"><a href="#Batch-164"><span class="linenos">164</span></a>        <span class="k">if</span> <span class="n">level</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">valid_levels</span><span class="p">:</span>
</span><span id="Batch-165"><a href="#Batch-165"><span class="linenos">165</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid verbosity level: </span><span class="si">{</span><span class="n">level</span><span class="si">}</span><span class="s2">. Must be one of </span><span class="si">{</span><span class="n">valid_levels</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Batch-166"><a href="#Batch-166"><span class="linenos">166</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">verbosity</span> <span class="o">=</span> <span class="n">level</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
</span><span id="Batch-167"><a href="#Batch-167"><span class="linenos">167</span></a>        <span class="k">return</span> <span class="bp">self</span>
</span><span id="Batch-168"><a href="#Batch-168"><span class="linenos">168</span></a>    
</span><span id="Batch-169"><a href="#Batch-169"><span class="linenos">169</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">add_time_limit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seconds</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">minutes</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">hours</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;Batch&#39;</span><span class="p">:</span>
</span><span id="Batch-170"><a href="#Batch-170"><span class="linenos">170</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Add time limit for the entire batch execution.</span>
</span><span id="Batch-171"><a href="#Batch-171"><span class="linenos">171</span></a><span class="sd">        </span>
</span><span id="Batch-172"><a href="#Batch-172"><span class="linenos">172</span></a><span class="sd">        When time limit is reached, all active provider batches are cancelled and </span>
</span><span id="Batch-173"><a href="#Batch-173"><span class="linenos">173</span></a><span class="sd">        remaining unprocessed jobs are marked as failed. The batch execution </span>
</span><span id="Batch-174"><a href="#Batch-174"><span class="linenos">174</span></a><span class="sd">        completes normally without throwing exceptions.</span>
</span><span id="Batch-175"><a href="#Batch-175"><span class="linenos">175</span></a><span class="sd">        </span>
</span><span id="Batch-176"><a href="#Batch-176"><span class="linenos">176</span></a><span class="sd">        Args:</span>
</span><span id="Batch-177"><a href="#Batch-177"><span class="linenos">177</span></a><span class="sd">            seconds: Time limit in seconds (optional)</span>
</span><span id="Batch-178"><a href="#Batch-178"><span class="linenos">178</span></a><span class="sd">            minutes: Time limit in minutes (optional)</span>
</span><span id="Batch-179"><a href="#Batch-179"><span class="linenos">179</span></a><span class="sd">            hours: Time limit in hours (optional)</span>
</span><span id="Batch-180"><a href="#Batch-180"><span class="linenos">180</span></a><span class="sd">            </span>
</span><span id="Batch-181"><a href="#Batch-181"><span class="linenos">181</span></a><span class="sd">        Returns:</span>
</span><span id="Batch-182"><a href="#Batch-182"><span class="linenos">182</span></a><span class="sd">            Self for chaining</span>
</span><span id="Batch-183"><a href="#Batch-183"><span class="linenos">183</span></a><span class="sd">            </span>
</span><span id="Batch-184"><a href="#Batch-184"><span class="linenos">184</span></a><span class="sd">        Raises:</span>
</span><span id="Batch-185"><a href="#Batch-185"><span class="linenos">185</span></a><span class="sd">            ValueError: If no time units specified, or if total time is outside </span>
</span><span id="Batch-186"><a href="#Batch-186"><span class="linenos">186</span></a><span class="sd">                       valid range (min: 10 seconds, max: 24 hours)</span>
</span><span id="Batch-187"><a href="#Batch-187"><span class="linenos">187</span></a><span class="sd">            </span>
</span><span id="Batch-188"><a href="#Batch-188"><span class="linenos">188</span></a><span class="sd">        Note:</span>
</span><span id="Batch-189"><a href="#Batch-189"><span class="linenos">189</span></a><span class="sd">            - Can combine multiple time units</span>
</span><span id="Batch-190"><a href="#Batch-190"><span class="linenos">190</span></a><span class="sd">            - Time limit is checked every second by a background watchdog thread</span>
</span><span id="Batch-191"><a href="#Batch-191"><span class="linenos">191</span></a><span class="sd">            - Jobs that exceed time limit appear in results()[&quot;failed&quot;] with time limit error message</span>
</span><span id="Batch-192"><a href="#Batch-192"><span class="linenos">192</span></a><span class="sd">            - No exceptions are thrown when time limit is reached</span>
</span><span id="Batch-193"><a href="#Batch-193"><span class="linenos">193</span></a><span class="sd">            </span>
</span><span id="Batch-194"><a href="#Batch-194"><span class="linenos">194</span></a><span class="sd">        Example:</span>
</span><span id="Batch-195"><a href="#Batch-195"><span class="linenos">195</span></a><span class="sd">            ```python</span>
</span><span id="Batch-196"><a href="#Batch-196"><span class="linenos">196</span></a><span class="sd">            batch.add_time_limit(seconds=30)  # 30 seconds</span>
</span><span id="Batch-197"><a href="#Batch-197"><span class="linenos">197</span></a><span class="sd">            batch.add_time_limit(minutes=5)   # 5 minutes</span>
</span><span id="Batch-198"><a href="#Batch-198"><span class="linenos">198</span></a><span class="sd">            batch.add_time_limit(hours=2)     # 2 hours</span>
</span><span id="Batch-199"><a href="#Batch-199"><span class="linenos">199</span></a><span class="sd">            batch.add_time_limit(hours=1, minutes=30, seconds=15)  # 5415 seconds total</span>
</span><span id="Batch-200"><a href="#Batch-200"><span class="linenos">200</span></a><span class="sd">            ```</span>
</span><span id="Batch-201"><a href="#Batch-201"><span class="linenos">201</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Batch-202"><a href="#Batch-202"><span class="linenos">202</span></a>        <span class="n">time_limit_seconds</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="Batch-203"><a href="#Batch-203"><span class="linenos">203</span></a>        
</span><span id="Batch-204"><a href="#Batch-204"><span class="linenos">204</span></a>        <span class="k">if</span> <span class="n">seconds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Batch-205"><a href="#Batch-205"><span class="linenos">205</span></a>            <span class="n">time_limit_seconds</span> <span class="o">+=</span> <span class="n">seconds</span>
</span><span id="Batch-206"><a href="#Batch-206"><span class="linenos">206</span></a>        <span class="k">if</span> <span class="n">minutes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Batch-207"><a href="#Batch-207"><span class="linenos">207</span></a>            <span class="n">time_limit_seconds</span> <span class="o">+=</span> <span class="n">minutes</span> <span class="o">*</span> <span class="mi">60</span>
</span><span id="Batch-208"><a href="#Batch-208"><span class="linenos">208</span></a>        <span class="k">if</span> <span class="n">hours</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Batch-209"><a href="#Batch-209"><span class="linenos">209</span></a>            <span class="n">time_limit_seconds</span> <span class="o">+=</span> <span class="n">hours</span> <span class="o">*</span> <span class="mi">3600</span>
</span><span id="Batch-210"><a href="#Batch-210"><span class="linenos">210</span></a>            
</span><span id="Batch-211"><a href="#Batch-211"><span class="linenos">211</span></a>        <span class="k">if</span> <span class="n">time_limit_seconds</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Batch-212"><a href="#Batch-212"><span class="linenos">212</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Must specify at least one of seconds, minutes, or hours&quot;</span><span class="p">)</span>
</span><span id="Batch-213"><a href="#Batch-213"><span class="linenos">213</span></a>            
</span><span id="Batch-214"><a href="#Batch-214"><span class="linenos">214</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">time_limit_seconds</span> <span class="o">=</span> <span class="n">time_limit_seconds</span>
</span><span id="Batch-215"><a href="#Batch-215"><span class="linenos">215</span></a>        <span class="k">return</span> <span class="bp">self</span>
</span><span id="Batch-216"><a href="#Batch-216"><span class="linenos">216</span></a>    
</span><span id="Batch-217"><a href="#Batch-217"><span class="linenos">217</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">add_job</span><span class="p">(</span>
</span><span id="Batch-218"><a href="#Batch-218"><span class="linenos">218</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="Batch-219"><a href="#Batch-219"><span class="linenos">219</span></a>        <span class="n">messages</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Message</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Batch-220"><a href="#Batch-220"><span class="linenos">220</span></a>        <span class="n">file</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Path</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Batch-221"><a href="#Batch-221"><span class="linenos">221</span></a>        <span class="n">prompt</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Batch-222"><a href="#Batch-222"><span class="linenos">222</span></a>        <span class="n">model</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Batch-223"><a href="#Batch-223"><span class="linenos">223</span></a>        <span class="n">temperature</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Batch-224"><a href="#Batch-224"><span class="linenos">224</span></a>        <span class="n">max_tokens</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Batch-225"><a href="#Batch-225"><span class="linenos">225</span></a>        <span class="n">response_model</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="n">BaseModel</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Batch-226"><a href="#Batch-226"><span class="linenos">226</span></a>        <span class="n">enable_citations</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="Batch-227"><a href="#Batch-227"><span class="linenos">227</span></a>        <span class="o">**</span><span class="n">kwargs</span>
</span><span id="Batch-228"><a href="#Batch-228"><span class="linenos">228</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;Batch&#39;</span><span class="p">:</span>
</span><span id="Batch-229"><a href="#Batch-229"><span class="linenos">229</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Add a job to the batch.</span>
</span><span id="Batch-230"><a href="#Batch-230"><span class="linenos">230</span></a><span class="sd">        </span>
</span><span id="Batch-231"><a href="#Batch-231"><span class="linenos">231</span></a><span class="sd">        Either provide messages OR file+prompt, not both. Parameters not provided</span>
</span><span id="Batch-232"><a href="#Batch-232"><span class="linenos">232</span></a><span class="sd">        will use the defaults set via the defaults() method.</span>
</span><span id="Batch-233"><a href="#Batch-233"><span class="linenos">233</span></a><span class="sd">        </span>
</span><span id="Batch-234"><a href="#Batch-234"><span class="linenos">234</span></a><span class="sd">        Args:</span>
</span><span id="Batch-235"><a href="#Batch-235"><span class="linenos">235</span></a><span class="sd">            messages: Chat messages for direct input</span>
</span><span id="Batch-236"><a href="#Batch-236"><span class="linenos">236</span></a><span class="sd">            file: File path for file-based input</span>
</span><span id="Batch-237"><a href="#Batch-237"><span class="linenos">237</span></a><span class="sd">            prompt: Prompt to use with file input</span>
</span><span id="Batch-238"><a href="#Batch-238"><span class="linenos">238</span></a><span class="sd">            model: Model to use (overrides default)</span>
</span><span id="Batch-239"><a href="#Batch-239"><span class="linenos">239</span></a><span class="sd">            temperature: Sampling temperature (overrides default)</span>
</span><span id="Batch-240"><a href="#Batch-240"><span class="linenos">240</span></a><span class="sd">            max_tokens: Max tokens to generate (overrides default)</span>
</span><span id="Batch-241"><a href="#Batch-241"><span class="linenos">241</span></a><span class="sd">            response_model: Pydantic model for structured output</span>
</span><span id="Batch-242"><a href="#Batch-242"><span class="linenos">242</span></a><span class="sd">            enable_citations: Whether to extract citations</span>
</span><span id="Batch-243"><a href="#Batch-243"><span class="linenos">243</span></a><span class="sd">            **kwargs: Additional parameters</span>
</span><span id="Batch-244"><a href="#Batch-244"><span class="linenos">244</span></a><span class="sd">            </span>
</span><span id="Batch-245"><a href="#Batch-245"><span class="linenos">245</span></a><span class="sd">        Returns:</span>
</span><span id="Batch-246"><a href="#Batch-246"><span class="linenos">246</span></a><span class="sd">            Self for chaining</span>
</span><span id="Batch-247"><a href="#Batch-247"><span class="linenos">247</span></a><span class="sd">            </span>
</span><span id="Batch-248"><a href="#Batch-248"><span class="linenos">248</span></a><span class="sd">        Example:</span>
</span><span id="Batch-249"><a href="#Batch-249"><span class="linenos">249</span></a><span class="sd">            ```python</span>
</span><span id="Batch-250"><a href="#Batch-250"><span class="linenos">250</span></a><span class="sd">            batch.add_job(</span>
</span><span id="Batch-251"><a href="#Batch-251"><span class="linenos">251</span></a><span class="sd">                messages=[{&quot;role&quot;: &quot;user&quot;, &quot;content&quot;: &quot;Hello&quot;}],</span>
</span><span id="Batch-252"><a href="#Batch-252"><span class="linenos">252</span></a><span class="sd">                model=&quot;gpt-4&quot;</span>
</span><span id="Batch-253"><a href="#Batch-253"><span class="linenos">253</span></a><span class="sd">            )</span>
</span><span id="Batch-254"><a href="#Batch-254"><span class="linenos">254</span></a><span class="sd">            ```</span>
</span><span id="Batch-255"><a href="#Batch-255"><span class="linenos">255</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Batch-256"><a href="#Batch-256"><span class="linenos">256</span></a>        <span class="c1"># Generate unique job ID</span>
</span><span id="Batch-257"><a href="#Batch-257"><span class="linenos">257</span></a>        <span class="n">job_id</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;job-</span><span class="si">{</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span><span class="o">.</span><span class="n">hex</span><span class="p">[:</span><span class="mi">8</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="Batch-258"><a href="#Batch-258"><span class="linenos">258</span></a>        
</span><span id="Batch-259"><a href="#Batch-259"><span class="linenos">259</span></a>        <span class="c1"># Merge with defaults</span>
</span><span id="Batch-260"><a href="#Batch-260"><span class="linenos">260</span></a>        <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">default_params</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="Batch-261"><a href="#Batch-261"><span class="linenos">261</span></a>        
</span><span id="Batch-262"><a href="#Batch-262"><span class="linenos">262</span></a>        <span class="c1"># Update with provided parameters</span>
</span><span id="Batch-263"><a href="#Batch-263"><span class="linenos">263</span></a>        <span class="k">if</span> <span class="n">model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Batch-264"><a href="#Batch-264"><span class="linenos">264</span></a>            <span class="n">params</span><span class="p">[</span><span class="s2">&quot;model&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model</span>
</span><span id="Batch-265"><a href="#Batch-265"><span class="linenos">265</span></a>        <span class="k">if</span> <span class="n">temperature</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Batch-266"><a href="#Batch-266"><span class="linenos">266</span></a>            <span class="n">params</span><span class="p">[</span><span class="s2">&quot;temperature&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">temperature</span>
</span><span id="Batch-267"><a href="#Batch-267"><span class="linenos">267</span></a>        <span class="k">if</span> <span class="n">max_tokens</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Batch-268"><a href="#Batch-268"><span class="linenos">268</span></a>            <span class="n">params</span><span class="p">[</span><span class="s2">&quot;max_tokens&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">max_tokens</span>
</span><span id="Batch-269"><a href="#Batch-269"><span class="linenos">269</span></a>        
</span><span id="Batch-270"><a href="#Batch-270"><span class="linenos">270</span></a>        <span class="c1"># Add other kwargs</span>
</span><span id="Batch-271"><a href="#Batch-271"><span class="linenos">271</span></a>        <span class="n">params</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="Batch-272"><a href="#Batch-272"><span class="linenos">272</span></a>        
</span><span id="Batch-273"><a href="#Batch-273"><span class="linenos">273</span></a>        <span class="c1"># Ensure model is provided</span>
</span><span id="Batch-274"><a href="#Batch-274"><span class="linenos">274</span></a>        <span class="k">if</span> <span class="s2">&quot;model&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>
</span><span id="Batch-275"><a href="#Batch-275"><span class="linenos">275</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Model must be provided either in defaults or job parameters&quot;</span><span class="p">)</span>
</span><span id="Batch-276"><a href="#Batch-276"><span class="linenos">276</span></a>        
</span><span id="Batch-277"><a href="#Batch-277"><span class="linenos">277</span></a>        <span class="c1"># Validate parameters</span>
</span><span id="Batch-278"><a href="#Batch-278"><span class="linenos">278</span></a>        <span class="n">provider</span> <span class="o">=</span> <span class="n">get_provider</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;model&quot;</span><span class="p">])</span>
</span><span id="Batch-279"><a href="#Batch-279"><span class="linenos">279</span></a>        <span class="c1"># Extract params without model to avoid duplicate</span>
</span><span id="Batch-280"><a href="#Batch-280"><span class="linenos">280</span></a>        <span class="n">param_subset</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="o">!=</span> <span class="s2">&quot;model&quot;</span><span class="p">}</span>
</span><span id="Batch-281"><a href="#Batch-281"><span class="linenos">281</span></a>        <span class="n">provider</span><span class="o">.</span><span class="n">validate_params</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;model&quot;</span><span class="p">],</span> <span class="o">**</span><span class="n">param_subset</span><span class="p">)</span>
</span><span id="Batch-282"><a href="#Batch-282"><span class="linenos">282</span></a>        
</span><span id="Batch-283"><a href="#Batch-283"><span class="linenos">283</span></a>        <span class="c1"># Convert file path if string</span>
</span><span id="Batch-284"><a href="#Batch-284"><span class="linenos">284</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="Batch-285"><a href="#Batch-285"><span class="linenos">285</span></a>            <span class="n">file</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
</span><span id="Batch-286"><a href="#Batch-286"><span class="linenos">286</span></a>        
</span><span id="Batch-287"><a href="#Batch-287"><span class="linenos">287</span></a>        <span class="c1"># Warn about temporary file paths that may not persist</span>
</span><span id="Batch-288"><a href="#Batch-288"><span class="linenos">288</span></a>        <span class="k">if</span> <span class="n">file</span><span class="p">:</span>
</span><span id="Batch-289"><a href="#Batch-289"><span class="linenos">289</span></a>            <span class="n">file_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
</span><span id="Batch-290"><a href="#Batch-290"><span class="linenos">290</span></a>            <span class="k">if</span> <span class="s2">&quot;/tmp/&quot;</span> <span class="ow">in</span> <span class="n">file_str</span> <span class="ow">or</span> <span class="s2">&quot;/var/folders/&quot;</span> <span class="ow">in</span> <span class="n">file_str</span> <span class="ow">or</span> <span class="s2">&quot;temp&quot;</span> <span class="ow">in</span> <span class="n">file_str</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
</span><span id="Batch-291"><a href="#Batch-291"><span class="linenos">291</span></a>                <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;batchata&quot;</span><span class="p">)</span>
</span><span id="Batch-292"><a href="#Batch-292"><span class="linenos">292</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;File path appears to be in a temporary directory: </span><span class="si">{</span><span class="n">file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Batch-293"><a href="#Batch-293"><span class="linenos">293</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;This may cause issues when resuming from state if temp files are cleaned up&quot;</span><span class="p">)</span>
</span><span id="Batch-294"><a href="#Batch-294"><span class="linenos">294</span></a>        
</span><span id="Batch-295"><a href="#Batch-295"><span class="linenos">295</span></a>        <span class="c1"># Create job</span>
</span><span id="Batch-296"><a href="#Batch-296"><span class="linenos">296</span></a>        <span class="n">job</span> <span class="o">=</span> <span class="n">Job</span><span class="p">(</span>
</span><span id="Batch-297"><a href="#Batch-297"><span class="linenos">297</span></a>            <span class="nb">id</span><span class="o">=</span><span class="n">job_id</span><span class="p">,</span>
</span><span id="Batch-298"><a href="#Batch-298"><span class="linenos">298</span></a>            <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span>
</span><span id="Batch-299"><a href="#Batch-299"><span class="linenos">299</span></a>            <span class="n">file</span><span class="o">=</span><span class="n">file</span><span class="p">,</span>
</span><span id="Batch-300"><a href="#Batch-300"><span class="linenos">300</span></a>            <span class="n">prompt</span><span class="o">=</span><span class="n">prompt</span><span class="p">,</span>
</span><span id="Batch-301"><a href="#Batch-301"><span class="linenos">301</span></a>            <span class="n">response_model</span><span class="o">=</span><span class="n">response_model</span><span class="p">,</span>
</span><span id="Batch-302"><a href="#Batch-302"><span class="linenos">302</span></a>            <span class="n">enable_citations</span><span class="o">=</span><span class="n">enable_citations</span><span class="p">,</span>
</span><span id="Batch-303"><a href="#Batch-303"><span class="linenos">303</span></a>            <span class="o">**</span><span class="n">params</span>
</span><span id="Batch-304"><a href="#Batch-304"><span class="linenos">304</span></a>        <span class="p">)</span>
</span><span id="Batch-305"><a href="#Batch-305"><span class="linenos">305</span></a>        
</span><span id="Batch-306"><a href="#Batch-306"><span class="linenos">306</span></a>        <span class="c1"># Validate citation compatibility</span>
</span><span id="Batch-307"><a href="#Batch-307"><span class="linenos">307</span></a>        <span class="k">if</span> <span class="n">response_model</span> <span class="ow">and</span> <span class="n">enable_citations</span><span class="p">:</span>
</span><span id="Batch-308"><a href="#Batch-308"><span class="linenos">308</span></a>            <span class="kn">from</span><span class="w"> </span><span class="nn">..utils.validation</span><span class="w"> </span><span class="kn">import</span> <span class="n">validate_flat_model</span>
</span><span id="Batch-309"><a href="#Batch-309"><span class="linenos">309</span></a>            <span class="n">validate_flat_model</span><span class="p">(</span><span class="n">response_model</span><span class="p">)</span>
</span><span id="Batch-310"><a href="#Batch-310"><span class="linenos">310</span></a>        
</span><span id="Batch-311"><a href="#Batch-311"><span class="linenos">311</span></a>        <span class="c1"># Validate job with provider (includes PDF validation for Anthropic)</span>
</span><span id="Batch-312"><a href="#Batch-312"><span class="linenos">312</span></a>        <span class="n">provider</span><span class="o">.</span><span class="n">validate_job</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>
</span><span id="Batch-313"><a href="#Batch-313"><span class="linenos">313</span></a>        
</span><span id="Batch-314"><a href="#Batch-314"><span class="linenos">314</span></a>        
</span><span id="Batch-315"><a href="#Batch-315"><span class="linenos">315</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">jobs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>
</span><span id="Batch-316"><a href="#Batch-316"><span class="linenos">316</span></a>        <span class="k">return</span> <span class="bp">self</span>
</span><span id="Batch-317"><a href="#Batch-317"><span class="linenos">317</span></a>    
</span><span id="Batch-318"><a href="#Batch-318"><span class="linenos">318</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">on_progress</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="n">Dict</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">Dict</span><span class="p">],</span> <span class="kc">None</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">progress_interval</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">print_status</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">dry_run</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;BatchRun&#39;</span><span class="p">:</span>
</span><span id="Batch-319"><a href="#Batch-319"><span class="linenos">319</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute the batch.</span>
</span><span id="Batch-320"><a href="#Batch-320"><span class="linenos">320</span></a><span class="sd">        </span>
</span><span id="Batch-321"><a href="#Batch-321"><span class="linenos">321</span></a><span class="sd">        Creates a BatchRun instance and executes the jobs synchronously.</span>
</span><span id="Batch-322"><a href="#Batch-322"><span class="linenos">322</span></a><span class="sd">        </span>
</span><span id="Batch-323"><a href="#Batch-323"><span class="linenos">323</span></a><span class="sd">        Args:</span>
</span><span id="Batch-324"><a href="#Batch-324"><span class="linenos">324</span></a><span class="sd">            on_progress: Optional progress callback function that receives</span>
</span><span id="Batch-325"><a href="#Batch-325"><span class="linenos">325</span></a><span class="sd">                        (stats_dict, elapsed_time_seconds, batch_data)</span>
</span><span id="Batch-326"><a href="#Batch-326"><span class="linenos">326</span></a><span class="sd">            progress_interval: Interval in seconds between progress updates (default: 1.0)</span>
</span><span id="Batch-327"><a href="#Batch-327"><span class="linenos">327</span></a><span class="sd">            print_status: Whether to show rich progress display (default: False)</span>
</span><span id="Batch-328"><a href="#Batch-328"><span class="linenos">328</span></a><span class="sd">            dry_run: If True, only show cost estimation without executing (default: False)</span>
</span><span id="Batch-329"><a href="#Batch-329"><span class="linenos">329</span></a><span class="sd">            </span>
</span><span id="Batch-330"><a href="#Batch-330"><span class="linenos">330</span></a><span class="sd">        Returns:</span>
</span><span id="Batch-331"><a href="#Batch-331"><span class="linenos">331</span></a><span class="sd">            BatchRun instance with completed results</span>
</span><span id="Batch-332"><a href="#Batch-332"><span class="linenos">332</span></a><span class="sd">            </span>
</span><span id="Batch-333"><a href="#Batch-333"><span class="linenos">333</span></a><span class="sd">        Raises:</span>
</span><span id="Batch-334"><a href="#Batch-334"><span class="linenos">334</span></a><span class="sd">            ValueError: If no jobs have been added</span>
</span><span id="Batch-335"><a href="#Batch-335"><span class="linenos">335</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Batch-336"><a href="#Batch-336"><span class="linenos">336</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobs</span><span class="p">:</span>
</span><span id="Batch-337"><a href="#Batch-337"><span class="linenos">337</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No jobs added to batch&quot;</span><span class="p">)</span>
</span><span id="Batch-338"><a href="#Batch-338"><span class="linenos">338</span></a>        
</span><span id="Batch-339"><a href="#Batch-339"><span class="linenos">339</span></a>        <span class="c1"># Import here to avoid circular dependency</span>
</span><span id="Batch-340"><a href="#Batch-340"><span class="linenos">340</span></a>        <span class="kn">from</span><span class="w"> </span><span class="nn">.batch_run</span><span class="w"> </span><span class="kn">import</span> <span class="n">BatchRun</span>
</span><span id="Batch-341"><a href="#Batch-341"><span class="linenos">341</span></a>        
</span><span id="Batch-342"><a href="#Batch-342"><span class="linenos">342</span></a>        <span class="c1"># Create and start the run</span>
</span><span id="Batch-343"><a href="#Batch-343"><span class="linenos">343</span></a>        <span class="n">run</span> <span class="o">=</span> <span class="n">BatchRun</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobs</span><span class="p">)</span>
</span><span id="Batch-344"><a href="#Batch-344"><span class="linenos">344</span></a>        
</span><span id="Batch-345"><a href="#Batch-345"><span class="linenos">345</span></a>        <span class="c1"># Handle dry run mode</span>
</span><span id="Batch-346"><a href="#Batch-346"><span class="linenos">346</span></a>        <span class="k">if</span> <span class="n">dry_run</span><span class="p">:</span>
</span><span id="Batch-347"><a href="#Batch-347"><span class="linenos">347</span></a>            <span class="k">return</span> <span class="n">run</span><span class="o">.</span><span class="n">dry_run</span><span class="p">()</span>
</span><span id="Batch-348"><a href="#Batch-348"><span class="linenos">348</span></a>        
</span><span id="Batch-349"><a href="#Batch-349"><span class="linenos">349</span></a>        <span class="c1"># Set progress callback - either rich display or custom callback</span>
</span><span id="Batch-350"><a href="#Batch-350"><span class="linenos">350</span></a>        <span class="k">if</span> <span class="n">print_status</span><span class="p">:</span>
</span><span id="Batch-351"><a href="#Batch-351"><span class="linenos">351</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_with_rich_display</span><span class="p">(</span><span class="n">run</span><span class="p">,</span> <span class="n">progress_interval</span><span class="p">)</span>
</span><span id="Batch-352"><a href="#Batch-352"><span class="linenos">352</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Batch-353"><a href="#Batch-353"><span class="linenos">353</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_with_custom_callback</span><span class="p">(</span><span class="n">run</span><span class="p">,</span> <span class="n">on_progress</span><span class="p">,</span> <span class="n">progress_interval</span><span class="p">)</span>
</span><span id="Batch-354"><a href="#Batch-354"><span class="linenos">354</span></a>    
</span><span id="Batch-355"><a href="#Batch-355"><span class="linenos">355</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_run_with_rich_display</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run</span><span class="p">:</span> <span class="s1">&#39;BatchRun&#39;</span><span class="p">,</span> <span class="n">progress_interval</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;BatchRun&#39;</span><span class="p">:</span>
</span><span id="Batch-356"><a href="#Batch-356"><span class="linenos">356</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute batch run with rich progress display.</span>
</span><span id="Batch-357"><a href="#Batch-357"><span class="linenos">357</span></a><span class="sd">        </span>
</span><span id="Batch-358"><a href="#Batch-358"><span class="linenos">358</span></a><span class="sd">        Args:</span>
</span><span id="Batch-359"><a href="#Batch-359"><span class="linenos">359</span></a><span class="sd">            run: BatchRun instance to execute</span>
</span><span id="Batch-360"><a href="#Batch-360"><span class="linenos">360</span></a><span class="sd">            progress_interval: Interval between progress updates</span>
</span><span id="Batch-361"><a href="#Batch-361"><span class="linenos">361</span></a><span class="sd">            </span>
</span><span id="Batch-362"><a href="#Batch-362"><span class="linenos">362</span></a><span class="sd">        Returns:</span>
</span><span id="Batch-363"><a href="#Batch-363"><span class="linenos">363</span></a><span class="sd">            Completed BatchRun instance</span>
</span><span id="Batch-364"><a href="#Batch-364"><span class="linenos">364</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Batch-365"><a href="#Batch-365"><span class="linenos">365</span></a>        <span class="kn">from</span><span class="w"> </span><span class="nn">..utils.rich_progress</span><span class="w"> </span><span class="kn">import</span> <span class="n">RichBatchProgressDisplay</span>
</span><span id="Batch-366"><a href="#Batch-366"><span class="linenos">366</span></a>        <span class="n">display</span> <span class="o">=</span> <span class="n">RichBatchProgressDisplay</span><span class="p">()</span>
</span><span id="Batch-367"><a href="#Batch-367"><span class="linenos">367</span></a>        
</span><span id="Batch-368"><a href="#Batch-368"><span class="linenos">368</span></a>        <span class="k">def</span><span class="w"> </span><span class="nf">rich_progress_callback</span><span class="p">(</span><span class="n">stats</span><span class="p">,</span> <span class="n">elapsed_time</span><span class="p">,</span> <span class="n">batch_data</span><span class="p">):</span>
</span><span id="Batch-369"><a href="#Batch-369"><span class="linenos">369</span></a>            <span class="c1"># Start display on first call</span>
</span><span id="Batch-370"><a href="#Batch-370"><span class="linenos">370</span></a>            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">rich_progress_callback</span><span class="p">,</span> <span class="s1">&#39;_started&#39;</span><span class="p">):</span>
</span><span id="Batch-371"><a href="#Batch-371"><span class="linenos">371</span></a>                <span class="n">config_dict</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="Batch-372"><a href="#Batch-372"><span class="linenos">372</span></a>                    <span class="s1">&#39;results_dir&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">results_dir</span><span class="p">,</span>
</span><span id="Batch-373"><a href="#Batch-373"><span class="linenos">373</span></a>                    <span class="s1">&#39;state_file&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">state_file</span><span class="p">,</span>
</span><span id="Batch-374"><a href="#Batch-374"><span class="linenos">374</span></a>                    <span class="s1">&#39;items_per_batch&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">items_per_batch</span><span class="p">,</span>
</span><span id="Batch-375"><a href="#Batch-375"><span class="linenos">375</span></a>                    <span class="s1">&#39;max_parallel_batches&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">max_parallel_batches</span>
</span><span id="Batch-376"><a href="#Batch-376"><span class="linenos">376</span></a>                <span class="p">}</span>
</span><span id="Batch-377"><a href="#Batch-377"><span class="linenos">377</span></a>                <span class="n">display</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">stats</span><span class="p">,</span> <span class="n">config_dict</span><span class="p">)</span>
</span><span id="Batch-378"><a href="#Batch-378"><span class="linenos">378</span></a>                <span class="n">rich_progress_callback</span><span class="o">.</span><span class="n">_started</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="Batch-379"><a href="#Batch-379"><span class="linenos">379</span></a>            
</span><span id="Batch-380"><a href="#Batch-380"><span class="linenos">380</span></a>            <span class="c1"># Update display</span>
</span><span id="Batch-381"><a href="#Batch-381"><span class="linenos">381</span></a>            <span class="n">display</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">stats</span><span class="p">,</span> <span class="n">batch_data</span><span class="p">,</span> <span class="n">elapsed_time</span><span class="p">)</span>
</span><span id="Batch-382"><a href="#Batch-382"><span class="linenos">382</span></a>        
</span><span id="Batch-383"><a href="#Batch-383"><span class="linenos">383</span></a>        <span class="n">run</span><span class="o">.</span><span class="n">set_on_progress</span><span class="p">(</span><span class="n">rich_progress_callback</span><span class="p">,</span> <span class="n">interval</span><span class="o">=</span><span class="n">progress_interval</span><span class="p">)</span>
</span><span id="Batch-384"><a href="#Batch-384"><span class="linenos">384</span></a>        
</span><span id="Batch-385"><a href="#Batch-385"><span class="linenos">385</span></a>        <span class="c1"># Execute with proper cleanup</span>
</span><span id="Batch-386"><a href="#Batch-386"><span class="linenos">386</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="Batch-387"><a href="#Batch-387"><span class="linenos">387</span></a>            <span class="n">run</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
</span><span id="Batch-388"><a href="#Batch-388"><span class="linenos">388</span></a>            
</span><span id="Batch-389"><a href="#Batch-389"><span class="linenos">389</span></a>            <span class="c1"># Show final status with all batches completed</span>
</span><span id="Batch-390"><a href="#Batch-390"><span class="linenos">390</span></a>            <span class="n">stats</span> <span class="o">=</span> <span class="n">run</span><span class="o">.</span><span class="n">status</span><span class="p">()</span>
</span><span id="Batch-391"><a href="#Batch-391"><span class="linenos">391</span></a>            <span class="n">display</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">stats</span><span class="p">,</span> <span class="n">run</span><span class="o">.</span><span class="n">batch_tracking</span><span class="p">,</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">run</span><span class="o">.</span><span class="n">_start_time</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">())</span>
</span><span id="Batch-392"><a href="#Batch-392"><span class="linenos">392</span></a>            
</span><span id="Batch-393"><a href="#Batch-393"><span class="linenos">393</span></a>            <span class="c1"># Small delay to ensure display updates</span>
</span><span id="Batch-394"><a href="#Batch-394"><span class="linenos">394</span></a>            <span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
</span><span id="Batch-395"><a href="#Batch-395"><span class="linenos">395</span></a>            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.2</span><span class="p">)</span>
</span><span id="Batch-396"><a href="#Batch-396"><span class="linenos">396</span></a>            
</span><span id="Batch-397"><a href="#Batch-397"><span class="linenos">397</span></a>        <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
</span><span id="Batch-398"><a href="#Batch-398"><span class="linenos">398</span></a>            <span class="c1"># Update batch tracking to show cancelled status for pending/running batches</span>
</span><span id="Batch-399"><a href="#Batch-399"><span class="linenos">399</span></a>            <span class="k">with</span> <span class="n">run</span><span class="o">.</span><span class="n">_state_lock</span><span class="p">:</span>
</span><span id="Batch-400"><a href="#Batch-400"><span class="linenos">400</span></a>                <span class="k">for</span> <span class="n">batch_id</span><span class="p">,</span> <span class="n">batch_info</span> <span class="ow">in</span> <span class="n">run</span><span class="o">.</span><span class="n">batch_tracking</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="Batch-401"><a href="#Batch-401"><span class="linenos">401</span></a>                    <span class="k">if</span> <span class="n">batch_info</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;running&#39;</span><span class="p">:</span>
</span><span id="Batch-402"><a href="#Batch-402"><span class="linenos">402</span></a>                        <span class="n">batch_info</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;cancelled&#39;</span>
</span><span id="Batch-403"><a href="#Batch-403"><span class="linenos">403</span></a>                    <span class="k">elif</span> <span class="n">batch_info</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;pending&#39;</span><span class="p">:</span>
</span><span id="Batch-404"><a href="#Batch-404"><span class="linenos">404</span></a>                        <span class="n">batch_info</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;cancelled&#39;</span>
</span><span id="Batch-405"><a href="#Batch-405"><span class="linenos">405</span></a>            
</span><span id="Batch-406"><a href="#Batch-406"><span class="linenos">406</span></a>            <span class="c1"># Show final status with cancelled batches</span>
</span><span id="Batch-407"><a href="#Batch-407"><span class="linenos">407</span></a>            <span class="n">stats</span> <span class="o">=</span> <span class="n">run</span><span class="o">.</span><span class="n">status</span><span class="p">()</span>
</span><span id="Batch-408"><a href="#Batch-408"><span class="linenos">408</span></a>            <span class="n">display</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">stats</span><span class="p">,</span> <span class="n">run</span><span class="o">.</span><span class="n">batch_tracking</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
</span><span id="Batch-409"><a href="#Batch-409"><span class="linenos">409</span></a>            
</span><span id="Batch-410"><a href="#Batch-410"><span class="linenos">410</span></a>            <span class="c1"># Add a small delay to ensure the display updates</span>
</span><span id="Batch-411"><a href="#Batch-411"><span class="linenos">411</span></a>            <span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
</span><span id="Batch-412"><a href="#Batch-412"><span class="linenos">412</span></a>            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
</span><span id="Batch-413"><a href="#Batch-413"><span class="linenos">413</span></a>            
</span><span id="Batch-414"><a href="#Batch-414"><span class="linenos">414</span></a>            <span class="n">display</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
</span><span id="Batch-415"><a href="#Batch-415"><span class="linenos">415</span></a>            <span class="k">raise</span>
</span><span id="Batch-416"><a href="#Batch-416"><span class="linenos">416</span></a>        <span class="k">finally</span><span class="p">:</span>
</span><span id="Batch-417"><a href="#Batch-417"><span class="linenos">417</span></a>            <span class="k">if</span> <span class="n">display</span><span class="o">.</span><span class="n">live</span><span class="p">:</span>  <span class="c1"># Only stop if not already stopped</span>
</span><span id="Batch-418"><a href="#Batch-418"><span class="linenos">418</span></a>                <span class="n">display</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
</span><span id="Batch-419"><a href="#Batch-419"><span class="linenos">419</span></a>        
</span><span id="Batch-420"><a href="#Batch-420"><span class="linenos">420</span></a>        <span class="k">return</span> <span class="n">run</span>
</span><span id="Batch-421"><a href="#Batch-421"><span class="linenos">421</span></a>    
</span><span id="Batch-422"><a href="#Batch-422"><span class="linenos">422</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_run_with_custom_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run</span><span class="p">:</span> <span class="s1">&#39;BatchRun&#39;</span><span class="p">,</span> <span class="n">on_progress</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="n">Dict</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">Dict</span><span class="p">],</span> <span class="kc">None</span><span class="p">]],</span> <span class="n">progress_interval</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;BatchRun&#39;</span><span class="p">:</span>
</span><span id="Batch-423"><a href="#Batch-423"><span class="linenos">423</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute batch run with custom progress callback.</span>
</span><span id="Batch-424"><a href="#Batch-424"><span class="linenos">424</span></a><span class="sd">        </span>
</span><span id="Batch-425"><a href="#Batch-425"><span class="linenos">425</span></a><span class="sd">        Args:</span>
</span><span id="Batch-426"><a href="#Batch-426"><span class="linenos">426</span></a><span class="sd">            run: BatchRun instance to execute</span>
</span><span id="Batch-427"><a href="#Batch-427"><span class="linenos">427</span></a><span class="sd">            on_progress: Optional custom progress callback</span>
</span><span id="Batch-428"><a href="#Batch-428"><span class="linenos">428</span></a><span class="sd">            progress_interval: Interval between progress updates</span>
</span><span id="Batch-429"><a href="#Batch-429"><span class="linenos">429</span></a><span class="sd">            </span>
</span><span id="Batch-430"><a href="#Batch-430"><span class="linenos">430</span></a><span class="sd">        Returns:</span>
</span><span id="Batch-431"><a href="#Batch-431"><span class="linenos">431</span></a><span class="sd">            Completed BatchRun instance</span>
</span><span id="Batch-432"><a href="#Batch-432"><span class="linenos">432</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Batch-433"><a href="#Batch-433"><span class="linenos">433</span></a>        <span class="c1"># Use custom progress callback if provided</span>
</span><span id="Batch-434"><a href="#Batch-434"><span class="linenos">434</span></a>        <span class="k">if</span> <span class="n">on_progress</span><span class="p">:</span>
</span><span id="Batch-435"><a href="#Batch-435"><span class="linenos">435</span></a>            <span class="n">run</span><span class="o">.</span><span class="n">set_on_progress</span><span class="p">(</span><span class="n">on_progress</span><span class="p">,</span> <span class="n">interval</span><span class="o">=</span><span class="n">progress_interval</span><span class="p">)</span>
</span><span id="Batch-436"><a href="#Batch-436"><span class="linenos">436</span></a>        
</span><span id="Batch-437"><a href="#Batch-437"><span class="linenos">437</span></a>        <span class="n">run</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
</span><span id="Batch-438"><a href="#Batch-438"><span class="linenos">438</span></a>        <span class="k">return</span> <span class="n">run</span>
</span><span id="Batch-439"><a href="#Batch-439"><span class="linenos">439</span></a>    
</span><span id="Batch-440"><a href="#Batch-440"><span class="linenos">440</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span id="Batch-441"><a href="#Batch-441"><span class="linenos">441</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the number of jobs in the batch.&quot;&quot;&quot;</span>
</span><span id="Batch-442"><a href="#Batch-442"><span class="linenos">442</span></a>        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jobs</span><span class="p">)</span>
</span><span id="Batch-443"><a href="#Batch-443"><span class="linenos">443</span></a>    
</span><span id="Batch-444"><a href="#Batch-444"><span class="linenos">444</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
</span><span id="Batch-445"><a href="#Batch-445"><span class="linenos">445</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;String representation of the batch.&quot;&quot;&quot;</span>
</span><span id="Batch-446"><a href="#Batch-446"><span class="linenos">446</span></a>        <span class="k">return</span> <span class="p">(</span>
</span><span id="Batch-447"><a href="#Batch-447"><span class="linenos">447</span></a>            <span class="sa">f</span><span class="s2">&quot;Batch(jobs=</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jobs</span><span class="p">)</span><span class="si">}</span><span class="s2">, &quot;</span>
</span><span id="Batch-448"><a href="#Batch-448"><span class="linenos">448</span></a>            <span class="sa">f</span><span class="s2">&quot;max_parallel_batches=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">max_parallel_batches</span><span class="si">}</span><span class="s2">, &quot;</span>
</span><span id="Batch-449"><a href="#Batch-449"><span class="linenos">449</span></a>            <span class="sa">f</span><span class="s2">&quot;cost_limit=$</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">cost_limit_usd</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="s1">&#39;None&#39;</span><span class="si">}</span><span class="s2">)&quot;</span>
</span><span id="Batch-450"><a href="#Batch-450"><span class="linenos">450</span></a>        <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Builder for batch job configuration.</p>

<p>Provides a fluent interface for configuring batch jobs with sensible defaults
and validation. The batch can be configured with cost limits, default parameters,
and progress callbacks.</p>

<p>Example:</p>

<pre><code><div class="pdoc-code codehilite">
<pre><span></span><code><span class="n">batch</span> <span class="o">=</span> <span class="n">Batch</span><span class="p">(</span><span class="s2">&quot;./results&quot;</span><span class="p">,</span> <span class="n">max_parallel_batches</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">items_per_batch</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    <span class="o">.</span><span class="n">set_state</span><span class="p">(</span><span class="n">file</span><span class="o">=</span><span class="s2">&quot;./state.json&quot;</span><span class="p">,</span> <span class="n">reuse_state</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="o">.</span><span class="n">set_default_params</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="s2">&quot;claude-sonnet-4-20250514&quot;</span><span class="p">,</span> <span class="n">temperature</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
    <span class="o">.</span><span class="n">add_cost_limit</span><span class="p">(</span><span class="n">usd</span><span class="o">=</span><span class="mf">15.0</span><span class="p">)</span>
    <span class="o">.</span><span class="n">add_job</span><span class="p">(</span><span class="n">messages</span><span class="o">=</span><span class="p">[{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="s2">&quot;Hello&quot;</span><span class="p">}])</span>
    <span class="o">.</span><span class="n">add_job</span><span class="p">(</span><span class="n">file</span><span class="o">=</span><span class="s2">&quot;./path/to/file.pdf&quot;</span><span class="p">,</span> <span class="n">prompt</span><span class="o">=</span><span class="s2">&quot;Generate summary of file&quot;</span><span class="p">)</span>

<span class="n">run</span> <span class="o">=</span> <span class="n">batch</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</code></pre>
</div>
</code></pre>
</div>


                            <div id="Batch.__init__" class="classattr">
                                        <input id="Batch.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">Batch</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">results_dir</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">max_parallel_batches</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span>,</span><span class="param">	<span class="n">items_per_batch</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span>,</span><span class="param">	<span class="n">raw_files</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></span>)</span>

                <label class="view-source-button" for="Batch.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Batch.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Batch.__init__-39"><a href="#Batch.__init__-39"><span class="linenos">39</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">results_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">max_parallel_batches</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">items_per_batch</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">raw_files</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
</span><span id="Batch.__init__-40"><a href="#Batch.__init__-40"><span class="linenos">40</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize batch configuration.</span>
</span><span id="Batch.__init__-41"><a href="#Batch.__init__-41"><span class="linenos">41</span></a><span class="sd">        </span>
</span><span id="Batch.__init__-42"><a href="#Batch.__init__-42"><span class="linenos">42</span></a><span class="sd">        Args:</span>
</span><span id="Batch.__init__-43"><a href="#Batch.__init__-43"><span class="linenos">43</span></a><span class="sd">            results_dir: Directory to store results</span>
</span><span id="Batch.__init__-44"><a href="#Batch.__init__-44"><span class="linenos">44</span></a><span class="sd">            max_parallel_batches: Maximum parallel batch requests</span>
</span><span id="Batch.__init__-45"><a href="#Batch.__init__-45"><span class="linenos">45</span></a><span class="sd">            items_per_batch: Number of jobs per provider batch</span>
</span><span id="Batch.__init__-46"><a href="#Batch.__init__-46"><span class="linenos">46</span></a><span class="sd">            raw_files: Whether to save debug files (raw responses, JSONL files) from providers (default: True if results_dir is set, False otherwise)</span>
</span><span id="Batch.__init__-47"><a href="#Batch.__init__-47"><span class="linenos">47</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Batch.__init__-48"><a href="#Batch.__init__-48"><span class="linenos">48</span></a>        <span class="c1"># Auto-determine raw_files based on results_dir if not explicitly set</span>
</span><span id="Batch.__init__-49"><a href="#Batch.__init__-49"><span class="linenos">49</span></a>        <span class="k">if</span> <span class="n">raw_files</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Batch.__init__-50"><a href="#Batch.__init__-50"><span class="linenos">50</span></a>            <span class="n">raw_files</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">results_dir</span> <span class="ow">and</span> <span class="n">results_dir</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
</span><span id="Batch.__init__-51"><a href="#Batch.__init__-51"><span class="linenos">51</span></a>        
</span><span id="Batch.__init__-52"><a href="#Batch.__init__-52"><span class="linenos">52</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">BatchParams</span><span class="p">(</span>
</span><span id="Batch.__init__-53"><a href="#Batch.__init__-53"><span class="linenos">53</span></a>            <span class="n">state_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="Batch.__init__-54"><a href="#Batch.__init__-54"><span class="linenos">54</span></a>            <span class="n">results_dir</span><span class="o">=</span><span class="n">results_dir</span><span class="p">,</span>
</span><span id="Batch.__init__-55"><a href="#Batch.__init__-55"><span class="linenos">55</span></a>            <span class="n">max_parallel_batches</span><span class="o">=</span><span class="n">max_parallel_batches</span><span class="p">,</span>
</span><span id="Batch.__init__-56"><a href="#Batch.__init__-56"><span class="linenos">56</span></a>            <span class="n">items_per_batch</span><span class="o">=</span><span class="n">items_per_batch</span><span class="p">,</span>
</span><span id="Batch.__init__-57"><a href="#Batch.__init__-57"><span class="linenos">57</span></a>            <span class="n">reuse_state</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="Batch.__init__-58"><a href="#Batch.__init__-58"><span class="linenos">58</span></a>            <span class="n">raw_files</span><span class="o">=</span><span class="n">raw_files</span>
</span><span id="Batch.__init__-59"><a href="#Batch.__init__-59"><span class="linenos">59</span></a>        <span class="p">)</span>
</span><span id="Batch.__init__-60"><a href="#Batch.__init__-60"><span class="linenos">60</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">jobs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Job</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
</span></pre></div>


            <div class="docstring"><p>Initialize batch configuration.</p>

<p>Args:
    results_dir: Directory to store results
    max_parallel_batches: Maximum parallel batch requests
    items_per_batch: Number of jobs per provider batch
    raw_files: Whether to save debug files (raw responses, JSONL files) from providers (default: True if results_dir is set, False otherwise)</p>
</div>


                            </div>
                            <div id="Batch.config" class="classattr">
                                <div class="attr variable">
            <span class="name">config</span>

        
    </div>
    <a class="headerlink" href="#Batch.config"></a>
    
    

                            </div>
                            <div id="Batch.jobs" class="classattr">
                                <div class="attr variable">
            <span class="name">jobs</span><span class="annotation">: List[<a href="#Job">Job</a>]</span>

        
    </div>
    <a class="headerlink" href="#Batch.jobs"></a>
    
    

                            </div>
                            <div id="Batch.set_default_params" class="classattr">
                                        <input id="Batch.set_default_params-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">set_default_params</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="o">**</span><span class="n">kwargs</span></span><span class="return-annotation">) -> <span class="n"><a href="#Batch">Batch</a></span>:</span></span>

                <label class="view-source-button" for="Batch.set_default_params-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Batch.set_default_params"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Batch.set_default_params-62"><a href="#Batch.set_default_params-62"><span class="linenos">62</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">set_default_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;Batch&#39;</span><span class="p">:</span>
</span><span id="Batch.set_default_params-63"><a href="#Batch.set_default_params-63"><span class="linenos">63</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Set default parameters for all jobs.</span>
</span><span id="Batch.set_default_params-64"><a href="#Batch.set_default_params-64"><span class="linenos">64</span></a><span class="sd">        </span>
</span><span id="Batch.set_default_params-65"><a href="#Batch.set_default_params-65"><span class="linenos">65</span></a><span class="sd">        These defaults will be applied to all jobs unless overridden</span>
</span><span id="Batch.set_default_params-66"><a href="#Batch.set_default_params-66"><span class="linenos">66</span></a><span class="sd">        by job-specific parameters.</span>
</span><span id="Batch.set_default_params-67"><a href="#Batch.set_default_params-67"><span class="linenos">67</span></a><span class="sd">        </span>
</span><span id="Batch.set_default_params-68"><a href="#Batch.set_default_params-68"><span class="linenos">68</span></a><span class="sd">        Args:</span>
</span><span id="Batch.set_default_params-69"><a href="#Batch.set_default_params-69"><span class="linenos">69</span></a><span class="sd">            **kwargs: Default parameters (model, temperature, max_tokens, etc.)</span>
</span><span id="Batch.set_default_params-70"><a href="#Batch.set_default_params-70"><span class="linenos">70</span></a><span class="sd">            </span>
</span><span id="Batch.set_default_params-71"><a href="#Batch.set_default_params-71"><span class="linenos">71</span></a><span class="sd">        Returns:</span>
</span><span id="Batch.set_default_params-72"><a href="#Batch.set_default_params-72"><span class="linenos">72</span></a><span class="sd">            Self for chaining</span>
</span><span id="Batch.set_default_params-73"><a href="#Batch.set_default_params-73"><span class="linenos">73</span></a><span class="sd">            </span>
</span><span id="Batch.set_default_params-74"><a href="#Batch.set_default_params-74"><span class="linenos">74</span></a><span class="sd">        Example:</span>
</span><span id="Batch.set_default_params-75"><a href="#Batch.set_default_params-75"><span class="linenos">75</span></a><span class="sd">            ```python</span>
</span><span id="Batch.set_default_params-76"><a href="#Batch.set_default_params-76"><span class="linenos">76</span></a><span class="sd">            batch.set_default_params(model=&quot;claude-3-sonnet&quot;, temperature=0.7)</span>
</span><span id="Batch.set_default_params-77"><a href="#Batch.set_default_params-77"><span class="linenos">77</span></a><span class="sd">            ```</span>
</span><span id="Batch.set_default_params-78"><a href="#Batch.set_default_params-78"><span class="linenos">78</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Batch.set_default_params-79"><a href="#Batch.set_default_params-79"><span class="linenos">79</span></a>        <span class="c1"># Validate if model is provided</span>
</span><span id="Batch.set_default_params-80"><a href="#Batch.set_default_params-80"><span class="linenos">80</span></a>        <span class="k">if</span> <span class="s2">&quot;model&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
</span><span id="Batch.set_default_params-81"><a href="#Batch.set_default_params-81"><span class="linenos">81</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">validate_default_params</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;model&quot;</span><span class="p">])</span>
</span><span id="Batch.set_default_params-82"><a href="#Batch.set_default_params-82"><span class="linenos">82</span></a>        
</span><span id="Batch.set_default_params-83"><a href="#Batch.set_default_params-83"><span class="linenos">83</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">default_params</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="Batch.set_default_params-84"><a href="#Batch.set_default_params-84"><span class="linenos">84</span></a>        <span class="k">return</span> <span class="bp">self</span>
</span></pre></div>


            <div class="docstring"><p>Set default parameters for all jobs.</p>

<p>These defaults will be applied to all jobs unless overridden
by job-specific parameters.</p>

<p>Args:
    **kwargs: Default parameters (model, temperature, max_tokens, etc.)</p>

<p>Returns:
    Self for chaining</p>

<p>Example:</p>

<pre><code><div class="pdoc-code codehilite">
<pre><span></span><code><span class="n">batch</span><span class="o">.</span><span class="n">set_default_params</span><span class="p">(</span><span class="n">model</span><span class="o">=</span><span class="s2">&quot;claude-3-sonnet&quot;</span><span class="p">,</span> <span class="n">temperature</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
</code></pre>
</div>
</code></pre>
</div>


                            </div>
                            <div id="Batch.set_state" class="classattr">
                                        <input id="Batch.set_state-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">set_state</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">file</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">reuse_state</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span></span><span class="return-annotation">) -> <span class="n"><a href="#Batch">Batch</a></span>:</span></span>

                <label class="view-source-button" for="Batch.set_state-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Batch.set_state"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Batch.set_state-86"><a href="#Batch.set_state-86"><span class="linenos"> 86</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">set_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">reuse_state</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;Batch&#39;</span><span class="p">:</span>
</span><span id="Batch.set_state-87"><a href="#Batch.set_state-87"><span class="linenos"> 87</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Set state file configuration.</span>
</span><span id="Batch.set_state-88"><a href="#Batch.set_state-88"><span class="linenos"> 88</span></a><span class="sd">        </span>
</span><span id="Batch.set_state-89"><a href="#Batch.set_state-89"><span class="linenos"> 89</span></a><span class="sd">        Args:</span>
</span><span id="Batch.set_state-90"><a href="#Batch.set_state-90"><span class="linenos"> 90</span></a><span class="sd">            file: Path to state file for persistence (default: None)</span>
</span><span id="Batch.set_state-91"><a href="#Batch.set_state-91"><span class="linenos"> 91</span></a><span class="sd">            reuse_state: Whether to resume from existing state file (default: True)</span>
</span><span id="Batch.set_state-92"><a href="#Batch.set_state-92"><span class="linenos"> 92</span></a><span class="sd">            </span>
</span><span id="Batch.set_state-93"><a href="#Batch.set_state-93"><span class="linenos"> 93</span></a><span class="sd">        Returns:</span>
</span><span id="Batch.set_state-94"><a href="#Batch.set_state-94"><span class="linenos"> 94</span></a><span class="sd">            Self for chaining</span>
</span><span id="Batch.set_state-95"><a href="#Batch.set_state-95"><span class="linenos"> 95</span></a><span class="sd">            </span>
</span><span id="Batch.set_state-96"><a href="#Batch.set_state-96"><span class="linenos"> 96</span></a><span class="sd">        Example:</span>
</span><span id="Batch.set_state-97"><a href="#Batch.set_state-97"><span class="linenos"> 97</span></a><span class="sd">            ```python</span>
</span><span id="Batch.set_state-98"><a href="#Batch.set_state-98"><span class="linenos"> 98</span></a><span class="sd">            batch.set_state(file=&quot;./state.json&quot;, reuse_state=True)</span>
</span><span id="Batch.set_state-99"><a href="#Batch.set_state-99"><span class="linenos"> 99</span></a><span class="sd">            ```</span>
</span><span id="Batch.set_state-100"><a href="#Batch.set_state-100"><span class="linenos">100</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Batch.set_state-101"><a href="#Batch.set_state-101"><span class="linenos">101</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">state_file</span> <span class="o">=</span> <span class="n">file</span>
</span><span id="Batch.set_state-102"><a href="#Batch.set_state-102"><span class="linenos">102</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">reuse_state</span> <span class="o">=</span> <span class="n">reuse_state</span>
</span><span id="Batch.set_state-103"><a href="#Batch.set_state-103"><span class="linenos">103</span></a>        <span class="k">return</span> <span class="bp">self</span>
</span></pre></div>


            <div class="docstring"><p>Set state file configuration.</p>

<p>Args:
    file: Path to state file for persistence (default: None)
    reuse_state: Whether to resume from existing state file (default: True)</p>

<p>Returns:
    Self for chaining</p>

<p>Example:</p>

<pre><code><div class="pdoc-code codehilite">
<pre><span></span><code><span class="n">batch</span><span class="o">.</span><span class="n">set_state</span><span class="p">(</span><span class="n">file</span><span class="o">=</span><span class="s2">&quot;./state.json&quot;</span><span class="p">,</span> <span class="n">reuse_state</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre>
</div>
</code></pre>
</div>


                            </div>
                            <div id="Batch.add_cost_limit" class="classattr">
                                        <input id="Batch.add_cost_limit-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">add_cost_limit</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">usd</span><span class="p">:</span> <span class="nb">float</span></span><span class="return-annotation">) -> <span class="n"><a href="#Batch">Batch</a></span>:</span></span>

                <label class="view-source-button" for="Batch.add_cost_limit-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Batch.add_cost_limit"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Batch.add_cost_limit-105"><a href="#Batch.add_cost_limit-105"><span class="linenos">105</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">add_cost_limit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">usd</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;Batch&#39;</span><span class="p">:</span>
</span><span id="Batch.add_cost_limit-106"><a href="#Batch.add_cost_limit-106"><span class="linenos">106</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Add cost limit for the batch.</span>
</span><span id="Batch.add_cost_limit-107"><a href="#Batch.add_cost_limit-107"><span class="linenos">107</span></a><span class="sd">        </span>
</span><span id="Batch.add_cost_limit-108"><a href="#Batch.add_cost_limit-108"><span class="linenos">108</span></a><span class="sd">        The batch will stop accepting new jobs once the cost limit is reached.</span>
</span><span id="Batch.add_cost_limit-109"><a href="#Batch.add_cost_limit-109"><span class="linenos">109</span></a><span class="sd">        Active jobs will be allowed to complete.</span>
</span><span id="Batch.add_cost_limit-110"><a href="#Batch.add_cost_limit-110"><span class="linenos">110</span></a><span class="sd">        </span>
</span><span id="Batch.add_cost_limit-111"><a href="#Batch.add_cost_limit-111"><span class="linenos">111</span></a><span class="sd">        Args:</span>
</span><span id="Batch.add_cost_limit-112"><a href="#Batch.add_cost_limit-112"><span class="linenos">112</span></a><span class="sd">            usd: Cost limit in USD</span>
</span><span id="Batch.add_cost_limit-113"><a href="#Batch.add_cost_limit-113"><span class="linenos">113</span></a><span class="sd">            </span>
</span><span id="Batch.add_cost_limit-114"><a href="#Batch.add_cost_limit-114"><span class="linenos">114</span></a><span class="sd">        Returns:</span>
</span><span id="Batch.add_cost_limit-115"><a href="#Batch.add_cost_limit-115"><span class="linenos">115</span></a><span class="sd">            Self for chaining</span>
</span><span id="Batch.add_cost_limit-116"><a href="#Batch.add_cost_limit-116"><span class="linenos">116</span></a><span class="sd">            </span>
</span><span id="Batch.add_cost_limit-117"><a href="#Batch.add_cost_limit-117"><span class="linenos">117</span></a><span class="sd">        Example:</span>
</span><span id="Batch.add_cost_limit-118"><a href="#Batch.add_cost_limit-118"><span class="linenos">118</span></a><span class="sd">            ```python</span>
</span><span id="Batch.add_cost_limit-119"><a href="#Batch.add_cost_limit-119"><span class="linenos">119</span></a><span class="sd">            batch.add_cost_limit(usd=50.0)</span>
</span><span id="Batch.add_cost_limit-120"><a href="#Batch.add_cost_limit-120"><span class="linenos">120</span></a><span class="sd">            ```</span>
</span><span id="Batch.add_cost_limit-121"><a href="#Batch.add_cost_limit-121"><span class="linenos">121</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Batch.add_cost_limit-122"><a href="#Batch.add_cost_limit-122"><span class="linenos">122</span></a>        <span class="k">if</span> <span class="n">usd</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Batch.add_cost_limit-123"><a href="#Batch.add_cost_limit-123"><span class="linenos">123</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cost limit must be positive&quot;</span><span class="p">)</span>
</span><span id="Batch.add_cost_limit-124"><a href="#Batch.add_cost_limit-124"><span class="linenos">124</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">cost_limit_usd</span> <span class="o">=</span> <span class="n">usd</span>
</span><span id="Batch.add_cost_limit-125"><a href="#Batch.add_cost_limit-125"><span class="linenos">125</span></a>        <span class="k">return</span> <span class="bp">self</span>
</span></pre></div>


            <div class="docstring"><p>Add cost limit for the batch.</p>

<p>The batch will stop accepting new jobs once the cost limit is reached.
Active jobs will be allowed to complete.</p>

<p>Args:
    usd: Cost limit in USD</p>

<p>Returns:
    Self for chaining</p>

<p>Example:</p>

<pre><code><div class="pdoc-code codehilite">
<pre><span></span><code><span class="n">batch</span><span class="o">.</span><span class="n">add_cost_limit</span><span class="p">(</span><span class="n">usd</span><span class="o">=</span><span class="mf">50.0</span><span class="p">)</span>
</code></pre>
</div>
</code></pre>
</div>


                            </div>
                            <div id="Batch.raw_files" class="classattr">
                                        <input id="Batch.raw_files-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">raw_files</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">enabled</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span></span><span class="return-annotation">) -> <span class="n"><a href="#Batch">Batch</a></span>:</span></span>

                <label class="view-source-button" for="Batch.raw_files-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Batch.raw_files"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Batch.raw_files-127"><a href="#Batch.raw_files-127"><span class="linenos">127</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">raw_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">enabled</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;Batch&#39;</span><span class="p">:</span>
</span><span id="Batch.raw_files-128"><a href="#Batch.raw_files-128"><span class="linenos">128</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Enable or disable saving debug files from providers.</span>
</span><span id="Batch.raw_files-129"><a href="#Batch.raw_files-129"><span class="linenos">129</span></a><span class="sd">        </span>
</span><span id="Batch.raw_files-130"><a href="#Batch.raw_files-130"><span class="linenos">130</span></a><span class="sd">        When enabled, debug files (raw API responses, JSONL files) will be saved</span>
</span><span id="Batch.raw_files-131"><a href="#Batch.raw_files-131"><span class="linenos">131</span></a><span class="sd">        in a &#39;raw_files&#39; subdirectory within the results directory.</span>
</span><span id="Batch.raw_files-132"><a href="#Batch.raw_files-132"><span class="linenos">132</span></a><span class="sd">        This is useful for debugging, auditing, or accessing provider-specific metadata.</span>
</span><span id="Batch.raw_files-133"><a href="#Batch.raw_files-133"><span class="linenos">133</span></a><span class="sd">        </span>
</span><span id="Batch.raw_files-134"><a href="#Batch.raw_files-134"><span class="linenos">134</span></a><span class="sd">        Args:</span>
</span><span id="Batch.raw_files-135"><a href="#Batch.raw_files-135"><span class="linenos">135</span></a><span class="sd">            enabled: Whether to save debug files (default: True)</span>
</span><span id="Batch.raw_files-136"><a href="#Batch.raw_files-136"><span class="linenos">136</span></a><span class="sd">            </span>
</span><span id="Batch.raw_files-137"><a href="#Batch.raw_files-137"><span class="linenos">137</span></a><span class="sd">        Returns:</span>
</span><span id="Batch.raw_files-138"><a href="#Batch.raw_files-138"><span class="linenos">138</span></a><span class="sd">            Self for chaining</span>
</span><span id="Batch.raw_files-139"><a href="#Batch.raw_files-139"><span class="linenos">139</span></a><span class="sd">            </span>
</span><span id="Batch.raw_files-140"><a href="#Batch.raw_files-140"><span class="linenos">140</span></a><span class="sd">        Example:</span>
</span><span id="Batch.raw_files-141"><a href="#Batch.raw_files-141"><span class="linenos">141</span></a><span class="sd">            ```python</span>
</span><span id="Batch.raw_files-142"><a href="#Batch.raw_files-142"><span class="linenos">142</span></a><span class="sd">            batch.raw_files(True)</span>
</span><span id="Batch.raw_files-143"><a href="#Batch.raw_files-143"><span class="linenos">143</span></a><span class="sd">            ```</span>
</span><span id="Batch.raw_files-144"><a href="#Batch.raw_files-144"><span class="linenos">144</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Batch.raw_files-145"><a href="#Batch.raw_files-145"><span class="linenos">145</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">raw_files</span> <span class="o">=</span> <span class="n">enabled</span>
</span><span id="Batch.raw_files-146"><a href="#Batch.raw_files-146"><span class="linenos">146</span></a>        <span class="k">return</span> <span class="bp">self</span>
</span></pre></div>


            <div class="docstring"><p>Enable or disable saving debug files from providers.</p>

<p>When enabled, debug files (raw API responses, JSONL files) will be saved
in a 'raw_files' subdirectory within the results directory.
This is useful for debugging, auditing, or accessing provider-specific metadata.</p>

<p>Args:
    enabled: Whether to save debug files (default: True)</p>

<p>Returns:
    Self for chaining</p>

<p>Example:</p>

<pre><code><div class="pdoc-code codehilite">
<pre><span></span><code><span class="n">batch</span><span class="o">.</span><span class="n">raw_files</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</code></pre>
</div>
</code></pre>
</div>


                            </div>
                            <div id="Batch.set_verbosity" class="classattr">
                                        <input id="Batch.set_verbosity-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">set_verbosity</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">level</span><span class="p">:</span> <span class="nb">str</span></span><span class="return-annotation">) -> <span class="n"><a href="#Batch">Batch</a></span>:</span></span>

                <label class="view-source-button" for="Batch.set_verbosity-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Batch.set_verbosity"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Batch.set_verbosity-148"><a href="#Batch.set_verbosity-148"><span class="linenos">148</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">set_verbosity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">level</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;Batch&#39;</span><span class="p">:</span>
</span><span id="Batch.set_verbosity-149"><a href="#Batch.set_verbosity-149"><span class="linenos">149</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Set logging verbosity level.</span>
</span><span id="Batch.set_verbosity-150"><a href="#Batch.set_verbosity-150"><span class="linenos">150</span></a><span class="sd">        </span>
</span><span id="Batch.set_verbosity-151"><a href="#Batch.set_verbosity-151"><span class="linenos">151</span></a><span class="sd">        Args:</span>
</span><span id="Batch.set_verbosity-152"><a href="#Batch.set_verbosity-152"><span class="linenos">152</span></a><span class="sd">            level: Verbosity level (&quot;debug&quot;, &quot;info&quot;, &quot;warn&quot;, &quot;error&quot;)</span>
</span><span id="Batch.set_verbosity-153"><a href="#Batch.set_verbosity-153"><span class="linenos">153</span></a><span class="sd">            </span>
</span><span id="Batch.set_verbosity-154"><a href="#Batch.set_verbosity-154"><span class="linenos">154</span></a><span class="sd">        Returns:</span>
</span><span id="Batch.set_verbosity-155"><a href="#Batch.set_verbosity-155"><span class="linenos">155</span></a><span class="sd">            Self for chaining</span>
</span><span id="Batch.set_verbosity-156"><a href="#Batch.set_verbosity-156"><span class="linenos">156</span></a><span class="sd">            </span>
</span><span id="Batch.set_verbosity-157"><a href="#Batch.set_verbosity-157"><span class="linenos">157</span></a><span class="sd">        Example:</span>
</span><span id="Batch.set_verbosity-158"><a href="#Batch.set_verbosity-158"><span class="linenos">158</span></a><span class="sd">            ```python</span>
</span><span id="Batch.set_verbosity-159"><a href="#Batch.set_verbosity-159"><span class="linenos">159</span></a><span class="sd">            batch.set_verbosity(&quot;error&quot;)  # For production</span>
</span><span id="Batch.set_verbosity-160"><a href="#Batch.set_verbosity-160"><span class="linenos">160</span></a><span class="sd">            batch.set_verbosity(&quot;debug&quot;)  # For debugging</span>
</span><span id="Batch.set_verbosity-161"><a href="#Batch.set_verbosity-161"><span class="linenos">161</span></a><span class="sd">            ```</span>
</span><span id="Batch.set_verbosity-162"><a href="#Batch.set_verbosity-162"><span class="linenos">162</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Batch.set_verbosity-163"><a href="#Batch.set_verbosity-163"><span class="linenos">163</span></a>        <span class="n">valid_levels</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;debug&quot;</span><span class="p">,</span> <span class="s2">&quot;info&quot;</span><span class="p">,</span> <span class="s2">&quot;warn&quot;</span><span class="p">,</span> <span class="s2">&quot;error&quot;</span><span class="p">}</span>
</span><span id="Batch.set_verbosity-164"><a href="#Batch.set_verbosity-164"><span class="linenos">164</span></a>        <span class="k">if</span> <span class="n">level</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">valid_levels</span><span class="p">:</span>
</span><span id="Batch.set_verbosity-165"><a href="#Batch.set_verbosity-165"><span class="linenos">165</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid verbosity level: </span><span class="si">{</span><span class="n">level</span><span class="si">}</span><span class="s2">. Must be one of </span><span class="si">{</span><span class="n">valid_levels</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Batch.set_verbosity-166"><a href="#Batch.set_verbosity-166"><span class="linenos">166</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">verbosity</span> <span class="o">=</span> <span class="n">level</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
</span><span id="Batch.set_verbosity-167"><a href="#Batch.set_verbosity-167"><span class="linenos">167</span></a>        <span class="k">return</span> <span class="bp">self</span>
</span></pre></div>


            <div class="docstring"><p>Set logging verbosity level.</p>

<p>Args:
    level: Verbosity level ("debug", "info", "warn", "error")</p>

<p>Returns:
    Self for chaining</p>

<p>Example:</p>

<pre><code><div class="pdoc-code codehilite">
<pre><span></span><code><span class="n">batch</span><span class="o">.</span><span class="n">set_verbosity</span><span class="p">(</span><span class="s2">&quot;error&quot;</span><span class="p">)</span>  <span class="c1"># For production</span>
<span class="n">batch</span><span class="o">.</span><span class="n">set_verbosity</span><span class="p">(</span><span class="s2">&quot;debug&quot;</span><span class="p">)</span>  <span class="c1"># For debugging</span>
</code></pre>
</div>
</code></pre>
</div>


                            </div>
                            <div id="Batch.add_time_limit" class="classattr">
                                        <input id="Batch.add_time_limit-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">add_time_limit</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">seconds</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">minutes</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">hours</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></span><span class="return-annotation">) -> <span class="n"><a href="#Batch">Batch</a></span>:</span></span>

                <label class="view-source-button" for="Batch.add_time_limit-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Batch.add_time_limit"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Batch.add_time_limit-169"><a href="#Batch.add_time_limit-169"><span class="linenos">169</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">add_time_limit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seconds</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">minutes</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">hours</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;Batch&#39;</span><span class="p">:</span>
</span><span id="Batch.add_time_limit-170"><a href="#Batch.add_time_limit-170"><span class="linenos">170</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Add time limit for the entire batch execution.</span>
</span><span id="Batch.add_time_limit-171"><a href="#Batch.add_time_limit-171"><span class="linenos">171</span></a><span class="sd">        </span>
</span><span id="Batch.add_time_limit-172"><a href="#Batch.add_time_limit-172"><span class="linenos">172</span></a><span class="sd">        When time limit is reached, all active provider batches are cancelled and </span>
</span><span id="Batch.add_time_limit-173"><a href="#Batch.add_time_limit-173"><span class="linenos">173</span></a><span class="sd">        remaining unprocessed jobs are marked as failed. The batch execution </span>
</span><span id="Batch.add_time_limit-174"><a href="#Batch.add_time_limit-174"><span class="linenos">174</span></a><span class="sd">        completes normally without throwing exceptions.</span>
</span><span id="Batch.add_time_limit-175"><a href="#Batch.add_time_limit-175"><span class="linenos">175</span></a><span class="sd">        </span>
</span><span id="Batch.add_time_limit-176"><a href="#Batch.add_time_limit-176"><span class="linenos">176</span></a><span class="sd">        Args:</span>
</span><span id="Batch.add_time_limit-177"><a href="#Batch.add_time_limit-177"><span class="linenos">177</span></a><span class="sd">            seconds: Time limit in seconds (optional)</span>
</span><span id="Batch.add_time_limit-178"><a href="#Batch.add_time_limit-178"><span class="linenos">178</span></a><span class="sd">            minutes: Time limit in minutes (optional)</span>
</span><span id="Batch.add_time_limit-179"><a href="#Batch.add_time_limit-179"><span class="linenos">179</span></a><span class="sd">            hours: Time limit in hours (optional)</span>
</span><span id="Batch.add_time_limit-180"><a href="#Batch.add_time_limit-180"><span class="linenos">180</span></a><span class="sd">            </span>
</span><span id="Batch.add_time_limit-181"><a href="#Batch.add_time_limit-181"><span class="linenos">181</span></a><span class="sd">        Returns:</span>
</span><span id="Batch.add_time_limit-182"><a href="#Batch.add_time_limit-182"><span class="linenos">182</span></a><span class="sd">            Self for chaining</span>
</span><span id="Batch.add_time_limit-183"><a href="#Batch.add_time_limit-183"><span class="linenos">183</span></a><span class="sd">            </span>
</span><span id="Batch.add_time_limit-184"><a href="#Batch.add_time_limit-184"><span class="linenos">184</span></a><span class="sd">        Raises:</span>
</span><span id="Batch.add_time_limit-185"><a href="#Batch.add_time_limit-185"><span class="linenos">185</span></a><span class="sd">            ValueError: If no time units specified, or if total time is outside </span>
</span><span id="Batch.add_time_limit-186"><a href="#Batch.add_time_limit-186"><span class="linenos">186</span></a><span class="sd">                       valid range (min: 10 seconds, max: 24 hours)</span>
</span><span id="Batch.add_time_limit-187"><a href="#Batch.add_time_limit-187"><span class="linenos">187</span></a><span class="sd">            </span>
</span><span id="Batch.add_time_limit-188"><a href="#Batch.add_time_limit-188"><span class="linenos">188</span></a><span class="sd">        Note:</span>
</span><span id="Batch.add_time_limit-189"><a href="#Batch.add_time_limit-189"><span class="linenos">189</span></a><span class="sd">            - Can combine multiple time units</span>
</span><span id="Batch.add_time_limit-190"><a href="#Batch.add_time_limit-190"><span class="linenos">190</span></a><span class="sd">            - Time limit is checked every second by a background watchdog thread</span>
</span><span id="Batch.add_time_limit-191"><a href="#Batch.add_time_limit-191"><span class="linenos">191</span></a><span class="sd">            - Jobs that exceed time limit appear in results()[&quot;failed&quot;] with time limit error message</span>
</span><span id="Batch.add_time_limit-192"><a href="#Batch.add_time_limit-192"><span class="linenos">192</span></a><span class="sd">            - No exceptions are thrown when time limit is reached</span>
</span><span id="Batch.add_time_limit-193"><a href="#Batch.add_time_limit-193"><span class="linenos">193</span></a><span class="sd">            </span>
</span><span id="Batch.add_time_limit-194"><a href="#Batch.add_time_limit-194"><span class="linenos">194</span></a><span class="sd">        Example:</span>
</span><span id="Batch.add_time_limit-195"><a href="#Batch.add_time_limit-195"><span class="linenos">195</span></a><span class="sd">            ```python</span>
</span><span id="Batch.add_time_limit-196"><a href="#Batch.add_time_limit-196"><span class="linenos">196</span></a><span class="sd">            batch.add_time_limit(seconds=30)  # 30 seconds</span>
</span><span id="Batch.add_time_limit-197"><a href="#Batch.add_time_limit-197"><span class="linenos">197</span></a><span class="sd">            batch.add_time_limit(minutes=5)   # 5 minutes</span>
</span><span id="Batch.add_time_limit-198"><a href="#Batch.add_time_limit-198"><span class="linenos">198</span></a><span class="sd">            batch.add_time_limit(hours=2)     # 2 hours</span>
</span><span id="Batch.add_time_limit-199"><a href="#Batch.add_time_limit-199"><span class="linenos">199</span></a><span class="sd">            batch.add_time_limit(hours=1, minutes=30, seconds=15)  # 5415 seconds total</span>
</span><span id="Batch.add_time_limit-200"><a href="#Batch.add_time_limit-200"><span class="linenos">200</span></a><span class="sd">            ```</span>
</span><span id="Batch.add_time_limit-201"><a href="#Batch.add_time_limit-201"><span class="linenos">201</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Batch.add_time_limit-202"><a href="#Batch.add_time_limit-202"><span class="linenos">202</span></a>        <span class="n">time_limit_seconds</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="Batch.add_time_limit-203"><a href="#Batch.add_time_limit-203"><span class="linenos">203</span></a>        
</span><span id="Batch.add_time_limit-204"><a href="#Batch.add_time_limit-204"><span class="linenos">204</span></a>        <span class="k">if</span> <span class="n">seconds</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Batch.add_time_limit-205"><a href="#Batch.add_time_limit-205"><span class="linenos">205</span></a>            <span class="n">time_limit_seconds</span> <span class="o">+=</span> <span class="n">seconds</span>
</span><span id="Batch.add_time_limit-206"><a href="#Batch.add_time_limit-206"><span class="linenos">206</span></a>        <span class="k">if</span> <span class="n">minutes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Batch.add_time_limit-207"><a href="#Batch.add_time_limit-207"><span class="linenos">207</span></a>            <span class="n">time_limit_seconds</span> <span class="o">+=</span> <span class="n">minutes</span> <span class="o">*</span> <span class="mi">60</span>
</span><span id="Batch.add_time_limit-208"><a href="#Batch.add_time_limit-208"><span class="linenos">208</span></a>        <span class="k">if</span> <span class="n">hours</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Batch.add_time_limit-209"><a href="#Batch.add_time_limit-209"><span class="linenos">209</span></a>            <span class="n">time_limit_seconds</span> <span class="o">+=</span> <span class="n">hours</span> <span class="o">*</span> <span class="mi">3600</span>
</span><span id="Batch.add_time_limit-210"><a href="#Batch.add_time_limit-210"><span class="linenos">210</span></a>            
</span><span id="Batch.add_time_limit-211"><a href="#Batch.add_time_limit-211"><span class="linenos">211</span></a>        <span class="k">if</span> <span class="n">time_limit_seconds</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="Batch.add_time_limit-212"><a href="#Batch.add_time_limit-212"><span class="linenos">212</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Must specify at least one of seconds, minutes, or hours&quot;</span><span class="p">)</span>
</span><span id="Batch.add_time_limit-213"><a href="#Batch.add_time_limit-213"><span class="linenos">213</span></a>            
</span><span id="Batch.add_time_limit-214"><a href="#Batch.add_time_limit-214"><span class="linenos">214</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">time_limit_seconds</span> <span class="o">=</span> <span class="n">time_limit_seconds</span>
</span><span id="Batch.add_time_limit-215"><a href="#Batch.add_time_limit-215"><span class="linenos">215</span></a>        <span class="k">return</span> <span class="bp">self</span>
</span></pre></div>


            <div class="docstring"><p>Add time limit for the entire batch execution.</p>

<p>When time limit is reached, all active provider batches are cancelled and 
remaining unprocessed jobs are marked as failed. The batch execution 
completes normally without throwing exceptions.</p>

<p>Args:
    seconds: Time limit in seconds (optional)
    minutes: Time limit in minutes (optional)
    hours: Time limit in hours (optional)</p>

<p>Returns:
    Self for chaining</p>

<p>Raises:
    ValueError: If no time units specified, or if total time is outside 
               valid range (min: 10 seconds, max: 24 hours)</p>

<p>Note:
    - Can combine multiple time units
    - Time limit is checked every second by a background watchdog thread
    - Jobs that exceed time limit appear in results()["failed"] with time limit error message
    - No exceptions are thrown when time limit is reached</p>

<p>Example:</p>

<pre><code><div class="pdoc-code codehilite">
<pre><span></span><code><span class="n">batch</span><span class="o">.</span><span class="n">add_time_limit</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>  <span class="c1"># 30 seconds</span>
<span class="n">batch</span><span class="o">.</span><span class="n">add_time_limit</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>   <span class="c1"># 5 minutes</span>
<span class="n">batch</span><span class="o">.</span><span class="n">add_time_limit</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>     <span class="c1"># 2 hours</span>
<span class="n">batch</span><span class="o">.</span><span class="n">add_time_limit</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">minutes</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">seconds</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>  <span class="c1"># 5415 seconds total</span>
</code></pre>
</div>
</code></pre>
</div>


                            </div>
                            <div id="Batch.add_job" class="classattr">
                                        <input id="Batch.add_job-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">add_job</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">messages</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">file</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">,</span> <span class="n">NoneType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">prompt</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">model</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">temperature</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">max_tokens</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">response_model</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="n">pydantic</span><span class="o">.</span><span class="n">main</span><span class="o">.</span><span class="n">BaseModel</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">enable_citations</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>,</span><span class="param">	<span class="o">**</span><span class="n">kwargs</span></span><span class="return-annotation">) -> <span class="n"><a href="#Batch">Batch</a></span>:</span></span>

                <label class="view-source-button" for="Batch.add_job-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Batch.add_job"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Batch.add_job-217"><a href="#Batch.add_job-217"><span class="linenos">217</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">add_job</span><span class="p">(</span>
</span><span id="Batch.add_job-218"><a href="#Batch.add_job-218"><span class="linenos">218</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="Batch.add_job-219"><a href="#Batch.add_job-219"><span class="linenos">219</span></a>        <span class="n">messages</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Message</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Batch.add_job-220"><a href="#Batch.add_job-220"><span class="linenos">220</span></a>        <span class="n">file</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Path</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Batch.add_job-221"><a href="#Batch.add_job-221"><span class="linenos">221</span></a>        <span class="n">prompt</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Batch.add_job-222"><a href="#Batch.add_job-222"><span class="linenos">222</span></a>        <span class="n">model</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Batch.add_job-223"><a href="#Batch.add_job-223"><span class="linenos">223</span></a>        <span class="n">temperature</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Batch.add_job-224"><a href="#Batch.add_job-224"><span class="linenos">224</span></a>        <span class="n">max_tokens</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Batch.add_job-225"><a href="#Batch.add_job-225"><span class="linenos">225</span></a>        <span class="n">response_model</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="n">BaseModel</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Batch.add_job-226"><a href="#Batch.add_job-226"><span class="linenos">226</span></a>        <span class="n">enable_citations</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="Batch.add_job-227"><a href="#Batch.add_job-227"><span class="linenos">227</span></a>        <span class="o">**</span><span class="n">kwargs</span>
</span><span id="Batch.add_job-228"><a href="#Batch.add_job-228"><span class="linenos">228</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;Batch&#39;</span><span class="p">:</span>
</span><span id="Batch.add_job-229"><a href="#Batch.add_job-229"><span class="linenos">229</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Add a job to the batch.</span>
</span><span id="Batch.add_job-230"><a href="#Batch.add_job-230"><span class="linenos">230</span></a><span class="sd">        </span>
</span><span id="Batch.add_job-231"><a href="#Batch.add_job-231"><span class="linenos">231</span></a><span class="sd">        Either provide messages OR file+prompt, not both. Parameters not provided</span>
</span><span id="Batch.add_job-232"><a href="#Batch.add_job-232"><span class="linenos">232</span></a><span class="sd">        will use the defaults set via the defaults() method.</span>
</span><span id="Batch.add_job-233"><a href="#Batch.add_job-233"><span class="linenos">233</span></a><span class="sd">        </span>
</span><span id="Batch.add_job-234"><a href="#Batch.add_job-234"><span class="linenos">234</span></a><span class="sd">        Args:</span>
</span><span id="Batch.add_job-235"><a href="#Batch.add_job-235"><span class="linenos">235</span></a><span class="sd">            messages: Chat messages for direct input</span>
</span><span id="Batch.add_job-236"><a href="#Batch.add_job-236"><span class="linenos">236</span></a><span class="sd">            file: File path for file-based input</span>
</span><span id="Batch.add_job-237"><a href="#Batch.add_job-237"><span class="linenos">237</span></a><span class="sd">            prompt: Prompt to use with file input</span>
</span><span id="Batch.add_job-238"><a href="#Batch.add_job-238"><span class="linenos">238</span></a><span class="sd">            model: Model to use (overrides default)</span>
</span><span id="Batch.add_job-239"><a href="#Batch.add_job-239"><span class="linenos">239</span></a><span class="sd">            temperature: Sampling temperature (overrides default)</span>
</span><span id="Batch.add_job-240"><a href="#Batch.add_job-240"><span class="linenos">240</span></a><span class="sd">            max_tokens: Max tokens to generate (overrides default)</span>
</span><span id="Batch.add_job-241"><a href="#Batch.add_job-241"><span class="linenos">241</span></a><span class="sd">            response_model: Pydantic model for structured output</span>
</span><span id="Batch.add_job-242"><a href="#Batch.add_job-242"><span class="linenos">242</span></a><span class="sd">            enable_citations: Whether to extract citations</span>
</span><span id="Batch.add_job-243"><a href="#Batch.add_job-243"><span class="linenos">243</span></a><span class="sd">            **kwargs: Additional parameters</span>
</span><span id="Batch.add_job-244"><a href="#Batch.add_job-244"><span class="linenos">244</span></a><span class="sd">            </span>
</span><span id="Batch.add_job-245"><a href="#Batch.add_job-245"><span class="linenos">245</span></a><span class="sd">        Returns:</span>
</span><span id="Batch.add_job-246"><a href="#Batch.add_job-246"><span class="linenos">246</span></a><span class="sd">            Self for chaining</span>
</span><span id="Batch.add_job-247"><a href="#Batch.add_job-247"><span class="linenos">247</span></a><span class="sd">            </span>
</span><span id="Batch.add_job-248"><a href="#Batch.add_job-248"><span class="linenos">248</span></a><span class="sd">        Example:</span>
</span><span id="Batch.add_job-249"><a href="#Batch.add_job-249"><span class="linenos">249</span></a><span class="sd">            ```python</span>
</span><span id="Batch.add_job-250"><a href="#Batch.add_job-250"><span class="linenos">250</span></a><span class="sd">            batch.add_job(</span>
</span><span id="Batch.add_job-251"><a href="#Batch.add_job-251"><span class="linenos">251</span></a><span class="sd">                messages=[{&quot;role&quot;: &quot;user&quot;, &quot;content&quot;: &quot;Hello&quot;}],</span>
</span><span id="Batch.add_job-252"><a href="#Batch.add_job-252"><span class="linenos">252</span></a><span class="sd">                model=&quot;gpt-4&quot;</span>
</span><span id="Batch.add_job-253"><a href="#Batch.add_job-253"><span class="linenos">253</span></a><span class="sd">            )</span>
</span><span id="Batch.add_job-254"><a href="#Batch.add_job-254"><span class="linenos">254</span></a><span class="sd">            ```</span>
</span><span id="Batch.add_job-255"><a href="#Batch.add_job-255"><span class="linenos">255</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Batch.add_job-256"><a href="#Batch.add_job-256"><span class="linenos">256</span></a>        <span class="c1"># Generate unique job ID</span>
</span><span id="Batch.add_job-257"><a href="#Batch.add_job-257"><span class="linenos">257</span></a>        <span class="n">job_id</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;job-</span><span class="si">{</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span><span class="o">.</span><span class="n">hex</span><span class="p">[:</span><span class="mi">8</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="Batch.add_job-258"><a href="#Batch.add_job-258"><span class="linenos">258</span></a>        
</span><span id="Batch.add_job-259"><a href="#Batch.add_job-259"><span class="linenos">259</span></a>        <span class="c1"># Merge with defaults</span>
</span><span id="Batch.add_job-260"><a href="#Batch.add_job-260"><span class="linenos">260</span></a>        <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">default_params</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="Batch.add_job-261"><a href="#Batch.add_job-261"><span class="linenos">261</span></a>        
</span><span id="Batch.add_job-262"><a href="#Batch.add_job-262"><span class="linenos">262</span></a>        <span class="c1"># Update with provided parameters</span>
</span><span id="Batch.add_job-263"><a href="#Batch.add_job-263"><span class="linenos">263</span></a>        <span class="k">if</span> <span class="n">model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Batch.add_job-264"><a href="#Batch.add_job-264"><span class="linenos">264</span></a>            <span class="n">params</span><span class="p">[</span><span class="s2">&quot;model&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model</span>
</span><span id="Batch.add_job-265"><a href="#Batch.add_job-265"><span class="linenos">265</span></a>        <span class="k">if</span> <span class="n">temperature</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Batch.add_job-266"><a href="#Batch.add_job-266"><span class="linenos">266</span></a>            <span class="n">params</span><span class="p">[</span><span class="s2">&quot;temperature&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">temperature</span>
</span><span id="Batch.add_job-267"><a href="#Batch.add_job-267"><span class="linenos">267</span></a>        <span class="k">if</span> <span class="n">max_tokens</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="Batch.add_job-268"><a href="#Batch.add_job-268"><span class="linenos">268</span></a>            <span class="n">params</span><span class="p">[</span><span class="s2">&quot;max_tokens&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">max_tokens</span>
</span><span id="Batch.add_job-269"><a href="#Batch.add_job-269"><span class="linenos">269</span></a>        
</span><span id="Batch.add_job-270"><a href="#Batch.add_job-270"><span class="linenos">270</span></a>        <span class="c1"># Add other kwargs</span>
</span><span id="Batch.add_job-271"><a href="#Batch.add_job-271"><span class="linenos">271</span></a>        <span class="n">params</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
</span><span id="Batch.add_job-272"><a href="#Batch.add_job-272"><span class="linenos">272</span></a>        
</span><span id="Batch.add_job-273"><a href="#Batch.add_job-273"><span class="linenos">273</span></a>        <span class="c1"># Ensure model is provided</span>
</span><span id="Batch.add_job-274"><a href="#Batch.add_job-274"><span class="linenos">274</span></a>        <span class="k">if</span> <span class="s2">&quot;model&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>
</span><span id="Batch.add_job-275"><a href="#Batch.add_job-275"><span class="linenos">275</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Model must be provided either in defaults or job parameters&quot;</span><span class="p">)</span>
</span><span id="Batch.add_job-276"><a href="#Batch.add_job-276"><span class="linenos">276</span></a>        
</span><span id="Batch.add_job-277"><a href="#Batch.add_job-277"><span class="linenos">277</span></a>        <span class="c1"># Validate parameters</span>
</span><span id="Batch.add_job-278"><a href="#Batch.add_job-278"><span class="linenos">278</span></a>        <span class="n">provider</span> <span class="o">=</span> <span class="n">get_provider</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;model&quot;</span><span class="p">])</span>
</span><span id="Batch.add_job-279"><a href="#Batch.add_job-279"><span class="linenos">279</span></a>        <span class="c1"># Extract params without model to avoid duplicate</span>
</span><span id="Batch.add_job-280"><a href="#Batch.add_job-280"><span class="linenos">280</span></a>        <span class="n">param_subset</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="o">!=</span> <span class="s2">&quot;model&quot;</span><span class="p">}</span>
</span><span id="Batch.add_job-281"><a href="#Batch.add_job-281"><span class="linenos">281</span></a>        <span class="n">provider</span><span class="o">.</span><span class="n">validate_params</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;model&quot;</span><span class="p">],</span> <span class="o">**</span><span class="n">param_subset</span><span class="p">)</span>
</span><span id="Batch.add_job-282"><a href="#Batch.add_job-282"><span class="linenos">282</span></a>        
</span><span id="Batch.add_job-283"><a href="#Batch.add_job-283"><span class="linenos">283</span></a>        <span class="c1"># Convert file path if string</span>
</span><span id="Batch.add_job-284"><a href="#Batch.add_job-284"><span class="linenos">284</span></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="Batch.add_job-285"><a href="#Batch.add_job-285"><span class="linenos">285</span></a>            <span class="n">file</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
</span><span id="Batch.add_job-286"><a href="#Batch.add_job-286"><span class="linenos">286</span></a>        
</span><span id="Batch.add_job-287"><a href="#Batch.add_job-287"><span class="linenos">287</span></a>        <span class="c1"># Warn about temporary file paths that may not persist</span>
</span><span id="Batch.add_job-288"><a href="#Batch.add_job-288"><span class="linenos">288</span></a>        <span class="k">if</span> <span class="n">file</span><span class="p">:</span>
</span><span id="Batch.add_job-289"><a href="#Batch.add_job-289"><span class="linenos">289</span></a>            <span class="n">file_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
</span><span id="Batch.add_job-290"><a href="#Batch.add_job-290"><span class="linenos">290</span></a>            <span class="k">if</span> <span class="s2">&quot;/tmp/&quot;</span> <span class="ow">in</span> <span class="n">file_str</span> <span class="ow">or</span> <span class="s2">&quot;/var/folders/&quot;</span> <span class="ow">in</span> <span class="n">file_str</span> <span class="ow">or</span> <span class="s2">&quot;temp&quot;</span> <span class="ow">in</span> <span class="n">file_str</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
</span><span id="Batch.add_job-291"><a href="#Batch.add_job-291"><span class="linenos">291</span></a>                <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;batchata&quot;</span><span class="p">)</span>
</span><span id="Batch.add_job-292"><a href="#Batch.add_job-292"><span class="linenos">292</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;File path appears to be in a temporary directory: </span><span class="si">{</span><span class="n">file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="Batch.add_job-293"><a href="#Batch.add_job-293"><span class="linenos">293</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;This may cause issues when resuming from state if temp files are cleaned up&quot;</span><span class="p">)</span>
</span><span id="Batch.add_job-294"><a href="#Batch.add_job-294"><span class="linenos">294</span></a>        
</span><span id="Batch.add_job-295"><a href="#Batch.add_job-295"><span class="linenos">295</span></a>        <span class="c1"># Create job</span>
</span><span id="Batch.add_job-296"><a href="#Batch.add_job-296"><span class="linenos">296</span></a>        <span class="n">job</span> <span class="o">=</span> <span class="n">Job</span><span class="p">(</span>
</span><span id="Batch.add_job-297"><a href="#Batch.add_job-297"><span class="linenos">297</span></a>            <span class="nb">id</span><span class="o">=</span><span class="n">job_id</span><span class="p">,</span>
</span><span id="Batch.add_job-298"><a href="#Batch.add_job-298"><span class="linenos">298</span></a>            <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span>
</span><span id="Batch.add_job-299"><a href="#Batch.add_job-299"><span class="linenos">299</span></a>            <span class="n">file</span><span class="o">=</span><span class="n">file</span><span class="p">,</span>
</span><span id="Batch.add_job-300"><a href="#Batch.add_job-300"><span class="linenos">300</span></a>            <span class="n">prompt</span><span class="o">=</span><span class="n">prompt</span><span class="p">,</span>
</span><span id="Batch.add_job-301"><a href="#Batch.add_job-301"><span class="linenos">301</span></a>            <span class="n">response_model</span><span class="o">=</span><span class="n">response_model</span><span class="p">,</span>
</span><span id="Batch.add_job-302"><a href="#Batch.add_job-302"><span class="linenos">302</span></a>            <span class="n">enable_citations</span><span class="o">=</span><span class="n">enable_citations</span><span class="p">,</span>
</span><span id="Batch.add_job-303"><a href="#Batch.add_job-303"><span class="linenos">303</span></a>            <span class="o">**</span><span class="n">params</span>
</span><span id="Batch.add_job-304"><a href="#Batch.add_job-304"><span class="linenos">304</span></a>        <span class="p">)</span>
</span><span id="Batch.add_job-305"><a href="#Batch.add_job-305"><span class="linenos">305</span></a>        
</span><span id="Batch.add_job-306"><a href="#Batch.add_job-306"><span class="linenos">306</span></a>        <span class="c1"># Validate citation compatibility</span>
</span><span id="Batch.add_job-307"><a href="#Batch.add_job-307"><span class="linenos">307</span></a>        <span class="k">if</span> <span class="n">response_model</span> <span class="ow">and</span> <span class="n">enable_citations</span><span class="p">:</span>
</span><span id="Batch.add_job-308"><a href="#Batch.add_job-308"><span class="linenos">308</span></a>            <span class="kn">from</span><span class="w"> </span><span class="nn">..utils.validation</span><span class="w"> </span><span class="kn">import</span> <span class="n">validate_flat_model</span>
</span><span id="Batch.add_job-309"><a href="#Batch.add_job-309"><span class="linenos">309</span></a>            <span class="n">validate_flat_model</span><span class="p">(</span><span class="n">response_model</span><span class="p">)</span>
</span><span id="Batch.add_job-310"><a href="#Batch.add_job-310"><span class="linenos">310</span></a>        
</span><span id="Batch.add_job-311"><a href="#Batch.add_job-311"><span class="linenos">311</span></a>        <span class="c1"># Validate job with provider (includes PDF validation for Anthropic)</span>
</span><span id="Batch.add_job-312"><a href="#Batch.add_job-312"><span class="linenos">312</span></a>        <span class="n">provider</span><span class="o">.</span><span class="n">validate_job</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>
</span><span id="Batch.add_job-313"><a href="#Batch.add_job-313"><span class="linenos">313</span></a>        
</span><span id="Batch.add_job-314"><a href="#Batch.add_job-314"><span class="linenos">314</span></a>        
</span><span id="Batch.add_job-315"><a href="#Batch.add_job-315"><span class="linenos">315</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">jobs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>
</span><span id="Batch.add_job-316"><a href="#Batch.add_job-316"><span class="linenos">316</span></a>        <span class="k">return</span> <span class="bp">self</span>
</span></pre></div>


            <div class="docstring"><p>Add a job to the batch.</p>

<p>Either provide messages OR file+prompt, not both. Parameters not provided
will use the defaults set via the defaults() method.</p>

<p>Args:
    messages: Chat messages for direct input
    file: File path for file-based input
    prompt: Prompt to use with file input
    model: Model to use (overrides default)
    temperature: Sampling temperature (overrides default)
    max_tokens: Max tokens to generate (overrides default)
    response_model: Pydantic model for structured output
    enable_citations: Whether to extract citations
    **kwargs: Additional parameters</p>

<p>Returns:
    Self for chaining</p>

<p>Example:</p>

<pre><code><div class="pdoc-code codehilite">
<pre><span></span><code><span class="n">batch</span><span class="o">.</span><span class="n">add_job</span><span class="p">(</span>
    <span class="n">messages</span><span class="o">=</span><span class="p">[{</span><span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="s2">&quot;user&quot;</span><span class="p">,</span> <span class="s2">&quot;content&quot;</span><span class="p">:</span> <span class="s2">&quot;Hello&quot;</span><span class="p">}],</span>
    <span class="n">model</span><span class="o">=</span><span class="s2">&quot;gpt-4&quot;</span>
<span class="p">)</span>
</code></pre>
</div>
</code></pre>
</div>


                            </div>
                            <div id="Batch.run" class="classattr">
                                        <input id="Batch.run-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">run</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">on_progress</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="n">Dict</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">Dict</span><span class="p">],</span> <span class="n">NoneType</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">progress_interval</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span>,</span><span class="param">	<span class="n">print_status</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>,</span><span class="param">	<span class="n">dry_run</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span></span><span class="return-annotation">) -> <span class="n"><a href="#BatchRun">BatchRun</a></span>:</span></span>

                <label class="view-source-button" for="Batch.run-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Batch.run"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Batch.run-318"><a href="#Batch.run-318"><span class="linenos">318</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">on_progress</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="n">Dict</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">Dict</span><span class="p">],</span> <span class="kc">None</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">progress_interval</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">print_status</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">dry_run</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;BatchRun&#39;</span><span class="p">:</span>
</span><span id="Batch.run-319"><a href="#Batch.run-319"><span class="linenos">319</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute the batch.</span>
</span><span id="Batch.run-320"><a href="#Batch.run-320"><span class="linenos">320</span></a><span class="sd">        </span>
</span><span id="Batch.run-321"><a href="#Batch.run-321"><span class="linenos">321</span></a><span class="sd">        Creates a BatchRun instance and executes the jobs synchronously.</span>
</span><span id="Batch.run-322"><a href="#Batch.run-322"><span class="linenos">322</span></a><span class="sd">        </span>
</span><span id="Batch.run-323"><a href="#Batch.run-323"><span class="linenos">323</span></a><span class="sd">        Args:</span>
</span><span id="Batch.run-324"><a href="#Batch.run-324"><span class="linenos">324</span></a><span class="sd">            on_progress: Optional progress callback function that receives</span>
</span><span id="Batch.run-325"><a href="#Batch.run-325"><span class="linenos">325</span></a><span class="sd">                        (stats_dict, elapsed_time_seconds, batch_data)</span>
</span><span id="Batch.run-326"><a href="#Batch.run-326"><span class="linenos">326</span></a><span class="sd">            progress_interval: Interval in seconds between progress updates (default: 1.0)</span>
</span><span id="Batch.run-327"><a href="#Batch.run-327"><span class="linenos">327</span></a><span class="sd">            print_status: Whether to show rich progress display (default: False)</span>
</span><span id="Batch.run-328"><a href="#Batch.run-328"><span class="linenos">328</span></a><span class="sd">            dry_run: If True, only show cost estimation without executing (default: False)</span>
</span><span id="Batch.run-329"><a href="#Batch.run-329"><span class="linenos">329</span></a><span class="sd">            </span>
</span><span id="Batch.run-330"><a href="#Batch.run-330"><span class="linenos">330</span></a><span class="sd">        Returns:</span>
</span><span id="Batch.run-331"><a href="#Batch.run-331"><span class="linenos">331</span></a><span class="sd">            BatchRun instance with completed results</span>
</span><span id="Batch.run-332"><a href="#Batch.run-332"><span class="linenos">332</span></a><span class="sd">            </span>
</span><span id="Batch.run-333"><a href="#Batch.run-333"><span class="linenos">333</span></a><span class="sd">        Raises:</span>
</span><span id="Batch.run-334"><a href="#Batch.run-334"><span class="linenos">334</span></a><span class="sd">            ValueError: If no jobs have been added</span>
</span><span id="Batch.run-335"><a href="#Batch.run-335"><span class="linenos">335</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="Batch.run-336"><a href="#Batch.run-336"><span class="linenos">336</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobs</span><span class="p">:</span>
</span><span id="Batch.run-337"><a href="#Batch.run-337"><span class="linenos">337</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No jobs added to batch&quot;</span><span class="p">)</span>
</span><span id="Batch.run-338"><a href="#Batch.run-338"><span class="linenos">338</span></a>        
</span><span id="Batch.run-339"><a href="#Batch.run-339"><span class="linenos">339</span></a>        <span class="c1"># Import here to avoid circular dependency</span>
</span><span id="Batch.run-340"><a href="#Batch.run-340"><span class="linenos">340</span></a>        <span class="kn">from</span><span class="w"> </span><span class="nn">.batch_run</span><span class="w"> </span><span class="kn">import</span> <span class="n">BatchRun</span>
</span><span id="Batch.run-341"><a href="#Batch.run-341"><span class="linenos">341</span></a>        
</span><span id="Batch.run-342"><a href="#Batch.run-342"><span class="linenos">342</span></a>        <span class="c1"># Create and start the run</span>
</span><span id="Batch.run-343"><a href="#Batch.run-343"><span class="linenos">343</span></a>        <span class="n">run</span> <span class="o">=</span> <span class="n">BatchRun</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobs</span><span class="p">)</span>
</span><span id="Batch.run-344"><a href="#Batch.run-344"><span class="linenos">344</span></a>        
</span><span id="Batch.run-345"><a href="#Batch.run-345"><span class="linenos">345</span></a>        <span class="c1"># Handle dry run mode</span>
</span><span id="Batch.run-346"><a href="#Batch.run-346"><span class="linenos">346</span></a>        <span class="k">if</span> <span class="n">dry_run</span><span class="p">:</span>
</span><span id="Batch.run-347"><a href="#Batch.run-347"><span class="linenos">347</span></a>            <span class="k">return</span> <span class="n">run</span><span class="o">.</span><span class="n">dry_run</span><span class="p">()</span>
</span><span id="Batch.run-348"><a href="#Batch.run-348"><span class="linenos">348</span></a>        
</span><span id="Batch.run-349"><a href="#Batch.run-349"><span class="linenos">349</span></a>        <span class="c1"># Set progress callback - either rich display or custom callback</span>
</span><span id="Batch.run-350"><a href="#Batch.run-350"><span class="linenos">350</span></a>        <span class="k">if</span> <span class="n">print_status</span><span class="p">:</span>
</span><span id="Batch.run-351"><a href="#Batch.run-351"><span class="linenos">351</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_with_rich_display</span><span class="p">(</span><span class="n">run</span><span class="p">,</span> <span class="n">progress_interval</span><span class="p">)</span>
</span><span id="Batch.run-352"><a href="#Batch.run-352"><span class="linenos">352</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="Batch.run-353"><a href="#Batch.run-353"><span class="linenos">353</span></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_with_custom_callback</span><span class="p">(</span><span class="n">run</span><span class="p">,</span> <span class="n">on_progress</span><span class="p">,</span> <span class="n">progress_interval</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Execute the batch.</p>

<p>Creates a BatchRun instance and executes the jobs synchronously.</p>

<p>Args:
    on_progress: Optional progress callback function that receives
                (stats_dict, elapsed_time_seconds, batch_data)
    progress_interval: Interval in seconds between progress updates (default: 1.0)
    print_status: Whether to show rich progress display (default: False)
    dry_run: If True, only show cost estimation without executing (default: False)</p>

<p>Returns:
    BatchRun instance with completed results</p>

<p>Raises:
    ValueError: If no jobs have been added</p>
</div>


                            </div>
                </section>
                <section id="BatchRun">
                            <input id="BatchRun-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">BatchRun</span>:

                <label class="view-source-button" for="BatchRun-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#BatchRun"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="BatchRun-25"><a href="#BatchRun-25"><span class="linenos"> 25</span></a><span class="k">class</span><span class="w"> </span><span class="nc">BatchRun</span><span class="p">:</span>
</span><span id="BatchRun-26"><a href="#BatchRun-26"><span class="linenos"> 26</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Manages the execution of a batch job synchronously.</span>
</span><span id="BatchRun-27"><a href="#BatchRun-27"><span class="linenos"> 27</span></a><span class="sd">    </span>
</span><span id="BatchRun-28"><a href="#BatchRun-28"><span class="linenos"> 28</span></a><span class="sd">    Processes jobs in batches based on items_per_batch configuration.</span>
</span><span id="BatchRun-29"><a href="#BatchRun-29"><span class="linenos"> 29</span></a><span class="sd">    Simpler synchronous execution for clear logging and debugging.</span>
</span><span id="BatchRun-30"><a href="#BatchRun-30"><span class="linenos"> 30</span></a><span class="sd">    </span>
</span><span id="BatchRun-31"><a href="#BatchRun-31"><span class="linenos"> 31</span></a><span class="sd">    Example:</span>
</span><span id="BatchRun-32"><a href="#BatchRun-32"><span class="linenos"> 32</span></a><span class="sd">        ```python</span>
</span><span id="BatchRun-33"><a href="#BatchRun-33"><span class="linenos"> 33</span></a><span class="sd">        config = BatchParams(...)</span>
</span><span id="BatchRun-34"><a href="#BatchRun-34"><span class="linenos"> 34</span></a><span class="sd">        run = BatchRun(config, jobs)</span>
</span><span id="BatchRun-35"><a href="#BatchRun-35"><span class="linenos"> 35</span></a><span class="sd">        run.execute()</span>
</span><span id="BatchRun-36"><a href="#BatchRun-36"><span class="linenos"> 36</span></a><span class="sd">        results = run.results()</span>
</span><span id="BatchRun-37"><a href="#BatchRun-37"><span class="linenos"> 37</span></a><span class="sd">        ```</span>
</span><span id="BatchRun-38"><a href="#BatchRun-38"><span class="linenos"> 38</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="BatchRun-39"><a href="#BatchRun-39"><span class="linenos"> 39</span></a>    
</span><span id="BatchRun-40"><a href="#BatchRun-40"><span class="linenos"> 40</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">BatchParams</span><span class="p">,</span> <span class="n">jobs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Job</span><span class="p">]):</span>
</span><span id="BatchRun-41"><a href="#BatchRun-41"><span class="linenos"> 41</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize batch run.</span>
</span><span id="BatchRun-42"><a href="#BatchRun-42"><span class="linenos"> 42</span></a><span class="sd">        </span>
</span><span id="BatchRun-43"><a href="#BatchRun-43"><span class="linenos"> 43</span></a><span class="sd">        Args:</span>
</span><span id="BatchRun-44"><a href="#BatchRun-44"><span class="linenos"> 44</span></a><span class="sd">            config: Batch configuration</span>
</span><span id="BatchRun-45"><a href="#BatchRun-45"><span class="linenos"> 45</span></a><span class="sd">            jobs: List of jobs to execute</span>
</span><span id="BatchRun-46"><a href="#BatchRun-46"><span class="linenos"> 46</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="BatchRun-47"><a href="#BatchRun-47"><span class="linenos"> 47</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
</span><span id="BatchRun-48"><a href="#BatchRun-48"><span class="linenos"> 48</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">jobs</span> <span class="o">=</span> <span class="p">{</span><span class="n">job</span><span class="o">.</span><span class="n">id</span><span class="p">:</span> <span class="n">job</span> <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="n">jobs</span><span class="p">}</span>
</span><span id="BatchRun-49"><a href="#BatchRun-49"><span class="linenos"> 49</span></a>        
</span><span id="BatchRun-50"><a href="#BatchRun-50"><span class="linenos"> 50</span></a>        <span class="c1"># Set logging level based on config</span>
</span><span id="BatchRun-51"><a href="#BatchRun-51"><span class="linenos"> 51</span></a>        <span class="n">set_log_level</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">verbosity</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>
</span><span id="BatchRun-52"><a href="#BatchRun-52"><span class="linenos"> 52</span></a>        
</span><span id="BatchRun-53"><a href="#BatchRun-53"><span class="linenos"> 53</span></a>        <span class="c1"># Initialize components</span>
</span><span id="BatchRun-54"><a href="#BatchRun-54"><span class="linenos"> 54</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cost_tracker</span> <span class="o">=</span> <span class="n">CostTracker</span><span class="p">(</span><span class="n">limit_usd</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">cost_limit_usd</span><span class="p">)</span>
</span><span id="BatchRun-55"><a href="#BatchRun-55"><span class="linenos"> 55</span></a>        
</span><span id="BatchRun-56"><a href="#BatchRun-56"><span class="linenos"> 56</span></a>        <span class="c1"># Use temp file for state if not provided</span>
</span><span id="BatchRun-57"><a href="#BatchRun-57"><span class="linenos"> 57</span></a>        <span class="n">state_file</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">state_file</span>
</span><span id="BatchRun-58"><a href="#BatchRun-58"><span class="linenos"> 58</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">state_file</span><span class="p">:</span>
</span><span id="BatchRun-59"><a href="#BatchRun-59"><span class="linenos"> 59</span></a>            <span class="n">state_file</span> <span class="o">=</span> <span class="n">create_temp_state_file</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
</span><span id="BatchRun-60"><a href="#BatchRun-60"><span class="linenos"> 60</span></a>            <span class="n">config</span><span class="o">.</span><span class="n">reuse_state</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="BatchRun-61"><a href="#BatchRun-61"><span class="linenos"> 61</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Created temporary state file: </span><span class="si">{</span><span class="n">state_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="BatchRun-62"><a href="#BatchRun-62"><span class="linenos"> 62</span></a>        
</span><span id="BatchRun-63"><a href="#BatchRun-63"><span class="linenos"> 63</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">state_manager</span> <span class="o">=</span> <span class="n">StateManager</span><span class="p">(</span><span class="n">state_file</span><span class="p">)</span>
</span><span id="BatchRun-64"><a href="#BatchRun-64"><span class="linenos"> 64</span></a>        
</span><span id="BatchRun-65"><a href="#BatchRun-65"><span class="linenos"> 65</span></a>        <span class="c1"># State tracking</span>
</span><span id="BatchRun-66"><a href="#BatchRun-66"><span class="linenos"> 66</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pending_jobs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Job</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="BatchRun-67"><a href="#BatchRun-67"><span class="linenos"> 67</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">completed_results</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">JobResult</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># job_id -&gt; result</span>
</span><span id="BatchRun-68"><a href="#BatchRun-68"><span class="linenos"> 68</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">failed_jobs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># job_id -&gt; error</span>
</span><span id="BatchRun-69"><a href="#BatchRun-69"><span class="linenos"> 69</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cancelled_jobs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># job_id -&gt; reason</span>
</span><span id="BatchRun-70"><a href="#BatchRun-70"><span class="linenos"> 70</span></a>        
</span><span id="BatchRun-71"><a href="#BatchRun-71"><span class="linenos"> 71</span></a>        <span class="c1"># Batch tracking</span>
</span><span id="BatchRun-72"><a href="#BatchRun-72"><span class="linenos"> 72</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">total_batches</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="BatchRun-73"><a href="#BatchRun-73"><span class="linenos"> 73</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">completed_batches</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="BatchRun-74"><a href="#BatchRun-74"><span class="linenos"> 74</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">current_batch_index</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="BatchRun-75"><a href="#BatchRun-75"><span class="linenos"> 75</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">current_batch_size</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="BatchRun-76"><a href="#BatchRun-76"><span class="linenos"> 76</span></a>        
</span><span id="BatchRun-77"><a href="#BatchRun-77"><span class="linenos"> 77</span></a>        <span class="c1"># Execution control</span>
</span><span id="BatchRun-78"><a href="#BatchRun-78"><span class="linenos"> 78</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_started</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="BatchRun-79"><a href="#BatchRun-79"><span class="linenos"> 79</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_start_time</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">datetime</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="BatchRun-80"><a href="#BatchRun-80"><span class="linenos"> 80</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_time_limit_exceeded</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="BatchRun-81"><a href="#BatchRun-81"><span class="linenos"> 81</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_progress_callback</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="n">Dict</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span> <span class="kc">None</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="BatchRun-82"><a href="#BatchRun-82"><span class="linenos"> 82</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_progress_interval</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span>  <span class="c1"># Default to 1 second</span>
</span><span id="BatchRun-83"><a href="#BatchRun-83"><span class="linenos"> 83</span></a>        
</span><span id="BatchRun-84"><a href="#BatchRun-84"><span class="linenos"> 84</span></a>        <span class="c1"># Threading primitives</span>
</span><span id="BatchRun-85"><a href="#BatchRun-85"><span class="linenos"> 85</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_state_lock</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>
</span><span id="BatchRun-86"><a href="#BatchRun-86"><span class="linenos"> 86</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_shutdown_event</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>
</span><span id="BatchRun-87"><a href="#BatchRun-87"><span class="linenos"> 87</span></a>        
</span><span id="BatchRun-88"><a href="#BatchRun-88"><span class="linenos"> 88</span></a>        <span class="c1"># Batch tracking for progress display</span>
</span><span id="BatchRun-89"><a href="#BatchRun-89"><span class="linenos"> 89</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">batch_tracking</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># batch_id -&gt; batch_info</span>
</span><span id="BatchRun-90"><a href="#BatchRun-90"><span class="linenos"> 90</span></a>        
</span><span id="BatchRun-91"><a href="#BatchRun-91"><span class="linenos"> 91</span></a>        <span class="c1"># Active batch tracking for cancellation</span>
</span><span id="BatchRun-92"><a href="#BatchRun-92"><span class="linenos"> 92</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_active_batches</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">object</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># batch_id -&gt; provider</span>
</span><span id="BatchRun-93"><a href="#BatchRun-93"><span class="linenos"> 93</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_active_batches_lock</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>
</span><span id="BatchRun-94"><a href="#BatchRun-94"><span class="linenos"> 94</span></a>        
</span><span id="BatchRun-95"><a href="#BatchRun-95"><span class="linenos"> 95</span></a>        <span class="c1"># Results directory</span>
</span><span id="BatchRun-96"><a href="#BatchRun-96"><span class="linenos"> 96</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">results_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">results_dir</span><span class="p">)</span>
</span><span id="BatchRun-97"><a href="#BatchRun-97"><span class="linenos"> 97</span></a>        
</span><span id="BatchRun-98"><a href="#BatchRun-98"><span class="linenos"> 98</span></a>        <span class="c1"># If not reusing state, clear the results directory</span>
</span><span id="BatchRun-99"><a href="#BatchRun-99"><span class="linenos"> 99</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">config</span><span class="o">.</span><span class="n">reuse_state</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">results_dir</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
</span><span id="BatchRun-100"><a href="#BatchRun-100"><span class="linenos">100</span></a>            <span class="kn">import</span><span class="w"> </span><span class="nn">shutil</span>
</span><span id="BatchRun-101"><a href="#BatchRun-101"><span class="linenos">101</span></a>            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">results_dir</span><span class="p">)</span>
</span><span id="BatchRun-102"><a href="#BatchRun-102"><span class="linenos">102</span></a>        
</span><span id="BatchRun-103"><a href="#BatchRun-103"><span class="linenos">103</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">results_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="BatchRun-104"><a href="#BatchRun-104"><span class="linenos">104</span></a>        
</span><span id="BatchRun-105"><a href="#BatchRun-105"><span class="linenos">105</span></a>        <span class="c1"># Raw files directory (if enabled)</span>
</span><span id="BatchRun-106"><a href="#BatchRun-106"><span class="linenos">106</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">raw_files_dir</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="BatchRun-107"><a href="#BatchRun-107"><span class="linenos">107</span></a>        <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">raw_files</span><span class="p">:</span>
</span><span id="BatchRun-108"><a href="#BatchRun-108"><span class="linenos">108</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">raw_files_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">results_dir</span> <span class="o">/</span> <span class="s2">&quot;raw_files&quot;</span>
</span><span id="BatchRun-109"><a href="#BatchRun-109"><span class="linenos">109</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">raw_files_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="BatchRun-110"><a href="#BatchRun-110"><span class="linenos">110</span></a>        
</span><span id="BatchRun-111"><a href="#BatchRun-111"><span class="linenos">111</span></a>        <span class="c1"># Try to resume from saved state</span>
</span><span id="BatchRun-112"><a href="#BatchRun-112"><span class="linenos">112</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_resume_from_state</span><span class="p">()</span>
</span><span id="BatchRun-113"><a href="#BatchRun-113"><span class="linenos">113</span></a>    
</span><span id="BatchRun-114"><a href="#BatchRun-114"><span class="linenos">114</span></a>    
</span><span id="BatchRun-115"><a href="#BatchRun-115"><span class="linenos">115</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_resume_from_state</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="BatchRun-116"><a href="#BatchRun-116"><span class="linenos">116</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Resume from saved state if available.&quot;&quot;&quot;</span>
</span><span id="BatchRun-117"><a href="#BatchRun-117"><span class="linenos">117</span></a>        <span class="c1"># Check if we should reuse state</span>
</span><span id="BatchRun-118"><a href="#BatchRun-118"><span class="linenos">118</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">reuse_state</span><span class="p">:</span>
</span><span id="BatchRun-119"><a href="#BatchRun-119"><span class="linenos">119</span></a>            <span class="c1"># Clear any existing state and start fresh</span>
</span><span id="BatchRun-120"><a href="#BatchRun-120"><span class="linenos">120</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">state_manager</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
</span><span id="BatchRun-121"><a href="#BatchRun-121"><span class="linenos">121</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">pending_jobs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jobs</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
</span><span id="BatchRun-122"><a href="#BatchRun-122"><span class="linenos">122</span></a>            <span class="k">return</span>
</span><span id="BatchRun-123"><a href="#BatchRun-123"><span class="linenos">123</span></a>            
</span><span id="BatchRun-124"><a href="#BatchRun-124"><span class="linenos">124</span></a>        <span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_manager</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
</span><span id="BatchRun-125"><a href="#BatchRun-125"><span class="linenos">125</span></a>        <span class="k">if</span> <span class="n">state</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="BatchRun-126"><a href="#BatchRun-126"><span class="linenos">126</span></a>            <span class="c1"># No saved state, use jobs passed to constructor</span>
</span><span id="BatchRun-127"><a href="#BatchRun-127"><span class="linenos">127</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">pending_jobs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jobs</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
</span><span id="BatchRun-128"><a href="#BatchRun-128"><span class="linenos">128</span></a>            <span class="k">return</span>
</span><span id="BatchRun-129"><a href="#BatchRun-129"><span class="linenos">129</span></a>        
</span><span id="BatchRun-130"><a href="#BatchRun-130"><span class="linenos">130</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Resuming batch run from saved state&quot;</span><span class="p">)</span>
</span><span id="BatchRun-131"><a href="#BatchRun-131"><span class="linenos">131</span></a>        
</span><span id="BatchRun-132"><a href="#BatchRun-132"><span class="linenos">132</span></a>        <span class="c1"># Restore pending jobs</span>
</span><span id="BatchRun-133"><a href="#BatchRun-133"><span class="linenos">133</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pending_jobs</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="BatchRun-134"><a href="#BatchRun-134"><span class="linenos">134</span></a>        <span class="k">for</span> <span class="n">job_data</span> <span class="ow">in</span> <span class="n">state</span><span class="o">.</span><span class="n">pending_jobs</span><span class="p">:</span>
</span><span id="BatchRun-135"><a href="#BatchRun-135"><span class="linenos">135</span></a>            <span class="n">job</span> <span class="o">=</span> <span class="n">Job</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">job_data</span><span class="p">)</span>
</span><span id="BatchRun-136"><a href="#BatchRun-136"><span class="linenos">136</span></a>            <span class="c1"># Check if file exists (if job has a file)</span>
</span><span id="BatchRun-137"><a href="#BatchRun-137"><span class="linenos">137</span></a>            <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">file</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">job</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
</span><span id="BatchRun-138"><a href="#BatchRun-138"><span class="linenos">138</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;File not found for job </span><span class="si">{</span><span class="n">job</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">job</span><span class="o">.</span><span class="n">file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="BatchRun-139"><a href="#BatchRun-139"><span class="linenos">139</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;This may happen if files were in temporary directories that were cleaned up&quot;</span><span class="p">)</span>
</span><span id="BatchRun-140"><a href="#BatchRun-140"><span class="linenos">140</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">failed_jobs</span><span class="p">[</span><span class="n">job</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;File not found: </span><span class="si">{</span><span class="n">job</span><span class="o">.</span><span class="n">file</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="BatchRun-141"><a href="#BatchRun-141"><span class="linenos">141</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="BatchRun-142"><a href="#BatchRun-142"><span class="linenos">142</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">pending_jobs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>
</span><span id="BatchRun-143"><a href="#BatchRun-143"><span class="linenos">143</span></a>        
</span><span id="BatchRun-144"><a href="#BatchRun-144"><span class="linenos">144</span></a>        <span class="c1"># Restore completed results from file references</span>
</span><span id="BatchRun-145"><a href="#BatchRun-145"><span class="linenos">145</span></a>        <span class="k">for</span> <span class="n">result_ref</span> <span class="ow">in</span> <span class="n">state</span><span class="o">.</span><span class="n">completed_results</span><span class="p">:</span>
</span><span id="BatchRun-146"><a href="#BatchRun-146"><span class="linenos">146</span></a>            <span class="n">job_id</span> <span class="o">=</span> <span class="n">result_ref</span><span class="p">[</span><span class="s2">&quot;job_id&quot;</span><span class="p">]</span>
</span><span id="BatchRun-147"><a href="#BatchRun-147"><span class="linenos">147</span></a>            <span class="n">file_path</span> <span class="o">=</span> <span class="n">result_ref</span><span class="p">[</span><span class="s2">&quot;file_path&quot;</span><span class="p">]</span>
</span><span id="BatchRun-148"><a href="#BatchRun-148"><span class="linenos">148</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="BatchRun-149"><a href="#BatchRun-149"><span class="linenos">149</span></a>                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span><span id="BatchRun-150"><a href="#BatchRun-150"><span class="linenos">150</span></a>                    <span class="n">result_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</span><span id="BatchRun-151"><a href="#BatchRun-151"><span class="linenos">151</span></a>                <span class="n">result</span> <span class="o">=</span> <span class="n">JobResult</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">result_data</span><span class="p">)</span>
</span><span id="BatchRun-152"><a href="#BatchRun-152"><span class="linenos">152</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">completed_results</span><span class="p">[</span><span class="n">job_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span>
</span><span id="BatchRun-153"><a href="#BatchRun-153"><span class="linenos">153</span></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="BatchRun-154"><a href="#BatchRun-154"><span class="linenos">154</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to load result for </span><span class="si">{</span><span class="n">job_id</span><span class="si">}</span><span class="s2"> from </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="BatchRun-155"><a href="#BatchRun-155"><span class="linenos">155</span></a>                <span class="c1"># Move to failed jobs if we can&#39;t load the result</span>
</span><span id="BatchRun-156"><a href="#BatchRun-156"><span class="linenos">156</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">failed_jobs</span><span class="p">[</span><span class="n">job_id</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Failed to load result file: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="BatchRun-157"><a href="#BatchRun-157"><span class="linenos">157</span></a>        
</span><span id="BatchRun-158"><a href="#BatchRun-158"><span class="linenos">158</span></a>        <span class="c1"># Restore failed jobs</span>
</span><span id="BatchRun-159"><a href="#BatchRun-159"><span class="linenos">159</span></a>        <span class="k">for</span> <span class="n">job_data</span> <span class="ow">in</span> <span class="n">state</span><span class="o">.</span><span class="n">failed_jobs</span><span class="p">:</span>
</span><span id="BatchRun-160"><a href="#BatchRun-160"><span class="linenos">160</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">failed_jobs</span><span class="p">[</span><span class="n">job_data</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">job_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="s2">&quot;Unknown error&quot;</span><span class="p">)</span>
</span><span id="BatchRun-161"><a href="#BatchRun-161"><span class="linenos">161</span></a>        
</span><span id="BatchRun-162"><a href="#BatchRun-162"><span class="linenos">162</span></a>        <span class="c1"># Restore cancelled jobs (if they exist in state)</span>
</span><span id="BatchRun-163"><a href="#BatchRun-163"><span class="linenos">163</span></a>        <span class="k">for</span> <span class="n">job_data</span> <span class="ow">in</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="s1">&#39;cancelled_jobs&#39;</span><span class="p">,</span> <span class="p">[]):</span>
</span><span id="BatchRun-164"><a href="#BatchRun-164"><span class="linenos">164</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">cancelled_jobs</span><span class="p">[</span><span class="n">job_data</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">job_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;reason&quot;</span><span class="p">,</span> <span class="s2">&quot;Cancelled&quot;</span><span class="p">)</span>
</span><span id="BatchRun-165"><a href="#BatchRun-165"><span class="linenos">165</span></a>        
</span><span id="BatchRun-166"><a href="#BatchRun-166"><span class="linenos">166</span></a>        <span class="c1"># Restore cost tracker</span>
</span><span id="BatchRun-167"><a href="#BatchRun-167"><span class="linenos">167</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cost_tracker</span><span class="o">.</span><span class="n">used_usd</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">total_cost_usd</span>
</span><span id="BatchRun-168"><a href="#BatchRun-168"><span class="linenos">168</span></a>        
</span><span id="BatchRun-169"><a href="#BatchRun-169"><span class="linenos">169</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="BatchRun-170"><a href="#BatchRun-170"><span class="linenos">170</span></a>            <span class="sa">f</span><span class="s2">&quot;Resumed with </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pending_jobs</span><span class="p">)</span><span class="si">}</span><span class="s2"> pending, &quot;</span>
</span><span id="BatchRun-171"><a href="#BatchRun-171"><span class="linenos">171</span></a>            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">completed_results</span><span class="p">)</span><span class="si">}</span><span class="s2"> completed, &quot;</span>
</span><span id="BatchRun-172"><a href="#BatchRun-172"><span class="linenos">172</span></a>            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">failed_jobs</span><span class="p">)</span><span class="si">}</span><span class="s2"> failed, &quot;</span>
</span><span id="BatchRun-173"><a href="#BatchRun-173"><span class="linenos">173</span></a>            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cancelled_jobs</span><span class="p">)</span><span class="si">}</span><span class="s2"> cancelled&quot;</span>
</span><span id="BatchRun-174"><a href="#BatchRun-174"><span class="linenos">174</span></a>        <span class="p">)</span>
</span><span id="BatchRun-175"><a href="#BatchRun-175"><span class="linenos">175</span></a>    
</span><span id="BatchRun-176"><a href="#BatchRun-176"><span class="linenos">176</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">to_json</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
</span><span id="BatchRun-177"><a href="#BatchRun-177"><span class="linenos">177</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert current state to JSON-serializable dict.&quot;&quot;&quot;</span>
</span><span id="BatchRun-178"><a href="#BatchRun-178"><span class="linenos">178</span></a>        <span class="k">return</span> <span class="p">{</span>
</span><span id="BatchRun-179"><a href="#BatchRun-179"><span class="linenos">179</span></a>            <span class="s2">&quot;created_at&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
</span><span id="BatchRun-180"><a href="#BatchRun-180"><span class="linenos">180</span></a>            <span class="s2">&quot;pending_jobs&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">job</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span> <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pending_jobs</span><span class="p">],</span>
</span><span id="BatchRun-181"><a href="#BatchRun-181"><span class="linenos">181</span></a>            <span class="s2">&quot;completed_results&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span id="BatchRun-182"><a href="#BatchRun-182"><span class="linenos">182</span></a>                <span class="p">{</span><span class="s2">&quot;job_id&quot;</span><span class="p">:</span> <span class="n">job_id</span><span class="p">,</span> <span class="s2">&quot;file_path&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">results_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">job_id</span><span class="si">}</span><span class="s2">.json&quot;</span><span class="p">)}</span>
</span><span id="BatchRun-183"><a href="#BatchRun-183"><span class="linenos">183</span></a>                <span class="k">for</span> <span class="n">job_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">completed_results</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
</span><span id="BatchRun-184"><a href="#BatchRun-184"><span class="linenos">184</span></a>            <span class="p">],</span>
</span><span id="BatchRun-185"><a href="#BatchRun-185"><span class="linenos">185</span></a>            <span class="s2">&quot;failed_jobs&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span id="BatchRun-186"><a href="#BatchRun-186"><span class="linenos">186</span></a>                <span class="p">{</span>
</span><span id="BatchRun-187"><a href="#BatchRun-187"><span class="linenos">187</span></a>                    <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">job_id</span><span class="p">,</span> 
</span><span id="BatchRun-188"><a href="#BatchRun-188"><span class="linenos">188</span></a>                    <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="n">error</span><span class="p">,</span>
</span><span id="BatchRun-189"><a href="#BatchRun-189"><span class="linenos">189</span></a>                    <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
</span><span id="BatchRun-190"><a href="#BatchRun-190"><span class="linenos">190</span></a>                <span class="p">}</span> <span class="k">for</span> <span class="n">job_id</span><span class="p">,</span> <span class="n">error</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">failed_jobs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
</span><span id="BatchRun-191"><a href="#BatchRun-191"><span class="linenos">191</span></a>            <span class="p">],</span>
</span><span id="BatchRun-192"><a href="#BatchRun-192"><span class="linenos">192</span></a>            <span class="s2">&quot;cancelled_jobs&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span id="BatchRun-193"><a href="#BatchRun-193"><span class="linenos">193</span></a>                <span class="p">{</span>
</span><span id="BatchRun-194"><a href="#BatchRun-194"><span class="linenos">194</span></a>                    <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">job_id</span><span class="p">,</span> 
</span><span id="BatchRun-195"><a href="#BatchRun-195"><span class="linenos">195</span></a>                    <span class="s2">&quot;reason&quot;</span><span class="p">:</span> <span class="n">reason</span><span class="p">,</span>
</span><span id="BatchRun-196"><a href="#BatchRun-196"><span class="linenos">196</span></a>                    <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
</span><span id="BatchRun-197"><a href="#BatchRun-197"><span class="linenos">197</span></a>                <span class="p">}</span> <span class="k">for</span> <span class="n">job_id</span><span class="p">,</span> <span class="n">reason</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cancelled_jobs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
</span><span id="BatchRun-198"><a href="#BatchRun-198"><span class="linenos">198</span></a>            <span class="p">],</span>
</span><span id="BatchRun-199"><a href="#BatchRun-199"><span class="linenos">199</span></a>            <span class="s2">&quot;total_cost_usd&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cost_tracker</span><span class="o">.</span><span class="n">used_usd</span><span class="p">,</span>
</span><span id="BatchRun-200"><a href="#BatchRun-200"><span class="linenos">200</span></a>            <span class="s2">&quot;config&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="BatchRun-201"><a href="#BatchRun-201"><span class="linenos">201</span></a>                <span class="s2">&quot;state_file&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">state_file</span><span class="p">,</span>
</span><span id="BatchRun-202"><a href="#BatchRun-202"><span class="linenos">202</span></a>                <span class="s2">&quot;results_dir&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">results_dir</span><span class="p">,</span>
</span><span id="BatchRun-203"><a href="#BatchRun-203"><span class="linenos">203</span></a>                <span class="s2">&quot;max_parallel_batches&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">max_parallel_batches</span><span class="p">,</span>
</span><span id="BatchRun-204"><a href="#BatchRun-204"><span class="linenos">204</span></a>                <span class="s2">&quot;items_per_batch&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">items_per_batch</span><span class="p">,</span>
</span><span id="BatchRun-205"><a href="#BatchRun-205"><span class="linenos">205</span></a>                <span class="s2">&quot;cost_limit_usd&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">cost_limit_usd</span><span class="p">,</span>
</span><span id="BatchRun-206"><a href="#BatchRun-206"><span class="linenos">206</span></a>                <span class="s2">&quot;default_params&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">default_params</span><span class="p">,</span>
</span><span id="BatchRun-207"><a href="#BatchRun-207"><span class="linenos">207</span></a>                <span class="s2">&quot;raw_files&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">raw_files</span>
</span><span id="BatchRun-208"><a href="#BatchRun-208"><span class="linenos">208</span></a>            <span class="p">}</span>
</span><span id="BatchRun-209"><a href="#BatchRun-209"><span class="linenos">209</span></a>        <span class="p">}</span>
</span><span id="BatchRun-210"><a href="#BatchRun-210"><span class="linenos">210</span></a>    
</span><span id="BatchRun-211"><a href="#BatchRun-211"><span class="linenos">211</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="BatchRun-212"><a href="#BatchRun-212"><span class="linenos">212</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute synchronous batch run and wait for completion.&quot;&quot;&quot;</span>
</span><span id="BatchRun-213"><a href="#BatchRun-213"><span class="linenos">213</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_started</span><span class="p">:</span>
</span><span id="BatchRun-214"><a href="#BatchRun-214"><span class="linenos">214</span></a>            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Batch run already started&quot;</span><span class="p">)</span>
</span><span id="BatchRun-215"><a href="#BatchRun-215"><span class="linenos">215</span></a>        
</span><span id="BatchRun-216"><a href="#BatchRun-216"><span class="linenos">216</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_started</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="BatchRun-217"><a href="#BatchRun-217"><span class="linenos">217</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_start_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
</span><span id="BatchRun-218"><a href="#BatchRun-218"><span class="linenos">218</span></a>        
</span><span id="BatchRun-219"><a href="#BatchRun-219"><span class="linenos">219</span></a>        <span class="c1"># Register signal handler for graceful shutdown</span>
</span><span id="BatchRun-220"><a href="#BatchRun-220"><span class="linenos">220</span></a>        <span class="k">def</span><span class="w"> </span><span class="nf">signal_handler</span><span class="p">(</span><span class="n">signum</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
</span><span id="BatchRun-221"><a href="#BatchRun-221"><span class="linenos">221</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Received interrupt signal, shutting down gracefully...&quot;</span><span class="p">)</span>
</span><span id="BatchRun-222"><a href="#BatchRun-222"><span class="linenos">222</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_shutdown_event</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
</span><span id="BatchRun-223"><a href="#BatchRun-223"><span class="linenos">223</span></a>        
</span><span id="BatchRun-224"><a href="#BatchRun-224"><span class="linenos">224</span></a>        <span class="c1"># Store original handler to restore later</span>
</span><span id="BatchRun-225"><a href="#BatchRun-225"><span class="linenos">225</span></a>        <span class="n">original_handler</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGINT</span><span class="p">,</span> <span class="n">signal_handler</span><span class="p">)</span>
</span><span id="BatchRun-226"><a href="#BatchRun-226"><span class="linenos">226</span></a>        
</span><span id="BatchRun-227"><a href="#BatchRun-227"><span class="linenos">227</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="BatchRun-228"><a href="#BatchRun-228"><span class="linenos">228</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Starting batch run&quot;</span><span class="p">)</span>
</span><span id="BatchRun-229"><a href="#BatchRun-229"><span class="linenos">229</span></a>            
</span><span id="BatchRun-230"><a href="#BatchRun-230"><span class="linenos">230</span></a>            <span class="c1"># Start time limit watchdog if configured</span>
</span><span id="BatchRun-231"><a href="#BatchRun-231"><span class="linenos">231</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_start_time_limit_watchdog</span><span class="p">()</span>
</span><span id="BatchRun-232"><a href="#BatchRun-232"><span class="linenos">232</span></a>            
</span><span id="BatchRun-233"><a href="#BatchRun-233"><span class="linenos">233</span></a>            <span class="c1"># Call initial progress</span>
</span><span id="BatchRun-234"><a href="#BatchRun-234"><span class="linenos">234</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_progress_callback</span><span class="p">:</span>
</span><span id="BatchRun-235"><a href="#BatchRun-235"><span class="linenos">235</span></a>                <span class="n">stats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">()</span>
</span><span id="BatchRun-236"><a href="#BatchRun-236"><span class="linenos">236</span></a>                <span class="n">batch_data</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_tracking</span><span class="p">)</span>
</span><span id="BatchRun-237"><a href="#BatchRun-237"><span class="linenos">237</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_progress_callback</span><span class="p">(</span><span class="n">stats</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">batch_data</span><span class="p">)</span>
</span><span id="BatchRun-238"><a href="#BatchRun-238"><span class="linenos">238</span></a>            
</span><span id="BatchRun-239"><a href="#BatchRun-239"><span class="linenos">239</span></a>            <span class="c1"># Process all jobs synchronously</span>
</span><span id="BatchRun-240"><a href="#BatchRun-240"><span class="linenos">240</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_process_all_jobs</span><span class="p">()</span>
</span><span id="BatchRun-241"><a href="#BatchRun-241"><span class="linenos">241</span></a>            
</span><span id="BatchRun-242"><a href="#BatchRun-242"><span class="linenos">242</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Batch run completed&quot;</span><span class="p">)</span>
</span><span id="BatchRun-243"><a href="#BatchRun-243"><span class="linenos">243</span></a>        <span class="k">finally</span><span class="p">:</span>
</span><span id="BatchRun-244"><a href="#BatchRun-244"><span class="linenos">244</span></a>            <span class="c1"># Restore original signal handler</span>
</span><span id="BatchRun-245"><a href="#BatchRun-245"><span class="linenos">245</span></a>            <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGINT</span><span class="p">,</span> <span class="n">original_handler</span><span class="p">)</span>
</span><span id="BatchRun-246"><a href="#BatchRun-246"><span class="linenos">246</span></a>    
</span><span id="BatchRun-247"><a href="#BatchRun-247"><span class="linenos">247</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">set_on_progress</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">callback</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Dict</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">Dict</span><span class="p">],</span> <span class="kc">None</span><span class="p">],</span> <span class="n">interval</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;BatchRun&#39;</span><span class="p">:</span>
</span><span id="BatchRun-248"><a href="#BatchRun-248"><span class="linenos">248</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Set progress callback for execution monitoring.</span>
</span><span id="BatchRun-249"><a href="#BatchRun-249"><span class="linenos">249</span></a><span class="sd">        </span>
</span><span id="BatchRun-250"><a href="#BatchRun-250"><span class="linenos">250</span></a><span class="sd">        The callback will be called periodically with progress statistics</span>
</span><span id="BatchRun-251"><a href="#BatchRun-251"><span class="linenos">251</span></a><span class="sd">        including completed jobs, total jobs, current cost, etc.</span>
</span><span id="BatchRun-252"><a href="#BatchRun-252"><span class="linenos">252</span></a><span class="sd">        </span>
</span><span id="BatchRun-253"><a href="#BatchRun-253"><span class="linenos">253</span></a><span class="sd">        Args:</span>
</span><span id="BatchRun-254"><a href="#BatchRun-254"><span class="linenos">254</span></a><span class="sd">            callback: Function that receives (stats_dict, elapsed_time_seconds, batch_data)</span>
</span><span id="BatchRun-255"><a href="#BatchRun-255"><span class="linenos">255</span></a><span class="sd">                     - stats_dict: Progress statistics dictionary</span>
</span><span id="BatchRun-256"><a href="#BatchRun-256"><span class="linenos">256</span></a><span class="sd">                     - elapsed_time_seconds: Time elapsed since batch started (float)</span>
</span><span id="BatchRun-257"><a href="#BatchRun-257"><span class="linenos">257</span></a><span class="sd">                     - batch_data: Dictionary mapping batch_id to batch information</span>
</span><span id="BatchRun-258"><a href="#BatchRun-258"><span class="linenos">258</span></a><span class="sd">            interval: Interval in seconds between progress updates (default: 1.0)</span>
</span><span id="BatchRun-259"><a href="#BatchRun-259"><span class="linenos">259</span></a><span class="sd">            </span>
</span><span id="BatchRun-260"><a href="#BatchRun-260"><span class="linenos">260</span></a><span class="sd">        Returns:</span>
</span><span id="BatchRun-261"><a href="#BatchRun-261"><span class="linenos">261</span></a><span class="sd">            Self for chaining</span>
</span><span id="BatchRun-262"><a href="#BatchRun-262"><span class="linenos">262</span></a><span class="sd">            </span>
</span><span id="BatchRun-263"><a href="#BatchRun-263"><span class="linenos">263</span></a><span class="sd">        Example:</span>
</span><span id="BatchRun-264"><a href="#BatchRun-264"><span class="linenos">264</span></a><span class="sd">            ```python</span>
</span><span id="BatchRun-265"><a href="#BatchRun-265"><span class="linenos">265</span></a><span class="sd">            run.set_on_progress(</span>
</span><span id="BatchRun-266"><a href="#BatchRun-266"><span class="linenos">266</span></a><span class="sd">                lambda stats, time, batch_data: print(</span>
</span><span id="BatchRun-267"><a href="#BatchRun-267"><span class="linenos">267</span></a><span class="sd">                    f&quot;Progress: {stats[&#39;completed&#39;]}/{stats[&#39;total&#39;]}, {time:.1f}s&quot;</span>
</span><span id="BatchRun-268"><a href="#BatchRun-268"><span class="linenos">268</span></a><span class="sd">                )</span>
</span><span id="BatchRun-269"><a href="#BatchRun-269"><span class="linenos">269</span></a><span class="sd">            )</span>
</span><span id="BatchRun-270"><a href="#BatchRun-270"><span class="linenos">270</span></a><span class="sd">            ```</span>
</span><span id="BatchRun-271"><a href="#BatchRun-271"><span class="linenos">271</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="BatchRun-272"><a href="#BatchRun-272"><span class="linenos">272</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_progress_callback</span> <span class="o">=</span> <span class="n">callback</span>
</span><span id="BatchRun-273"><a href="#BatchRun-273"><span class="linenos">273</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_progress_interval</span> <span class="o">=</span> <span class="n">interval</span>
</span><span id="BatchRun-274"><a href="#BatchRun-274"><span class="linenos">274</span></a>        <span class="k">return</span> <span class="bp">self</span>
</span><span id="BatchRun-275"><a href="#BatchRun-275"><span class="linenos">275</span></a>    
</span><span id="BatchRun-276"><a href="#BatchRun-276"><span class="linenos">276</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_start_time_limit_watchdog</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="BatchRun-277"><a href="#BatchRun-277"><span class="linenos">277</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Start a background thread to check for time limit every second.&quot;&quot;&quot;</span>
</span><span id="BatchRun-278"><a href="#BatchRun-278"><span class="linenos">278</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">time_limit_seconds</span><span class="p">:</span>
</span><span id="BatchRun-279"><a href="#BatchRun-279"><span class="linenos">279</span></a>            <span class="k">return</span>
</span><span id="BatchRun-280"><a href="#BatchRun-280"><span class="linenos">280</span></a>        
</span><span id="BatchRun-281"><a href="#BatchRun-281"><span class="linenos">281</span></a>        <span class="k">def</span><span class="w"> </span><span class="nf">time_limit_watchdog</span><span class="p">():</span>
</span><span id="BatchRun-282"><a href="#BatchRun-282"><span class="linenos">282</span></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;Check for time limit every second and trigger shutdown if exceeded.&quot;&quot;&quot;</span>
</span><span id="BatchRun-283"><a href="#BatchRun-283"><span class="linenos">283</span></a>            <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shutdown_event</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
</span><span id="BatchRun-284"><a href="#BatchRun-284"><span class="linenos">284</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_time_limit</span><span class="p">():</span>
</span><span id="BatchRun-285"><a href="#BatchRun-285"><span class="linenos">285</span></a>                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Batch execution time limit exceeded&quot;</span><span class="p">)</span>
</span><span id="BatchRun-286"><a href="#BatchRun-286"><span class="linenos">286</span></a>                    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_lock</span><span class="p">:</span>
</span><span id="BatchRun-287"><a href="#BatchRun-287"><span class="linenos">287</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">_time_limit_exceeded</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="BatchRun-288"><a href="#BatchRun-288"><span class="linenos">288</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">_shutdown_event</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
</span><span id="BatchRun-289"><a href="#BatchRun-289"><span class="linenos">289</span></a>                    <span class="k">break</span>
</span><span id="BatchRun-290"><a href="#BatchRun-290"><span class="linenos">290</span></a>                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
</span><span id="BatchRun-291"><a href="#BatchRun-291"><span class="linenos">291</span></a>        
</span><span id="BatchRun-292"><a href="#BatchRun-292"><span class="linenos">292</span></a>        <span class="c1"># Start watchdog as daemon thread</span>
</span><span id="BatchRun-293"><a href="#BatchRun-293"><span class="linenos">293</span></a>        <span class="n">watchdog_thread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">time_limit_watchdog</span><span class="p">,</span> <span class="n">daemon</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="BatchRun-294"><a href="#BatchRun-294"><span class="linenos">294</span></a>        <span class="n">watchdog_thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</span><span id="BatchRun-295"><a href="#BatchRun-295"><span class="linenos">295</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Started time limit watchdog thread (time limit: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">time_limit_seconds</span><span class="si">}</span><span class="s2">s)&quot;</span><span class="p">)</span>
</span><span id="BatchRun-296"><a href="#BatchRun-296"><span class="linenos">296</span></a>    
</span><span id="BatchRun-297"><a href="#BatchRun-297"><span class="linenos">297</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_check_time_limit</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="BatchRun-298"><a href="#BatchRun-298"><span class="linenos">298</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if batch execution has exceeded time limit.&quot;&quot;&quot;</span>
</span><span id="BatchRun-299"><a href="#BatchRun-299"><span class="linenos">299</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">time_limit_seconds</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_start_time</span><span class="p">:</span>
</span><span id="BatchRun-300"><a href="#BatchRun-300"><span class="linenos">300</span></a>            <span class="k">return</span> <span class="kc">False</span>
</span><span id="BatchRun-301"><a href="#BatchRun-301"><span class="linenos">301</span></a>        
</span><span id="BatchRun-302"><a href="#BatchRun-302"><span class="linenos">302</span></a>        <span class="n">elapsed</span> <span class="o">=</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_start_time</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>
</span><span id="BatchRun-303"><a href="#BatchRun-303"><span class="linenos">303</span></a>        <span class="k">return</span> <span class="n">elapsed</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">time_limit_seconds</span>
</span><span id="BatchRun-304"><a href="#BatchRun-304"><span class="linenos">304</span></a>    
</span><span id="BatchRun-305"><a href="#BatchRun-305"><span class="linenos">305</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_process_all_jobs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="BatchRun-306"><a href="#BatchRun-306"><span class="linenos">306</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Process all jobs with parallel execution.&quot;&quot;&quot;</span>
</span><span id="BatchRun-307"><a href="#BatchRun-307"><span class="linenos">307</span></a>        <span class="c1"># Prepare all batches</span>
</span><span id="BatchRun-308"><a href="#BatchRun-308"><span class="linenos">308</span></a>        <span class="n">batches</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_batches</span><span class="p">()</span>
</span><span id="BatchRun-309"><a href="#BatchRun-309"><span class="linenos">309</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">total_batches</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">batches</span><span class="p">)</span>
</span><span id="BatchRun-310"><a href="#BatchRun-310"><span class="linenos">310</span></a>        
</span><span id="BatchRun-311"><a href="#BatchRun-311"><span class="linenos">311</span></a>        <span class="c1"># Process batches in parallel</span>
</span><span id="BatchRun-312"><a href="#BatchRun-312"><span class="linenos">312</span></a>        <span class="k">with</span> <span class="n">ThreadPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">max_parallel_batches</span><span class="p">)</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>
</span><span id="BatchRun-313"><a href="#BatchRun-313"><span class="linenos">313</span></a>            <span class="n">futures</span> <span class="o">=</span> <span class="p">[</span><span class="n">executor</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_execute_batch_wrapped</span><span class="p">,</span> <span class="n">provider</span><span class="p">,</span> <span class="n">batch_jobs</span><span class="p">)</span> 
</span><span id="BatchRun-314"><a href="#BatchRun-314"><span class="linenos">314</span></a>                      <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">provider</span><span class="p">,</span> <span class="n">batch_jobs</span> <span class="ow">in</span> <span class="n">batches</span><span class="p">]</span>
</span><span id="BatchRun-315"><a href="#BatchRun-315"><span class="linenos">315</span></a>            
</span><span id="BatchRun-316"><a href="#BatchRun-316"><span class="linenos">316</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="BatchRun-317"><a href="#BatchRun-317"><span class="linenos">317</span></a>                <span class="k">for</span> <span class="n">future</span> <span class="ow">in</span> <span class="n">as_completed</span><span class="p">(</span><span class="n">futures</span><span class="p">):</span>
</span><span id="BatchRun-318"><a href="#BatchRun-318"><span class="linenos">318</span></a>                    <span class="c1"># Stop if shutdown event detected (includes time limit)</span>
</span><span id="BatchRun-319"><a href="#BatchRun-319"><span class="linenos">319</span></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shutdown_event</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
</span><span id="BatchRun-320"><a href="#BatchRun-320"><span class="linenos">320</span></a>                        <span class="k">break</span>
</span><span id="BatchRun-321"><a href="#BatchRun-321"><span class="linenos">321</span></a>                    <span class="n">future</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>  <span class="c1"># Re-raise any exceptions</span>
</span><span id="BatchRun-322"><a href="#BatchRun-322"><span class="linenos">322</span></a>            <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
</span><span id="BatchRun-323"><a href="#BatchRun-323"><span class="linenos">323</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_shutdown_event</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
</span><span id="BatchRun-324"><a href="#BatchRun-324"><span class="linenos">324</span></a>                <span class="c1"># Cancel remaining futures</span>
</span><span id="BatchRun-325"><a href="#BatchRun-325"><span class="linenos">325</span></a>                <span class="k">for</span> <span class="n">future</span> <span class="ow">in</span> <span class="n">futures</span><span class="p">:</span>
</span><span id="BatchRun-326"><a href="#BatchRun-326"><span class="linenos">326</span></a>                    <span class="n">future</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>
</span><span id="BatchRun-327"><a href="#BatchRun-327"><span class="linenos">327</span></a>                <span class="k">raise</span>
</span><span id="BatchRun-328"><a href="#BatchRun-328"><span class="linenos">328</span></a>            <span class="k">finally</span><span class="p">:</span>
</span><span id="BatchRun-329"><a href="#BatchRun-329"><span class="linenos">329</span></a>                <span class="c1"># Handle time limit or cancellation - mark remaining jobs appropriately</span>
</span><span id="BatchRun-330"><a href="#BatchRun-330"><span class="linenos">330</span></a>                <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_lock</span><span class="p">:</span>
</span><span id="BatchRun-331"><a href="#BatchRun-331"><span class="linenos">331</span></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shutdown_event</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
</span><span id="BatchRun-332"><a href="#BatchRun-332"><span class="linenos">332</span></a>                        <span class="c1"># If time limit exceeded, cancel all active batches</span>
</span><span id="BatchRun-333"><a href="#BatchRun-333"><span class="linenos">333</span></a>                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_time_limit_exceeded</span><span class="p">:</span>
</span><span id="BatchRun-334"><a href="#BatchRun-334"><span class="linenos">334</span></a>                            <span class="bp">self</span><span class="o">.</span><span class="n">_cancel_all_active_batches</span><span class="p">()</span>
</span><span id="BatchRun-335"><a href="#BatchRun-335"><span class="linenos">335</span></a>                        
</span><span id="BatchRun-336"><a href="#BatchRun-336"><span class="linenos">336</span></a>                        <span class="c1"># Mark any unprocessed jobs based on reason for shutdown</span>
</span><span id="BatchRun-337"><a href="#BatchRun-337"><span class="linenos">337</span></a>                        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">batch_jobs</span> <span class="ow">in</span> <span class="n">batches</span><span class="p">:</span>
</span><span id="BatchRun-338"><a href="#BatchRun-338"><span class="linenos">338</span></a>                            <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="n">batch_jobs</span><span class="p">:</span>
</span><span id="BatchRun-339"><a href="#BatchRun-339"><span class="linenos">339</span></a>                                <span class="c1"># Skip jobs already processed</span>
</span><span id="BatchRun-340"><a href="#BatchRun-340"><span class="linenos">340</span></a>                                <span class="k">if</span> <span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">completed_results</span> <span class="ow">or</span> 
</span><span id="BatchRun-341"><a href="#BatchRun-341"><span class="linenos">341</span></a>                                    <span class="n">job</span><span class="o">.</span><span class="n">id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">failed_jobs</span> <span class="ow">or</span> 
</span><span id="BatchRun-342"><a href="#BatchRun-342"><span class="linenos">342</span></a>                                    <span class="n">job</span><span class="o">.</span><span class="n">id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cancelled_jobs</span><span class="p">):</span>
</span><span id="BatchRun-343"><a href="#BatchRun-343"><span class="linenos">343</span></a>                                    <span class="k">continue</span>
</span><span id="BatchRun-344"><a href="#BatchRun-344"><span class="linenos">344</span></a>                                
</span><span id="BatchRun-345"><a href="#BatchRun-345"><span class="linenos">345</span></a>                                <span class="c1"># Mark based on shutdown reason</span>
</span><span id="BatchRun-346"><a href="#BatchRun-346"><span class="linenos">346</span></a>                                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_time_limit_exceeded</span><span class="p">:</span>
</span><span id="BatchRun-347"><a href="#BatchRun-347"><span class="linenos">347</span></a>                                    <span class="bp">self</span><span class="o">.</span><span class="n">failed_jobs</span><span class="p">[</span><span class="n">job</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Time limit exceeded: batch execution time limit exceeded&quot;</span>
</span><span id="BatchRun-348"><a href="#BatchRun-348"><span class="linenos">348</span></a>                                <span class="k">else</span><span class="p">:</span>
</span><span id="BatchRun-349"><a href="#BatchRun-349"><span class="linenos">349</span></a>                                    <span class="bp">self</span><span class="o">.</span><span class="n">cancelled_jobs</span><span class="p">[</span><span class="n">job</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Cancelled by user&quot;</span>
</span><span id="BatchRun-350"><a href="#BatchRun-350"><span class="linenos">350</span></a>                                
</span><span id="BatchRun-351"><a href="#BatchRun-351"><span class="linenos">351</span></a>                                <span class="k">if</span> <span class="n">job</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pending_jobs</span><span class="p">:</span>
</span><span id="BatchRun-352"><a href="#BatchRun-352"><span class="linenos">352</span></a>                                    <span class="bp">self</span><span class="o">.</span><span class="n">pending_jobs</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>
</span><span id="BatchRun-353"><a href="#BatchRun-353"><span class="linenos">353</span></a>                        
</span><span id="BatchRun-354"><a href="#BatchRun-354"><span class="linenos">354</span></a>                        <span class="c1"># Save state</span>
</span><span id="BatchRun-355"><a href="#BatchRun-355"><span class="linenos">355</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">state_manager</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span><span id="BatchRun-356"><a href="#BatchRun-356"><span class="linenos">356</span></a>    
</span><span id="BatchRun-357"><a href="#BatchRun-357"><span class="linenos">357</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_cancel_all_active_batches</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="BatchRun-358"><a href="#BatchRun-358"><span class="linenos">358</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Cancel all active batches at the provider level.&quot;&quot;&quot;</span>
</span><span id="BatchRun-359"><a href="#BatchRun-359"><span class="linenos">359</span></a>        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_active_batches_lock</span><span class="p">:</span>
</span><span id="BatchRun-360"><a href="#BatchRun-360"><span class="linenos">360</span></a>            <span class="n">active_batch_items</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_active_batches</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
</span><span id="BatchRun-361"><a href="#BatchRun-361"><span class="linenos">361</span></a>            
</span><span id="BatchRun-362"><a href="#BatchRun-362"><span class="linenos">362</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cancelling </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">active_batch_items</span><span class="p">)</span><span class="si">}</span><span class="s2"> active batches due to time limit exceeded&quot;</span><span class="p">)</span>
</span><span id="BatchRun-363"><a href="#BatchRun-363"><span class="linenos">363</span></a>        
</span><span id="BatchRun-364"><a href="#BatchRun-364"><span class="linenos">364</span></a>        <span class="c1"># Cancel outside the lock to avoid blocking</span>
</span><span id="BatchRun-365"><a href="#BatchRun-365"><span class="linenos">365</span></a>        <span class="k">for</span> <span class="n">batch_id</span><span class="p">,</span> <span class="n">provider</span> <span class="ow">in</span> <span class="n">active_batch_items</span><span class="p">:</span>
</span><span id="BatchRun-366"><a href="#BatchRun-366"><span class="linenos">366</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="BatchRun-367"><a href="#BatchRun-367"><span class="linenos">367</span></a>                <span class="n">provider</span><span class="o">.</span><span class="n">cancel_batch</span><span class="p">(</span><span class="n">batch_id</span><span class="p">)</span>
</span><span id="BatchRun-368"><a href="#BatchRun-368"><span class="linenos">368</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cancelled batch </span><span class="si">{</span><span class="n">batch_id</span><span class="si">}</span><span class="s2"> due to time limit exceeded&quot;</span><span class="p">)</span>
</span><span id="BatchRun-369"><a href="#BatchRun-369"><span class="linenos">369</span></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="BatchRun-370"><a href="#BatchRun-370"><span class="linenos">370</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to cancel batch </span><span class="si">{</span><span class="n">batch_id</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="BatchRun-371"><a href="#BatchRun-371"><span class="linenos">371</span></a>        
</span><span id="BatchRun-372"><a href="#BatchRun-372"><span class="linenos">372</span></a>        <span class="c1"># Clear the tracking after cancellation attempts</span>
</span><span id="BatchRun-373"><a href="#BatchRun-373"><span class="linenos">373</span></a>        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_active_batches_lock</span><span class="p">:</span>
</span><span id="BatchRun-374"><a href="#BatchRun-374"><span class="linenos">374</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_active_batches</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
</span><span id="BatchRun-375"><a href="#BatchRun-375"><span class="linenos">375</span></a>    
</span><span id="BatchRun-376"><a href="#BatchRun-376"><span class="linenos">376</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_execute_batch_wrapped</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">provider</span><span class="p">,</span> <span class="n">batch_jobs</span><span class="p">):</span>
</span><span id="BatchRun-377"><a href="#BatchRun-377"><span class="linenos">377</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Thread-safe wrapper for _execute_batch.&quot;&quot;&quot;</span>
</span><span id="BatchRun-378"><a href="#BatchRun-378"><span class="linenos">378</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="BatchRun-379"><a href="#BatchRun-379"><span class="linenos">379</span></a>            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_execute_batch</span><span class="p">(</span><span class="n">provider</span><span class="p">,</span> <span class="n">batch_jobs</span><span class="p">)</span>
</span><span id="BatchRun-380"><a href="#BatchRun-380"><span class="linenos">380</span></a>            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_lock</span><span class="p">:</span>
</span><span id="BatchRun-381"><a href="#BatchRun-381"><span class="linenos">381</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_update_batch_results</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</span><span id="BatchRun-382"><a href="#BatchRun-382"><span class="linenos">382</span></a>                <span class="c1"># Remove jobs from pending_jobs if specified</span>
</span><span id="BatchRun-383"><a href="#BatchRun-383"><span class="linenos">383</span></a>                <span class="n">jobs_to_remove</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;jobs_to_remove&quot;</span><span class="p">,</span> <span class="p">[])</span>
</span><span id="BatchRun-384"><a href="#BatchRun-384"><span class="linenos">384</span></a>                <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="n">jobs_to_remove</span><span class="p">:</span>
</span><span id="BatchRun-385"><a href="#BatchRun-385"><span class="linenos">385</span></a>                    <span class="k">if</span> <span class="n">job</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pending_jobs</span><span class="p">:</span>
</span><span id="BatchRun-386"><a href="#BatchRun-386"><span class="linenos">386</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">pending_jobs</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>
</span><span id="BatchRun-387"><a href="#BatchRun-387"><span class="linenos">387</span></a>        <span class="k">except</span> <span class="ne">TimeoutError</span><span class="p">:</span>
</span><span id="BatchRun-388"><a href="#BatchRun-388"><span class="linenos">388</span></a>            <span class="c1"># Handle time limit exceeded - mark jobs as failed</span>
</span><span id="BatchRun-389"><a href="#BatchRun-389"><span class="linenos">389</span></a>            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_lock</span><span class="p">:</span>
</span><span id="BatchRun-390"><a href="#BatchRun-390"><span class="linenos">390</span></a>                <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="n">batch_jobs</span><span class="p">:</span>
</span><span id="BatchRun-391"><a href="#BatchRun-391"><span class="linenos">391</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">failed_jobs</span><span class="p">[</span><span class="n">job</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Time limit exceeded: batch execution time limit exceeded&quot;</span>
</span><span id="BatchRun-392"><a href="#BatchRun-392"><span class="linenos">392</span></a>                    <span class="k">if</span> <span class="n">job</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pending_jobs</span><span class="p">:</span>
</span><span id="BatchRun-393"><a href="#BatchRun-393"><span class="linenos">393</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">pending_jobs</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>
</span><span id="BatchRun-394"><a href="#BatchRun-394"><span class="linenos">394</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">state_manager</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span><span id="BatchRun-395"><a href="#BatchRun-395"><span class="linenos">395</span></a>            <span class="c1"># Don&#39;t re-raise, just return the result</span>
</span><span id="BatchRun-396"><a href="#BatchRun-396"><span class="linenos">396</span></a>            <span class="k">return</span>
</span><span id="BatchRun-397"><a href="#BatchRun-397"><span class="linenos">397</span></a>        <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
</span><span id="BatchRun-398"><a href="#BatchRun-398"><span class="linenos">398</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_shutdown_event</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
</span><span id="BatchRun-399"><a href="#BatchRun-399"><span class="linenos">399</span></a>            <span class="c1"># Handle user cancellation</span>
</span><span id="BatchRun-400"><a href="#BatchRun-400"><span class="linenos">400</span></a>            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_lock</span><span class="p">:</span>
</span><span id="BatchRun-401"><a href="#BatchRun-401"><span class="linenos">401</span></a>                <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="n">batch_jobs</span><span class="p">:</span>
</span><span id="BatchRun-402"><a href="#BatchRun-402"><span class="linenos">402</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">cancelled_jobs</span><span class="p">[</span><span class="n">job</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Cancelled by user&quot;</span>
</span><span id="BatchRun-403"><a href="#BatchRun-403"><span class="linenos">403</span></a>                    <span class="k">if</span> <span class="n">job</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pending_jobs</span><span class="p">:</span>
</span><span id="BatchRun-404"><a href="#BatchRun-404"><span class="linenos">404</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">pending_jobs</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>
</span><span id="BatchRun-405"><a href="#BatchRun-405"><span class="linenos">405</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">state_manager</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span><span id="BatchRun-406"><a href="#BatchRun-406"><span class="linenos">406</span></a>            <span class="k">raise</span>
</span><span id="BatchRun-407"><a href="#BatchRun-407"><span class="linenos">407</span></a>    
</span><span id="BatchRun-408"><a href="#BatchRun-408"><span class="linenos">408</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_group_jobs_by_provider</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Job</span><span class="p">]]:</span>
</span><span id="BatchRun-409"><a href="#BatchRun-409"><span class="linenos">409</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Group jobs by provider.&quot;&quot;&quot;</span>
</span><span id="BatchRun-410"><a href="#BatchRun-410"><span class="linenos">410</span></a>        <span class="n">jobs_by_provider</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="BatchRun-411"><a href="#BatchRun-411"><span class="linenos">411</span></a>        
</span><span id="BatchRun-412"><a href="#BatchRun-412"><span class="linenos">412</span></a>        <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pending_jobs</span><span class="p">[:]:</span>  <span class="c1"># Copy to avoid modification during iteration</span>
</span><span id="BatchRun-413"><a href="#BatchRun-413"><span class="linenos">413</span></a>            <span class="k">try</span><span class="p">:</span>
</span><span id="BatchRun-414"><a href="#BatchRun-414"><span class="linenos">414</span></a>                <span class="n">provider</span> <span class="o">=</span> <span class="n">get_provider</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">model</span><span class="p">)</span>
</span><span id="BatchRun-415"><a href="#BatchRun-415"><span class="linenos">415</span></a>                <span class="n">provider_name</span> <span class="o">=</span> <span class="n">provider</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
</span><span id="BatchRun-416"><a href="#BatchRun-416"><span class="linenos">416</span></a>                
</span><span id="BatchRun-417"><a href="#BatchRun-417"><span class="linenos">417</span></a>                <span class="k">if</span> <span class="n">provider_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">jobs_by_provider</span><span class="p">:</span>
</span><span id="BatchRun-418"><a href="#BatchRun-418"><span class="linenos">418</span></a>                    <span class="n">jobs_by_provider</span><span class="p">[</span><span class="n">provider_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="BatchRun-419"><a href="#BatchRun-419"><span class="linenos">419</span></a>                
</span><span id="BatchRun-420"><a href="#BatchRun-420"><span class="linenos">420</span></a>                <span class="n">jobs_by_provider</span><span class="p">[</span><span class="n">provider_name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>
</span><span id="BatchRun-421"><a href="#BatchRun-421"><span class="linenos">421</span></a>                
</span><span id="BatchRun-422"><a href="#BatchRun-422"><span class="linenos">422</span></a>            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="BatchRun-423"><a href="#BatchRun-423"><span class="linenos">423</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to get provider for job </span><span class="si">{</span><span class="n">job</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="BatchRun-424"><a href="#BatchRun-424"><span class="linenos">424</span></a>                <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_lock</span><span class="p">:</span>
</span><span id="BatchRun-425"><a href="#BatchRun-425"><span class="linenos">425</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">failed_jobs</span><span class="p">[</span><span class="n">job</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</span><span id="BatchRun-426"><a href="#BatchRun-426"><span class="linenos">426</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">pending_jobs</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>
</span><span id="BatchRun-427"><a href="#BatchRun-427"><span class="linenos">427</span></a>        
</span><span id="BatchRun-428"><a href="#BatchRun-428"><span class="linenos">428</span></a>        <span class="k">return</span> <span class="n">jobs_by_provider</span>
</span><span id="BatchRun-429"><a href="#BatchRun-429"><span class="linenos">429</span></a>    
</span><span id="BatchRun-430"><a href="#BatchRun-430"><span class="linenos">430</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_split_into_batches</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">jobs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Job</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Job</span><span class="p">]]:</span>
</span><span id="BatchRun-431"><a href="#BatchRun-431"><span class="linenos">431</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Split jobs into batches based on items_per_batch.&quot;&quot;&quot;</span>
</span><span id="BatchRun-432"><a href="#BatchRun-432"><span class="linenos">432</span></a>        <span class="n">batches</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="BatchRun-433"><a href="#BatchRun-433"><span class="linenos">433</span></a>        <span class="n">batch_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">items_per_batch</span>
</span><span id="BatchRun-434"><a href="#BatchRun-434"><span class="linenos">434</span></a>        
</span><span id="BatchRun-435"><a href="#BatchRun-435"><span class="linenos">435</span></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">jobs</span><span class="p">),</span> <span class="n">batch_size</span><span class="p">):</span>
</span><span id="BatchRun-436"><a href="#BatchRun-436"><span class="linenos">436</span></a>            <span class="n">batch</span> <span class="o">=</span> <span class="n">jobs</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="n">batch_size</span><span class="p">]</span>
</span><span id="BatchRun-437"><a href="#BatchRun-437"><span class="linenos">437</span></a>            <span class="n">batches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
</span><span id="BatchRun-438"><a href="#BatchRun-438"><span class="linenos">438</span></a>        
</span><span id="BatchRun-439"><a href="#BatchRun-439"><span class="linenos">439</span></a>        <span class="k">return</span> <span class="n">batches</span>
</span><span id="BatchRun-440"><a href="#BatchRun-440"><span class="linenos">440</span></a>    
</span><span id="BatchRun-441"><a href="#BatchRun-441"><span class="linenos">441</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_prepare_batches</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">object</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Job</span><span class="p">]]]:</span>
</span><span id="BatchRun-442"><a href="#BatchRun-442"><span class="linenos">442</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Prepare all batches as simple list of (provider_name, provider, jobs).&quot;&quot;&quot;</span>
</span><span id="BatchRun-443"><a href="#BatchRun-443"><span class="linenos">443</span></a>        <span class="n">batches</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="BatchRun-444"><a href="#BatchRun-444"><span class="linenos">444</span></a>        <span class="n">jobs_by_provider</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_group_jobs_by_provider</span><span class="p">()</span>
</span><span id="BatchRun-445"><a href="#BatchRun-445"><span class="linenos">445</span></a>        
</span><span id="BatchRun-446"><a href="#BatchRun-446"><span class="linenos">446</span></a>        <span class="k">for</span> <span class="n">provider_name</span><span class="p">,</span> <span class="n">provider_jobs</span> <span class="ow">in</span> <span class="n">jobs_by_provider</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="BatchRun-447"><a href="#BatchRun-447"><span class="linenos">447</span></a>            <span class="n">provider</span> <span class="o">=</span> <span class="n">get_provider</span><span class="p">(</span><span class="n">provider_jobs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">model</span><span class="p">)</span>
</span><span id="BatchRun-448"><a href="#BatchRun-448"><span class="linenos">448</span></a>            <span class="n">job_batches</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_split_into_batches</span><span class="p">(</span><span class="n">provider_jobs</span><span class="p">)</span>
</span><span id="BatchRun-449"><a href="#BatchRun-449"><span class="linenos">449</span></a>            
</span><span id="BatchRun-450"><a href="#BatchRun-450"><span class="linenos">450</span></a>            <span class="k">for</span> <span class="n">batch_jobs</span> <span class="ow">in</span> <span class="n">job_batches</span><span class="p">:</span>
</span><span id="BatchRun-451"><a href="#BatchRun-451"><span class="linenos">451</span></a>                <span class="n">batches</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">provider_name</span><span class="p">,</span> <span class="n">provider</span><span class="p">,</span> <span class="n">batch_jobs</span><span class="p">))</span>
</span><span id="BatchRun-452"><a href="#BatchRun-452"><span class="linenos">452</span></a>                
</span><span id="BatchRun-453"><a href="#BatchRun-453"><span class="linenos">453</span></a>                <span class="c1"># Pre-populate batch tracking for pending batches</span>
</span><span id="BatchRun-454"><a href="#BatchRun-454"><span class="linenos">454</span></a>                <span class="n">batch_id</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;pending_</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_tracking</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="BatchRun-455"><a href="#BatchRun-455"><span class="linenos">455</span></a>                <span class="n">estimated_cost</span> <span class="o">=</span> <span class="n">provider</span><span class="o">.</span><span class="n">estimate_cost</span><span class="p">(</span><span class="n">batch_jobs</span><span class="p">)</span>
</span><span id="BatchRun-456"><a href="#BatchRun-456"><span class="linenos">456</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">batch_tracking</span><span class="p">[</span><span class="n">batch_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="BatchRun-457"><a href="#BatchRun-457"><span class="linenos">457</span></a>                    <span class="s1">&#39;start_time&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="BatchRun-458"><a href="#BatchRun-458"><span class="linenos">458</span></a>                    <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;pending&#39;</span><span class="p">,</span>
</span><span id="BatchRun-459"><a href="#BatchRun-459"><span class="linenos">459</span></a>                    <span class="s1">&#39;total&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">batch_jobs</span><span class="p">),</span>
</span><span id="BatchRun-460"><a href="#BatchRun-460"><span class="linenos">460</span></a>                    <span class="s1">&#39;completed&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="BatchRun-461"><a href="#BatchRun-461"><span class="linenos">461</span></a>                    <span class="s1">&#39;cost&#39;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
</span><span id="BatchRun-462"><a href="#BatchRun-462"><span class="linenos">462</span></a>                    <span class="s1">&#39;estimated_cost&#39;</span><span class="p">:</span> <span class="n">estimated_cost</span><span class="p">,</span>
</span><span id="BatchRun-463"><a href="#BatchRun-463"><span class="linenos">463</span></a>                    <span class="s1">&#39;provider&#39;</span><span class="p">:</span> <span class="n">provider_name</span><span class="p">,</span>
</span><span id="BatchRun-464"><a href="#BatchRun-464"><span class="linenos">464</span></a>                    <span class="s1">&#39;jobs&#39;</span><span class="p">:</span> <span class="n">batch_jobs</span>
</span><span id="BatchRun-465"><a href="#BatchRun-465"><span class="linenos">465</span></a>                <span class="p">}</span>
</span><span id="BatchRun-466"><a href="#BatchRun-466"><span class="linenos">466</span></a>        
</span><span id="BatchRun-467"><a href="#BatchRun-467"><span class="linenos">467</span></a>        <span class="k">return</span> <span class="n">batches</span>
</span><span id="BatchRun-468"><a href="#BatchRun-468"><span class="linenos">468</span></a>    
</span><span id="BatchRun-469"><a href="#BatchRun-469"><span class="linenos">469</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_poll_batch_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">provider</span><span class="p">,</span> <span class="n">batch_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">]]:</span>
</span><span id="BatchRun-470"><a href="#BatchRun-470"><span class="linenos">470</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Poll until batch completes.&quot;&quot;&quot;</span>
</span><span id="BatchRun-471"><a href="#BatchRun-471"><span class="linenos">471</span></a>        <span class="n">status</span><span class="p">,</span> <span class="n">error_details</span> <span class="o">=</span> <span class="n">provider</span><span class="o">.</span><span class="n">get_batch_status</span><span class="p">(</span><span class="n">batch_id</span><span class="p">)</span>
</span><span id="BatchRun-472"><a href="#BatchRun-472"><span class="linenos">472</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Initial batch status: </span><span class="si">{</span><span class="n">status</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="BatchRun-473"><a href="#BatchRun-473"><span class="linenos">473</span></a>        <span class="n">poll_count</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="BatchRun-474"><a href="#BatchRun-474"><span class="linenos">474</span></a>        
</span><span id="BatchRun-475"><a href="#BatchRun-475"><span class="linenos">475</span></a>        <span class="c1"># Use provider-specific polling interval</span>
</span><span id="BatchRun-476"><a href="#BatchRun-476"><span class="linenos">476</span></a>        <span class="n">provider_polling_interval</span> <span class="o">=</span> <span class="n">provider</span><span class="o">.</span><span class="n">get_polling_interval</span><span class="p">()</span>
</span><span id="BatchRun-477"><a href="#BatchRun-477"><span class="linenos">477</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Using </span><span class="si">{</span><span class="n">provider_polling_interval</span><span class="si">}</span><span class="s2">s polling interval for </span><span class="si">{</span><span class="n">provider</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="BatchRun-478"><a href="#BatchRun-478"><span class="linenos">478</span></a>        
</span><span id="BatchRun-479"><a href="#BatchRun-479"><span class="linenos">479</span></a>        <span class="k">while</span> <span class="n">status</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;complete&quot;</span><span class="p">,</span> <span class="s2">&quot;failed&quot;</span><span class="p">]:</span>
</span><span id="BatchRun-480"><a href="#BatchRun-480"><span class="linenos">480</span></a>            <span class="n">poll_count</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="BatchRun-481"><a href="#BatchRun-481"><span class="linenos">481</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Polling attempt </span><span class="si">{</span><span class="n">poll_count</span><span class="si">}</span><span class="s2">, current status: </span><span class="si">{</span><span class="n">status</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="BatchRun-482"><a href="#BatchRun-482"><span class="linenos">482</span></a>            
</span><span id="BatchRun-483"><a href="#BatchRun-483"><span class="linenos">483</span></a>            <span class="c1"># Interruptible wait - will wake up immediately if shutdown event is set (includes time limit)</span>
</span><span id="BatchRun-484"><a href="#BatchRun-484"><span class="linenos">484</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_shutdown_event</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">provider_polling_interval</span><span class="p">):</span>
</span><span id="BatchRun-485"><a href="#BatchRun-485"><span class="linenos">485</span></a>                <span class="c1"># Check if it&#39;s time limit exceeded or user cancellation</span>
</span><span id="BatchRun-486"><a href="#BatchRun-486"><span class="linenos">486</span></a>                <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_lock</span><span class="p">:</span>
</span><span id="BatchRun-487"><a href="#BatchRun-487"><span class="linenos">487</span></a>                    <span class="n">is_time_limit_exceeded</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_time_limit_exceeded</span>
</span><span id="BatchRun-488"><a href="#BatchRun-488"><span class="linenos">488</span></a>                
</span><span id="BatchRun-489"><a href="#BatchRun-489"><span class="linenos">489</span></a>                <span class="k">if</span> <span class="n">is_time_limit_exceeded</span><span class="p">:</span>
</span><span id="BatchRun-490"><a href="#BatchRun-490"><span class="linenos">490</span></a>                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Batch </span><span class="si">{</span><span class="n">batch_id</span><span class="si">}</span><span class="s2"> polling interrupted by time limit exceeded&quot;</span><span class="p">)</span>
</span><span id="BatchRun-491"><a href="#BatchRun-491"><span class="linenos">491</span></a>                    <span class="k">raise</span> <span class="ne">TimeoutError</span><span class="p">(</span><span class="s2">&quot;Batch cancelled due to time limit exceeded&quot;</span><span class="p">)</span>
</span><span id="BatchRun-492"><a href="#BatchRun-492"><span class="linenos">492</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="BatchRun-493"><a href="#BatchRun-493"><span class="linenos">493</span></a>                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Batch </span><span class="si">{</span><span class="n">batch_id</span><span class="si">}</span><span class="s2"> polling interrupted by user&quot;</span><span class="p">)</span>
</span><span id="BatchRun-494"><a href="#BatchRun-494"><span class="linenos">494</span></a>                    <span class="k">raise</span> <span class="ne">KeyboardInterrupt</span><span class="p">(</span><span class="s2">&quot;Batch cancelled by user&quot;</span><span class="p">)</span>
</span><span id="BatchRun-495"><a href="#BatchRun-495"><span class="linenos">495</span></a>            
</span><span id="BatchRun-496"><a href="#BatchRun-496"><span class="linenos">496</span></a>            <span class="n">status</span><span class="p">,</span> <span class="n">error_details</span> <span class="o">=</span> <span class="n">provider</span><span class="o">.</span><span class="n">get_batch_status</span><span class="p">(</span><span class="n">batch_id</span><span class="p">)</span>
</span><span id="BatchRun-497"><a href="#BatchRun-497"><span class="linenos">497</span></a>            
</span><span id="BatchRun-498"><a href="#BatchRun-498"><span class="linenos">498</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_progress_callback</span><span class="p">:</span>
</span><span id="BatchRun-499"><a href="#BatchRun-499"><span class="linenos">499</span></a>                <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_lock</span><span class="p">:</span>
</span><span id="BatchRun-500"><a href="#BatchRun-500"><span class="linenos">500</span></a>                    <span class="n">stats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">()</span>
</span><span id="BatchRun-501"><a href="#BatchRun-501"><span class="linenos">501</span></a>                    <span class="n">elapsed_time</span> <span class="o">=</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_start_time</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span>
</span><span id="BatchRun-502"><a href="#BatchRun-502"><span class="linenos">502</span></a>                    <span class="n">batch_data</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_tracking</span><span class="p">)</span>
</span><span id="BatchRun-503"><a href="#BatchRun-503"><span class="linenos">503</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_progress_callback</span><span class="p">(</span><span class="n">stats</span><span class="p">,</span> <span class="n">elapsed_time</span><span class="p">,</span> <span class="n">batch_data</span><span class="p">)</span>
</span><span id="BatchRun-504"><a href="#BatchRun-504"><span class="linenos">504</span></a>            
</span><span id="BatchRun-505"><a href="#BatchRun-505"><span class="linenos">505</span></a>            <span class="n">elapsed_seconds</span> <span class="o">=</span> <span class="n">poll_count</span> <span class="o">*</span> <span class="n">provider_polling_interval</span>
</span><span id="BatchRun-506"><a href="#BatchRun-506"><span class="linenos">506</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Batch </span><span class="si">{</span><span class="n">batch_id</span><span class="si">}</span><span class="s2"> status: </span><span class="si">{</span><span class="n">status</span><span class="si">}</span><span class="s2"> (polling for </span><span class="si">{</span><span class="n">elapsed_seconds</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">s)&quot;</span><span class="p">)</span>
</span><span id="BatchRun-507"><a href="#BatchRun-507"><span class="linenos">507</span></a>        
</span><span id="BatchRun-508"><a href="#BatchRun-508"><span class="linenos">508</span></a>        <span class="k">return</span> <span class="n">status</span><span class="p">,</span> <span class="n">error_details</span>
</span><span id="BatchRun-509"><a href="#BatchRun-509"><span class="linenos">509</span></a>    
</span><span id="BatchRun-510"><a href="#BatchRun-510"><span class="linenos">510</span></a>    
</span><span id="BatchRun-511"><a href="#BatchRun-511"><span class="linenos">511</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_update_batch_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch_result</span><span class="p">:</span> <span class="n">Dict</span><span class="p">):</span>
</span><span id="BatchRun-512"><a href="#BatchRun-512"><span class="linenos">512</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Update state from batch results.&quot;&quot;&quot;</span>
</span><span id="BatchRun-513"><a href="#BatchRun-513"><span class="linenos">513</span></a>        <span class="n">results</span> <span class="o">=</span> <span class="n">batch_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;results&quot;</span><span class="p">,</span> <span class="p">[])</span>
</span><span id="BatchRun-514"><a href="#BatchRun-514"><span class="linenos">514</span></a>        <span class="n">failed</span> <span class="o">=</span> <span class="n">batch_result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;failed&quot;</span><span class="p">,</span> <span class="p">{})</span>
</span><span id="BatchRun-515"><a href="#BatchRun-515"><span class="linenos">515</span></a>                
</span><span id="BatchRun-516"><a href="#BatchRun-516"><span class="linenos">516</span></a>        <span class="c1"># Update completed results</span>
</span><span id="BatchRun-517"><a href="#BatchRun-517"><span class="linenos">517</span></a>        <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
</span><span id="BatchRun-518"><a href="#BatchRun-518"><span class="linenos">518</span></a>            <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">is_success</span><span class="p">:</span>
</span><span id="BatchRun-519"><a href="#BatchRun-519"><span class="linenos">519</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">completed_results</span><span class="p">[</span><span class="n">result</span><span class="o">.</span><span class="n">job_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span>
</span><span id="BatchRun-520"><a href="#BatchRun-520"><span class="linenos">520</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_save_result_to_file</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</span><span id="BatchRun-521"><a href="#BatchRun-521"><span class="linenos">521</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✓ Job </span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">job_id</span><span class="si">}</span><span class="s2"> completed successfully&quot;</span><span class="p">)</span>
</span><span id="BatchRun-522"><a href="#BatchRun-522"><span class="linenos">522</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="BatchRun-523"><a href="#BatchRun-523"><span class="linenos">523</span></a>                <span class="n">error_message</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">error</span> <span class="ow">or</span> <span class="s2">&quot;Unknown error&quot;</span>
</span><span id="BatchRun-524"><a href="#BatchRun-524"><span class="linenos">524</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">failed_jobs</span><span class="p">[</span><span class="n">result</span><span class="o">.</span><span class="n">job_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">error_message</span>
</span><span id="BatchRun-525"><a href="#BatchRun-525"><span class="linenos">525</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_save_result_to_file</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</span><span id="BatchRun-526"><a href="#BatchRun-526"><span class="linenos">526</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✗ Job </span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">job_id</span><span class="si">}</span><span class="s2"> failed: </span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">error</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="BatchRun-527"><a href="#BatchRun-527"><span class="linenos">527</span></a>            
</span><span id="BatchRun-528"><a href="#BatchRun-528"><span class="linenos">528</span></a>            <span class="c1"># Remove completed/failed job from pending</span>
</span><span id="BatchRun-529"><a href="#BatchRun-529"><span class="linenos">529</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">pending_jobs</span> <span class="o">=</span> <span class="p">[</span><span class="n">job</span> <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pending_jobs</span> <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">id</span> <span class="o">!=</span> <span class="n">result</span><span class="o">.</span><span class="n">job_id</span><span class="p">]</span>
</span><span id="BatchRun-530"><a href="#BatchRun-530"><span class="linenos">530</span></a>        
</span><span id="BatchRun-531"><a href="#BatchRun-531"><span class="linenos">531</span></a>        <span class="c1"># Update failed jobs</span>
</span><span id="BatchRun-532"><a href="#BatchRun-532"><span class="linenos">532</span></a>        <span class="k">for</span> <span class="n">job_id</span><span class="p">,</span> <span class="n">error</span> <span class="ow">in</span> <span class="n">failed</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="BatchRun-533"><a href="#BatchRun-533"><span class="linenos">533</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">failed_jobs</span><span class="p">[</span><span class="n">job_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">error</span>
</span><span id="BatchRun-534"><a href="#BatchRun-534"><span class="linenos">534</span></a>            <span class="c1"># Remove failed job from pending</span>
</span><span id="BatchRun-535"><a href="#BatchRun-535"><span class="linenos">535</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">pending_jobs</span> <span class="o">=</span> <span class="p">[</span><span class="n">job</span> <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pending_jobs</span> <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">id</span> <span class="o">!=</span> <span class="n">job_id</span><span class="p">]</span>
</span><span id="BatchRun-536"><a href="#BatchRun-536"><span class="linenos">536</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✗ Job </span><span class="si">{</span><span class="n">job_id</span><span class="si">}</span><span class="s2"> failed: </span><span class="si">{</span><span class="n">error</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="BatchRun-537"><a href="#BatchRun-537"><span class="linenos">537</span></a>        
</span><span id="BatchRun-538"><a href="#BatchRun-538"><span class="linenos">538</span></a>        <span class="c1"># Update batch tracking</span>
</span><span id="BatchRun-539"><a href="#BatchRun-539"><span class="linenos">539</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">completed_batches</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span id="BatchRun-540"><a href="#BatchRun-540"><span class="linenos">540</span></a>        
</span><span id="BatchRun-541"><a href="#BatchRun-541"><span class="linenos">541</span></a>        <span class="c1"># Save state</span>
</span><span id="BatchRun-542"><a href="#BatchRun-542"><span class="linenos">542</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">state_manager</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span><span id="BatchRun-543"><a href="#BatchRun-543"><span class="linenos">543</span></a>    
</span><span id="BatchRun-544"><a href="#BatchRun-544"><span class="linenos">544</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_execute_batch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">provider</span><span class="p">,</span> <span class="n">batch_jobs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Job</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
</span><span id="BatchRun-545"><a href="#BatchRun-545"><span class="linenos">545</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute one batch, return results dict with jobs/costs/errors.&quot;&quot;&quot;</span>
</span><span id="BatchRun-546"><a href="#BatchRun-546"><span class="linenos">546</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">batch_jobs</span><span class="p">:</span>
</span><span id="BatchRun-547"><a href="#BatchRun-547"><span class="linenos">547</span></a>            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;results&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;failed&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="s2">&quot;cost&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">}</span>
</span><span id="BatchRun-548"><a href="#BatchRun-548"><span class="linenos">548</span></a>        
</span><span id="BatchRun-549"><a href="#BatchRun-549"><span class="linenos">549</span></a>        <span class="c1"># Reserve cost limit</span>
</span><span id="BatchRun-550"><a href="#BatchRun-550"><span class="linenos">550</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Estimating cost for batch of </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">batch_jobs</span><span class="p">)</span><span class="si">}</span><span class="s2"> jobs...&quot;</span><span class="p">)</span>
</span><span id="BatchRun-551"><a href="#BatchRun-551"><span class="linenos">551</span></a>        <span class="n">estimated_cost</span> <span class="o">=</span> <span class="n">provider</span><span class="o">.</span><span class="n">estimate_cost</span><span class="p">(</span><span class="n">batch_jobs</span><span class="p">)</span>
</span><span id="BatchRun-552"><a href="#BatchRun-552"><span class="linenos">552</span></a>        <span class="n">remaining</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cost_tracker</span><span class="o">.</span><span class="n">remaining</span><span class="p">()</span>
</span><span id="BatchRun-553"><a href="#BatchRun-553"><span class="linenos">553</span></a>        <span class="n">remaining_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;$</span><span class="si">{</span><span class="n">remaining</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">remaining</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;unlimited&quot;</span>
</span><span id="BatchRun-554"><a href="#BatchRun-554"><span class="linenos">554</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total estimated cost: $</span><span class="si">{</span><span class="n">estimated_cost</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">, remaining budget: </span><span class="si">{</span><span class="n">remaining_str</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="BatchRun-555"><a href="#BatchRun-555"><span class="linenos">555</span></a>        
</span><span id="BatchRun-556"><a href="#BatchRun-556"><span class="linenos">556</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">cost_tracker</span><span class="o">.</span><span class="n">reserve_cost</span><span class="p">(</span><span class="n">estimated_cost</span><span class="p">):</span>
</span><span id="BatchRun-557"><a href="#BatchRun-557"><span class="linenos">557</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cost limit would be exceeded, skipping batch of </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">batch_jobs</span><span class="p">)</span><span class="si">}</span><span class="s2"> jobs&quot;</span><span class="p">)</span>
</span><span id="BatchRun-558"><a href="#BatchRun-558"><span class="linenos">558</span></a>            <span class="n">failed</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="BatchRun-559"><a href="#BatchRun-559"><span class="linenos">559</span></a>            <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="n">batch_jobs</span><span class="p">:</span>
</span><span id="BatchRun-560"><a href="#BatchRun-560"><span class="linenos">560</span></a>                <span class="n">failed</span><span class="p">[</span><span class="n">job</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Cost limit exceeded&quot;</span>
</span><span id="BatchRun-561"><a href="#BatchRun-561"><span class="linenos">561</span></a>            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;results&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;failed&quot;</span><span class="p">:</span> <span class="n">failed</span><span class="p">,</span> <span class="s2">&quot;cost&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span> <span class="s2">&quot;jobs_to_remove&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">batch_jobs</span><span class="p">)}</span>
</span><span id="BatchRun-562"><a href="#BatchRun-562"><span class="linenos">562</span></a>        
</span><span id="BatchRun-563"><a href="#BatchRun-563"><span class="linenos">563</span></a>        <span class="n">batch_id</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="BatchRun-564"><a href="#BatchRun-564"><span class="linenos">564</span></a>        <span class="n">job_mapping</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="BatchRun-565"><a href="#BatchRun-565"><span class="linenos">565</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="BatchRun-566"><a href="#BatchRun-566"><span class="linenos">566</span></a>            <span class="c1"># Create batch</span>
</span><span id="BatchRun-567"><a href="#BatchRun-567"><span class="linenos">567</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Creating batch with </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">batch_jobs</span><span class="p">)</span><span class="si">}</span><span class="s2"> jobs...&quot;</span><span class="p">)</span>
</span><span id="BatchRun-568"><a href="#BatchRun-568"><span class="linenos">568</span></a>            <span class="n">raw_files_path</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">raw_files_dir</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_files_dir</span> <span class="k">else</span> <span class="kc">None</span>
</span><span id="BatchRun-569"><a href="#BatchRun-569"><span class="linenos">569</span></a>            <span class="n">batch_id</span><span class="p">,</span> <span class="n">job_mapping</span> <span class="o">=</span> <span class="n">provider</span><span class="o">.</span><span class="n">create_batch</span><span class="p">(</span><span class="n">batch_jobs</span><span class="p">,</span> <span class="n">raw_files_path</span><span class="p">)</span>
</span><span id="BatchRun-570"><a href="#BatchRun-570"><span class="linenos">570</span></a>            
</span><span id="BatchRun-571"><a href="#BatchRun-571"><span class="linenos">571</span></a>            <span class="c1"># Track active batch for cancellation</span>
</span><span id="BatchRun-572"><a href="#BatchRun-572"><span class="linenos">572</span></a>            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_active_batches_lock</span><span class="p">:</span>
</span><span id="BatchRun-573"><a href="#BatchRun-573"><span class="linenos">573</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_active_batches</span><span class="p">[</span><span class="n">batch_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">provider</span>
</span><span id="BatchRun-574"><a href="#BatchRun-574"><span class="linenos">574</span></a>            
</span><span id="BatchRun-575"><a href="#BatchRun-575"><span class="linenos">575</span></a>            <span class="c1"># Track batch creation</span>
</span><span id="BatchRun-576"><a href="#BatchRun-576"><span class="linenos">576</span></a>            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_lock</span><span class="p">:</span>
</span><span id="BatchRun-577"><a href="#BatchRun-577"><span class="linenos">577</span></a>                <span class="c1"># Remove pending entry if it exists</span>
</span><span id="BatchRun-578"><a href="#BatchRun-578"><span class="linenos">578</span></a>                <span class="n">pending_keys</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_tracking</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;pending_&#39;</span><span class="p">)]</span>
</span><span id="BatchRun-579"><a href="#BatchRun-579"><span class="linenos">579</span></a>                <span class="k">for</span> <span class="n">pending_key</span> <span class="ow">in</span> <span class="n">pending_keys</span><span class="p">:</span>
</span><span id="BatchRun-580"><a href="#BatchRun-580"><span class="linenos">580</span></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_tracking</span><span class="p">[</span><span class="n">pending_key</span><span class="p">][</span><span class="s1">&#39;jobs&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">batch_jobs</span><span class="p">:</span>
</span><span id="BatchRun-581"><a href="#BatchRun-581"><span class="linenos">581</span></a>                        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_tracking</span><span class="p">[</span><span class="n">pending_key</span><span class="p">]</span>
</span><span id="BatchRun-582"><a href="#BatchRun-582"><span class="linenos">582</span></a>                        <span class="k">break</span>
</span><span id="BatchRun-583"><a href="#BatchRun-583"><span class="linenos">583</span></a>                
</span><span id="BatchRun-584"><a href="#BatchRun-584"><span class="linenos">584</span></a>                <span class="c1"># Add actual batch tracking</span>
</span><span id="BatchRun-585"><a href="#BatchRun-585"><span class="linenos">585</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">batch_tracking</span><span class="p">[</span><span class="n">batch_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="BatchRun-586"><a href="#BatchRun-586"><span class="linenos">586</span></a>                    <span class="s1">&#39;start_time&#39;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(),</span>
</span><span id="BatchRun-587"><a href="#BatchRun-587"><span class="linenos">587</span></a>                    <span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;running&#39;</span><span class="p">,</span>
</span><span id="BatchRun-588"><a href="#BatchRun-588"><span class="linenos">588</span></a>                    <span class="s1">&#39;total&#39;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">batch_jobs</span><span class="p">),</span>
</span><span id="BatchRun-589"><a href="#BatchRun-589"><span class="linenos">589</span></a>                    <span class="s1">&#39;completed&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span><span id="BatchRun-590"><a href="#BatchRun-590"><span class="linenos">590</span></a>                    <span class="s1">&#39;cost&#39;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
</span><span id="BatchRun-591"><a href="#BatchRun-591"><span class="linenos">591</span></a>                    <span class="s1">&#39;estimated_cost&#39;</span><span class="p">:</span> <span class="n">estimated_cost</span><span class="p">,</span>
</span><span id="BatchRun-592"><a href="#BatchRun-592"><span class="linenos">592</span></a>                    <span class="s1">&#39;provider&#39;</span><span class="p">:</span> <span class="n">provider</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
</span><span id="BatchRun-593"><a href="#BatchRun-593"><span class="linenos">593</span></a>                    <span class="s1">&#39;jobs&#39;</span><span class="p">:</span> <span class="n">batch_jobs</span>
</span><span id="BatchRun-594"><a href="#BatchRun-594"><span class="linenos">594</span></a>                <span class="p">}</span>
</span><span id="BatchRun-595"><a href="#BatchRun-595"><span class="linenos">595</span></a>            
</span><span id="BatchRun-596"><a href="#BatchRun-596"><span class="linenos">596</span></a>            <span class="c1"># Poll for completion</span>
</span><span id="BatchRun-597"><a href="#BatchRun-597"><span class="linenos">597</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Polling for batch </span><span class="si">{</span><span class="n">batch_id</span><span class="si">}</span><span class="s2"> completion...&quot;</span><span class="p">)</span>
</span><span id="BatchRun-598"><a href="#BatchRun-598"><span class="linenos">598</span></a>            <span class="n">status</span><span class="p">,</span> <span class="n">error_details</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_poll_batch_status</span><span class="p">(</span><span class="n">provider</span><span class="p">,</span> <span class="n">batch_id</span><span class="p">)</span>
</span><span id="BatchRun-599"><a href="#BatchRun-599"><span class="linenos">599</span></a>            
</span><span id="BatchRun-600"><a href="#BatchRun-600"><span class="linenos">600</span></a>            <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;failed&quot;</span><span class="p">:</span>
</span><span id="BatchRun-601"><a href="#BatchRun-601"><span class="linenos">601</span></a>                <span class="k">if</span> <span class="n">error_details</span><span class="p">:</span>
</span><span id="BatchRun-602"><a href="#BatchRun-602"><span class="linenos">602</span></a>                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Batch </span><span class="si">{</span><span class="n">batch_id</span><span class="si">}</span><span class="s2"> failed with details: </span><span class="si">{</span><span class="n">error_details</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="BatchRun-603"><a href="#BatchRun-603"><span class="linenos">603</span></a>                <span class="k">else</span><span class="p">:</span>
</span><span id="BatchRun-604"><a href="#BatchRun-604"><span class="linenos">604</span></a>                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Batch </span><span class="si">{</span><span class="n">batch_id</span><span class="si">}</span><span class="s2"> failed&quot;</span><span class="p">)</span>
</span><span id="BatchRun-605"><a href="#BatchRun-605"><span class="linenos">605</span></a>                
</span><span id="BatchRun-606"><a href="#BatchRun-606"><span class="linenos">606</span></a>                <span class="c1"># Save error details if configured</span>
</span><span id="BatchRun-607"><a href="#BatchRun-607"><span class="linenos">607</span></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_files_dir</span> <span class="ow">and</span> <span class="n">error_details</span><span class="p">:</span>
</span><span id="BatchRun-608"><a href="#BatchRun-608"><span class="linenos">608</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">_save_batch_error_details</span><span class="p">(</span><span class="n">batch_id</span><span class="p">,</span> <span class="n">error_details</span><span class="p">)</span>
</span><span id="BatchRun-609"><a href="#BatchRun-609"><span class="linenos">609</span></a>                
</span><span id="BatchRun-610"><a href="#BatchRun-610"><span class="linenos">610</span></a>                <span class="c1"># Continue to get individual results - some jobs might have succeeded</span>
</span><span id="BatchRun-611"><a href="#BatchRun-611"><span class="linenos">611</span></a>            
</span><span id="BatchRun-612"><a href="#BatchRun-612"><span class="linenos">612</span></a>            <span class="c1"># Get results</span>
</span><span id="BatchRun-613"><a href="#BatchRun-613"><span class="linenos">613</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Getting results for batch </span><span class="si">{</span><span class="n">batch_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="BatchRun-614"><a href="#BatchRun-614"><span class="linenos">614</span></a>            <span class="n">raw_files_path</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">raw_files_dir</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_files_dir</span> <span class="k">else</span> <span class="kc">None</span>
</span><span id="BatchRun-615"><a href="#BatchRun-615"><span class="linenos">615</span></a>            <span class="n">results</span> <span class="o">=</span> <span class="n">provider</span><span class="o">.</span><span class="n">get_batch_results</span><span class="p">(</span><span class="n">batch_id</span><span class="p">,</span> <span class="n">job_mapping</span><span class="p">,</span> <span class="n">raw_files_path</span><span class="p">)</span>
</span><span id="BatchRun-616"><a href="#BatchRun-616"><span class="linenos">616</span></a>            
</span><span id="BatchRun-617"><a href="#BatchRun-617"><span class="linenos">617</span></a>            <span class="c1"># Calculate actual cost and adjust reservation</span>
</span><span id="BatchRun-618"><a href="#BatchRun-618"><span class="linenos">618</span></a>            <span class="n">actual_cost</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">cost_usd</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">)</span>
</span><span id="BatchRun-619"><a href="#BatchRun-619"><span class="linenos">619</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">cost_tracker</span><span class="o">.</span><span class="n">adjust_reserved_cost</span><span class="p">(</span><span class="n">estimated_cost</span><span class="p">,</span> <span class="n">actual_cost</span><span class="p">)</span>
</span><span id="BatchRun-620"><a href="#BatchRun-620"><span class="linenos">620</span></a>            
</span><span id="BatchRun-621"><a href="#BatchRun-621"><span class="linenos">621</span></a>            <span class="c1"># Update batch tracking for completion</span>
</span><span id="BatchRun-622"><a href="#BatchRun-622"><span class="linenos">622</span></a>            <span class="n">success_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">([</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span> <span class="k">if</span> <span class="n">r</span><span class="o">.</span><span class="n">is_success</span><span class="p">])</span>
</span><span id="BatchRun-623"><a href="#BatchRun-623"><span class="linenos">623</span></a>            <span class="n">failed_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">([</span><span class="n">r</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">r</span><span class="o">.</span><span class="n">is_success</span><span class="p">])</span>
</span><span id="BatchRun-624"><a href="#BatchRun-624"><span class="linenos">624</span></a>            <span class="n">batch_status</span> <span class="o">=</span> <span class="s1">&#39;complete&#39;</span> <span class="k">if</span> <span class="n">failed_count</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;failed&#39;</span>
</span><span id="BatchRun-625"><a href="#BatchRun-625"><span class="linenos">625</span></a>            
</span><span id="BatchRun-626"><a href="#BatchRun-626"><span class="linenos">626</span></a>            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_lock</span><span class="p">:</span>
</span><span id="BatchRun-627"><a href="#BatchRun-627"><span class="linenos">627</span></a>                <span class="k">if</span> <span class="n">batch_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_tracking</span><span class="p">:</span>
</span><span id="BatchRun-628"><a href="#BatchRun-628"><span class="linenos">628</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">batch_tracking</span><span class="p">[</span><span class="n">batch_id</span><span class="p">][</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">batch_status</span>
</span><span id="BatchRun-629"><a href="#BatchRun-629"><span class="linenos">629</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">batch_tracking</span><span class="p">[</span><span class="n">batch_id</span><span class="p">][</span><span class="s1">&#39;completed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">success_count</span>
</span><span id="BatchRun-630"><a href="#BatchRun-630"><span class="linenos">630</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">batch_tracking</span><span class="p">[</span><span class="n">batch_id</span><span class="p">][</span><span class="s1">&#39;failed&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">failed_count</span>
</span><span id="BatchRun-631"><a href="#BatchRun-631"><span class="linenos">631</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">batch_tracking</span><span class="p">[</span><span class="n">batch_id</span><span class="p">][</span><span class="s1">&#39;cost&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">actual_cost</span>
</span><span id="BatchRun-632"><a href="#BatchRun-632"><span class="linenos">632</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">batch_tracking</span><span class="p">[</span><span class="n">batch_id</span><span class="p">][</span><span class="s1">&#39;completion_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
</span><span id="BatchRun-633"><a href="#BatchRun-633"><span class="linenos">633</span></a>                    <span class="k">if</span> <span class="n">batch_status</span> <span class="o">==</span> <span class="s1">&#39;failed&#39;</span> <span class="ow">and</span> <span class="n">failed_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
</span><span id="BatchRun-634"><a href="#BatchRun-634"><span class="linenos">634</span></a>                        <span class="c1"># Use the first job&#39;s error as the batch error summary</span>
</span><span id="BatchRun-635"><a href="#BatchRun-635"><span class="linenos">635</span></a>                        <span class="n">first_error</span> <span class="o">=</span> <span class="nb">next</span><span class="p">((</span><span class="n">r</span><span class="o">.</span><span class="n">error</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">r</span><span class="o">.</span><span class="n">is_success</span><span class="p">),</span> <span class="s1">&#39;Some jobs failed&#39;</span><span class="p">)</span>
</span><span id="BatchRun-636"><a href="#BatchRun-636"><span class="linenos">636</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">batch_tracking</span><span class="p">[</span><span class="n">batch_id</span><span class="p">][</span><span class="s1">&#39;error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">first_error</span>
</span><span id="BatchRun-637"><a href="#BatchRun-637"><span class="linenos">637</span></a>            
</span><span id="BatchRun-638"><a href="#BatchRun-638"><span class="linenos">638</span></a>            <span class="c1"># Remove from active batches tracking</span>
</span><span id="BatchRun-639"><a href="#BatchRun-639"><span class="linenos">639</span></a>            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_active_batches_lock</span><span class="p">:</span>
</span><span id="BatchRun-640"><a href="#BatchRun-640"><span class="linenos">640</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_active_batches</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">batch_id</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="BatchRun-641"><a href="#BatchRun-641"><span class="linenos">641</span></a>            
</span><span id="BatchRun-642"><a href="#BatchRun-642"><span class="linenos">642</span></a>            <span class="n">status_symbol</span> <span class="o">=</span> <span class="s2">&quot;✓&quot;</span> <span class="k">if</span> <span class="n">batch_status</span> <span class="o">==</span> <span class="s1">&#39;complete&#39;</span> <span class="k">else</span> <span class="s2">&quot;⚠&quot;</span>
</span><span id="BatchRun-643"><a href="#BatchRun-643"><span class="linenos">643</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
</span><span id="BatchRun-644"><a href="#BatchRun-644"><span class="linenos">644</span></a>                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">status_symbol</span><span class="si">}</span><span class="s2"> Batch </span><span class="si">{</span><span class="n">batch_id</span><span class="si">}</span><span class="s2"> completed: &quot;</span>
</span><span id="BatchRun-645"><a href="#BatchRun-645"><span class="linenos">645</span></a>                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">success_count</span><span class="si">}</span><span class="s2"> success, &quot;</span>
</span><span id="BatchRun-646"><a href="#BatchRun-646"><span class="linenos">646</span></a>                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">failed_count</span><span class="si">}</span><span class="s2"> failed, &quot;</span>
</span><span id="BatchRun-647"><a href="#BatchRun-647"><span class="linenos">647</span></a>                <span class="sa">f</span><span class="s2">&quot;cost: $</span><span class="si">{</span><span class="n">actual_cost</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="BatchRun-648"><a href="#BatchRun-648"><span class="linenos">648</span></a>            <span class="p">)</span>
</span><span id="BatchRun-649"><a href="#BatchRun-649"><span class="linenos">649</span></a>            
</span><span id="BatchRun-650"><a href="#BatchRun-650"><span class="linenos">650</span></a>            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;results&quot;</span><span class="p">:</span> <span class="n">results</span><span class="p">,</span> <span class="s2">&quot;failed&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="s2">&quot;cost&quot;</span><span class="p">:</span> <span class="n">actual_cost</span><span class="p">,</span> <span class="s2">&quot;jobs_to_remove&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">batch_jobs</span><span class="p">)}</span>
</span><span id="BatchRun-651"><a href="#BatchRun-651"><span class="linenos">651</span></a>            
</span><span id="BatchRun-652"><a href="#BatchRun-652"><span class="linenos">652</span></a>        <span class="k">except</span> <span class="ne">TimeoutError</span><span class="p">:</span>
</span><span id="BatchRun-653"><a href="#BatchRun-653"><span class="linenos">653</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Time limit exceeded for batch</span><span class="si">{</span><span class="sa">f</span><span class="s1">&#39; </span><span class="si">{</span><span class="n">batch_id</span><span class="si">}</span><span class="s1">&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">batch_id</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="BatchRun-654"><a href="#BatchRun-654"><span class="linenos">654</span></a>            <span class="k">if</span> <span class="n">batch_id</span><span class="p">:</span>
</span><span id="BatchRun-655"><a href="#BatchRun-655"><span class="linenos">655</span></a>                <span class="c1"># Update batch tracking for time limit exceeded</span>
</span><span id="BatchRun-656"><a href="#BatchRun-656"><span class="linenos">656</span></a>                <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_lock</span><span class="p">:</span>
</span><span id="BatchRun-657"><a href="#BatchRun-657"><span class="linenos">657</span></a>                    <span class="k">if</span> <span class="n">batch_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_tracking</span><span class="p">:</span>
</span><span id="BatchRun-658"><a href="#BatchRun-658"><span class="linenos">658</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">batch_tracking</span><span class="p">[</span><span class="n">batch_id</span><span class="p">][</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;failed&#39;</span>
</span><span id="BatchRun-659"><a href="#BatchRun-659"><span class="linenos">659</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">batch_tracking</span><span class="p">[</span><span class="n">batch_id</span><span class="p">][</span><span class="s1">&#39;error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Time limit exceeded: batch execution time limit exceeded&#39;</span>
</span><span id="BatchRun-660"><a href="#BatchRun-660"><span class="linenos">660</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">batch_tracking</span><span class="p">[</span><span class="n">batch_id</span><span class="p">][</span><span class="s1">&#39;completion_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
</span><span id="BatchRun-661"><a href="#BatchRun-661"><span class="linenos">661</span></a>                <span class="c1"># NOTE: Don&#39;t remove from _active_batches - let centralized cancellation handle it</span>
</span><span id="BatchRun-662"><a href="#BatchRun-662"><span class="linenos">662</span></a>            <span class="c1"># Release the reservation since batch exceeded time limit</span>
</span><span id="BatchRun-663"><a href="#BatchRun-663"><span class="linenos">663</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">cost_tracker</span><span class="o">.</span><span class="n">adjust_reserved_cost</span><span class="p">(</span><span class="n">estimated_cost</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
</span><span id="BatchRun-664"><a href="#BatchRun-664"><span class="linenos">664</span></a>            <span class="c1"># Re-raise to be handled by wrapper</span>
</span><span id="BatchRun-665"><a href="#BatchRun-665"><span class="linenos">665</span></a>            <span class="k">raise</span>
</span><span id="BatchRun-666"><a href="#BatchRun-666"><span class="linenos">666</span></a>            
</span><span id="BatchRun-667"><a href="#BatchRun-667"><span class="linenos">667</span></a>        <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
</span><span id="BatchRun-668"><a href="#BatchRun-668"><span class="linenos">668</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Cancelling batch</span><span class="si">{</span><span class="sa">f</span><span class="s1">&#39; </span><span class="si">{</span><span class="n">batch_id</span><span class="si">}</span><span class="s1">&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">batch_id</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="si">}</span><span class="s2">...&quot;</span><span class="p">)</span>
</span><span id="BatchRun-669"><a href="#BatchRun-669"><span class="linenos">669</span></a>            <span class="k">if</span> <span class="n">batch_id</span><span class="p">:</span>
</span><span id="BatchRun-670"><a href="#BatchRun-670"><span class="linenos">670</span></a>                <span class="c1"># Update batch tracking for cancellation</span>
</span><span id="BatchRun-671"><a href="#BatchRun-671"><span class="linenos">671</span></a>                <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_lock</span><span class="p">:</span>
</span><span id="BatchRun-672"><a href="#BatchRun-672"><span class="linenos">672</span></a>                    <span class="k">if</span> <span class="n">batch_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_tracking</span><span class="p">:</span>
</span><span id="BatchRun-673"><a href="#BatchRun-673"><span class="linenos">673</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">batch_tracking</span><span class="p">[</span><span class="n">batch_id</span><span class="p">][</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;cancelled&#39;</span>
</span><span id="BatchRun-674"><a href="#BatchRun-674"><span class="linenos">674</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">batch_tracking</span><span class="p">[</span><span class="n">batch_id</span><span class="p">][</span><span class="s1">&#39;error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Cancelled by user&#39;</span>
</span><span id="BatchRun-675"><a href="#BatchRun-675"><span class="linenos">675</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">batch_tracking</span><span class="p">[</span><span class="n">batch_id</span><span class="p">][</span><span class="s1">&#39;completion_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
</span><span id="BatchRun-676"><a href="#BatchRun-676"><span class="linenos">676</span></a>                <span class="c1"># Remove from active batches tracking</span>
</span><span id="BatchRun-677"><a href="#BatchRun-677"><span class="linenos">677</span></a>                <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_active_batches_lock</span><span class="p">:</span>
</span><span id="BatchRun-678"><a href="#BatchRun-678"><span class="linenos">678</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">_active_batches</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">batch_id</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="BatchRun-679"><a href="#BatchRun-679"><span class="linenos">679</span></a>            <span class="c1"># Release the reservation since batch was cancelled</span>
</span><span id="BatchRun-680"><a href="#BatchRun-680"><span class="linenos">680</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">cost_tracker</span><span class="o">.</span><span class="n">adjust_reserved_cost</span><span class="p">(</span><span class="n">estimated_cost</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
</span><span id="BatchRun-681"><a href="#BatchRun-681"><span class="linenos">681</span></a>            <span class="c1"># Handle cancellation in the wrapper with proper locking</span>
</span><span id="BatchRun-682"><a href="#BatchRun-682"><span class="linenos">682</span></a>            <span class="k">raise</span>
</span><span id="BatchRun-683"><a href="#BatchRun-683"><span class="linenos">683</span></a>            
</span><span id="BatchRun-684"><a href="#BatchRun-684"><span class="linenos">684</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="BatchRun-685"><a href="#BatchRun-685"><span class="linenos">685</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✗ Batch execution failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="BatchRun-686"><a href="#BatchRun-686"><span class="linenos">686</span></a>            <span class="c1"># Update batch tracking for exception</span>
</span><span id="BatchRun-687"><a href="#BatchRun-687"><span class="linenos">687</span></a>            <span class="k">if</span> <span class="n">batch_id</span><span class="p">:</span>
</span><span id="BatchRun-688"><a href="#BatchRun-688"><span class="linenos">688</span></a>                <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_lock</span><span class="p">:</span>
</span><span id="BatchRun-689"><a href="#BatchRun-689"><span class="linenos">689</span></a>                    <span class="k">if</span> <span class="n">batch_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_tracking</span><span class="p">:</span>
</span><span id="BatchRun-690"><a href="#BatchRun-690"><span class="linenos">690</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">batch_tracking</span><span class="p">[</span><span class="n">batch_id</span><span class="p">][</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;failed&#39;</span>
</span><span id="BatchRun-691"><a href="#BatchRun-691"><span class="linenos">691</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">batch_tracking</span><span class="p">[</span><span class="n">batch_id</span><span class="p">][</span><span class="s1">&#39;error&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</span><span id="BatchRun-692"><a href="#BatchRun-692"><span class="linenos">692</span></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">batch_tracking</span><span class="p">[</span><span class="n">batch_id</span><span class="p">][</span><span class="s1">&#39;completion_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
</span><span id="BatchRun-693"><a href="#BatchRun-693"><span class="linenos">693</span></a>                <span class="c1"># Remove from active batches tracking</span>
</span><span id="BatchRun-694"><a href="#BatchRun-694"><span class="linenos">694</span></a>                <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_active_batches_lock</span><span class="p">:</span>
</span><span id="BatchRun-695"><a href="#BatchRun-695"><span class="linenos">695</span></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">_active_batches</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">batch_id</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="BatchRun-696"><a href="#BatchRun-696"><span class="linenos">696</span></a>            <span class="c1"># Release the reservation since batch failed</span>
</span><span id="BatchRun-697"><a href="#BatchRun-697"><span class="linenos">697</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">cost_tracker</span><span class="o">.</span><span class="n">adjust_reserved_cost</span><span class="p">(</span><span class="n">estimated_cost</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
</span><span id="BatchRun-698"><a href="#BatchRun-698"><span class="linenos">698</span></a>            <span class="n">failed</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="BatchRun-699"><a href="#BatchRun-699"><span class="linenos">699</span></a>            <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="n">batch_jobs</span><span class="p">:</span>
</span><span id="BatchRun-700"><a href="#BatchRun-700"><span class="linenos">700</span></a>                <span class="n">failed</span><span class="p">[</span><span class="n">job</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</span><span id="BatchRun-701"><a href="#BatchRun-701"><span class="linenos">701</span></a>            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;results&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;failed&quot;</span><span class="p">:</span> <span class="n">failed</span><span class="p">,</span> <span class="s2">&quot;cost&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span> <span class="s2">&quot;jobs_to_remove&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">batch_jobs</span><span class="p">)}</span>
</span><span id="BatchRun-702"><a href="#BatchRun-702"><span class="linenos">702</span></a>    
</span><span id="BatchRun-703"><a href="#BatchRun-703"><span class="linenos">703</span></a>    
</span><span id="BatchRun-704"><a href="#BatchRun-704"><span class="linenos">704</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_save_result_to_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result</span><span class="p">:</span> <span class="n">JobResult</span><span class="p">):</span>
</span><span id="BatchRun-705"><a href="#BatchRun-705"><span class="linenos">705</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Save individual result to file.&quot;&quot;&quot;</span>
</span><span id="BatchRun-706"><a href="#BatchRun-706"><span class="linenos">706</span></a>        <span class="n">result_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">results_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">job_id</span><span class="si">}</span><span class="s2">.json&quot;</span>
</span><span id="BatchRun-707"><a href="#BatchRun-707"><span class="linenos">707</span></a>        
</span><span id="BatchRun-708"><a href="#BatchRun-708"><span class="linenos">708</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="BatchRun-709"><a href="#BatchRun-709"><span class="linenos">709</span></a>            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">result_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span><span id="BatchRun-710"><a href="#BatchRun-710"><span class="linenos">710</span></a>                <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(),</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</span><span id="BatchRun-711"><a href="#BatchRun-711"><span class="linenos">711</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="BatchRun-712"><a href="#BatchRun-712"><span class="linenos">712</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to save result for </span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">job_id</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="BatchRun-713"><a href="#BatchRun-713"><span class="linenos">713</span></a>    
</span><span id="BatchRun-714"><a href="#BatchRun-714"><span class="linenos">714</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_save_batch_error_details</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">error_details</span><span class="p">:</span> <span class="n">Dict</span><span class="p">):</span>
</span><span id="BatchRun-715"><a href="#BatchRun-715"><span class="linenos">715</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Save batch error details to debug files directory.&quot;&quot;&quot;</span>
</span><span id="BatchRun-716"><a href="#BatchRun-716"><span class="linenos">716</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="BatchRun-717"><a href="#BatchRun-717"><span class="linenos">717</span></a>            <span class="n">error_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_files_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;batch_</span><span class="si">{</span><span class="n">batch_id</span><span class="si">}</span><span class="s2">_error.json&quot;</span>
</span><span id="BatchRun-718"><a href="#BatchRun-718"><span class="linenos">718</span></a>            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">error_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</span><span id="BatchRun-719"><a href="#BatchRun-719"><span class="linenos">719</span></a>                <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">({</span>
</span><span id="BatchRun-720"><a href="#BatchRun-720"><span class="linenos">720</span></a>                    <span class="s2">&quot;batch_id&quot;</span><span class="p">:</span> <span class="n">batch_id</span><span class="p">,</span>
</span><span id="BatchRun-721"><a href="#BatchRun-721"><span class="linenos">721</span></a>                    <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
</span><span id="BatchRun-722"><a href="#BatchRun-722"><span class="linenos">722</span></a>                    <span class="s2">&quot;error_details&quot;</span><span class="p">:</span> <span class="n">error_details</span>
</span><span id="BatchRun-723"><a href="#BatchRun-723"><span class="linenos">723</span></a>                <span class="p">},</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</span><span id="BatchRun-724"><a href="#BatchRun-724"><span class="linenos">724</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saved batch error details to </span><span class="si">{</span><span class="n">error_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="BatchRun-725"><a href="#BatchRun-725"><span class="linenos">725</span></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span><span id="BatchRun-726"><a href="#BatchRun-726"><span class="linenos">726</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to save batch error details: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="BatchRun-727"><a href="#BatchRun-727"><span class="linenos">727</span></a>    
</span><span id="BatchRun-728"><a href="#BatchRun-728"><span class="linenos">728</span></a>    <span class="nd">@property</span>
</span><span id="BatchRun-729"><a href="#BatchRun-729"><span class="linenos">729</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">is_complete</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="BatchRun-730"><a href="#BatchRun-730"><span class="linenos">730</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Whether all jobs are complete.&quot;&quot;&quot;</span>
</span><span id="BatchRun-731"><a href="#BatchRun-731"><span class="linenos">731</span></a>        <span class="n">total_jobs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jobs</span><span class="p">)</span>
</span><span id="BatchRun-732"><a href="#BatchRun-732"><span class="linenos">732</span></a>        <span class="n">completed_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">completed_results</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">failed_jobs</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cancelled_jobs</span><span class="p">)</span>
</span><span id="BatchRun-733"><a href="#BatchRun-733"><span class="linenos">733</span></a>        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pending_jobs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">completed_count</span> <span class="o">==</span> <span class="n">total_jobs</span>
</span><span id="BatchRun-734"><a href="#BatchRun-734"><span class="linenos">734</span></a>
</span><span id="BatchRun-735"><a href="#BatchRun-735"><span class="linenos">735</span></a>    
</span><span id="BatchRun-736"><a href="#BatchRun-736"><span class="linenos">736</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">print_status</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
</span><span id="BatchRun-737"><a href="#BatchRun-737"><span class="linenos">737</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get current execution statistics.&quot;&quot;&quot;</span>
</span><span id="BatchRun-738"><a href="#BatchRun-738"><span class="linenos">738</span></a>        <span class="n">total_jobs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jobs</span><span class="p">)</span>
</span><span id="BatchRun-739"><a href="#BatchRun-739"><span class="linenos">739</span></a>        <span class="n">completed_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">completed_results</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">failed_jobs</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cancelled_jobs</span><span class="p">)</span>
</span><span id="BatchRun-740"><a href="#BatchRun-740"><span class="linenos">740</span></a>        <span class="n">remaining_count</span> <span class="o">=</span> <span class="n">total_jobs</span> <span class="o">-</span> <span class="n">completed_count</span>
</span><span id="BatchRun-741"><a href="#BatchRun-741"><span class="linenos">741</span></a>        
</span><span id="BatchRun-742"><a href="#BatchRun-742"><span class="linenos">742</span></a>        <span class="n">stats</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="BatchRun-743"><a href="#BatchRun-743"><span class="linenos">743</span></a>            <span class="s2">&quot;total&quot;</span><span class="p">:</span> <span class="n">total_jobs</span><span class="p">,</span>
</span><span id="BatchRun-744"><a href="#BatchRun-744"><span class="linenos">744</span></a>            <span class="s2">&quot;pending&quot;</span><span class="p">:</span> <span class="n">remaining_count</span><span class="p">,</span>
</span><span id="BatchRun-745"><a href="#BatchRun-745"><span class="linenos">745</span></a>            <span class="s2">&quot;active&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>  <span class="c1"># Always 0 for synchronous execution</span>
</span><span id="BatchRun-746"><a href="#BatchRun-746"><span class="linenos">746</span></a>            <span class="s2">&quot;completed&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">completed_results</span><span class="p">),</span>
</span><span id="BatchRun-747"><a href="#BatchRun-747"><span class="linenos">747</span></a>            <span class="s2">&quot;failed&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">failed_jobs</span><span class="p">),</span>
</span><span id="BatchRun-748"><a href="#BatchRun-748"><span class="linenos">748</span></a>            <span class="s2">&quot;cancelled&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cancelled_jobs</span><span class="p">),</span>
</span><span id="BatchRun-749"><a href="#BatchRun-749"><span class="linenos">749</span></a>            <span class="s2">&quot;cost_usd&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cost_tracker</span><span class="o">.</span><span class="n">used_usd</span><span class="p">,</span>
</span><span id="BatchRun-750"><a href="#BatchRun-750"><span class="linenos">750</span></a>            <span class="s2">&quot;cost_limit_usd&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cost_tracker</span><span class="o">.</span><span class="n">limit_usd</span><span class="p">,</span>
</span><span id="BatchRun-751"><a href="#BatchRun-751"><span class="linenos">751</span></a>            <span class="s2">&quot;is_complete&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_complete</span><span class="p">,</span>
</span><span id="BatchRun-752"><a href="#BatchRun-752"><span class="linenos">752</span></a>            <span class="s2">&quot;batches_total&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_batches</span><span class="p">,</span>
</span><span id="BatchRun-753"><a href="#BatchRun-753"><span class="linenos">753</span></a>            <span class="s2">&quot;batches_completed&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">completed_batches</span><span class="p">,</span>
</span><span id="BatchRun-754"><a href="#BatchRun-754"><span class="linenos">754</span></a>            <span class="s2">&quot;batches_pending&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_batches</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">completed_batches</span><span class="p">,</span>
</span><span id="BatchRun-755"><a href="#BatchRun-755"><span class="linenos">755</span></a>            <span class="s2">&quot;current_batch_index&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_batch_index</span><span class="p">,</span>
</span><span id="BatchRun-756"><a href="#BatchRun-756"><span class="linenos">756</span></a>            <span class="s2">&quot;current_batch_size&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_batch_size</span><span class="p">,</span>
</span><span id="BatchRun-757"><a href="#BatchRun-757"><span class="linenos">757</span></a>            <span class="s2">&quot;items_per_batch&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">items_per_batch</span>
</span><span id="BatchRun-758"><a href="#BatchRun-758"><span class="linenos">758</span></a>        <span class="p">}</span>
</span><span id="BatchRun-759"><a href="#BatchRun-759"><span class="linenos">759</span></a>        
</span><span id="BatchRun-760"><a href="#BatchRun-760"><span class="linenos">760</span></a>        <span class="k">if</span> <span class="n">print_status</span><span class="p">:</span>
</span><span id="BatchRun-761"><a href="#BatchRun-761"><span class="linenos">761</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Batch Run Status:&quot;</span><span class="p">)</span>
</span><span id="BatchRun-762"><a href="#BatchRun-762"><span class="linenos">762</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Total jobs: </span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;total&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="BatchRun-763"><a href="#BatchRun-763"><span class="linenos">763</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Pending: </span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;pending&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="BatchRun-764"><a href="#BatchRun-764"><span class="linenos">764</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Active: </span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;active&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="BatchRun-765"><a href="#BatchRun-765"><span class="linenos">765</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Completed: </span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;completed&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="BatchRun-766"><a href="#BatchRun-766"><span class="linenos">766</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Failed: </span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;failed&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="BatchRun-767"><a href="#BatchRun-767"><span class="linenos">767</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Cancelled: </span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;cancelled&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="BatchRun-768"><a href="#BatchRun-768"><span class="linenos">768</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Cost: $</span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;cost_usd&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="BatchRun-769"><a href="#BatchRun-769"><span class="linenos">769</span></a>            <span class="k">if</span> <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;cost_limit_usd&#39;</span><span class="p">]:</span>
</span><span id="BatchRun-770"><a href="#BatchRun-770"><span class="linenos">770</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Cost limit: $</span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;cost_limit_usd&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="BatchRun-771"><a href="#BatchRun-771"><span class="linenos">771</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Complete: </span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;is_complete&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="BatchRun-772"><a href="#BatchRun-772"><span class="linenos">772</span></a>        
</span><span id="BatchRun-773"><a href="#BatchRun-773"><span class="linenos">773</span></a>        <span class="k">return</span> <span class="n">stats</span>
</span><span id="BatchRun-774"><a href="#BatchRun-774"><span class="linenos">774</span></a>    
</span><span id="BatchRun-775"><a href="#BatchRun-775"><span class="linenos">775</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">results</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">JobResult</span><span class="p">]]:</span>
</span><span id="BatchRun-776"><a href="#BatchRun-776"><span class="linenos">776</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get all results organized by status.</span>
</span><span id="BatchRun-777"><a href="#BatchRun-777"><span class="linenos">777</span></a><span class="sd">        </span>
</span><span id="BatchRun-778"><a href="#BatchRun-778"><span class="linenos">778</span></a><span class="sd">        Returns:</span>
</span><span id="BatchRun-779"><a href="#BatchRun-779"><span class="linenos">779</span></a><span class="sd">            {</span>
</span><span id="BatchRun-780"><a href="#BatchRun-780"><span class="linenos">780</span></a><span class="sd">                &quot;completed&quot;: [JobResult],</span>
</span><span id="BatchRun-781"><a href="#BatchRun-781"><span class="linenos">781</span></a><span class="sd">                &quot;failed&quot;: [JobResult],</span>
</span><span id="BatchRun-782"><a href="#BatchRun-782"><span class="linenos">782</span></a><span class="sd">                &quot;cancelled&quot;: [JobResult]</span>
</span><span id="BatchRun-783"><a href="#BatchRun-783"><span class="linenos">783</span></a><span class="sd">            }</span>
</span><span id="BatchRun-784"><a href="#BatchRun-784"><span class="linenos">784</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="BatchRun-785"><a href="#BatchRun-785"><span class="linenos">785</span></a>        <span class="k">return</span> <span class="p">{</span>
</span><span id="BatchRun-786"><a href="#BatchRun-786"><span class="linenos">786</span></a>            <span class="s2">&quot;completed&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">completed_results</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span>
</span><span id="BatchRun-787"><a href="#BatchRun-787"><span class="linenos">787</span></a>            <span class="s2">&quot;failed&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_failed_results</span><span class="p">(),</span>
</span><span id="BatchRun-788"><a href="#BatchRun-788"><span class="linenos">788</span></a>            <span class="s2">&quot;cancelled&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_cancelled_results</span><span class="p">()</span>
</span><span id="BatchRun-789"><a href="#BatchRun-789"><span class="linenos">789</span></a>        <span class="p">}</span>
</span><span id="BatchRun-790"><a href="#BatchRun-790"><span class="linenos">790</span></a>    
</span><span id="BatchRun-791"><a href="#BatchRun-791"><span class="linenos">791</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_failed_jobs</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
</span><span id="BatchRun-792"><a href="#BatchRun-792"><span class="linenos">792</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get failed jobs with error messages.</span>
</span><span id="BatchRun-793"><a href="#BatchRun-793"><span class="linenos">793</span></a><span class="sd">        </span>
</span><span id="BatchRun-794"><a href="#BatchRun-794"><span class="linenos">794</span></a><span class="sd">        Note: This method is deprecated. Use results()[&#39;failed&#39;] instead.</span>
</span><span id="BatchRun-795"><a href="#BatchRun-795"><span class="linenos">795</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="BatchRun-796"><a href="#BatchRun-796"><span class="linenos">796</span></a>        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">failed_jobs</span><span class="p">)</span>
</span><span id="BatchRun-797"><a href="#BatchRun-797"><span class="linenos">797</span></a>    
</span><span id="BatchRun-798"><a href="#BatchRun-798"><span class="linenos">798</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_create_failed_results</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">JobResult</span><span class="p">]:</span>
</span><span id="BatchRun-799"><a href="#BatchRun-799"><span class="linenos">799</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert failed jobs to JobResult objects.&quot;&quot;&quot;</span>
</span><span id="BatchRun-800"><a href="#BatchRun-800"><span class="linenos">800</span></a>        <span class="n">failed_results</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="BatchRun-801"><a href="#BatchRun-801"><span class="linenos">801</span></a>        <span class="k">for</span> <span class="n">job_id</span><span class="p">,</span> <span class="n">error_msg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">failed_jobs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="BatchRun-802"><a href="#BatchRun-802"><span class="linenos">802</span></a>            <span class="n">failed_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">JobResult</span><span class="p">(</span>
</span><span id="BatchRun-803"><a href="#BatchRun-803"><span class="linenos">803</span></a>                <span class="n">job_id</span><span class="o">=</span><span class="n">job_id</span><span class="p">,</span>
</span><span id="BatchRun-804"><a href="#BatchRun-804"><span class="linenos">804</span></a>                <span class="n">raw_response</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="BatchRun-805"><a href="#BatchRun-805"><span class="linenos">805</span></a>                <span class="n">parsed_response</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="BatchRun-806"><a href="#BatchRun-806"><span class="linenos">806</span></a>                <span class="n">error</span><span class="o">=</span><span class="n">error_msg</span><span class="p">,</span>
</span><span id="BatchRun-807"><a href="#BatchRun-807"><span class="linenos">807</span></a>                <span class="n">cost_usd</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
</span><span id="BatchRun-808"><a href="#BatchRun-808"><span class="linenos">808</span></a>                <span class="n">input_tokens</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
</span><span id="BatchRun-809"><a href="#BatchRun-809"><span class="linenos">809</span></a>                <span class="n">output_tokens</span><span class="o">=</span><span class="mi">0</span>
</span><span id="BatchRun-810"><a href="#BatchRun-810"><span class="linenos">810</span></a>            <span class="p">))</span>
</span><span id="BatchRun-811"><a href="#BatchRun-811"><span class="linenos">811</span></a>        <span class="k">return</span> <span class="n">failed_results</span>
</span><span id="BatchRun-812"><a href="#BatchRun-812"><span class="linenos">812</span></a>    
</span><span id="BatchRun-813"><a href="#BatchRun-813"><span class="linenos">813</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_create_cancelled_results</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">JobResult</span><span class="p">]:</span>
</span><span id="BatchRun-814"><a href="#BatchRun-814"><span class="linenos">814</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert cancelled jobs to JobResult objects.&quot;&quot;&quot;</span>
</span><span id="BatchRun-815"><a href="#BatchRun-815"><span class="linenos">815</span></a>        <span class="n">cancelled_results</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="BatchRun-816"><a href="#BatchRun-816"><span class="linenos">816</span></a>        <span class="k">for</span> <span class="n">job_id</span><span class="p">,</span> <span class="n">reason</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cancelled_jobs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="BatchRun-817"><a href="#BatchRun-817"><span class="linenos">817</span></a>            <span class="n">cancelled_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">JobResult</span><span class="p">(</span>
</span><span id="BatchRun-818"><a href="#BatchRun-818"><span class="linenos">818</span></a>                <span class="n">job_id</span><span class="o">=</span><span class="n">job_id</span><span class="p">,</span>
</span><span id="BatchRun-819"><a href="#BatchRun-819"><span class="linenos">819</span></a>                <span class="n">raw_response</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="BatchRun-820"><a href="#BatchRun-820"><span class="linenos">820</span></a>                <span class="n">parsed_response</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
</span><span id="BatchRun-821"><a href="#BatchRun-821"><span class="linenos">821</span></a>                <span class="n">error</span><span class="o">=</span><span class="n">reason</span><span class="p">,</span>
</span><span id="BatchRun-822"><a href="#BatchRun-822"><span class="linenos">822</span></a>                <span class="n">cost_usd</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
</span><span id="BatchRun-823"><a href="#BatchRun-823"><span class="linenos">823</span></a>                <span class="n">input_tokens</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
</span><span id="BatchRun-824"><a href="#BatchRun-824"><span class="linenos">824</span></a>                <span class="n">output_tokens</span><span class="o">=</span><span class="mi">0</span>
</span><span id="BatchRun-825"><a href="#BatchRun-825"><span class="linenos">825</span></a>            <span class="p">))</span>
</span><span id="BatchRun-826"><a href="#BatchRun-826"><span class="linenos">826</span></a>        <span class="k">return</span> <span class="n">cancelled_results</span>
</span><span id="BatchRun-827"><a href="#BatchRun-827"><span class="linenos">827</span></a>    
</span><span id="BatchRun-828"><a href="#BatchRun-828"><span class="linenos">828</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">shutdown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="BatchRun-829"><a href="#BatchRun-829"><span class="linenos">829</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Shutdown (no-op for synchronous execution).&quot;&quot;&quot;</span>
</span><span id="BatchRun-830"><a href="#BatchRun-830"><span class="linenos">830</span></a>        <span class="k">pass</span>
</span><span id="BatchRun-831"><a href="#BatchRun-831"><span class="linenos">831</span></a>    
</span><span id="BatchRun-832"><a href="#BatchRun-832"><span class="linenos">832</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">dry_run</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;BatchRun&#39;</span><span class="p">:</span>
</span><span id="BatchRun-833"><a href="#BatchRun-833"><span class="linenos">833</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Perform a dry run - show cost estimation and job details without executing.</span>
</span><span id="BatchRun-834"><a href="#BatchRun-834"><span class="linenos">834</span></a><span class="sd">        </span>
</span><span id="BatchRun-835"><a href="#BatchRun-835"><span class="linenos">835</span></a><span class="sd">        Returns:</span>
</span><span id="BatchRun-836"><a href="#BatchRun-836"><span class="linenos">836</span></a><span class="sd">            Self for chaining (doesn&#39;t actually execute jobs)</span>
</span><span id="BatchRun-837"><a href="#BatchRun-837"><span class="linenos">837</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="BatchRun-838"><a href="#BatchRun-838"><span class="linenos">838</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;=== DRY RUN MODE ===&quot;</span><span class="p">)</span>
</span><span id="BatchRun-839"><a href="#BatchRun-839"><span class="linenos">839</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;This will show cost estimates without executing jobs&quot;</span><span class="p">)</span>
</span><span id="BatchRun-840"><a href="#BatchRun-840"><span class="linenos">840</span></a>        
</span><span id="BatchRun-841"><a href="#BatchRun-841"><span class="linenos">841</span></a>        <span class="c1"># Load existing state if reuse_state=True</span>
</span><span id="BatchRun-842"><a href="#BatchRun-842"><span class="linenos">842</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">reuse_state</span><span class="p">:</span>
</span><span id="BatchRun-843"><a href="#BatchRun-843"><span class="linenos">843</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">state_manager</span><span class="o">.</span><span class="n">load_state</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span><span id="BatchRun-844"><a href="#BatchRun-844"><span class="linenos">844</span></a>        
</span><span id="BatchRun-845"><a href="#BatchRun-845"><span class="linenos">845</span></a>        <span class="c1"># Filter out completed jobs from previous runs</span>
</span><span id="BatchRun-846"><a href="#BatchRun-846"><span class="linenos">846</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pending_jobs</span> <span class="o">=</span> <span class="p">[</span><span class="n">job</span> <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobs</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">completed_results</span><span class="p">]</span>
</span><span id="BatchRun-847"><a href="#BatchRun-847"><span class="linenos">847</span></a>        
</span><span id="BatchRun-848"><a href="#BatchRun-848"><span class="linenos">848</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">pending_jobs</span><span class="p">:</span>
</span><span id="BatchRun-849"><a href="#BatchRun-849"><span class="linenos">849</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;No pending jobs to analyze (all jobs already completed)&quot;</span><span class="p">)</span>
</span><span id="BatchRun-850"><a href="#BatchRun-850"><span class="linenos">850</span></a>            <span class="k">return</span> <span class="bp">self</span>
</span><span id="BatchRun-851"><a href="#BatchRun-851"><span class="linenos">851</span></a>        
</span><span id="BatchRun-852"><a href="#BatchRun-852"><span class="linenos">852</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Analyzing </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pending_jobs</span><span class="p">)</span><span class="si">}</span><span class="s2"> pending jobs...&quot;</span><span class="p">)</span>
</span><span id="BatchRun-853"><a href="#BatchRun-853"><span class="linenos">853</span></a>        
</span><span id="BatchRun-854"><a href="#BatchRun-854"><span class="linenos">854</span></a>        <span class="c1"># Group jobs by provider and analyze costs</span>
</span><span id="BatchRun-855"><a href="#BatchRun-855"><span class="linenos">855</span></a>        <span class="n">provider_groups</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_group_jobs_by_provider</span><span class="p">()</span>
</span><span id="BatchRun-856"><a href="#BatchRun-856"><span class="linenos">856</span></a>        <span class="n">total_estimated_cost</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="BatchRun-857"><a href="#BatchRun-857"><span class="linenos">857</span></a>        
</span><span id="BatchRun-858"><a href="#BatchRun-858"><span class="linenos">858</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Job breakdown:&quot;</span><span class="p">)</span>
</span><span id="BatchRun-859"><a href="#BatchRun-859"><span class="linenos">859</span></a>        <span class="k">for</span> <span class="n">provider_name</span><span class="p">,</span> <span class="n">jobs</span> <span class="ow">in</span> <span class="n">provider_groups</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="BatchRun-860"><a href="#BatchRun-860"><span class="linenos">860</span></a>            <span class="n">provider</span> <span class="o">=</span> <span class="n">get_provider</span><span class="p">(</span><span class="n">jobs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">model</span><span class="p">)</span>
</span><span id="BatchRun-861"><a href="#BatchRun-861"><span class="linenos">861</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">provider_name</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">jobs</span><span class="p">)</span><span class="si">}</span><span class="s2"> jobs):&quot;</span><span class="p">)</span>
</span><span id="BatchRun-862"><a href="#BatchRun-862"><span class="linenos">862</span></a>            
</span><span id="BatchRun-863"><a href="#BatchRun-863"><span class="linenos">863</span></a>            <span class="n">job_batches</span> <span class="o">=</span> <span class="p">[</span><span class="n">jobs</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">items_per_batch</span><span class="p">]</span> 
</span><span id="BatchRun-864"><a href="#BatchRun-864"><span class="linenos">864</span></a>                          <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">jobs</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">items_per_batch</span><span class="p">)]</span>
</span><span id="BatchRun-865"><a href="#BatchRun-865"><span class="linenos">865</span></a>            
</span><span id="BatchRun-866"><a href="#BatchRun-866"><span class="linenos">866</span></a>            <span class="k">for</span> <span class="n">batch_idx</span><span class="p">,</span> <span class="n">batch_jobs</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">job_batches</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
</span><span id="BatchRun-867"><a href="#BatchRun-867"><span class="linenos">867</span></a>                <span class="n">estimated_cost</span> <span class="o">=</span> <span class="n">provider</span><span class="o">.</span><span class="n">estimate_cost</span><span class="p">(</span><span class="n">batch_jobs</span><span class="p">)</span>
</span><span id="BatchRun-868"><a href="#BatchRun-868"><span class="linenos">868</span></a>                <span class="n">total_estimated_cost</span> <span class="o">+=</span> <span class="n">estimated_cost</span>
</span><span id="BatchRun-869"><a href="#BatchRun-869"><span class="linenos">869</span></a>                
</span><span id="BatchRun-870"><a href="#BatchRun-870"><span class="linenos">870</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Batch </span><span class="si">{</span><span class="n">batch_idx</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">batch_jobs</span><span class="p">)</span><span class="si">}</span><span class="s2"> jobs, estimated cost: $</span><span class="si">{</span><span class="n">estimated_cost</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="BatchRun-871"><a href="#BatchRun-871"><span class="linenos">871</span></a>                <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="n">batch_jobs</span><span class="p">:</span>
</span><span id="BatchRun-872"><a href="#BatchRun-872"><span class="linenos">872</span></a>                    <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">file</span><span class="p">:</span>
</span><span id="BatchRun-873"><a href="#BatchRun-873"><span class="linenos">873</span></a>                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    - </span><span class="si">{</span><span class="n">job</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">job</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> (citations: </span><span class="si">{</span><span class="n">job</span><span class="o">.</span><span class="n">enable_citations</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
</span><span id="BatchRun-874"><a href="#BatchRun-874"><span class="linenos">874</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="BatchRun-875"><a href="#BatchRun-875"><span class="linenos">875</span></a>                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    - </span><span class="si">{</span><span class="n">job</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">: direct messages (citations: </span><span class="si">{</span><span class="n">job</span><span class="o">.</span><span class="n">enable_citations</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
</span><span id="BatchRun-876"><a href="#BatchRun-876"><span class="linenos">876</span></a>        
</span><span id="BatchRun-877"><a href="#BatchRun-877"><span class="linenos">877</span></a>        <span class="c1"># Show cost summary</span>
</span><span id="BatchRun-878"><a href="#BatchRun-878"><span class="linenos">878</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">=== COST SUMMARY ===&quot;</span><span class="p">)</span>
</span><span id="BatchRun-879"><a href="#BatchRun-879"><span class="linenos">879</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total estimated cost: $</span><span class="si">{</span><span class="n">total_estimated_cost</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="BatchRun-880"><a href="#BatchRun-880"><span class="linenos">880</span></a>        
</span><span id="BatchRun-881"><a href="#BatchRun-881"><span class="linenos">881</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">cost_limit_usd</span><span class="p">:</span>
</span><span id="BatchRun-882"><a href="#BatchRun-882"><span class="linenos">882</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cost limit: $</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">cost_limit_usd</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="BatchRun-883"><a href="#BatchRun-883"><span class="linenos">883</span></a>            <span class="k">if</span> <span class="n">total_estimated_cost</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">cost_limit_usd</span><span class="p">:</span>
</span><span id="BatchRun-884"><a href="#BatchRun-884"><span class="linenos">884</span></a>                <span class="n">excess</span> <span class="o">=</span> <span class="n">total_estimated_cost</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">cost_limit_usd</span>
</span><span id="BatchRun-885"><a href="#BatchRun-885"><span class="linenos">885</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;⚠️ Estimated cost exceeds limit by $</span><span class="si">{</span><span class="n">excess</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="BatchRun-886"><a href="#BatchRun-886"><span class="linenos">886</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="BatchRun-887"><a href="#BatchRun-887"><span class="linenos">887</span></a>                <span class="n">remaining</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">cost_limit_usd</span> <span class="o">-</span> <span class="n">total_estimated_cost</span>
</span><span id="BatchRun-888"><a href="#BatchRun-888"><span class="linenos">888</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✅ Within cost limit ($</span><span class="si">{</span><span class="n">remaining</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> remaining)&quot;</span><span class="p">)</span>
</span><span id="BatchRun-889"><a href="#BatchRun-889"><span class="linenos">889</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="BatchRun-890"><a href="#BatchRun-890"><span class="linenos">890</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;No cost limit set&quot;</span><span class="p">)</span>
</span><span id="BatchRun-891"><a href="#BatchRun-891"><span class="linenos">891</span></a>        
</span><span id="BatchRun-892"><a href="#BatchRun-892"><span class="linenos">892</span></a>        <span class="c1"># Show execution plan</span>
</span><span id="BatchRun-893"><a href="#BatchRun-893"><span class="linenos">893</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">=== EXECUTION PLAN ===&quot;</span><span class="p">)</span>
</span><span id="BatchRun-894"><a href="#BatchRun-894"><span class="linenos">894</span></a>        <span class="n">total_batches</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span>
</span><span id="BatchRun-895"><a href="#BatchRun-895"><span class="linenos">895</span></a>            <span class="nb">len</span><span class="p">(</span><span class="n">jobs</span><span class="p">)</span> <span class="o">//</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">items_per_batch</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">jobs</span><span class="p">)</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">items_per_batch</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="BatchRun-896"><a href="#BatchRun-896"><span class="linenos">896</span></a>            <span class="k">for</span> <span class="n">jobs</span> <span class="ow">in</span> <span class="n">provider_groups</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
</span><span id="BatchRun-897"><a href="#BatchRun-897"><span class="linenos">897</span></a>        <span class="p">)</span>
</span><span id="BatchRun-898"><a href="#BatchRun-898"><span class="linenos">898</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total batches to process: </span><span class="si">{</span><span class="n">total_batches</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="BatchRun-899"><a href="#BatchRun-899"><span class="linenos">899</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Max parallel batches: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">max_parallel_batches</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="BatchRun-900"><a href="#BatchRun-900"><span class="linenos">900</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Items per batch: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">items_per_batch</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="BatchRun-901"><a href="#BatchRun-901"><span class="linenos">901</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Results directory: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">results_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="BatchRun-902"><a href="#BatchRun-902"><span class="linenos">902</span></a>        
</span><span id="BatchRun-903"><a href="#BatchRun-903"><span class="linenos">903</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">=== DRY RUN COMPLETE ===&quot;</span><span class="p">)</span>
</span><span id="BatchRun-904"><a href="#BatchRun-904"><span class="linenos">904</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;To execute for real, call run() without dry_run=True&quot;</span><span class="p">)</span>
</span><span id="BatchRun-905"><a href="#BatchRun-905"><span class="linenos">905</span></a>        
</span><span id="BatchRun-906"><a href="#BatchRun-906"><span class="linenos">906</span></a>        <span class="k">return</span> <span class="bp">self</span>
</span></pre></div>


            <div class="docstring"><p>Manages the execution of a batch job synchronously.</p>

<p>Processes jobs in batches based on items_per_batch configuration.
Simpler synchronous execution for clear logging and debugging.</p>

<p>Example:</p>

<pre><code><div class="pdoc-code codehilite">
<pre><span></span><code><span class="n">config</span> <span class="o">=</span> <span class="n">BatchParams</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
<span class="n">run</span> <span class="o">=</span> <span class="n">BatchRun</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">jobs</span><span class="p">)</span>
<span class="n">run</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
<span class="n">results</span> <span class="o">=</span> <span class="n">run</span><span class="o">.</span><span class="n">results</span><span class="p">()</span>
</code></pre>
</div>
</code></pre>
</div>


                            <div id="BatchRun.__init__" class="classattr">
                                        <input id="BatchRun.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">BatchRun</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">config</span><span class="p">:</span> <span class="n">batchata</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">batch_params</span><span class="o">.</span><span class="n">BatchParams</span>,</span><span class="param">	<span class="n">jobs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n"><a href="#Job">Job</a></span><span class="p">]</span></span>)</span>

                <label class="view-source-button" for="BatchRun.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#BatchRun.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="BatchRun.__init__-40"><a href="#BatchRun.__init__-40"><span class="linenos"> 40</span></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">:</span> <span class="n">BatchParams</span><span class="p">,</span> <span class="n">jobs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Job</span><span class="p">]):</span>
</span><span id="BatchRun.__init__-41"><a href="#BatchRun.__init__-41"><span class="linenos"> 41</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize batch run.</span>
</span><span id="BatchRun.__init__-42"><a href="#BatchRun.__init__-42"><span class="linenos"> 42</span></a><span class="sd">        </span>
</span><span id="BatchRun.__init__-43"><a href="#BatchRun.__init__-43"><span class="linenos"> 43</span></a><span class="sd">        Args:</span>
</span><span id="BatchRun.__init__-44"><a href="#BatchRun.__init__-44"><span class="linenos"> 44</span></a><span class="sd">            config: Batch configuration</span>
</span><span id="BatchRun.__init__-45"><a href="#BatchRun.__init__-45"><span class="linenos"> 45</span></a><span class="sd">            jobs: List of jobs to execute</span>
</span><span id="BatchRun.__init__-46"><a href="#BatchRun.__init__-46"><span class="linenos"> 46</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="BatchRun.__init__-47"><a href="#BatchRun.__init__-47"><span class="linenos"> 47</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>
</span><span id="BatchRun.__init__-48"><a href="#BatchRun.__init__-48"><span class="linenos"> 48</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">jobs</span> <span class="o">=</span> <span class="p">{</span><span class="n">job</span><span class="o">.</span><span class="n">id</span><span class="p">:</span> <span class="n">job</span> <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="n">jobs</span><span class="p">}</span>
</span><span id="BatchRun.__init__-49"><a href="#BatchRun.__init__-49"><span class="linenos"> 49</span></a>        
</span><span id="BatchRun.__init__-50"><a href="#BatchRun.__init__-50"><span class="linenos"> 50</span></a>        <span class="c1"># Set logging level based on config</span>
</span><span id="BatchRun.__init__-51"><a href="#BatchRun.__init__-51"><span class="linenos"> 51</span></a>        <span class="n">set_log_level</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">verbosity</span><span class="o">.</span><span class="n">upper</span><span class="p">())</span>
</span><span id="BatchRun.__init__-52"><a href="#BatchRun.__init__-52"><span class="linenos"> 52</span></a>        
</span><span id="BatchRun.__init__-53"><a href="#BatchRun.__init__-53"><span class="linenos"> 53</span></a>        <span class="c1"># Initialize components</span>
</span><span id="BatchRun.__init__-54"><a href="#BatchRun.__init__-54"><span class="linenos"> 54</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cost_tracker</span> <span class="o">=</span> <span class="n">CostTracker</span><span class="p">(</span><span class="n">limit_usd</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">cost_limit_usd</span><span class="p">)</span>
</span><span id="BatchRun.__init__-55"><a href="#BatchRun.__init__-55"><span class="linenos"> 55</span></a>        
</span><span id="BatchRun.__init__-56"><a href="#BatchRun.__init__-56"><span class="linenos"> 56</span></a>        <span class="c1"># Use temp file for state if not provided</span>
</span><span id="BatchRun.__init__-57"><a href="#BatchRun.__init__-57"><span class="linenos"> 57</span></a>        <span class="n">state_file</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">state_file</span>
</span><span id="BatchRun.__init__-58"><a href="#BatchRun.__init__-58"><span class="linenos"> 58</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">state_file</span><span class="p">:</span>
</span><span id="BatchRun.__init__-59"><a href="#BatchRun.__init__-59"><span class="linenos"> 59</span></a>            <span class="n">state_file</span> <span class="o">=</span> <span class="n">create_temp_state_file</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
</span><span id="BatchRun.__init__-60"><a href="#BatchRun.__init__-60"><span class="linenos"> 60</span></a>            <span class="n">config</span><span class="o">.</span><span class="n">reuse_state</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="BatchRun.__init__-61"><a href="#BatchRun.__init__-61"><span class="linenos"> 61</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Created temporary state file: </span><span class="si">{</span><span class="n">state_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="BatchRun.__init__-62"><a href="#BatchRun.__init__-62"><span class="linenos"> 62</span></a>        
</span><span id="BatchRun.__init__-63"><a href="#BatchRun.__init__-63"><span class="linenos"> 63</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">state_manager</span> <span class="o">=</span> <span class="n">StateManager</span><span class="p">(</span><span class="n">state_file</span><span class="p">)</span>
</span><span id="BatchRun.__init__-64"><a href="#BatchRun.__init__-64"><span class="linenos"> 64</span></a>        
</span><span id="BatchRun.__init__-65"><a href="#BatchRun.__init__-65"><span class="linenos"> 65</span></a>        <span class="c1"># State tracking</span>
</span><span id="BatchRun.__init__-66"><a href="#BatchRun.__init__-66"><span class="linenos"> 66</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pending_jobs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Job</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="BatchRun.__init__-67"><a href="#BatchRun.__init__-67"><span class="linenos"> 67</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">completed_results</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">JobResult</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># job_id -&gt; result</span>
</span><span id="BatchRun.__init__-68"><a href="#BatchRun.__init__-68"><span class="linenos"> 68</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">failed_jobs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># job_id -&gt; error</span>
</span><span id="BatchRun.__init__-69"><a href="#BatchRun.__init__-69"><span class="linenos"> 69</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">cancelled_jobs</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># job_id -&gt; reason</span>
</span><span id="BatchRun.__init__-70"><a href="#BatchRun.__init__-70"><span class="linenos"> 70</span></a>        
</span><span id="BatchRun.__init__-71"><a href="#BatchRun.__init__-71"><span class="linenos"> 71</span></a>        <span class="c1"># Batch tracking</span>
</span><span id="BatchRun.__init__-72"><a href="#BatchRun.__init__-72"><span class="linenos"> 72</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">total_batches</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="BatchRun.__init__-73"><a href="#BatchRun.__init__-73"><span class="linenos"> 73</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">completed_batches</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="BatchRun.__init__-74"><a href="#BatchRun.__init__-74"><span class="linenos"> 74</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">current_batch_index</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="BatchRun.__init__-75"><a href="#BatchRun.__init__-75"><span class="linenos"> 75</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">current_batch_size</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="BatchRun.__init__-76"><a href="#BatchRun.__init__-76"><span class="linenos"> 76</span></a>        
</span><span id="BatchRun.__init__-77"><a href="#BatchRun.__init__-77"><span class="linenos"> 77</span></a>        <span class="c1"># Execution control</span>
</span><span id="BatchRun.__init__-78"><a href="#BatchRun.__init__-78"><span class="linenos"> 78</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_started</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="BatchRun.__init__-79"><a href="#BatchRun.__init__-79"><span class="linenos"> 79</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_start_time</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">datetime</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="BatchRun.__init__-80"><a href="#BatchRun.__init__-80"><span class="linenos"> 80</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_time_limit_exceeded</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="BatchRun.__init__-81"><a href="#BatchRun.__init__-81"><span class="linenos"> 81</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_progress_callback</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[</span><span class="n">Dict</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span> <span class="kc">None</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="BatchRun.__init__-82"><a href="#BatchRun.__init__-82"><span class="linenos"> 82</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_progress_interval</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span>  <span class="c1"># Default to 1 second</span>
</span><span id="BatchRun.__init__-83"><a href="#BatchRun.__init__-83"><span class="linenos"> 83</span></a>        
</span><span id="BatchRun.__init__-84"><a href="#BatchRun.__init__-84"><span class="linenos"> 84</span></a>        <span class="c1"># Threading primitives</span>
</span><span id="BatchRun.__init__-85"><a href="#BatchRun.__init__-85"><span class="linenos"> 85</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_state_lock</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>
</span><span id="BatchRun.__init__-86"><a href="#BatchRun.__init__-86"><span class="linenos"> 86</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_shutdown_event</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>
</span><span id="BatchRun.__init__-87"><a href="#BatchRun.__init__-87"><span class="linenos"> 87</span></a>        
</span><span id="BatchRun.__init__-88"><a href="#BatchRun.__init__-88"><span class="linenos"> 88</span></a>        <span class="c1"># Batch tracking for progress display</span>
</span><span id="BatchRun.__init__-89"><a href="#BatchRun.__init__-89"><span class="linenos"> 89</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">batch_tracking</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># batch_id -&gt; batch_info</span>
</span><span id="BatchRun.__init__-90"><a href="#BatchRun.__init__-90"><span class="linenos"> 90</span></a>        
</span><span id="BatchRun.__init__-91"><a href="#BatchRun.__init__-91"><span class="linenos"> 91</span></a>        <span class="c1"># Active batch tracking for cancellation</span>
</span><span id="BatchRun.__init__-92"><a href="#BatchRun.__init__-92"><span class="linenos"> 92</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_active_batches</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">object</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># batch_id -&gt; provider</span>
</span><span id="BatchRun.__init__-93"><a href="#BatchRun.__init__-93"><span class="linenos"> 93</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_active_batches_lock</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>
</span><span id="BatchRun.__init__-94"><a href="#BatchRun.__init__-94"><span class="linenos"> 94</span></a>        
</span><span id="BatchRun.__init__-95"><a href="#BatchRun.__init__-95"><span class="linenos"> 95</span></a>        <span class="c1"># Results directory</span>
</span><span id="BatchRun.__init__-96"><a href="#BatchRun.__init__-96"><span class="linenos"> 96</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">results_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">results_dir</span><span class="p">)</span>
</span><span id="BatchRun.__init__-97"><a href="#BatchRun.__init__-97"><span class="linenos"> 97</span></a>        
</span><span id="BatchRun.__init__-98"><a href="#BatchRun.__init__-98"><span class="linenos"> 98</span></a>        <span class="c1"># If not reusing state, clear the results directory</span>
</span><span id="BatchRun.__init__-99"><a href="#BatchRun.__init__-99"><span class="linenos"> 99</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">config</span><span class="o">.</span><span class="n">reuse_state</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">results_dir</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
</span><span id="BatchRun.__init__-100"><a href="#BatchRun.__init__-100"><span class="linenos">100</span></a>            <span class="kn">import</span><span class="w"> </span><span class="nn">shutil</span>
</span><span id="BatchRun.__init__-101"><a href="#BatchRun.__init__-101"><span class="linenos">101</span></a>            <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">results_dir</span><span class="p">)</span>
</span><span id="BatchRun.__init__-102"><a href="#BatchRun.__init__-102"><span class="linenos">102</span></a>        
</span><span id="BatchRun.__init__-103"><a href="#BatchRun.__init__-103"><span class="linenos">103</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">results_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="BatchRun.__init__-104"><a href="#BatchRun.__init__-104"><span class="linenos">104</span></a>        
</span><span id="BatchRun.__init__-105"><a href="#BatchRun.__init__-105"><span class="linenos">105</span></a>        <span class="c1"># Raw files directory (if enabled)</span>
</span><span id="BatchRun.__init__-106"><a href="#BatchRun.__init__-106"><span class="linenos">106</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">raw_files_dir</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="BatchRun.__init__-107"><a href="#BatchRun.__init__-107"><span class="linenos">107</span></a>        <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">raw_files</span><span class="p">:</span>
</span><span id="BatchRun.__init__-108"><a href="#BatchRun.__init__-108"><span class="linenos">108</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">raw_files_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">results_dir</span> <span class="o">/</span> <span class="s2">&quot;raw_files&quot;</span>
</span><span id="BatchRun.__init__-109"><a href="#BatchRun.__init__-109"><span class="linenos">109</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">raw_files_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="BatchRun.__init__-110"><a href="#BatchRun.__init__-110"><span class="linenos">110</span></a>        
</span><span id="BatchRun.__init__-111"><a href="#BatchRun.__init__-111"><span class="linenos">111</span></a>        <span class="c1"># Try to resume from saved state</span>
</span><span id="BatchRun.__init__-112"><a href="#BatchRun.__init__-112"><span class="linenos">112</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_resume_from_state</span><span class="p">()</span>
</span></pre></div>


            <div class="docstring"><p>Initialize batch run.</p>

<p>Args:
    config: Batch configuration
    jobs: List of jobs to execute</p>
</div>


                            </div>
                            <div id="BatchRun.config" class="classattr">
                                <div class="attr variable">
            <span class="name">config</span>

        
    </div>
    <a class="headerlink" href="#BatchRun.config"></a>
    
    

                            </div>
                            <div id="BatchRun.jobs" class="classattr">
                                <div class="attr variable">
            <span class="name">jobs</span>

        
    </div>
    <a class="headerlink" href="#BatchRun.jobs"></a>
    
    

                            </div>
                            <div id="BatchRun.cost_tracker" class="classattr">
                                <div class="attr variable">
            <span class="name">cost_tracker</span>

        
    </div>
    <a class="headerlink" href="#BatchRun.cost_tracker"></a>
    
    

                            </div>
                            <div id="BatchRun.state_manager" class="classattr">
                                <div class="attr variable">
            <span class="name">state_manager</span>

        
    </div>
    <a class="headerlink" href="#BatchRun.state_manager"></a>
    
    

                            </div>
                            <div id="BatchRun.pending_jobs" class="classattr">
                                <div class="attr variable">
            <span class="name">pending_jobs</span><span class="annotation">: List[<a href="#Job">Job</a>]</span>

        
    </div>
    <a class="headerlink" href="#BatchRun.pending_jobs"></a>
    
    

                            </div>
                            <div id="BatchRun.completed_results" class="classattr">
                                <div class="attr variable">
            <span class="name">completed_results</span><span class="annotation">: Dict[str, <a href="#JobResult">JobResult</a>]</span>

        
    </div>
    <a class="headerlink" href="#BatchRun.completed_results"></a>
    
    

                            </div>
                            <div id="BatchRun.failed_jobs" class="classattr">
                                <div class="attr variable">
            <span class="name">failed_jobs</span><span class="annotation">: Dict[str, str]</span>

        
    </div>
    <a class="headerlink" href="#BatchRun.failed_jobs"></a>
    
    

                            </div>
                            <div id="BatchRun.cancelled_jobs" class="classattr">
                                <div class="attr variable">
            <span class="name">cancelled_jobs</span><span class="annotation">: Dict[str, str]</span>

        
    </div>
    <a class="headerlink" href="#BatchRun.cancelled_jobs"></a>
    
    

                            </div>
                            <div id="BatchRun.total_batches" class="classattr">
                                <div class="attr variable">
            <span class="name">total_batches</span>

        
    </div>
    <a class="headerlink" href="#BatchRun.total_batches"></a>
    
    

                            </div>
                            <div id="BatchRun.completed_batches" class="classattr">
                                <div class="attr variable">
            <span class="name">completed_batches</span>

        
    </div>
    <a class="headerlink" href="#BatchRun.completed_batches"></a>
    
    

                            </div>
                            <div id="BatchRun.current_batch_index" class="classattr">
                                <div class="attr variable">
            <span class="name">current_batch_index</span>

        
    </div>
    <a class="headerlink" href="#BatchRun.current_batch_index"></a>
    
    

                            </div>
                            <div id="BatchRun.current_batch_size" class="classattr">
                                <div class="attr variable">
            <span class="name">current_batch_size</span>

        
    </div>
    <a class="headerlink" href="#BatchRun.current_batch_size"></a>
    
    

                            </div>
                            <div id="BatchRun.batch_tracking" class="classattr">
                                <div class="attr variable">
            <span class="name">batch_tracking</span><span class="annotation">: Dict[str, Dict]</span>

        
    </div>
    <a class="headerlink" href="#BatchRun.batch_tracking"></a>
    
    

                            </div>
                            <div id="BatchRun.results_dir" class="classattr">
                                <div class="attr variable">
            <span class="name">results_dir</span>

        
    </div>
    <a class="headerlink" href="#BatchRun.results_dir"></a>
    
    

                            </div>
                            <div id="BatchRun.raw_files_dir" class="classattr">
                                <div class="attr variable">
            <span class="name">raw_files_dir</span>

        
    </div>
    <a class="headerlink" href="#BatchRun.raw_files_dir"></a>
    
    

                            </div>
                            <div id="BatchRun.to_json" class="classattr">
                                        <input id="BatchRun.to_json-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">to_json</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="n">Dict</span>:</span></span>

                <label class="view-source-button" for="BatchRun.to_json-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#BatchRun.to_json"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="BatchRun.to_json-176"><a href="#BatchRun.to_json-176"><span class="linenos">176</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">to_json</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
</span><span id="BatchRun.to_json-177"><a href="#BatchRun.to_json-177"><span class="linenos">177</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Convert current state to JSON-serializable dict.&quot;&quot;&quot;</span>
</span><span id="BatchRun.to_json-178"><a href="#BatchRun.to_json-178"><span class="linenos">178</span></a>        <span class="k">return</span> <span class="p">{</span>
</span><span id="BatchRun.to_json-179"><a href="#BatchRun.to_json-179"><span class="linenos">179</span></a>            <span class="s2">&quot;created_at&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
</span><span id="BatchRun.to_json-180"><a href="#BatchRun.to_json-180"><span class="linenos">180</span></a>            <span class="s2">&quot;pending_jobs&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">job</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span> <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pending_jobs</span><span class="p">],</span>
</span><span id="BatchRun.to_json-181"><a href="#BatchRun.to_json-181"><span class="linenos">181</span></a>            <span class="s2">&quot;completed_results&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span id="BatchRun.to_json-182"><a href="#BatchRun.to_json-182"><span class="linenos">182</span></a>                <span class="p">{</span><span class="s2">&quot;job_id&quot;</span><span class="p">:</span> <span class="n">job_id</span><span class="p">,</span> <span class="s2">&quot;file_path&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">results_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">job_id</span><span class="si">}</span><span class="s2">.json&quot;</span><span class="p">)}</span>
</span><span id="BatchRun.to_json-183"><a href="#BatchRun.to_json-183"><span class="linenos">183</span></a>                <span class="k">for</span> <span class="n">job_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">completed_results</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
</span><span id="BatchRun.to_json-184"><a href="#BatchRun.to_json-184"><span class="linenos">184</span></a>            <span class="p">],</span>
</span><span id="BatchRun.to_json-185"><a href="#BatchRun.to_json-185"><span class="linenos">185</span></a>            <span class="s2">&quot;failed_jobs&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span id="BatchRun.to_json-186"><a href="#BatchRun.to_json-186"><span class="linenos">186</span></a>                <span class="p">{</span>
</span><span id="BatchRun.to_json-187"><a href="#BatchRun.to_json-187"><span class="linenos">187</span></a>                    <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">job_id</span><span class="p">,</span> 
</span><span id="BatchRun.to_json-188"><a href="#BatchRun.to_json-188"><span class="linenos">188</span></a>                    <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="n">error</span><span class="p">,</span>
</span><span id="BatchRun.to_json-189"><a href="#BatchRun.to_json-189"><span class="linenos">189</span></a>                    <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
</span><span id="BatchRun.to_json-190"><a href="#BatchRun.to_json-190"><span class="linenos">190</span></a>                <span class="p">}</span> <span class="k">for</span> <span class="n">job_id</span><span class="p">,</span> <span class="n">error</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">failed_jobs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
</span><span id="BatchRun.to_json-191"><a href="#BatchRun.to_json-191"><span class="linenos">191</span></a>            <span class="p">],</span>
</span><span id="BatchRun.to_json-192"><a href="#BatchRun.to_json-192"><span class="linenos">192</span></a>            <span class="s2">&quot;cancelled_jobs&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span id="BatchRun.to_json-193"><a href="#BatchRun.to_json-193"><span class="linenos">193</span></a>                <span class="p">{</span>
</span><span id="BatchRun.to_json-194"><a href="#BatchRun.to_json-194"><span class="linenos">194</span></a>                    <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">job_id</span><span class="p">,</span> 
</span><span id="BatchRun.to_json-195"><a href="#BatchRun.to_json-195"><span class="linenos">195</span></a>                    <span class="s2">&quot;reason&quot;</span><span class="p">:</span> <span class="n">reason</span><span class="p">,</span>
</span><span id="BatchRun.to_json-196"><a href="#BatchRun.to_json-196"><span class="linenos">196</span></a>                    <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
</span><span id="BatchRun.to_json-197"><a href="#BatchRun.to_json-197"><span class="linenos">197</span></a>                <span class="p">}</span> <span class="k">for</span> <span class="n">job_id</span><span class="p">,</span> <span class="n">reason</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cancelled_jobs</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
</span><span id="BatchRun.to_json-198"><a href="#BatchRun.to_json-198"><span class="linenos">198</span></a>            <span class="p">],</span>
</span><span id="BatchRun.to_json-199"><a href="#BatchRun.to_json-199"><span class="linenos">199</span></a>            <span class="s2">&quot;total_cost_usd&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cost_tracker</span><span class="o">.</span><span class="n">used_usd</span><span class="p">,</span>
</span><span id="BatchRun.to_json-200"><a href="#BatchRun.to_json-200"><span class="linenos">200</span></a>            <span class="s2">&quot;config&quot;</span><span class="p">:</span> <span class="p">{</span>
</span><span id="BatchRun.to_json-201"><a href="#BatchRun.to_json-201"><span class="linenos">201</span></a>                <span class="s2">&quot;state_file&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">state_file</span><span class="p">,</span>
</span><span id="BatchRun.to_json-202"><a href="#BatchRun.to_json-202"><span class="linenos">202</span></a>                <span class="s2">&quot;results_dir&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">results_dir</span><span class="p">,</span>
</span><span id="BatchRun.to_json-203"><a href="#BatchRun.to_json-203"><span class="linenos">203</span></a>                <span class="s2">&quot;max_parallel_batches&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">max_parallel_batches</span><span class="p">,</span>
</span><span id="BatchRun.to_json-204"><a href="#BatchRun.to_json-204"><span class="linenos">204</span></a>                <span class="s2">&quot;items_per_batch&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">items_per_batch</span><span class="p">,</span>
</span><span id="BatchRun.to_json-205"><a href="#BatchRun.to_json-205"><span class="linenos">205</span></a>                <span class="s2">&quot;cost_limit_usd&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">cost_limit_usd</span><span class="p">,</span>
</span><span id="BatchRun.to_json-206"><a href="#BatchRun.to_json-206"><span class="linenos">206</span></a>                <span class="s2">&quot;default_params&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">default_params</span><span class="p">,</span>
</span><span id="BatchRun.to_json-207"><a href="#BatchRun.to_json-207"><span class="linenos">207</span></a>                <span class="s2">&quot;raw_files&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">raw_files</span>
</span><span id="BatchRun.to_json-208"><a href="#BatchRun.to_json-208"><span class="linenos">208</span></a>            <span class="p">}</span>
</span><span id="BatchRun.to_json-209"><a href="#BatchRun.to_json-209"><span class="linenos">209</span></a>        <span class="p">}</span>
</span></pre></div>


            <div class="docstring"><p>Convert current state to JSON-serializable dict.</p>
</div>


                            </div>
                            <div id="BatchRun.execute" class="classattr">
                                        <input id="BatchRun.execute-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">execute</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="BatchRun.execute-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#BatchRun.execute"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="BatchRun.execute-211"><a href="#BatchRun.execute-211"><span class="linenos">211</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="BatchRun.execute-212"><a href="#BatchRun.execute-212"><span class="linenos">212</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute synchronous batch run and wait for completion.&quot;&quot;&quot;</span>
</span><span id="BatchRun.execute-213"><a href="#BatchRun.execute-213"><span class="linenos">213</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_started</span><span class="p">:</span>
</span><span id="BatchRun.execute-214"><a href="#BatchRun.execute-214"><span class="linenos">214</span></a>            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Batch run already started&quot;</span><span class="p">)</span>
</span><span id="BatchRun.execute-215"><a href="#BatchRun.execute-215"><span class="linenos">215</span></a>        
</span><span id="BatchRun.execute-216"><a href="#BatchRun.execute-216"><span class="linenos">216</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_started</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="BatchRun.execute-217"><a href="#BatchRun.execute-217"><span class="linenos">217</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_start_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
</span><span id="BatchRun.execute-218"><a href="#BatchRun.execute-218"><span class="linenos">218</span></a>        
</span><span id="BatchRun.execute-219"><a href="#BatchRun.execute-219"><span class="linenos">219</span></a>        <span class="c1"># Register signal handler for graceful shutdown</span>
</span><span id="BatchRun.execute-220"><a href="#BatchRun.execute-220"><span class="linenos">220</span></a>        <span class="k">def</span><span class="w"> </span><span class="nf">signal_handler</span><span class="p">(</span><span class="n">signum</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
</span><span id="BatchRun.execute-221"><a href="#BatchRun.execute-221"><span class="linenos">221</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Received interrupt signal, shutting down gracefully...&quot;</span><span class="p">)</span>
</span><span id="BatchRun.execute-222"><a href="#BatchRun.execute-222"><span class="linenos">222</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_shutdown_event</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
</span><span id="BatchRun.execute-223"><a href="#BatchRun.execute-223"><span class="linenos">223</span></a>        
</span><span id="BatchRun.execute-224"><a href="#BatchRun.execute-224"><span class="linenos">224</span></a>        <span class="c1"># Store original handler to restore later</span>
</span><span id="BatchRun.execute-225"><a href="#BatchRun.execute-225"><span class="linenos">225</span></a>        <span class="n">original_handler</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGINT</span><span class="p">,</span> <span class="n">signal_handler</span><span class="p">)</span>
</span><span id="BatchRun.execute-226"><a href="#BatchRun.execute-226"><span class="linenos">226</span></a>        
</span><span id="BatchRun.execute-227"><a href="#BatchRun.execute-227"><span class="linenos">227</span></a>        <span class="k">try</span><span class="p">:</span>
</span><span id="BatchRun.execute-228"><a href="#BatchRun.execute-228"><span class="linenos">228</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Starting batch run&quot;</span><span class="p">)</span>
</span><span id="BatchRun.execute-229"><a href="#BatchRun.execute-229"><span class="linenos">229</span></a>            
</span><span id="BatchRun.execute-230"><a href="#BatchRun.execute-230"><span class="linenos">230</span></a>            <span class="c1"># Start time limit watchdog if configured</span>
</span><span id="BatchRun.execute-231"><a href="#BatchRun.execute-231"><span class="linenos">231</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_start_time_limit_watchdog</span><span class="p">()</span>
</span><span id="BatchRun.execute-232"><a href="#BatchRun.execute-232"><span class="linenos">232</span></a>            
</span><span id="BatchRun.execute-233"><a href="#BatchRun.execute-233"><span class="linenos">233</span></a>            <span class="c1"># Call initial progress</span>
</span><span id="BatchRun.execute-234"><a href="#BatchRun.execute-234"><span class="linenos">234</span></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_progress_callback</span><span class="p">:</span>
</span><span id="BatchRun.execute-235"><a href="#BatchRun.execute-235"><span class="linenos">235</span></a>                <span class="n">stats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">status</span><span class="p">()</span>
</span><span id="BatchRun.execute-236"><a href="#BatchRun.execute-236"><span class="linenos">236</span></a>                <span class="n">batch_data</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_tracking</span><span class="p">)</span>
</span><span id="BatchRun.execute-237"><a href="#BatchRun.execute-237"><span class="linenos">237</span></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_progress_callback</span><span class="p">(</span><span class="n">stats</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">batch_data</span><span class="p">)</span>
</span><span id="BatchRun.execute-238"><a href="#BatchRun.execute-238"><span class="linenos">238</span></a>            
</span><span id="BatchRun.execute-239"><a href="#BatchRun.execute-239"><span class="linenos">239</span></a>            <span class="c1"># Process all jobs synchronously</span>
</span><span id="BatchRun.execute-240"><a href="#BatchRun.execute-240"><span class="linenos">240</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_process_all_jobs</span><span class="p">()</span>
</span><span id="BatchRun.execute-241"><a href="#BatchRun.execute-241"><span class="linenos">241</span></a>            
</span><span id="BatchRun.execute-242"><a href="#BatchRun.execute-242"><span class="linenos">242</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Batch run completed&quot;</span><span class="p">)</span>
</span><span id="BatchRun.execute-243"><a href="#BatchRun.execute-243"><span class="linenos">243</span></a>        <span class="k">finally</span><span class="p">:</span>
</span><span id="BatchRun.execute-244"><a href="#BatchRun.execute-244"><span class="linenos">244</span></a>            <span class="c1"># Restore original signal handler</span>
</span><span id="BatchRun.execute-245"><a href="#BatchRun.execute-245"><span class="linenos">245</span></a>            <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGINT</span><span class="p">,</span> <span class="n">original_handler</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Execute synchronous batch run and wait for completion.</p>
</div>


                            </div>
                            <div id="BatchRun.set_on_progress" class="classattr">
                                        <input id="BatchRun.set_on_progress-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">set_on_progress</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">callback</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Dict</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">Dict</span><span class="p">],</span> <span class="n">NoneType</span><span class="p">]</span>,</span><span class="param">	<span class="n">interval</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span></span><span class="return-annotation">) -> <span class="n"><a href="#BatchRun">BatchRun</a></span>:</span></span>

                <label class="view-source-button" for="BatchRun.set_on_progress-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#BatchRun.set_on_progress"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="BatchRun.set_on_progress-247"><a href="#BatchRun.set_on_progress-247"><span class="linenos">247</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">set_on_progress</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">callback</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Dict</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="n">Dict</span><span class="p">],</span> <span class="kc">None</span><span class="p">],</span> <span class="n">interval</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;BatchRun&#39;</span><span class="p">:</span>
</span><span id="BatchRun.set_on_progress-248"><a href="#BatchRun.set_on_progress-248"><span class="linenos">248</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Set progress callback for execution monitoring.</span>
</span><span id="BatchRun.set_on_progress-249"><a href="#BatchRun.set_on_progress-249"><span class="linenos">249</span></a><span class="sd">        </span>
</span><span id="BatchRun.set_on_progress-250"><a href="#BatchRun.set_on_progress-250"><span class="linenos">250</span></a><span class="sd">        The callback will be called periodically with progress statistics</span>
</span><span id="BatchRun.set_on_progress-251"><a href="#BatchRun.set_on_progress-251"><span class="linenos">251</span></a><span class="sd">        including completed jobs, total jobs, current cost, etc.</span>
</span><span id="BatchRun.set_on_progress-252"><a href="#BatchRun.set_on_progress-252"><span class="linenos">252</span></a><span class="sd">        </span>
</span><span id="BatchRun.set_on_progress-253"><a href="#BatchRun.set_on_progress-253"><span class="linenos">253</span></a><span class="sd">        Args:</span>
</span><span id="BatchRun.set_on_progress-254"><a href="#BatchRun.set_on_progress-254"><span class="linenos">254</span></a><span class="sd">            callback: Function that receives (stats_dict, elapsed_time_seconds, batch_data)</span>
</span><span id="BatchRun.set_on_progress-255"><a href="#BatchRun.set_on_progress-255"><span class="linenos">255</span></a><span class="sd">                     - stats_dict: Progress statistics dictionary</span>
</span><span id="BatchRun.set_on_progress-256"><a href="#BatchRun.set_on_progress-256"><span class="linenos">256</span></a><span class="sd">                     - elapsed_time_seconds: Time elapsed since batch started (float)</span>
</span><span id="BatchRun.set_on_progress-257"><a href="#BatchRun.set_on_progress-257"><span class="linenos">257</span></a><span class="sd">                     - batch_data: Dictionary mapping batch_id to batch information</span>
</span><span id="BatchRun.set_on_progress-258"><a href="#BatchRun.set_on_progress-258"><span class="linenos">258</span></a><span class="sd">            interval: Interval in seconds between progress updates (default: 1.0)</span>
</span><span id="BatchRun.set_on_progress-259"><a href="#BatchRun.set_on_progress-259"><span class="linenos">259</span></a><span class="sd">            </span>
</span><span id="BatchRun.set_on_progress-260"><a href="#BatchRun.set_on_progress-260"><span class="linenos">260</span></a><span class="sd">        Returns:</span>
</span><span id="BatchRun.set_on_progress-261"><a href="#BatchRun.set_on_progress-261"><span class="linenos">261</span></a><span class="sd">            Self for chaining</span>
</span><span id="BatchRun.set_on_progress-262"><a href="#BatchRun.set_on_progress-262"><span class="linenos">262</span></a><span class="sd">            </span>
</span><span id="BatchRun.set_on_progress-263"><a href="#BatchRun.set_on_progress-263"><span class="linenos">263</span></a><span class="sd">        Example:</span>
</span><span id="BatchRun.set_on_progress-264"><a href="#BatchRun.set_on_progress-264"><span class="linenos">264</span></a><span class="sd">            ```python</span>
</span><span id="BatchRun.set_on_progress-265"><a href="#BatchRun.set_on_progress-265"><span class="linenos">265</span></a><span class="sd">            run.set_on_progress(</span>
</span><span id="BatchRun.set_on_progress-266"><a href="#BatchRun.set_on_progress-266"><span class="linenos">266</span></a><span class="sd">                lambda stats, time, batch_data: print(</span>
</span><span id="BatchRun.set_on_progress-267"><a href="#BatchRun.set_on_progress-267"><span class="linenos">267</span></a><span class="sd">                    f&quot;Progress: {stats[&#39;completed&#39;]}/{stats[&#39;total&#39;]}, {time:.1f}s&quot;</span>
</span><span id="BatchRun.set_on_progress-268"><a href="#BatchRun.set_on_progress-268"><span class="linenos">268</span></a><span class="sd">                )</span>
</span><span id="BatchRun.set_on_progress-269"><a href="#BatchRun.set_on_progress-269"><span class="linenos">269</span></a><span class="sd">            )</span>
</span><span id="BatchRun.set_on_progress-270"><a href="#BatchRun.set_on_progress-270"><span class="linenos">270</span></a><span class="sd">            ```</span>
</span><span id="BatchRun.set_on_progress-271"><a href="#BatchRun.set_on_progress-271"><span class="linenos">271</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="BatchRun.set_on_progress-272"><a href="#BatchRun.set_on_progress-272"><span class="linenos">272</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_progress_callback</span> <span class="o">=</span> <span class="n">callback</span>
</span><span id="BatchRun.set_on_progress-273"><a href="#BatchRun.set_on_progress-273"><span class="linenos">273</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_progress_interval</span> <span class="o">=</span> <span class="n">interval</span>
</span><span id="BatchRun.set_on_progress-274"><a href="#BatchRun.set_on_progress-274"><span class="linenos">274</span></a>        <span class="k">return</span> <span class="bp">self</span>
</span></pre></div>


            <div class="docstring"><p>Set progress callback for execution monitoring.</p>

<p>The callback will be called periodically with progress statistics
including completed jobs, total jobs, current cost, etc.</p>

<p>Args:
    callback: Function that receives (stats_dict, elapsed_time_seconds, batch_data)
             - stats_dict: Progress statistics dictionary
             - elapsed_time_seconds: Time elapsed since batch started (float)
             - batch_data: Dictionary mapping batch_id to batch information
    interval: Interval in seconds between progress updates (default: 1.0)</p>

<p>Returns:
    Self for chaining</p>

<p>Example:</p>

<pre><code><div class="pdoc-code codehilite">
<pre><span></span><code><span class="n">run</span><span class="o">.</span><span class="n">set_on_progress</span><span class="p">(</span>
    <span class="k">lambda</span> <span class="n">stats</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">batch_data</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;Progress: </span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;completed&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;total&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">time</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">s&quot;</span>
    <span class="p">)</span>
<span class="p">)</span>
</code></pre>
</div>
</code></pre>
</div>


                            </div>
                            <div id="BatchRun.is_complete" class="classattr">
                                        <input id="BatchRun.is_complete-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr variable">
            <span class="name">is_complete</span><span class="annotation">: bool</span>

                <label class="view-source-button" for="BatchRun.is_complete-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#BatchRun.is_complete"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="BatchRun.is_complete-728"><a href="#BatchRun.is_complete-728"><span class="linenos">728</span></a>    <span class="nd">@property</span>
</span><span id="BatchRun.is_complete-729"><a href="#BatchRun.is_complete-729"><span class="linenos">729</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">is_complete</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="BatchRun.is_complete-730"><a href="#BatchRun.is_complete-730"><span class="linenos">730</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Whether all jobs are complete.&quot;&quot;&quot;</span>
</span><span id="BatchRun.is_complete-731"><a href="#BatchRun.is_complete-731"><span class="linenos">731</span></a>        <span class="n">total_jobs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jobs</span><span class="p">)</span>
</span><span id="BatchRun.is_complete-732"><a href="#BatchRun.is_complete-732"><span class="linenos">732</span></a>        <span class="n">completed_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">completed_results</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">failed_jobs</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cancelled_jobs</span><span class="p">)</span>
</span><span id="BatchRun.is_complete-733"><a href="#BatchRun.is_complete-733"><span class="linenos">733</span></a>        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pending_jobs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">completed_count</span> <span class="o">==</span> <span class="n">total_jobs</span>
</span></pre></div>


            <div class="docstring"><p>Whether all jobs are complete.</p>
</div>


                            </div>
                            <div id="BatchRun.status" class="classattr">
                                        <input id="BatchRun.status-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">status</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">print_status</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span></span><span class="return-annotation">) -> <span class="n">Dict</span>:</span></span>

                <label class="view-source-button" for="BatchRun.status-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#BatchRun.status"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="BatchRun.status-736"><a href="#BatchRun.status-736"><span class="linenos">736</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">print_status</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">:</span>
</span><span id="BatchRun.status-737"><a href="#BatchRun.status-737"><span class="linenos">737</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get current execution statistics.&quot;&quot;&quot;</span>
</span><span id="BatchRun.status-738"><a href="#BatchRun.status-738"><span class="linenos">738</span></a>        <span class="n">total_jobs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jobs</span><span class="p">)</span>
</span><span id="BatchRun.status-739"><a href="#BatchRun.status-739"><span class="linenos">739</span></a>        <span class="n">completed_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">completed_results</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">failed_jobs</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cancelled_jobs</span><span class="p">)</span>
</span><span id="BatchRun.status-740"><a href="#BatchRun.status-740"><span class="linenos">740</span></a>        <span class="n">remaining_count</span> <span class="o">=</span> <span class="n">total_jobs</span> <span class="o">-</span> <span class="n">completed_count</span>
</span><span id="BatchRun.status-741"><a href="#BatchRun.status-741"><span class="linenos">741</span></a>        
</span><span id="BatchRun.status-742"><a href="#BatchRun.status-742"><span class="linenos">742</span></a>        <span class="n">stats</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="BatchRun.status-743"><a href="#BatchRun.status-743"><span class="linenos">743</span></a>            <span class="s2">&quot;total&quot;</span><span class="p">:</span> <span class="n">total_jobs</span><span class="p">,</span>
</span><span id="BatchRun.status-744"><a href="#BatchRun.status-744"><span class="linenos">744</span></a>            <span class="s2">&quot;pending&quot;</span><span class="p">:</span> <span class="n">remaining_count</span><span class="p">,</span>
</span><span id="BatchRun.status-745"><a href="#BatchRun.status-745"><span class="linenos">745</span></a>            <span class="s2">&quot;active&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>  <span class="c1"># Always 0 for synchronous execution</span>
</span><span id="BatchRun.status-746"><a href="#BatchRun.status-746"><span class="linenos">746</span></a>            <span class="s2">&quot;completed&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">completed_results</span><span class="p">),</span>
</span><span id="BatchRun.status-747"><a href="#BatchRun.status-747"><span class="linenos">747</span></a>            <span class="s2">&quot;failed&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">failed_jobs</span><span class="p">),</span>
</span><span id="BatchRun.status-748"><a href="#BatchRun.status-748"><span class="linenos">748</span></a>            <span class="s2">&quot;cancelled&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cancelled_jobs</span><span class="p">),</span>
</span><span id="BatchRun.status-749"><a href="#BatchRun.status-749"><span class="linenos">749</span></a>            <span class="s2">&quot;cost_usd&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cost_tracker</span><span class="o">.</span><span class="n">used_usd</span><span class="p">,</span>
</span><span id="BatchRun.status-750"><a href="#BatchRun.status-750"><span class="linenos">750</span></a>            <span class="s2">&quot;cost_limit_usd&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cost_tracker</span><span class="o">.</span><span class="n">limit_usd</span><span class="p">,</span>
</span><span id="BatchRun.status-751"><a href="#BatchRun.status-751"><span class="linenos">751</span></a>            <span class="s2">&quot;is_complete&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_complete</span><span class="p">,</span>
</span><span id="BatchRun.status-752"><a href="#BatchRun.status-752"><span class="linenos">752</span></a>            <span class="s2">&quot;batches_total&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_batches</span><span class="p">,</span>
</span><span id="BatchRun.status-753"><a href="#BatchRun.status-753"><span class="linenos">753</span></a>            <span class="s2">&quot;batches_completed&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">completed_batches</span><span class="p">,</span>
</span><span id="BatchRun.status-754"><a href="#BatchRun.status-754"><span class="linenos">754</span></a>            <span class="s2">&quot;batches_pending&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_batches</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">completed_batches</span><span class="p">,</span>
</span><span id="BatchRun.status-755"><a href="#BatchRun.status-755"><span class="linenos">755</span></a>            <span class="s2">&quot;current_batch_index&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_batch_index</span><span class="p">,</span>
</span><span id="BatchRun.status-756"><a href="#BatchRun.status-756"><span class="linenos">756</span></a>            <span class="s2">&quot;current_batch_size&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_batch_size</span><span class="p">,</span>
</span><span id="BatchRun.status-757"><a href="#BatchRun.status-757"><span class="linenos">757</span></a>            <span class="s2">&quot;items_per_batch&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">items_per_batch</span>
</span><span id="BatchRun.status-758"><a href="#BatchRun.status-758"><span class="linenos">758</span></a>        <span class="p">}</span>
</span><span id="BatchRun.status-759"><a href="#BatchRun.status-759"><span class="linenos">759</span></a>        
</span><span id="BatchRun.status-760"><a href="#BatchRun.status-760"><span class="linenos">760</span></a>        <span class="k">if</span> <span class="n">print_status</span><span class="p">:</span>
</span><span id="BatchRun.status-761"><a href="#BatchRun.status-761"><span class="linenos">761</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Batch Run Status:&quot;</span><span class="p">)</span>
</span><span id="BatchRun.status-762"><a href="#BatchRun.status-762"><span class="linenos">762</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Total jobs: </span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;total&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="BatchRun.status-763"><a href="#BatchRun.status-763"><span class="linenos">763</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Pending: </span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;pending&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="BatchRun.status-764"><a href="#BatchRun.status-764"><span class="linenos">764</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Active: </span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;active&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="BatchRun.status-765"><a href="#BatchRun.status-765"><span class="linenos">765</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Completed: </span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;completed&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="BatchRun.status-766"><a href="#BatchRun.status-766"><span class="linenos">766</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Failed: </span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;failed&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="BatchRun.status-767"><a href="#BatchRun.status-767"><span class="linenos">767</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Cancelled: </span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;cancelled&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="BatchRun.status-768"><a href="#BatchRun.status-768"><span class="linenos">768</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Cost: $</span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;cost_usd&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.6f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="BatchRun.status-769"><a href="#BatchRun.status-769"><span class="linenos">769</span></a>            <span class="k">if</span> <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;cost_limit_usd&#39;</span><span class="p">]:</span>
</span><span id="BatchRun.status-770"><a href="#BatchRun.status-770"><span class="linenos">770</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Cost limit: $</span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;cost_limit_usd&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="BatchRun.status-771"><a href="#BatchRun.status-771"><span class="linenos">771</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Complete: </span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;is_complete&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="BatchRun.status-772"><a href="#BatchRun.status-772"><span class="linenos">772</span></a>        
</span><span id="BatchRun.status-773"><a href="#BatchRun.status-773"><span class="linenos">773</span></a>        <span class="k">return</span> <span class="n">stats</span>
</span></pre></div>


            <div class="docstring"><p>Get current execution statistics.</p>
</div>


                            </div>
                            <div id="BatchRun.results" class="classattr">
                                        <input id="BatchRun.results-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">results</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n"><a href="#JobResult">JobResult</a></span><span class="p">]]</span>:</span></span>

                <label class="view-source-button" for="BatchRun.results-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#BatchRun.results"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="BatchRun.results-775"><a href="#BatchRun.results-775"><span class="linenos">775</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">results</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">JobResult</span><span class="p">]]:</span>
</span><span id="BatchRun.results-776"><a href="#BatchRun.results-776"><span class="linenos">776</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get all results organized by status.</span>
</span><span id="BatchRun.results-777"><a href="#BatchRun.results-777"><span class="linenos">777</span></a><span class="sd">        </span>
</span><span id="BatchRun.results-778"><a href="#BatchRun.results-778"><span class="linenos">778</span></a><span class="sd">        Returns:</span>
</span><span id="BatchRun.results-779"><a href="#BatchRun.results-779"><span class="linenos">779</span></a><span class="sd">            {</span>
</span><span id="BatchRun.results-780"><a href="#BatchRun.results-780"><span class="linenos">780</span></a><span class="sd">                &quot;completed&quot;: [JobResult],</span>
</span><span id="BatchRun.results-781"><a href="#BatchRun.results-781"><span class="linenos">781</span></a><span class="sd">                &quot;failed&quot;: [JobResult],</span>
</span><span id="BatchRun.results-782"><a href="#BatchRun.results-782"><span class="linenos">782</span></a><span class="sd">                &quot;cancelled&quot;: [JobResult]</span>
</span><span id="BatchRun.results-783"><a href="#BatchRun.results-783"><span class="linenos">783</span></a><span class="sd">            }</span>
</span><span id="BatchRun.results-784"><a href="#BatchRun.results-784"><span class="linenos">784</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="BatchRun.results-785"><a href="#BatchRun.results-785"><span class="linenos">785</span></a>        <span class="k">return</span> <span class="p">{</span>
</span><span id="BatchRun.results-786"><a href="#BatchRun.results-786"><span class="linenos">786</span></a>            <span class="s2">&quot;completed&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">completed_results</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span>
</span><span id="BatchRun.results-787"><a href="#BatchRun.results-787"><span class="linenos">787</span></a>            <span class="s2">&quot;failed&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_failed_results</span><span class="p">(),</span>
</span><span id="BatchRun.results-788"><a href="#BatchRun.results-788"><span class="linenos">788</span></a>            <span class="s2">&quot;cancelled&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_cancelled_results</span><span class="p">()</span>
</span><span id="BatchRun.results-789"><a href="#BatchRun.results-789"><span class="linenos">789</span></a>        <span class="p">}</span>
</span></pre></div>


            <div class="docstring"><p>Get all results organized by status.</p>

<p>Returns:
    {
        "completed": [JobResult],
        "failed": [JobResult],
        "cancelled": [JobResult]
    }</p>
</div>


                            </div>
                            <div id="BatchRun.get_failed_jobs" class="classattr">
                                        <input id="BatchRun.get_failed_jobs-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">get_failed_jobs</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="BatchRun.get_failed_jobs-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#BatchRun.get_failed_jobs"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="BatchRun.get_failed_jobs-791"><a href="#BatchRun.get_failed_jobs-791"><span class="linenos">791</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_failed_jobs</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]:</span>
</span><span id="BatchRun.get_failed_jobs-792"><a href="#BatchRun.get_failed_jobs-792"><span class="linenos">792</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get failed jobs with error messages.</span>
</span><span id="BatchRun.get_failed_jobs-793"><a href="#BatchRun.get_failed_jobs-793"><span class="linenos">793</span></a><span class="sd">        </span>
</span><span id="BatchRun.get_failed_jobs-794"><a href="#BatchRun.get_failed_jobs-794"><span class="linenos">794</span></a><span class="sd">        Note: This method is deprecated. Use results()[&#39;failed&#39;] instead.</span>
</span><span id="BatchRun.get_failed_jobs-795"><a href="#BatchRun.get_failed_jobs-795"><span class="linenos">795</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="BatchRun.get_failed_jobs-796"><a href="#BatchRun.get_failed_jobs-796"><span class="linenos">796</span></a>        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">failed_jobs</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Get failed jobs with error messages.</p>

<p>Note: This method is deprecated. Use results()['failed'] instead.</p>
</div>


                            </div>
                            <div id="BatchRun.shutdown" class="classattr">
                                        <input id="BatchRun.shutdown-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">shutdown</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="BatchRun.shutdown-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#BatchRun.shutdown"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="BatchRun.shutdown-828"><a href="#BatchRun.shutdown-828"><span class="linenos">828</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">shutdown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="BatchRun.shutdown-829"><a href="#BatchRun.shutdown-829"><span class="linenos">829</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Shutdown (no-op for synchronous execution).&quot;&quot;&quot;</span>
</span><span id="BatchRun.shutdown-830"><a href="#BatchRun.shutdown-830"><span class="linenos">830</span></a>        <span class="k">pass</span>
</span></pre></div>


            <div class="docstring"><p>Shutdown (no-op for synchronous execution).</p>
</div>


                            </div>
                            <div id="BatchRun.dry_run" class="classattr">
                                        <input id="BatchRun.dry_run-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">dry_run</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="n"><a href="#BatchRun">BatchRun</a></span>:</span></span>

                <label class="view-source-button" for="BatchRun.dry_run-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#BatchRun.dry_run"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="BatchRun.dry_run-832"><a href="#BatchRun.dry_run-832"><span class="linenos">832</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">dry_run</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;BatchRun&#39;</span><span class="p">:</span>
</span><span id="BatchRun.dry_run-833"><a href="#BatchRun.dry_run-833"><span class="linenos">833</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Perform a dry run - show cost estimation and job details without executing.</span>
</span><span id="BatchRun.dry_run-834"><a href="#BatchRun.dry_run-834"><span class="linenos">834</span></a><span class="sd">        </span>
</span><span id="BatchRun.dry_run-835"><a href="#BatchRun.dry_run-835"><span class="linenos">835</span></a><span class="sd">        Returns:</span>
</span><span id="BatchRun.dry_run-836"><a href="#BatchRun.dry_run-836"><span class="linenos">836</span></a><span class="sd">            Self for chaining (doesn&#39;t actually execute jobs)</span>
</span><span id="BatchRun.dry_run-837"><a href="#BatchRun.dry_run-837"><span class="linenos">837</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="BatchRun.dry_run-838"><a href="#BatchRun.dry_run-838"><span class="linenos">838</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;=== DRY RUN MODE ===&quot;</span><span class="p">)</span>
</span><span id="BatchRun.dry_run-839"><a href="#BatchRun.dry_run-839"><span class="linenos">839</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;This will show cost estimates without executing jobs&quot;</span><span class="p">)</span>
</span><span id="BatchRun.dry_run-840"><a href="#BatchRun.dry_run-840"><span class="linenos">840</span></a>        
</span><span id="BatchRun.dry_run-841"><a href="#BatchRun.dry_run-841"><span class="linenos">841</span></a>        <span class="c1"># Load existing state if reuse_state=True</span>
</span><span id="BatchRun.dry_run-842"><a href="#BatchRun.dry_run-842"><span class="linenos">842</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">reuse_state</span><span class="p">:</span>
</span><span id="BatchRun.dry_run-843"><a href="#BatchRun.dry_run-843"><span class="linenos">843</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">state_manager</span><span class="o">.</span><span class="n">load_state</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span><span id="BatchRun.dry_run-844"><a href="#BatchRun.dry_run-844"><span class="linenos">844</span></a>        
</span><span id="BatchRun.dry_run-845"><a href="#BatchRun.dry_run-845"><span class="linenos">845</span></a>        <span class="c1"># Filter out completed jobs from previous runs</span>
</span><span id="BatchRun.dry_run-846"><a href="#BatchRun.dry_run-846"><span class="linenos">846</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pending_jobs</span> <span class="o">=</span> <span class="p">[</span><span class="n">job</span> <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobs</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">completed_results</span><span class="p">]</span>
</span><span id="BatchRun.dry_run-847"><a href="#BatchRun.dry_run-847"><span class="linenos">847</span></a>        
</span><span id="BatchRun.dry_run-848"><a href="#BatchRun.dry_run-848"><span class="linenos">848</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">pending_jobs</span><span class="p">:</span>
</span><span id="BatchRun.dry_run-849"><a href="#BatchRun.dry_run-849"><span class="linenos">849</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;No pending jobs to analyze (all jobs already completed)&quot;</span><span class="p">)</span>
</span><span id="BatchRun.dry_run-850"><a href="#BatchRun.dry_run-850"><span class="linenos">850</span></a>            <span class="k">return</span> <span class="bp">self</span>
</span><span id="BatchRun.dry_run-851"><a href="#BatchRun.dry_run-851"><span class="linenos">851</span></a>        
</span><span id="BatchRun.dry_run-852"><a href="#BatchRun.dry_run-852"><span class="linenos">852</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Analyzing </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pending_jobs</span><span class="p">)</span><span class="si">}</span><span class="s2"> pending jobs...&quot;</span><span class="p">)</span>
</span><span id="BatchRun.dry_run-853"><a href="#BatchRun.dry_run-853"><span class="linenos">853</span></a>        
</span><span id="BatchRun.dry_run-854"><a href="#BatchRun.dry_run-854"><span class="linenos">854</span></a>        <span class="c1"># Group jobs by provider and analyze costs</span>
</span><span id="BatchRun.dry_run-855"><a href="#BatchRun.dry_run-855"><span class="linenos">855</span></a>        <span class="n">provider_groups</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_group_jobs_by_provider</span><span class="p">()</span>
</span><span id="BatchRun.dry_run-856"><a href="#BatchRun.dry_run-856"><span class="linenos">856</span></a>        <span class="n">total_estimated_cost</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="BatchRun.dry_run-857"><a href="#BatchRun.dry_run-857"><span class="linenos">857</span></a>        
</span><span id="BatchRun.dry_run-858"><a href="#BatchRun.dry_run-858"><span class="linenos">858</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Job breakdown:&quot;</span><span class="p">)</span>
</span><span id="BatchRun.dry_run-859"><a href="#BatchRun.dry_run-859"><span class="linenos">859</span></a>        <span class="k">for</span> <span class="n">provider_name</span><span class="p">,</span> <span class="n">jobs</span> <span class="ow">in</span> <span class="n">provider_groups</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="BatchRun.dry_run-860"><a href="#BatchRun.dry_run-860"><span class="linenos">860</span></a>            <span class="n">provider</span> <span class="o">=</span> <span class="n">get_provider</span><span class="p">(</span><span class="n">jobs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">model</span><span class="p">)</span>
</span><span id="BatchRun.dry_run-861"><a href="#BatchRun.dry_run-861"><span class="linenos">861</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="si">{</span><span class="n">provider_name</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">jobs</span><span class="p">)</span><span class="si">}</span><span class="s2"> jobs):&quot;</span><span class="p">)</span>
</span><span id="BatchRun.dry_run-862"><a href="#BatchRun.dry_run-862"><span class="linenos">862</span></a>            
</span><span id="BatchRun.dry_run-863"><a href="#BatchRun.dry_run-863"><span class="linenos">863</span></a>            <span class="n">job_batches</span> <span class="o">=</span> <span class="p">[</span><span class="n">jobs</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">items_per_batch</span><span class="p">]</span> 
</span><span id="BatchRun.dry_run-864"><a href="#BatchRun.dry_run-864"><span class="linenos">864</span></a>                          <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">jobs</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">items_per_batch</span><span class="p">)]</span>
</span><span id="BatchRun.dry_run-865"><a href="#BatchRun.dry_run-865"><span class="linenos">865</span></a>            
</span><span id="BatchRun.dry_run-866"><a href="#BatchRun.dry_run-866"><span class="linenos">866</span></a>            <span class="k">for</span> <span class="n">batch_idx</span><span class="p">,</span> <span class="n">batch_jobs</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">job_batches</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
</span><span id="BatchRun.dry_run-867"><a href="#BatchRun.dry_run-867"><span class="linenos">867</span></a>                <span class="n">estimated_cost</span> <span class="o">=</span> <span class="n">provider</span><span class="o">.</span><span class="n">estimate_cost</span><span class="p">(</span><span class="n">batch_jobs</span><span class="p">)</span>
</span><span id="BatchRun.dry_run-868"><a href="#BatchRun.dry_run-868"><span class="linenos">868</span></a>                <span class="n">total_estimated_cost</span> <span class="o">+=</span> <span class="n">estimated_cost</span>
</span><span id="BatchRun.dry_run-869"><a href="#BatchRun.dry_run-869"><span class="linenos">869</span></a>                
</span><span id="BatchRun.dry_run-870"><a href="#BatchRun.dry_run-870"><span class="linenos">870</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Batch </span><span class="si">{</span><span class="n">batch_idx</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">batch_jobs</span><span class="p">)</span><span class="si">}</span><span class="s2"> jobs, estimated cost: $</span><span class="si">{</span><span class="n">estimated_cost</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="BatchRun.dry_run-871"><a href="#BatchRun.dry_run-871"><span class="linenos">871</span></a>                <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="n">batch_jobs</span><span class="p">:</span>
</span><span id="BatchRun.dry_run-872"><a href="#BatchRun.dry_run-872"><span class="linenos">872</span></a>                    <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">file</span><span class="p">:</span>
</span><span id="BatchRun.dry_run-873"><a href="#BatchRun.dry_run-873"><span class="linenos">873</span></a>                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    - </span><span class="si">{</span><span class="n">job</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">job</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> (citations: </span><span class="si">{</span><span class="n">job</span><span class="o">.</span><span class="n">enable_citations</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
</span><span id="BatchRun.dry_run-874"><a href="#BatchRun.dry_run-874"><span class="linenos">874</span></a>                    <span class="k">else</span><span class="p">:</span>
</span><span id="BatchRun.dry_run-875"><a href="#BatchRun.dry_run-875"><span class="linenos">875</span></a>                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    - </span><span class="si">{</span><span class="n">job</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">: direct messages (citations: </span><span class="si">{</span><span class="n">job</span><span class="o">.</span><span class="n">enable_citations</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
</span><span id="BatchRun.dry_run-876"><a href="#BatchRun.dry_run-876"><span class="linenos">876</span></a>        
</span><span id="BatchRun.dry_run-877"><a href="#BatchRun.dry_run-877"><span class="linenos">877</span></a>        <span class="c1"># Show cost summary</span>
</span><span id="BatchRun.dry_run-878"><a href="#BatchRun.dry_run-878"><span class="linenos">878</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">=== COST SUMMARY ===&quot;</span><span class="p">)</span>
</span><span id="BatchRun.dry_run-879"><a href="#BatchRun.dry_run-879"><span class="linenos">879</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total estimated cost: $</span><span class="si">{</span><span class="n">total_estimated_cost</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="BatchRun.dry_run-880"><a href="#BatchRun.dry_run-880"><span class="linenos">880</span></a>        
</span><span id="BatchRun.dry_run-881"><a href="#BatchRun.dry_run-881"><span class="linenos">881</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">cost_limit_usd</span><span class="p">:</span>
</span><span id="BatchRun.dry_run-882"><a href="#BatchRun.dry_run-882"><span class="linenos">882</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cost limit: $</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">cost_limit_usd</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="BatchRun.dry_run-883"><a href="#BatchRun.dry_run-883"><span class="linenos">883</span></a>            <span class="k">if</span> <span class="n">total_estimated_cost</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">cost_limit_usd</span><span class="p">:</span>
</span><span id="BatchRun.dry_run-884"><a href="#BatchRun.dry_run-884"><span class="linenos">884</span></a>                <span class="n">excess</span> <span class="o">=</span> <span class="n">total_estimated_cost</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">cost_limit_usd</span>
</span><span id="BatchRun.dry_run-885"><a href="#BatchRun.dry_run-885"><span class="linenos">885</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;⚠️ Estimated cost exceeds limit by $</span><span class="si">{</span><span class="n">excess</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="BatchRun.dry_run-886"><a href="#BatchRun.dry_run-886"><span class="linenos">886</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="BatchRun.dry_run-887"><a href="#BatchRun.dry_run-887"><span class="linenos">887</span></a>                <span class="n">remaining</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">cost_limit_usd</span> <span class="o">-</span> <span class="n">total_estimated_cost</span>
</span><span id="BatchRun.dry_run-888"><a href="#BatchRun.dry_run-888"><span class="linenos">888</span></a>                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;✅ Within cost limit ($</span><span class="si">{</span><span class="n">remaining</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> remaining)&quot;</span><span class="p">)</span>
</span><span id="BatchRun.dry_run-889"><a href="#BatchRun.dry_run-889"><span class="linenos">889</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="BatchRun.dry_run-890"><a href="#BatchRun.dry_run-890"><span class="linenos">890</span></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;No cost limit set&quot;</span><span class="p">)</span>
</span><span id="BatchRun.dry_run-891"><a href="#BatchRun.dry_run-891"><span class="linenos">891</span></a>        
</span><span id="BatchRun.dry_run-892"><a href="#BatchRun.dry_run-892"><span class="linenos">892</span></a>        <span class="c1"># Show execution plan</span>
</span><span id="BatchRun.dry_run-893"><a href="#BatchRun.dry_run-893"><span class="linenos">893</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">=== EXECUTION PLAN ===&quot;</span><span class="p">)</span>
</span><span id="BatchRun.dry_run-894"><a href="#BatchRun.dry_run-894"><span class="linenos">894</span></a>        <span class="n">total_batches</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span>
</span><span id="BatchRun.dry_run-895"><a href="#BatchRun.dry_run-895"><span class="linenos">895</span></a>            <span class="nb">len</span><span class="p">(</span><span class="n">jobs</span><span class="p">)</span> <span class="o">//</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">items_per_batch</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">jobs</span><span class="p">)</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">items_per_batch</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
</span><span id="BatchRun.dry_run-896"><a href="#BatchRun.dry_run-896"><span class="linenos">896</span></a>            <span class="k">for</span> <span class="n">jobs</span> <span class="ow">in</span> <span class="n">provider_groups</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
</span><span id="BatchRun.dry_run-897"><a href="#BatchRun.dry_run-897"><span class="linenos">897</span></a>        <span class="p">)</span>
</span><span id="BatchRun.dry_run-898"><a href="#BatchRun.dry_run-898"><span class="linenos">898</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Total batches to process: </span><span class="si">{</span><span class="n">total_batches</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="BatchRun.dry_run-899"><a href="#BatchRun.dry_run-899"><span class="linenos">899</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Max parallel batches: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">max_parallel_batches</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="BatchRun.dry_run-900"><a href="#BatchRun.dry_run-900"><span class="linenos">900</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Items per batch: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">items_per_batch</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="BatchRun.dry_run-901"><a href="#BatchRun.dry_run-901"><span class="linenos">901</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Results directory: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">results_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span id="BatchRun.dry_run-902"><a href="#BatchRun.dry_run-902"><span class="linenos">902</span></a>        
</span><span id="BatchRun.dry_run-903"><a href="#BatchRun.dry_run-903"><span class="linenos">903</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">=== DRY RUN COMPLETE ===&quot;</span><span class="p">)</span>
</span><span id="BatchRun.dry_run-904"><a href="#BatchRun.dry_run-904"><span class="linenos">904</span></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;To execute for real, call run() without dry_run=True&quot;</span><span class="p">)</span>
</span><span id="BatchRun.dry_run-905"><a href="#BatchRun.dry_run-905"><span class="linenos">905</span></a>        
</span><span id="BatchRun.dry_run-906"><a href="#BatchRun.dry_run-906"><span class="linenos">906</span></a>        <span class="k">return</span> <span class="bp">self</span>
</span></pre></div>


            <div class="docstring"><p>Perform a dry run - show cost estimation and job details without executing.</p>

<p>Returns:
    Self for chaining (doesn't actually execute jobs)</p>
</div>


                            </div>
                </section>
                <section id="Job">
                            <input id="Job-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
                    <div class="decorator decorator-dataclass">@dataclass</div>

    <span class="def">class</span>
    <span class="name">Job</span>:

                <label class="view-source-button" for="Job-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Job"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Job-12"><a href="#Job-12"><span class="linenos">12</span></a><span class="nd">@dataclass</span>
</span><span id="Job-13"><a href="#Job-13"><span class="linenos">13</span></a><span class="k">class</span><span class="w"> </span><span class="nc">Job</span><span class="p">:</span>
</span><span id="Job-14"><a href="#Job-14"><span class="linenos">14</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Configuration for a single AI job.</span>
</span><span id="Job-15"><a href="#Job-15"><span class="linenos">15</span></a><span class="sd">    </span>
</span><span id="Job-16"><a href="#Job-16"><span class="linenos">16</span></a><span class="sd">    Either provide messages OR prompt (with optional file), not both.</span>
</span><span id="Job-17"><a href="#Job-17"><span class="linenos">17</span></a><span class="sd">    </span>
</span><span id="Job-18"><a href="#Job-18"><span class="linenos">18</span></a><span class="sd">    Attributes:</span>
</span><span id="Job-19"><a href="#Job-19"><span class="linenos">19</span></a><span class="sd">        id: Unique identifier for the job</span>
</span><span id="Job-20"><a href="#Job-20"><span class="linenos">20</span></a><span class="sd">        messages: Chat messages for direct message input</span>
</span><span id="Job-21"><a href="#Job-21"><span class="linenos">21</span></a><span class="sd">        file: Optional file path for file-based input</span>
</span><span id="Job-22"><a href="#Job-22"><span class="linenos">22</span></a><span class="sd">        prompt: Prompt text (can be used alone or with file)</span>
</span><span id="Job-23"><a href="#Job-23"><span class="linenos">23</span></a><span class="sd">        model: Model name (e.g., &quot;claude-3-sonnet&quot;)</span>
</span><span id="Job-24"><a href="#Job-24"><span class="linenos">24</span></a><span class="sd">        temperature: Sampling temperature (0.0-1.0)</span>
</span><span id="Job-25"><a href="#Job-25"><span class="linenos">25</span></a><span class="sd">        max_tokens: Maximum tokens to generate</span>
</span><span id="Job-26"><a href="#Job-26"><span class="linenos">26</span></a><span class="sd">        response_model: Pydantic model for structured output</span>
</span><span id="Job-27"><a href="#Job-27"><span class="linenos">27</span></a><span class="sd">        enable_citations: Whether to extract citations from response</span>
</span><span id="Job-28"><a href="#Job-28"><span class="linenos">28</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="Job-29"><a href="#Job-29"><span class="linenos">29</span></a>    
</span><span id="Job-30"><a href="#Job-30"><span class="linenos">30</span></a>    <span class="nb">id</span><span class="p">:</span> <span class="nb">str</span>  <span class="c1"># Unique identifier</span>
</span><span id="Job-31"><a href="#Job-31"><span class="linenos">31</span></a>    <span class="n">model</span><span class="p">:</span> <span class="nb">str</span>  <span class="c1"># Model name (e.g., &quot;claude-3-sonnet&quot;)</span>
</span><span id="Job-32"><a href="#Job-32"><span class="linenos">32</span></a>    <span class="n">messages</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Message</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Chat messages</span>
</span><span id="Job-33"><a href="#Job-33"><span class="linenos">33</span></a>    <span class="n">file</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Path</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># File input</span>
</span><span id="Job-34"><a href="#Job-34"><span class="linenos">34</span></a>    <span class="n">prompt</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Prompt for file</span>
</span><span id="Job-35"><a href="#Job-35"><span class="linenos">35</span></a>    <span class="n">temperature</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.7</span>
</span><span id="Job-36"><a href="#Job-36"><span class="linenos">36</span></a>    <span class="n">max_tokens</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1000</span>
</span><span id="Job-37"><a href="#Job-37"><span class="linenos">37</span></a>    <span class="n">response_model</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="n">BaseModel</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># For structured output</span>
</span><span id="Job-38"><a href="#Job-38"><span class="linenos">38</span></a>    <span class="n">enable_citations</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="Job-39"><a href="#Job-39"><span class="linenos">39</span></a>    
</span><span id="Job-40"><a href="#Job-40"><span class="linenos">40</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="Job-41"><a href="#Job-41"><span class="linenos">41</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Validate job configuration.&quot;&quot;&quot;</span>
</span><span id="Job-42"><a href="#Job-42"><span class="linenos">42</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">messages</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">prompt</span><span class="p">):</span>
</span><span id="Job-43"><a href="#Job-43"><span class="linenos">43</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Provide either messages OR file+prompt, not both&quot;</span><span class="p">)</span>
</span><span id="Job-44"><a href="#Job-44"><span class="linenos">44</span></a>        
</span><span id="Job-45"><a href="#Job-45"><span class="linenos">45</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">file</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">prompt</span><span class="p">:</span>
</span><span id="Job-46"><a href="#Job-46"><span class="linenos">46</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;File input requires a prompt&quot;</span><span class="p">)</span>
</span><span id="Job-47"><a href="#Job-47"><span class="linenos">47</span></a>        
</span><span id="Job-48"><a href="#Job-48"><span class="linenos">48</span></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">messages</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">prompt</span><span class="p">:</span>
</span><span id="Job-49"><a href="#Job-49"><span class="linenos">49</span></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Must provide either messages or prompt&quot;</span><span class="p">)</span>
</span><span id="Job-50"><a href="#Job-50"><span class="linenos">50</span></a>    
</span><span id="Job-51"><a href="#Job-51"><span class="linenos">51</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="Job-52"><a href="#Job-52"><span class="linenos">52</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Serialize for state persistence.&quot;&quot;&quot;</span>
</span><span id="Job-53"><a href="#Job-53"><span class="linenos">53</span></a>        <span class="k">return</span> <span class="p">{</span>
</span><span id="Job-54"><a href="#Job-54"><span class="linenos">54</span></a>            <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
</span><span id="Job-55"><a href="#Job-55"><span class="linenos">55</span></a>            <span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
</span><span id="Job-56"><a href="#Job-56"><span class="linenos">56</span></a>            <span class="s2">&quot;messages&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">messages</span><span class="p">,</span>
</span><span id="Job-57"><a href="#Job-57"><span class="linenos">57</span></a>            <span class="s2">&quot;file&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">file</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Job-58"><a href="#Job-58"><span class="linenos">58</span></a>            <span class="s2">&quot;prompt&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">prompt</span><span class="p">,</span>
</span><span id="Job-59"><a href="#Job-59"><span class="linenos">59</span></a>            <span class="s2">&quot;temperature&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">temperature</span><span class="p">,</span>
</span><span id="Job-60"><a href="#Job-60"><span class="linenos">60</span></a>            <span class="s2">&quot;max_tokens&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_tokens</span><span class="p">,</span>
</span><span id="Job-61"><a href="#Job-61"><span class="linenos">61</span></a>            <span class="s2">&quot;response_model&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">response_model</span><span class="o">.</span><span class="vm">__name__</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">response_model</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Job-62"><a href="#Job-62"><span class="linenos">62</span></a>            <span class="s2">&quot;enable_citations&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">enable_citations</span>
</span><span id="Job-63"><a href="#Job-63"><span class="linenos">63</span></a>        <span class="p">}</span>
</span><span id="Job-64"><a href="#Job-64"><span class="linenos">64</span></a>    
</span><span id="Job-65"><a href="#Job-65"><span class="linenos">65</span></a>    <span class="nd">@classmethod</span>
</span><span id="Job-66"><a href="#Job-66"><span class="linenos">66</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">from_dict</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="s1">&#39;Job&#39;</span><span class="p">:</span>
</span><span id="Job-67"><a href="#Job-67"><span class="linenos">67</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Deserialize from state.&quot;&quot;&quot;</span>
</span><span id="Job-68"><a href="#Job-68"><span class="linenos">68</span></a>        <span class="c1"># Convert file string back to Path if present</span>
</span><span id="Job-69"><a href="#Job-69"><span class="linenos">69</span></a>        <span class="n">file_path</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Job-70"><a href="#Job-70"><span class="linenos">70</span></a>        <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;file&quot;</span><span class="p">):</span>
</span><span id="Job-71"><a href="#Job-71"><span class="linenos">71</span></a>            <span class="n">file_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;file&quot;</span><span class="p">])</span>
</span><span id="Job-72"><a href="#Job-72"><span class="linenos">72</span></a>        
</span><span id="Job-73"><a href="#Job-73"><span class="linenos">73</span></a>        <span class="c1"># Note: response_model reconstruction would need additional logic</span>
</span><span id="Job-74"><a href="#Job-74"><span class="linenos">74</span></a>        <span class="c1"># For now, we&#39;ll set it to None during deserialization</span>
</span><span id="Job-75"><a href="#Job-75"><span class="linenos">75</span></a>        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
</span><span id="Job-76"><a href="#Job-76"><span class="linenos">76</span></a>            <span class="nb">id</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span>
</span><span id="Job-77"><a href="#Job-77"><span class="linenos">77</span></a>            <span class="n">model</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;model&quot;</span><span class="p">],</span>
</span><span id="Job-78"><a href="#Job-78"><span class="linenos">78</span></a>            <span class="n">messages</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;messages&quot;</span><span class="p">),</span>
</span><span id="Job-79"><a href="#Job-79"><span class="linenos">79</span></a>            <span class="n">file</span><span class="o">=</span><span class="n">file_path</span><span class="p">,</span>
</span><span id="Job-80"><a href="#Job-80"><span class="linenos">80</span></a>            <span class="n">prompt</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;prompt&quot;</span><span class="p">),</span>
</span><span id="Job-81"><a href="#Job-81"><span class="linenos">81</span></a>            <span class="n">temperature</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;temperature&quot;</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">),</span>
</span><span id="Job-82"><a href="#Job-82"><span class="linenos">82</span></a>            <span class="n">max_tokens</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;max_tokens&quot;</span><span class="p">,</span> <span class="mi">1000</span><span class="p">),</span>
</span><span id="Job-83"><a href="#Job-83"><span class="linenos">83</span></a>            <span class="n">response_model</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="c1"># Cannot reconstruct from string</span>
</span><span id="Job-84"><a href="#Job-84"><span class="linenos">84</span></a>            <span class="n">enable_citations</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;enable_citations&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
</span><span id="Job-85"><a href="#Job-85"><span class="linenos">85</span></a>        <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Configuration for a single AI job.</p>

<p>Either provide messages OR prompt (with optional file), not both.</p>

<p>Attributes:
    id: Unique identifier for the job
    messages: Chat messages for direct message input
    file: Optional file path for file-based input
    prompt: Prompt text (can be used alone or with file)
    model: Model name (e.g., "claude-3-sonnet")
    temperature: Sampling temperature (0.0-1.0)
    max_tokens: Maximum tokens to generate
    response_model: Pydantic model for structured output
    enable_citations: Whether to extract citations from response</p>
</div>


                            <div id="Job.__init__" class="classattr">
                                <div class="attr function">
            
        <span class="name">Job</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="nb">id</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">model</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">messages</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">file</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">prompt</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">temperature</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.7</span>,</span><span class="param">	<span class="n">max_tokens</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1000</span>,</span><span class="param">	<span class="n">response_model</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="n">pydantic</span><span class="o">.</span><span class="n">main</span><span class="o">.</span><span class="n">BaseModel</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">enable_citations</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span></span>)</span>

        
    </div>
    <a class="headerlink" href="#Job.__init__"></a>
    
    

                            </div>
                            <div id="Job.id" class="classattr">
                                <div class="attr variable">
            <span class="name">id</span><span class="annotation">: str</span>

        
    </div>
    <a class="headerlink" href="#Job.id"></a>
    
    

                            </div>
                            <div id="Job.model" class="classattr">
                                <div class="attr variable">
            <span class="name">model</span><span class="annotation">: str</span>

        
    </div>
    <a class="headerlink" href="#Job.model"></a>
    
    

                            </div>
                            <div id="Job.messages" class="classattr">
                                <div class="attr variable">
            <span class="name">messages</span><span class="annotation">: Optional[List[Dict[str, Any]]]</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#Job.messages"></a>
    
    

                            </div>
                            <div id="Job.file" class="classattr">
                                <div class="attr variable">
            <span class="name">file</span><span class="annotation">: Optional[pathlib.Path]</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#Job.file"></a>
    
    

                            </div>
                            <div id="Job.prompt" class="classattr">
                                <div class="attr variable">
            <span class="name">prompt</span><span class="annotation">: Optional[str]</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#Job.prompt"></a>
    
    

                            </div>
                            <div id="Job.temperature" class="classattr">
                                <div class="attr variable">
            <span class="name">temperature</span><span class="annotation">: float</span>        =
<span class="default_value">0.7</span>

        
    </div>
    <a class="headerlink" href="#Job.temperature"></a>
    
    

                            </div>
                            <div id="Job.max_tokens" class="classattr">
                                <div class="attr variable">
            <span class="name">max_tokens</span><span class="annotation">: int</span>        =
<span class="default_value">1000</span>

        
    </div>
    <a class="headerlink" href="#Job.max_tokens"></a>
    
    

                            </div>
                            <div id="Job.response_model" class="classattr">
                                <div class="attr variable">
            <span class="name">response_model</span><span class="annotation">: Optional[Type[pydantic.main.BaseModel]]</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#Job.response_model"></a>
    
    

                            </div>
                            <div id="Job.enable_citations" class="classattr">
                                <div class="attr variable">
            <span class="name">enable_citations</span><span class="annotation">: bool</span>        =
<span class="default_value">False</span>

        
    </div>
    <a class="headerlink" href="#Job.enable_citations"></a>
    
    

                            </div>
                            <div id="Job.to_dict" class="classattr">
                                        <input id="Job.to_dict-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">to_dict</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="Job.to_dict-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Job.to_dict"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Job.to_dict-51"><a href="#Job.to_dict-51"><span class="linenos">51</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="Job.to_dict-52"><a href="#Job.to_dict-52"><span class="linenos">52</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Serialize for state persistence.&quot;&quot;&quot;</span>
</span><span id="Job.to_dict-53"><a href="#Job.to_dict-53"><span class="linenos">53</span></a>        <span class="k">return</span> <span class="p">{</span>
</span><span id="Job.to_dict-54"><a href="#Job.to_dict-54"><span class="linenos">54</span></a>            <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
</span><span id="Job.to_dict-55"><a href="#Job.to_dict-55"><span class="linenos">55</span></a>            <span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
</span><span id="Job.to_dict-56"><a href="#Job.to_dict-56"><span class="linenos">56</span></a>            <span class="s2">&quot;messages&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">messages</span><span class="p">,</span>
</span><span id="Job.to_dict-57"><a href="#Job.to_dict-57"><span class="linenos">57</span></a>            <span class="s2">&quot;file&quot;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file</span><span class="p">)</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">file</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Job.to_dict-58"><a href="#Job.to_dict-58"><span class="linenos">58</span></a>            <span class="s2">&quot;prompt&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">prompt</span><span class="p">,</span>
</span><span id="Job.to_dict-59"><a href="#Job.to_dict-59"><span class="linenos">59</span></a>            <span class="s2">&quot;temperature&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">temperature</span><span class="p">,</span>
</span><span id="Job.to_dict-60"><a href="#Job.to_dict-60"><span class="linenos">60</span></a>            <span class="s2">&quot;max_tokens&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_tokens</span><span class="p">,</span>
</span><span id="Job.to_dict-61"><a href="#Job.to_dict-61"><span class="linenos">61</span></a>            <span class="s2">&quot;response_model&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">response_model</span><span class="o">.</span><span class="vm">__name__</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">response_model</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="Job.to_dict-62"><a href="#Job.to_dict-62"><span class="linenos">62</span></a>            <span class="s2">&quot;enable_citations&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">enable_citations</span>
</span><span id="Job.to_dict-63"><a href="#Job.to_dict-63"><span class="linenos">63</span></a>        <span class="p">}</span>
</span></pre></div>


            <div class="docstring"><p>Serialize for state persistence.</p>
</div>


                            </div>
                            <div id="Job.from_dict" class="classattr">
                                        <input id="Job.from_dict-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-classmethod">@classmethod</div>

        <span class="def">def</span>
        <span class="name">from_dict</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">cls</span>, </span><span class="param"><span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span></span><span class="return-annotation">) -> <span class="n"><a href="#Job">Job</a></span>:</span></span>

                <label class="view-source-button" for="Job.from_dict-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Job.from_dict"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Job.from_dict-65"><a href="#Job.from_dict-65"><span class="linenos">65</span></a>    <span class="nd">@classmethod</span>
</span><span id="Job.from_dict-66"><a href="#Job.from_dict-66"><span class="linenos">66</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">from_dict</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="s1">&#39;Job&#39;</span><span class="p">:</span>
</span><span id="Job.from_dict-67"><a href="#Job.from_dict-67"><span class="linenos">67</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Deserialize from state.&quot;&quot;&quot;</span>
</span><span id="Job.from_dict-68"><a href="#Job.from_dict-68"><span class="linenos">68</span></a>        <span class="c1"># Convert file string back to Path if present</span>
</span><span id="Job.from_dict-69"><a href="#Job.from_dict-69"><span class="linenos">69</span></a>        <span class="n">file_path</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="Job.from_dict-70"><a href="#Job.from_dict-70"><span class="linenos">70</span></a>        <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;file&quot;</span><span class="p">):</span>
</span><span id="Job.from_dict-71"><a href="#Job.from_dict-71"><span class="linenos">71</span></a>            <span class="n">file_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;file&quot;</span><span class="p">])</span>
</span><span id="Job.from_dict-72"><a href="#Job.from_dict-72"><span class="linenos">72</span></a>        
</span><span id="Job.from_dict-73"><a href="#Job.from_dict-73"><span class="linenos">73</span></a>        <span class="c1"># Note: response_model reconstruction would need additional logic</span>
</span><span id="Job.from_dict-74"><a href="#Job.from_dict-74"><span class="linenos">74</span></a>        <span class="c1"># For now, we&#39;ll set it to None during deserialization</span>
</span><span id="Job.from_dict-75"><a href="#Job.from_dict-75"><span class="linenos">75</span></a>        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
</span><span id="Job.from_dict-76"><a href="#Job.from_dict-76"><span class="linenos">76</span></a>            <span class="nb">id</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span>
</span><span id="Job.from_dict-77"><a href="#Job.from_dict-77"><span class="linenos">77</span></a>            <span class="n">model</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;model&quot;</span><span class="p">],</span>
</span><span id="Job.from_dict-78"><a href="#Job.from_dict-78"><span class="linenos">78</span></a>            <span class="n">messages</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;messages&quot;</span><span class="p">),</span>
</span><span id="Job.from_dict-79"><a href="#Job.from_dict-79"><span class="linenos">79</span></a>            <span class="n">file</span><span class="o">=</span><span class="n">file_path</span><span class="p">,</span>
</span><span id="Job.from_dict-80"><a href="#Job.from_dict-80"><span class="linenos">80</span></a>            <span class="n">prompt</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;prompt&quot;</span><span class="p">),</span>
</span><span id="Job.from_dict-81"><a href="#Job.from_dict-81"><span class="linenos">81</span></a>            <span class="n">temperature</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;temperature&quot;</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">),</span>
</span><span id="Job.from_dict-82"><a href="#Job.from_dict-82"><span class="linenos">82</span></a>            <span class="n">max_tokens</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;max_tokens&quot;</span><span class="p">,</span> <span class="mi">1000</span><span class="p">),</span>
</span><span id="Job.from_dict-83"><a href="#Job.from_dict-83"><span class="linenos">83</span></a>            <span class="n">response_model</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="c1"># Cannot reconstruct from string</span>
</span><span id="Job.from_dict-84"><a href="#Job.from_dict-84"><span class="linenos">84</span></a>            <span class="n">enable_citations</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;enable_citations&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
</span><span id="Job.from_dict-85"><a href="#Job.from_dict-85"><span class="linenos">85</span></a>        <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Deserialize from state.</p>
</div>


                            </div>
                </section>
                <section id="JobResult">
                            <input id="JobResult-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
                    <div class="decorator decorator-dataclass">@dataclass</div>

    <span class="def">class</span>
    <span class="name">JobResult</span>:

                <label class="view-source-button" for="JobResult-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#JobResult"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="JobResult-11"><a href="#JobResult-11"><span class="linenos"> 11</span></a><span class="nd">@dataclass</span>
</span><span id="JobResult-12"><a href="#JobResult-12"><span class="linenos"> 12</span></a><span class="k">class</span><span class="w"> </span><span class="nc">JobResult</span><span class="p">:</span>
</span><span id="JobResult-13"><a href="#JobResult-13"><span class="linenos"> 13</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Result from a completed AI job.</span>
</span><span id="JobResult-14"><a href="#JobResult-14"><span class="linenos"> 14</span></a><span class="sd">    </span>
</span><span id="JobResult-15"><a href="#JobResult-15"><span class="linenos"> 15</span></a><span class="sd">    Attributes:</span>
</span><span id="JobResult-16"><a href="#JobResult-16"><span class="linenos"> 16</span></a><span class="sd">        job_id: ID of the job this result is for</span>
</span><span id="JobResult-17"><a href="#JobResult-17"><span class="linenos"> 17</span></a><span class="sd">        raw_response: Raw text response from the model (None for failed jobs)</span>
</span><span id="JobResult-18"><a href="#JobResult-18"><span class="linenos"> 18</span></a><span class="sd">        parsed_response: Structured output (if response_model was used)</span>
</span><span id="JobResult-19"><a href="#JobResult-19"><span class="linenos"> 19</span></a><span class="sd">        citations: Extracted citations (if enable_citations was True)</span>
</span><span id="JobResult-20"><a href="#JobResult-20"><span class="linenos"> 20</span></a><span class="sd">        citation_mappings: Maps field names to relevant citations (if response_model used)</span>
</span><span id="JobResult-21"><a href="#JobResult-21"><span class="linenos"> 21</span></a><span class="sd">        input_tokens: Number of input tokens used</span>
</span><span id="JobResult-22"><a href="#JobResult-22"><span class="linenos"> 22</span></a><span class="sd">        output_tokens: Number of output tokens generated</span>
</span><span id="JobResult-23"><a href="#JobResult-23"><span class="linenos"> 23</span></a><span class="sd">        cost_usd: Total cost in USD</span>
</span><span id="JobResult-24"><a href="#JobResult-24"><span class="linenos"> 24</span></a><span class="sd">        error: Error message if job failed</span>
</span><span id="JobResult-25"><a href="#JobResult-25"><span class="linenos"> 25</span></a><span class="sd">        batch_id: ID of the batch this job was part of (for mapping to raw files)</span>
</span><span id="JobResult-26"><a href="#JobResult-26"><span class="linenos"> 26</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="JobResult-27"><a href="#JobResult-27"><span class="linenos"> 27</span></a>    
</span><span id="JobResult-28"><a href="#JobResult-28"><span class="linenos"> 28</span></a>    <span class="n">job_id</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="JobResult-29"><a href="#JobResult-29"><span class="linenos"> 29</span></a>    <span class="n">raw_response</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Raw text response (None for failed jobs)</span>
</span><span id="JobResult-30"><a href="#JobResult-30"><span class="linenos"> 30</span></a>    <span class="n">parsed_response</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">BaseModel</span><span class="p">,</span> <span class="n">Dict</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Structured output or error dict</span>
</span><span id="JobResult-31"><a href="#JobResult-31"><span class="linenos"> 31</span></a>    <span class="n">citations</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Citation</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Extracted citations</span>
</span><span id="JobResult-32"><a href="#JobResult-32"><span class="linenos"> 32</span></a>    <span class="n">citation_mappings</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Citation</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Field -&gt; citations mapping</span>
</span><span id="JobResult-33"><a href="#JobResult-33"><span class="linenos"> 33</span></a>    <span class="n">input_tokens</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="JobResult-34"><a href="#JobResult-34"><span class="linenos"> 34</span></a>    <span class="n">output_tokens</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
</span><span id="JobResult-35"><a href="#JobResult-35"><span class="linenos"> 35</span></a>    <span class="n">cost_usd</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>
</span><span id="JobResult-36"><a href="#JobResult-36"><span class="linenos"> 36</span></a>    <span class="n">error</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Error message if failed</span>
</span><span id="JobResult-37"><a href="#JobResult-37"><span class="linenos"> 37</span></a>    <span class="n">batch_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Batch ID for mapping to raw files</span>
</span><span id="JobResult-38"><a href="#JobResult-38"><span class="linenos"> 38</span></a>    
</span><span id="JobResult-39"><a href="#JobResult-39"><span class="linenos"> 39</span></a>    <span class="nd">@property</span>
</span><span id="JobResult-40"><a href="#JobResult-40"><span class="linenos"> 40</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">is_success</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="JobResult-41"><a href="#JobResult-41"><span class="linenos"> 41</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Whether the job completed successfully.&quot;&quot;&quot;</span>
</span><span id="JobResult-42"><a href="#JobResult-42"><span class="linenos"> 42</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">error</span> <span class="ow">is</span> <span class="kc">None</span>
</span><span id="JobResult-43"><a href="#JobResult-43"><span class="linenos"> 43</span></a>    
</span><span id="JobResult-44"><a href="#JobResult-44"><span class="linenos"> 44</span></a>    <span class="nd">@property</span>
</span><span id="JobResult-45"><a href="#JobResult-45"><span class="linenos"> 45</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">total_tokens</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span id="JobResult-46"><a href="#JobResult-46"><span class="linenos"> 46</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Total tokens used (input + output).&quot;&quot;&quot;</span>
</span><span id="JobResult-47"><a href="#JobResult-47"><span class="linenos"> 47</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_tokens</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_tokens</span>
</span><span id="JobResult-48"><a href="#JobResult-48"><span class="linenos"> 48</span></a>    
</span><span id="JobResult-49"><a href="#JobResult-49"><span class="linenos"> 49</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="JobResult-50"><a href="#JobResult-50"><span class="linenos"> 50</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Serialize for state persistence.&quot;&quot;&quot;</span>
</span><span id="JobResult-51"><a href="#JobResult-51"><span class="linenos"> 51</span></a>        <span class="c1"># Handle parsed_response serialization</span>
</span><span id="JobResult-52"><a href="#JobResult-52"><span class="linenos"> 52</span></a>        <span class="n">parsed_response</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="JobResult-53"><a href="#JobResult-53"><span class="linenos"> 53</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parsed_response</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="JobResult-54"><a href="#JobResult-54"><span class="linenos"> 54</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parsed_response</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
</span><span id="JobResult-55"><a href="#JobResult-55"><span class="linenos"> 55</span></a>                <span class="n">parsed_response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parsed_response</span>
</span><span id="JobResult-56"><a href="#JobResult-56"><span class="linenos"> 56</span></a>            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parsed_response</span><span class="p">,</span> <span class="n">BaseModel</span><span class="p">):</span>
</span><span id="JobResult-57"><a href="#JobResult-57"><span class="linenos"> 57</span></a>                <span class="n">parsed_response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parsed_response</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span>
</span><span id="JobResult-58"><a href="#JobResult-58"><span class="linenos"> 58</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="JobResult-59"><a href="#JobResult-59"><span class="linenos"> 59</span></a>                <span class="n">parsed_response</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parsed_response</span><span class="p">)</span>
</span><span id="JobResult-60"><a href="#JobResult-60"><span class="linenos"> 60</span></a>        
</span><span id="JobResult-61"><a href="#JobResult-61"><span class="linenos"> 61</span></a>        <span class="c1"># Handle citation_mappings serialization</span>
</span><span id="JobResult-62"><a href="#JobResult-62"><span class="linenos"> 62</span></a>        <span class="n">citation_mappings</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="JobResult-63"><a href="#JobResult-63"><span class="linenos"> 63</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">citation_mappings</span><span class="p">:</span>
</span><span id="JobResult-64"><a href="#JobResult-64"><span class="linenos"> 64</span></a>            <span class="n">citation_mappings</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="JobResult-65"><a href="#JobResult-65"><span class="linenos"> 65</span></a>                <span class="n">field</span><span class="p">:</span> <span class="p">[</span><span class="n">asdict</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">citations</span><span class="p">]</span>
</span><span id="JobResult-66"><a href="#JobResult-66"><span class="linenos"> 66</span></a>                <span class="k">for</span> <span class="n">field</span><span class="p">,</span> <span class="n">citations</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">citation_mappings</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
</span><span id="JobResult-67"><a href="#JobResult-67"><span class="linenos"> 67</span></a>            <span class="p">}</span>
</span><span id="JobResult-68"><a href="#JobResult-68"><span class="linenos"> 68</span></a>        
</span><span id="JobResult-69"><a href="#JobResult-69"><span class="linenos"> 69</span></a>        <span class="k">return</span> <span class="p">{</span>
</span><span id="JobResult-70"><a href="#JobResult-70"><span class="linenos"> 70</span></a>            <span class="s2">&quot;job_id&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_id</span><span class="p">,</span>
</span><span id="JobResult-71"><a href="#JobResult-71"><span class="linenos"> 71</span></a>            <span class="s2">&quot;raw_response&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_response</span><span class="p">,</span>
</span><span id="JobResult-72"><a href="#JobResult-72"><span class="linenos"> 72</span></a>            <span class="s2">&quot;parsed_response&quot;</span><span class="p">:</span> <span class="n">parsed_response</span><span class="p">,</span>
</span><span id="JobResult-73"><a href="#JobResult-73"><span class="linenos"> 73</span></a>            <span class="s2">&quot;citations&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">asdict</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">citations</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">citations</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="JobResult-74"><a href="#JobResult-74"><span class="linenos"> 74</span></a>            <span class="s2">&quot;citation_mappings&quot;</span><span class="p">:</span> <span class="n">citation_mappings</span><span class="p">,</span>
</span><span id="JobResult-75"><a href="#JobResult-75"><span class="linenos"> 75</span></a>            <span class="s2">&quot;input_tokens&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_tokens</span><span class="p">,</span>
</span><span id="JobResult-76"><a href="#JobResult-76"><span class="linenos"> 76</span></a>            <span class="s2">&quot;output_tokens&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_tokens</span><span class="p">,</span>
</span><span id="JobResult-77"><a href="#JobResult-77"><span class="linenos"> 77</span></a>            <span class="s2">&quot;cost_usd&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cost_usd</span><span class="p">,</span>
</span><span id="JobResult-78"><a href="#JobResult-78"><span class="linenos"> 78</span></a>            <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">,</span>
</span><span id="JobResult-79"><a href="#JobResult-79"><span class="linenos"> 79</span></a>            <span class="s2">&quot;batch_id&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_id</span>
</span><span id="JobResult-80"><a href="#JobResult-80"><span class="linenos"> 80</span></a>        <span class="p">}</span>
</span><span id="JobResult-81"><a href="#JobResult-81"><span class="linenos"> 81</span></a>    
</span><span id="JobResult-82"><a href="#JobResult-82"><span class="linenos"> 82</span></a>    <span class="nd">@classmethod</span>
</span><span id="JobResult-83"><a href="#JobResult-83"><span class="linenos"> 83</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">from_dict</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="s1">&#39;JobResult&#39;</span><span class="p">:</span>
</span><span id="JobResult-84"><a href="#JobResult-84"><span class="linenos"> 84</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Deserialize from state.&quot;&quot;&quot;</span>
</span><span id="JobResult-85"><a href="#JobResult-85"><span class="linenos"> 85</span></a>        <span class="c1"># Reconstruct citations if present</span>
</span><span id="JobResult-86"><a href="#JobResult-86"><span class="linenos"> 86</span></a>        <span class="n">citations</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="JobResult-87"><a href="#JobResult-87"><span class="linenos"> 87</span></a>        <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;citations&quot;</span><span class="p">):</span>
</span><span id="JobResult-88"><a href="#JobResult-88"><span class="linenos"> 88</span></a>            <span class="n">citations</span> <span class="o">=</span> <span class="p">[</span><span class="n">Citation</span><span class="p">(</span><span class="o">**</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;citations&quot;</span><span class="p">]]</span>
</span><span id="JobResult-89"><a href="#JobResult-89"><span class="linenos"> 89</span></a>        
</span><span id="JobResult-90"><a href="#JobResult-90"><span class="linenos"> 90</span></a>        <span class="c1"># Reconstruct citation_mappings if present</span>
</span><span id="JobResult-91"><a href="#JobResult-91"><span class="linenos"> 91</span></a>        <span class="n">citation_mappings</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="JobResult-92"><a href="#JobResult-92"><span class="linenos"> 92</span></a>        <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;citation_mappings&quot;</span><span class="p">):</span>
</span><span id="JobResult-93"><a href="#JobResult-93"><span class="linenos"> 93</span></a>            <span class="n">citation_mappings</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="JobResult-94"><a href="#JobResult-94"><span class="linenos"> 94</span></a>                <span class="n">field</span><span class="p">:</span> <span class="p">[</span><span class="n">Citation</span><span class="p">(</span><span class="o">**</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">citations</span><span class="p">]</span>
</span><span id="JobResult-95"><a href="#JobResult-95"><span class="linenos"> 95</span></a>                <span class="k">for</span> <span class="n">field</span><span class="p">,</span> <span class="n">citations</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;citation_mappings&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
</span><span id="JobResult-96"><a href="#JobResult-96"><span class="linenos"> 96</span></a>            <span class="p">}</span>
</span><span id="JobResult-97"><a href="#JobResult-97"><span class="linenos"> 97</span></a>        
</span><span id="JobResult-98"><a href="#JobResult-98"><span class="linenos"> 98</span></a>        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
</span><span id="JobResult-99"><a href="#JobResult-99"><span class="linenos"> 99</span></a>            <span class="n">job_id</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;job_id&quot;</span><span class="p">],</span>
</span><span id="JobResult-100"><a href="#JobResult-100"><span class="linenos">100</span></a>            <span class="n">raw_response</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;raw_response&quot;</span><span class="p">],</span>
</span><span id="JobResult-101"><a href="#JobResult-101"><span class="linenos">101</span></a>            <span class="n">parsed_response</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;parsed_response&quot;</span><span class="p">),</span>
</span><span id="JobResult-102"><a href="#JobResult-102"><span class="linenos">102</span></a>            <span class="n">citations</span><span class="o">=</span><span class="n">citations</span><span class="p">,</span>
</span><span id="JobResult-103"><a href="#JobResult-103"><span class="linenos">103</span></a>            <span class="n">citation_mappings</span><span class="o">=</span><span class="n">citation_mappings</span><span class="p">,</span>
</span><span id="JobResult-104"><a href="#JobResult-104"><span class="linenos">104</span></a>            <span class="n">input_tokens</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;input_tokens&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
</span><span id="JobResult-105"><a href="#JobResult-105"><span class="linenos">105</span></a>            <span class="n">output_tokens</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;output_tokens&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
</span><span id="JobResult-106"><a href="#JobResult-106"><span class="linenos">106</span></a>            <span class="n">cost_usd</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;cost_usd&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span>
</span><span id="JobResult-107"><a href="#JobResult-107"><span class="linenos">107</span></a>            <span class="n">error</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;error&quot;</span><span class="p">),</span>
</span><span id="JobResult-108"><a href="#JobResult-108"><span class="linenos">108</span></a>            <span class="n">batch_id</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;batch_id&quot;</span><span class="p">)</span>
</span><span id="JobResult-109"><a href="#JobResult-109"><span class="linenos">109</span></a>        <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Result from a completed AI job.</p>

<p>Attributes:
    job_id: ID of the job this result is for
    raw_response: Raw text response from the model (None for failed jobs)
    parsed_response: Structured output (if response_model was used)
    citations: Extracted citations (if enable_citations was True)
    citation_mappings: Maps field names to relevant citations (if response_model used)
    input_tokens: Number of input tokens used
    output_tokens: Number of output tokens generated
    cost_usd: Total cost in USD
    error: Error message if job failed
    batch_id: ID of the batch this job was part of (for mapping to raw files)</p>
</div>


                            <div id="JobResult.__init__" class="classattr">
                                <div class="attr function">
            
        <span class="name">JobResult</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">job_id</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">raw_response</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">parsed_response</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">pydantic</span><span class="o">.</span><span class="n">main</span><span class="o">.</span><span class="n">BaseModel</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">NoneType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">citations</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n"><a href="#Citation">Citation</a></span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">citation_mappings</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n"><a href="#Citation">Citation</a></span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">input_tokens</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>,</span><span class="param">	<span class="n">output_tokens</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>,</span><span class="param">	<span class="n">cost_usd</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>,</span><span class="param">	<span class="n">error</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">batch_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></span>)</span>

        
    </div>
    <a class="headerlink" href="#JobResult.__init__"></a>
    
    

                            </div>
                            <div id="JobResult.job_id" class="classattr">
                                <div class="attr variable">
            <span class="name">job_id</span><span class="annotation">: str</span>

        
    </div>
    <a class="headerlink" href="#JobResult.job_id"></a>
    
    

                            </div>
                            <div id="JobResult.raw_response" class="classattr">
                                <div class="attr variable">
            <span class="name">raw_response</span><span class="annotation">: Optional[str]</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#JobResult.raw_response"></a>
    
    

                            </div>
                            <div id="JobResult.parsed_response" class="classattr">
                                <div class="attr variable">
            <span class="name">parsed_response</span><span class="annotation">: Union[pydantic.main.BaseModel, Dict, NoneType]</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#JobResult.parsed_response"></a>
    
    

                            </div>
                            <div id="JobResult.citations" class="classattr">
                                <div class="attr variable">
            <span class="name">citations</span><span class="annotation">: Optional[List[<a href="#Citation">Citation</a>]]</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#JobResult.citations"></a>
    
    

                            </div>
                            <div id="JobResult.citation_mappings" class="classattr">
                                <div class="attr variable">
            <span class="name">citation_mappings</span><span class="annotation">: Optional[Dict[str, List[<a href="#Citation">Citation</a>]]]</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#JobResult.citation_mappings"></a>
    
    

                            </div>
                            <div id="JobResult.input_tokens" class="classattr">
                                <div class="attr variable">
            <span class="name">input_tokens</span><span class="annotation">: int</span>        =
<span class="default_value">0</span>

        
    </div>
    <a class="headerlink" href="#JobResult.input_tokens"></a>
    
    

                            </div>
                            <div id="JobResult.output_tokens" class="classattr">
                                <div class="attr variable">
            <span class="name">output_tokens</span><span class="annotation">: int</span>        =
<span class="default_value">0</span>

        
    </div>
    <a class="headerlink" href="#JobResult.output_tokens"></a>
    
    

                            </div>
                            <div id="JobResult.cost_usd" class="classattr">
                                <div class="attr variable">
            <span class="name">cost_usd</span><span class="annotation">: float</span>        =
<span class="default_value">0.0</span>

        
    </div>
    <a class="headerlink" href="#JobResult.cost_usd"></a>
    
    

                            </div>
                            <div id="JobResult.error" class="classattr">
                                <div class="attr variable">
            <span class="name">error</span><span class="annotation">: Optional[str]</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#JobResult.error"></a>
    
    

                            </div>
                            <div id="JobResult.batch_id" class="classattr">
                                <div class="attr variable">
            <span class="name">batch_id</span><span class="annotation">: Optional[str]</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#JobResult.batch_id"></a>
    
    

                            </div>
                            <div id="JobResult.is_success" class="classattr">
                                        <input id="JobResult.is_success-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr variable">
            <span class="name">is_success</span><span class="annotation">: bool</span>

                <label class="view-source-button" for="JobResult.is_success-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#JobResult.is_success"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="JobResult.is_success-39"><a href="#JobResult.is_success-39"><span class="linenos">39</span></a>    <span class="nd">@property</span>
</span><span id="JobResult.is_success-40"><a href="#JobResult.is_success-40"><span class="linenos">40</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">is_success</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="JobResult.is_success-41"><a href="#JobResult.is_success-41"><span class="linenos">41</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Whether the job completed successfully.&quot;&quot;&quot;</span>
</span><span id="JobResult.is_success-42"><a href="#JobResult.is_success-42"><span class="linenos">42</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">error</span> <span class="ow">is</span> <span class="kc">None</span>
</span></pre></div>


            <div class="docstring"><p>Whether the job completed successfully.</p>
</div>


                            </div>
                            <div id="JobResult.total_tokens" class="classattr">
                                        <input id="JobResult.total_tokens-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr variable">
            <span class="name">total_tokens</span><span class="annotation">: int</span>

                <label class="view-source-button" for="JobResult.total_tokens-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#JobResult.total_tokens"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="JobResult.total_tokens-44"><a href="#JobResult.total_tokens-44"><span class="linenos">44</span></a>    <span class="nd">@property</span>
</span><span id="JobResult.total_tokens-45"><a href="#JobResult.total_tokens-45"><span class="linenos">45</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">total_tokens</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span id="JobResult.total_tokens-46"><a href="#JobResult.total_tokens-46"><span class="linenos">46</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Total tokens used (input + output).&quot;&quot;&quot;</span>
</span><span id="JobResult.total_tokens-47"><a href="#JobResult.total_tokens-47"><span class="linenos">47</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_tokens</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_tokens</span>
</span></pre></div>


            <div class="docstring"><p>Total tokens used (input + output).</p>
</div>


                            </div>
                            <div id="JobResult.to_dict" class="classattr">
                                        <input id="JobResult.to_dict-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">to_dict</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="JobResult.to_dict-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#JobResult.to_dict"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="JobResult.to_dict-49"><a href="#JobResult.to_dict-49"><span class="linenos">49</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="JobResult.to_dict-50"><a href="#JobResult.to_dict-50"><span class="linenos">50</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Serialize for state persistence.&quot;&quot;&quot;</span>
</span><span id="JobResult.to_dict-51"><a href="#JobResult.to_dict-51"><span class="linenos">51</span></a>        <span class="c1"># Handle parsed_response serialization</span>
</span><span id="JobResult.to_dict-52"><a href="#JobResult.to_dict-52"><span class="linenos">52</span></a>        <span class="n">parsed_response</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="JobResult.to_dict-53"><a href="#JobResult.to_dict-53"><span class="linenos">53</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parsed_response</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="JobResult.to_dict-54"><a href="#JobResult.to_dict-54"><span class="linenos">54</span></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parsed_response</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
</span><span id="JobResult.to_dict-55"><a href="#JobResult.to_dict-55"><span class="linenos">55</span></a>                <span class="n">parsed_response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parsed_response</span>
</span><span id="JobResult.to_dict-56"><a href="#JobResult.to_dict-56"><span class="linenos">56</span></a>            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parsed_response</span><span class="p">,</span> <span class="n">BaseModel</span><span class="p">):</span>
</span><span id="JobResult.to_dict-57"><a href="#JobResult.to_dict-57"><span class="linenos">57</span></a>                <span class="n">parsed_response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parsed_response</span><span class="o">.</span><span class="n">model_dump</span><span class="p">()</span>
</span><span id="JobResult.to_dict-58"><a href="#JobResult.to_dict-58"><span class="linenos">58</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="JobResult.to_dict-59"><a href="#JobResult.to_dict-59"><span class="linenos">59</span></a>                <span class="n">parsed_response</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parsed_response</span><span class="p">)</span>
</span><span id="JobResult.to_dict-60"><a href="#JobResult.to_dict-60"><span class="linenos">60</span></a>        
</span><span id="JobResult.to_dict-61"><a href="#JobResult.to_dict-61"><span class="linenos">61</span></a>        <span class="c1"># Handle citation_mappings serialization</span>
</span><span id="JobResult.to_dict-62"><a href="#JobResult.to_dict-62"><span class="linenos">62</span></a>        <span class="n">citation_mappings</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="JobResult.to_dict-63"><a href="#JobResult.to_dict-63"><span class="linenos">63</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">citation_mappings</span><span class="p">:</span>
</span><span id="JobResult.to_dict-64"><a href="#JobResult.to_dict-64"><span class="linenos">64</span></a>            <span class="n">citation_mappings</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="JobResult.to_dict-65"><a href="#JobResult.to_dict-65"><span class="linenos">65</span></a>                <span class="n">field</span><span class="p">:</span> <span class="p">[</span><span class="n">asdict</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">citations</span><span class="p">]</span>
</span><span id="JobResult.to_dict-66"><a href="#JobResult.to_dict-66"><span class="linenos">66</span></a>                <span class="k">for</span> <span class="n">field</span><span class="p">,</span> <span class="n">citations</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">citation_mappings</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
</span><span id="JobResult.to_dict-67"><a href="#JobResult.to_dict-67"><span class="linenos">67</span></a>            <span class="p">}</span>
</span><span id="JobResult.to_dict-68"><a href="#JobResult.to_dict-68"><span class="linenos">68</span></a>        
</span><span id="JobResult.to_dict-69"><a href="#JobResult.to_dict-69"><span class="linenos">69</span></a>        <span class="k">return</span> <span class="p">{</span>
</span><span id="JobResult.to_dict-70"><a href="#JobResult.to_dict-70"><span class="linenos">70</span></a>            <span class="s2">&quot;job_id&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_id</span><span class="p">,</span>
</span><span id="JobResult.to_dict-71"><a href="#JobResult.to_dict-71"><span class="linenos">71</span></a>            <span class="s2">&quot;raw_response&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">raw_response</span><span class="p">,</span>
</span><span id="JobResult.to_dict-72"><a href="#JobResult.to_dict-72"><span class="linenos">72</span></a>            <span class="s2">&quot;parsed_response&quot;</span><span class="p">:</span> <span class="n">parsed_response</span><span class="p">,</span>
</span><span id="JobResult.to_dict-73"><a href="#JobResult.to_dict-73"><span class="linenos">73</span></a>            <span class="s2">&quot;citations&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">asdict</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">citations</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">citations</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="JobResult.to_dict-74"><a href="#JobResult.to_dict-74"><span class="linenos">74</span></a>            <span class="s2">&quot;citation_mappings&quot;</span><span class="p">:</span> <span class="n">citation_mappings</span><span class="p">,</span>
</span><span id="JobResult.to_dict-75"><a href="#JobResult.to_dict-75"><span class="linenos">75</span></a>            <span class="s2">&quot;input_tokens&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_tokens</span><span class="p">,</span>
</span><span id="JobResult.to_dict-76"><a href="#JobResult.to_dict-76"><span class="linenos">76</span></a>            <span class="s2">&quot;output_tokens&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_tokens</span><span class="p">,</span>
</span><span id="JobResult.to_dict-77"><a href="#JobResult.to_dict-77"><span class="linenos">77</span></a>            <span class="s2">&quot;cost_usd&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cost_usd</span><span class="p">,</span>
</span><span id="JobResult.to_dict-78"><a href="#JobResult.to_dict-78"><span class="linenos">78</span></a>            <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">error</span><span class="p">,</span>
</span><span id="JobResult.to_dict-79"><a href="#JobResult.to_dict-79"><span class="linenos">79</span></a>            <span class="s2">&quot;batch_id&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_id</span>
</span><span id="JobResult.to_dict-80"><a href="#JobResult.to_dict-80"><span class="linenos">80</span></a>        <span class="p">}</span>
</span></pre></div>


            <div class="docstring"><p>Serialize for state persistence.</p>
</div>


                            </div>
                            <div id="JobResult.from_dict" class="classattr">
                                        <input id="JobResult.from_dict-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator decorator-classmethod">@classmethod</div>

        <span class="def">def</span>
        <span class="name">from_dict</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">cls</span>, </span><span class="param"><span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span></span><span class="return-annotation">) -> <span class="n"><a href="#JobResult">JobResult</a></span>:</span></span>

                <label class="view-source-button" for="JobResult.from_dict-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#JobResult.from_dict"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="JobResult.from_dict-82"><a href="#JobResult.from_dict-82"><span class="linenos"> 82</span></a>    <span class="nd">@classmethod</span>
</span><span id="JobResult.from_dict-83"><a href="#JobResult.from_dict-83"><span class="linenos"> 83</span></a>    <span class="k">def</span><span class="w"> </span><span class="nf">from_dict</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="s1">&#39;JobResult&#39;</span><span class="p">:</span>
</span><span id="JobResult.from_dict-84"><a href="#JobResult.from_dict-84"><span class="linenos"> 84</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Deserialize from state.&quot;&quot;&quot;</span>
</span><span id="JobResult.from_dict-85"><a href="#JobResult.from_dict-85"><span class="linenos"> 85</span></a>        <span class="c1"># Reconstruct citations if present</span>
</span><span id="JobResult.from_dict-86"><a href="#JobResult.from_dict-86"><span class="linenos"> 86</span></a>        <span class="n">citations</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="JobResult.from_dict-87"><a href="#JobResult.from_dict-87"><span class="linenos"> 87</span></a>        <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;citations&quot;</span><span class="p">):</span>
</span><span id="JobResult.from_dict-88"><a href="#JobResult.from_dict-88"><span class="linenos"> 88</span></a>            <span class="n">citations</span> <span class="o">=</span> <span class="p">[</span><span class="n">Citation</span><span class="p">(</span><span class="o">**</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;citations&quot;</span><span class="p">]]</span>
</span><span id="JobResult.from_dict-89"><a href="#JobResult.from_dict-89"><span class="linenos"> 89</span></a>        
</span><span id="JobResult.from_dict-90"><a href="#JobResult.from_dict-90"><span class="linenos"> 90</span></a>        <span class="c1"># Reconstruct citation_mappings if present</span>
</span><span id="JobResult.from_dict-91"><a href="#JobResult.from_dict-91"><span class="linenos"> 91</span></a>        <span class="n">citation_mappings</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="JobResult.from_dict-92"><a href="#JobResult.from_dict-92"><span class="linenos"> 92</span></a>        <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;citation_mappings&quot;</span><span class="p">):</span>
</span><span id="JobResult.from_dict-93"><a href="#JobResult.from_dict-93"><span class="linenos"> 93</span></a>            <span class="n">citation_mappings</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="JobResult.from_dict-94"><a href="#JobResult.from_dict-94"><span class="linenos"> 94</span></a>                <span class="n">field</span><span class="p">:</span> <span class="p">[</span><span class="n">Citation</span><span class="p">(</span><span class="o">**</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">citations</span><span class="p">]</span>
</span><span id="JobResult.from_dict-95"><a href="#JobResult.from_dict-95"><span class="linenos"> 95</span></a>                <span class="k">for</span> <span class="n">field</span><span class="p">,</span> <span class="n">citations</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;citation_mappings&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
</span><span id="JobResult.from_dict-96"><a href="#JobResult.from_dict-96"><span class="linenos"> 96</span></a>            <span class="p">}</span>
</span><span id="JobResult.from_dict-97"><a href="#JobResult.from_dict-97"><span class="linenos"> 97</span></a>        
</span><span id="JobResult.from_dict-98"><a href="#JobResult.from_dict-98"><span class="linenos"> 98</span></a>        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span>
</span><span id="JobResult.from_dict-99"><a href="#JobResult.from_dict-99"><span class="linenos"> 99</span></a>            <span class="n">job_id</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;job_id&quot;</span><span class="p">],</span>
</span><span id="JobResult.from_dict-100"><a href="#JobResult.from_dict-100"><span class="linenos">100</span></a>            <span class="n">raw_response</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;raw_response&quot;</span><span class="p">],</span>
</span><span id="JobResult.from_dict-101"><a href="#JobResult.from_dict-101"><span class="linenos">101</span></a>            <span class="n">parsed_response</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;parsed_response&quot;</span><span class="p">),</span>
</span><span id="JobResult.from_dict-102"><a href="#JobResult.from_dict-102"><span class="linenos">102</span></a>            <span class="n">citations</span><span class="o">=</span><span class="n">citations</span><span class="p">,</span>
</span><span id="JobResult.from_dict-103"><a href="#JobResult.from_dict-103"><span class="linenos">103</span></a>            <span class="n">citation_mappings</span><span class="o">=</span><span class="n">citation_mappings</span><span class="p">,</span>
</span><span id="JobResult.from_dict-104"><a href="#JobResult.from_dict-104"><span class="linenos">104</span></a>            <span class="n">input_tokens</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;input_tokens&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
</span><span id="JobResult.from_dict-105"><a href="#JobResult.from_dict-105"><span class="linenos">105</span></a>            <span class="n">output_tokens</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;output_tokens&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
</span><span id="JobResult.from_dict-106"><a href="#JobResult.from_dict-106"><span class="linenos">106</span></a>            <span class="n">cost_usd</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;cost_usd&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span>
</span><span id="JobResult.from_dict-107"><a href="#JobResult.from_dict-107"><span class="linenos">107</span></a>            <span class="n">error</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;error&quot;</span><span class="p">),</span>
</span><span id="JobResult.from_dict-108"><a href="#JobResult.from_dict-108"><span class="linenos">108</span></a>            <span class="n">batch_id</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;batch_id&quot;</span><span class="p">)</span>
</span><span id="JobResult.from_dict-109"><a href="#JobResult.from_dict-109"><span class="linenos">109</span></a>        <span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Deserialize from state.</p>
</div>


                            </div>
                </section>
                <section id="Citation">
                            <input id="Citation-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
                    <div class="decorator decorator-dataclass">@dataclass</div>

    <span class="def">class</span>
    <span class="name">Citation</span>:

                <label class="view-source-button" for="Citation-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#Citation"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="Citation-8"><a href="#Citation-8"><span class="linenos"> 8</span></a><span class="nd">@dataclass</span>
</span><span id="Citation-9"><a href="#Citation-9"><span class="linenos"> 9</span></a><span class="k">class</span><span class="w"> </span><span class="nc">Citation</span><span class="p">:</span>
</span><span id="Citation-10"><a href="#Citation-10"><span class="linenos">10</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Represents a citation extracted from an AI response.&quot;&quot;&quot;</span>
</span><span id="Citation-11"><a href="#Citation-11"><span class="linenos">11</span></a>    
</span><span id="Citation-12"><a href="#Citation-12"><span class="linenos">12</span></a>    <span class="n">text</span><span class="p">:</span> <span class="nb">str</span>  <span class="c1"># The cited text</span>
</span><span id="Citation-13"><a href="#Citation-13"><span class="linenos">13</span></a>    <span class="n">source</span><span class="p">:</span> <span class="nb">str</span>  <span class="c1"># Source identifier (e.g., page number, section)</span>
</span><span id="Citation-14"><a href="#Citation-14"><span class="linenos">14</span></a>    <span class="n">page</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Page number if applicable</span>
</span><span id="Citation-15"><a href="#Citation-15"><span class="linenos">15</span></a>    <span class="n">metadata</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Additional metadata</span>
</span></pre></div>


            <div class="docstring"><p>Represents a citation extracted from an AI response.</p>
</div>


                            <div id="Citation.__init__" class="classattr">
                                <div class="attr function">
            
        <span class="name">Citation</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">text</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">source</span><span class="p">:</span> <span class="nb">str</span>,</span><span class="param">	<span class="n">page</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>,</span><span class="param">	<span class="n">metadata</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span></span>)</span>

        
    </div>
    <a class="headerlink" href="#Citation.__init__"></a>
    
    

                            </div>
                            <div id="Citation.text" class="classattr">
                                <div class="attr variable">
            <span class="name">text</span><span class="annotation">: str</span>

        
    </div>
    <a class="headerlink" href="#Citation.text"></a>
    
    

                            </div>
                            <div id="Citation.source" class="classattr">
                                <div class="attr variable">
            <span class="name">source</span><span class="annotation">: str</span>

        
    </div>
    <a class="headerlink" href="#Citation.source"></a>
    
    

                            </div>
                            <div id="Citation.page" class="classattr">
                                <div class="attr variable">
            <span class="name">page</span><span class="annotation">: Optional[int]</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#Citation.page"></a>
    
    

                            </div>
                            <div id="Citation.metadata" class="classattr">
                                <div class="attr variable">
            <span class="name">metadata</span><span class="annotation">: Optional[Dict[str, Any]]</span>        =
<span class="default_value">None</span>

        
    </div>
    <a class="headerlink" href="#Citation.metadata"></a>
    
    

                            </div>
                </section>
                <section id="BatchataError">
                            <input id="BatchataError-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">BatchataError</span><wbr>(<span class="base">builtins.Exception</span>):

                <label class="view-source-button" for="BatchataError-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#BatchataError"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="BatchataError-5"><a href="#BatchataError-5"><span class="linenos">5</span></a><span class="k">class</span><span class="w"> </span><span class="nc">BatchataError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
</span><span id="BatchataError-6"><a href="#BatchataError-6"><span class="linenos">6</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Base exception for all Batchata errors.&quot;&quot;&quot;</span>
</span><span id="BatchataError-7"><a href="#BatchataError-7"><span class="linenos">7</span></a>    <span class="k">pass</span>
</span></pre></div>


            <div class="docstring"><p>Base exception for all Batchata errors.</p>
</div>


                </section>
                <section id="CostLimitExceededError">
                            <input id="CostLimitExceededError-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">CostLimitExceededError</span><wbr>(<span class="base"><a href="#BatchataError">batchata.BatchataError</a></span>):

                <label class="view-source-button" for="CostLimitExceededError-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#CostLimitExceededError"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="CostLimitExceededError-35"><a href="#CostLimitExceededError-35"><span class="linenos">35</span></a><span class="k">class</span><span class="w"> </span><span class="nc">CostLimitExceededError</span><span class="p">(</span><span class="n">BatchataError</span><span class="p">):</span>
</span><span id="CostLimitExceededError-36"><a href="#CostLimitExceededError-36"><span class="linenos">36</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Raised when cost limit would be exceeded.&quot;&quot;&quot;</span>
</span><span id="CostLimitExceededError-37"><a href="#CostLimitExceededError-37"><span class="linenos">37</span></a>    <span class="k">pass</span>
</span></pre></div>


            <div class="docstring"><p>Raised when cost limit would be exceeded.</p>
</div>


                </section>
                <section id="ProviderError">
                            <input id="ProviderError-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">ProviderError</span><wbr>(<span class="base"><a href="#BatchataError">batchata.BatchataError</a></span>):

                <label class="view-source-button" for="ProviderError-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ProviderError"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ProviderError-15"><a href="#ProviderError-15"><span class="linenos">15</span></a><span class="k">class</span><span class="w"> </span><span class="nc">ProviderError</span><span class="p">(</span><span class="n">BatchataError</span><span class="p">):</span>
</span><span id="ProviderError-16"><a href="#ProviderError-16"><span class="linenos">16</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Base exception for provider-related errors.&quot;&quot;&quot;</span>
</span><span id="ProviderError-17"><a href="#ProviderError-17"><span class="linenos">17</span></a>    <span class="k">pass</span>
</span></pre></div>


            <div class="docstring"><p>Base exception for provider-related errors.</p>
</div>


                </section>
                <section id="ProviderNotFoundError">
                            <input id="ProviderNotFoundError-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">ProviderNotFoundError</span><wbr>(<span class="base"><a href="#ProviderError">batchata.ProviderError</a></span>):

                <label class="view-source-button" for="ProviderNotFoundError-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ProviderNotFoundError"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ProviderNotFoundError-20"><a href="#ProviderNotFoundError-20"><span class="linenos">20</span></a><span class="k">class</span><span class="w"> </span><span class="nc">ProviderNotFoundError</span><span class="p">(</span><span class="n">ProviderError</span><span class="p">):</span>
</span><span id="ProviderNotFoundError-21"><a href="#ProviderNotFoundError-21"><span class="linenos">21</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Raised when no provider is found for a model.&quot;&quot;&quot;</span>
</span><span id="ProviderNotFoundError-22"><a href="#ProviderNotFoundError-22"><span class="linenos">22</span></a>    <span class="k">pass</span>
</span></pre></div>


            <div class="docstring"><p>Raised when no provider is found for a model.</p>
</div>


                </section>
                <section id="ValidationError">
                            <input id="ValidationError-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">ValidationError</span><wbr>(<span class="base"><a href="#BatchataError">batchata.BatchataError</a></span>):

                <label class="view-source-button" for="ValidationError-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ValidationError"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ValidationError-10"><a href="#ValidationError-10"><span class="linenos">10</span></a><span class="k">class</span><span class="w"> </span><span class="nc">ValidationError</span><span class="p">(</span><span class="n">BatchataError</span><span class="p">):</span>
</span><span id="ValidationError-11"><a href="#ValidationError-11"><span class="linenos">11</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Raised when job or configuration validation fails.&quot;&quot;&quot;</span>
</span><span id="ValidationError-12"><a href="#ValidationError-12"><span class="linenos">12</span></a>    <span class="k">pass</span>
</span></pre></div>


            <div class="docstring"><p>Raised when job or configuration validation fails.</p>
</div>


                </section>
    </main>
</body>
</html>